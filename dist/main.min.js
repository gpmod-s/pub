(function(){
class GPUtils_{static CANVAS_ID={DEFAULT:1,SQUARE:2};static CANVAS_TYPE={[this.CANVAS_ID.DEFAULT]:"default",[this.CANVAS_ID.SQUARE]:"square"};static CANVAS_DIMENSIONS={[this.CANVAS_ID.DEFAULT]:[758,424],[this.CANVAS_ID.SQUARE]:[424,424]};static getCanvasTypeById(a){return this.CANVAS_TYPE[a]??this.CANVAS_TYPE[this.CANVAS_ID.DEFAULT]}static getCanvasDimensionsById(a){return this.CANVAS_DIMENSIONS[a]??this.CANVAS_DIMENSIONS[this.CANVAS_ID.DEFAULT]}static async compressImageData(a,b=!0){const {data:c,
background:d,auth:e,meta:f}=a;a={m:{a:f.author,t:f.title,d:(new Date(f.date)).toISOString()},d:c};d&&(a.b=d);e&&(a.a=e);return b?this.wCompressData(a):this.compressData(a)}static async compressData(a){a=JSON.stringify(a);a=this.stringToArrayBuffer(a);a=await this.compressArrayBuffer(a);return this.arrayBufferToBlob(a)}static arrayBufferToBlob(a){return new Blob([a],{type:"octet/stream"})}static async compressArrayBuffer(a){var b=new CompressionStream("deflate"),c=b.writable.getWriter();c.write(a);
c.close();a=[];b=b.readable.getReader();for(c=0;;){const {value:d,done:e}=await b.read();if(e)break;a.push(d);c+=d.byteLength}b=new Uint8Array(c);c=0;for(const d of a)b.set(d,c),c+=d.byteLength;return b}static stringToArrayBuffer(a){return(new TextEncoder).encode(a)}static async decompressFile(a){return JSON.parse(await this.decompressBlob(a))}static async decompressBlob(a){let b=new DecompressionStream("deflate");a=a.stream().pipeThrough(b);return await (new Response(a)).text()}static saveBlob(a,
b=""){a=window.URL.createObjectURL(a);const c=document.createElement("a");c.href=a;c.download=b;c.click();window.URL.revokeObjectURL(a)}static wCompressData(a){return new Promise(b=>{const c=this.createWorker(this.compressWorkerBody);c.addEventListener("message",({data:d})=>{c.terminate();b(d)});c.postMessage(a)})}static compressWorkerBody(){self.work=new async function(){}.constructor("a",'a=JSON.stringify(a);a=(new TextEncoder).encode(a);var c=new CompressionStream("deflate"),b=c.writable.getWriter();b.write(a);b.close();a=[];c=c.readable.getReader();for(b=0;;){const {value:d,done:e}=await c.read();if(e)break;a.push(d);b+=d.byteLength}c=new Uint8Array(b);b=0;for(const d of a)c.set(d,b),b+=d.byteLength;return new Blob([c],{type:"octet/stream"})');
self.addEventListener("message",async({data:a})=>{self.postMessage(await self.work(a))})}static createWorker(a){a=URL.createObjectURL(new Blob([this.getFuncBody(a)]));const b=new Worker(a);URL.revokeObjectURL(a);return b}static getFuncBody(a){a=a.toString();return a.substring(a.indexOf("{")+1,a.lastIndexOf("}"))}static setInputFocusBlurHandler(a){const b=c=>{c.target!==a&&(a.blur(),document.removeEventListener("pointerdown",b,!0))};a.addEventListener("focus",c=>{c.target.select();document.addEventListener("pointerdown",
b,!0)});a.addEventListener("blur",c=>{window.getSelection().removeAllRanges()})}static drawFunctionString='function(a,c,d,t,D,f){f&&(a.beginPath(),a.rect(0,0,1,1),a.fill());a.lineCap=a.lineJoin="round";a.save();if(c){f=[];let E=!0,O=!1,P=void 0;try{for(var C,F=c[Symbol.iterator]();!(E=(C=F.next()).done);E=!0){const x=C.value,w=x[0],b=x.slice(2);if(10!=w){c=void 0;a.save();if(12==w)t?a.clearRect(0,32*d,758*d,424*d):(a.fillStyle="#FFFFFF",a.beginPath(),a.rect(0,32*d,758*d,424*d),a.fill());else if(8!=w){for(var e=1;e<b.length;e++)b[e]=[b[e][0]*d,b[e][1]*d];if(2<b.length)switch(w){case 1:var G=b[0];a.strokeStyle=G[0];a.lineWidth=G[1];a.globalAlpha=G[2];a.lineWidth*=d;c=[b[1][0],b[1][1]];a.beginPath();a.moveTo.apply(a,c);for(e=2;e<b.length;e++){c=[b[e][0],b[e][1]];var y=[b[e-1][0],b[e-1][1]];a.quadraticCurveTo(y[0],y[1],y[0]+(c[0]-y[0])/2,y[1]+(c[1]-y[1])/2)}a.lineTo(c[0],c[1]);a.stroke();break;case 2:a.strokeStyle="#FFFFFF";a.lineWidth=b[0]*d;c=[b[1][0],b[1][1]];t&&(a.globalCompositeOperation="destination-out");a.beginPath();a.moveTo.apply(a,c);for(e=2;e<b.length;e++){c=[b[e][0],b[e][1]];var z=[b[e-1][0],b[e-1][1]];a.quadraticCurveTo(z[0],z[1],z[0]+(c[0]-z[0])/2,z[1]+(c[1]-z[1])/2)}a.lineTo(c[0],c[1]);a.stroke();t&&(a.globalCompositeOperation="source-over");break;case 3:var H=b[0];a.strokeStyle=H[0];a.lineWidth=H[1];a.globalAlpha=H[2];a.lineWidth*=d;a.beginPath();a.moveTo(b[1][0],b[1][1]);a.lineTo(b[2][0],b[2][1]);a.stroke();break;case 4:var I=b[0];a.strokeStyle=I[0];a.lineWidth=I[1];a.globalAlpha=I[2];a.lineWidth*=d;a.beginPath();a.rect(b[1][0],b[1][1],b[2][0]-b[1][0],b[2][1]-b[1][1]);a.stroke();break;case 6:var J=b[0];a.fillStyle=J[0];a.lineWidth=J[1];a.globalAlpha=J[2];a.lineWidth*=d;a.beginPath();a.rect(b[1][0],b[1][1],b[2][0]-b[1][0],b[2][1]-b[1][1]);a.fill();break;case 5:var K=b[0];a.strokeStyle=K[0];a.lineWidth=K[1];a.globalAlpha=K[2];a.lineWidth*=d;var p=(b[2][0]-b[1][0])/2,m=(b[2][1]-b[1][1])/2,g=Math.round(b[1][0]+p),h=Math.round(b[1][1]+m),u=(Math.sqrt(2)-1)/3*4;a.beginPath();a.moveTo(g,h-m);a.bezierCurveTo(g+u*p,h-m,g+p,h-u*m,g+p,h);a.bezierCurveTo(g+p,h+u*m,g+u*p,h+m,g,h+m);a.bezierCurveTo(g-u*p,h+m,g-p,h+u*m,g-p,h);a.bezierCurveTo(g-p,h-u*m,g-u*p,h-m,g,h-m);a.stroke();break;case 7:var L=b[0];a.fillStyle=L[0];a.lineWidth=L[1];a.globalAlpha=L[2];a.lineWidth*=d;var q=(b[2][0]-b[1][0])/2,n=(b[2][1]-b[1][1])/2,k=Math.round(b[1][0]+q),l=Math.round(b[1][1]+n),v=(Math.sqrt(2)-1)/3*4;a.beginPath();a.moveTo(k,l-n);a.bezierCurveTo(k+v*q,l-n,k+q,l-v*n,k+q,l);a.bezierCurveTo(k+q,l+v*n,k+v*q,l+n,k,l+n);a.bezierCurveTo(k-v*q,l+n,k-q,l+v*n,k-q,l);a.bezierCurveTo(k-q,l-v*n,k-v*q,l-n,k,l-n);a.fill()}else if(![6,7,11].includes(w)){switch(w){case 2:a.fillStyle="#FFFFFF";a.lineWidth=b[0]*d;c=b[1];t&&(a.globalCompositeOperation="destination-out");break;case 10:a.fillStyle="#FF0000";a.lineWidth=2*d;a.globalAlpha=1;c=b[1];break;default:var M=b[0];a.fillStyle=M[0];a.lineWidth=M[1];a.globalAlpha=M[2];a.lineWidth*=d;c=b[1]}a.beginPath();a.arc(c[0],c[1],a.lineWidth/2,0,2*Math.PI);a.fill();2==w&&t&&(a.globalCompositeOperation="source-over")}}else{var Q=b[0];a.fillStyle=Q[0];a.globalAlpha=Q[1];a.beginPath();for(c=1;c<b.length;c+=5)a.rect(b[c]*d,b[c+1]*d,b[c+2]*d,b[c+3]*d);a.fill()}a.restore()}else D&&f.push(b)}}catch(x){O=!0,P=x}finally{try{E||null==F.return||F.return()}finally{if(O)throw P;}}t=!0;D=!1;C=void 0;try{for(var R,N=f[Symbol.iterator]();!(t=(R=N.next()).done);t=!0){var r=R.value;for(f=1;f<r.length;f++)r[f]=[r[f][0]*d,r[f][1]*d];a.strokeStyle="#CC0053";a.lineWidth=2*d;a.globalAlpha=1;var A=[r[1][0],r[1][1]];a.beginPath();a.moveTo.apply(a,A);for(f=2;f<r.length;f++){A=[r[f][0],r[f][1]];var B=[r[f-1][0],r[f-1][1]];a.quadraticCurveTo(B[0],B[1],B[0]+(A[0]-B[0])/2,B[1]+(A[1]-B[1])/2)}a.lineTo(A[0],A[1]);a.stroke()}}catch(x){D=!0,C=x}finally{try{t||null==N.return||N.return()}finally{if(D)throw C;}}}a.restore()}';static drawFunction=(new Function(`return ${this.drawFunctionString}`))();static bindMethods(a,
b){a.forEach(c=>{b[c.name]=c.bind(b)})}static bindDeep(a,b){if(a&&"object"===typeof a)for(const c in a){const d=a[c];"function"===typeof d?a[c]=d.bind(b):d&&"object"===typeof d&&this.bindDeep(d,b)}}static computeHash(a,b=0){let c=3735928559^b;b^=1103547991;for(let d=0,e;d<a.length;d++)e=a.charCodeAt(d),c=Math.imul(c^e,2654435761),b=Math.imul(b^e,1597334677);c=Math.imul(c^c>>>16,2246822507)^Math.imul(b^b>>>13,3266489909);b=Math.imul(b^b>>>16,2246822507)^Math.imul(c^c>>>13,3266489909);return 4294967296*
(2097151&b)+(c>>>0)}static buildTooltip(a){const b=document.createElement("div");b.className="tooltip_";b.textContent="?";if(!a)return b.classList.add("disabled_"),b;b.addEventListener("pointerenter",c=>{GPApp_.setTooltip(a,c.target)});b.addEventListener("pointerleave",c=>{window.gpSettingsTooltip&&(window.gpSettingsTooltip.remove(),window.gpSettingsTooltip=null)});return b}static rafThrottle=a=>{let b=!1,c=null,d;const e=function(...f){d=f;b||(b=!0,c=requestAnimationFrame(()=>{a.apply(this,d);b=
!1}))};e.cancel=()=>{null!==c&&(cancelAnimationFrame(c),c=null);b=!1};return e};}window.GPUtils_=GPUtils_;class GPMigration_{static INSERT="insert";static RENAME="rename";static REMOVE="remove";static TASKS=[[[10,4],[()=>{this.editStorage({rename:[["gp_userlist","banTwitchUsers","userBansSyncWithTwitch"]]})},()=>{const a=localStorage.getItem("gp_update");a&&(this.editStorage({insert:[["gp_about","lastNotifiedVersion",a]]}),localStorage.removeItem("gp_update"))}]],[[10,5],[()=>{this.editStorage({insert:[["gp_painter","defaultColor",["#000000","#ffffff"]]],rename:[["gp_painter_bindings","palette","colorPicker"],
["gp_painter_bindings","swap","switchColors"]],remove:[["gp_painter","zoomSensitivity"]]})}]]];static compareVersion(a,b){const c=Math.max(a.length,b.length);for(let d=0;d<c;d++){const e=a[d]??0,f=b[d]??0;if(e>f)return 1;if(e<f)return-1}return 0}static migrate(a){a=a.split(".");let b=this.TASKS.length;for(let c=this.TASKS.length-1;0<=c;c--)if(-1===this.compareVersion(a,this.TASKS[c][0]))b=c;else break;this.TASKS.slice(b).forEach(([c,d])=>{try{d.forEach(e=>{e()}),console.log(`gpmod: migrating to v${c.join(".")}`)}catch(e){console.error(`gpmod: migration error to v${c.join(".")} |`,
e)}})}static editStorage({insert:a,rename:b,remove:c}={}){const d={};a?.forEach(([e,f,g])=>{d[e]??(d[e]=[]);d[e].push([GPMigration_.INSERT,f,g])});b?.forEach(([e,f,g])=>{d[e]??(d[e]=[]);d[e].push([GPMigration_.RENAME,f,g])});c?.forEach(([e,f])=>{d[e]??(d[e]=[]);d[e].push([GPMigration_.REMOVE,f])});for(let e in d){let f;try{f=JSON.parse(localStorage.getItem(e))??{}}catch{continue}d[e].forEach(([g,...h])=>{switch(g){case GPMigration_.INSERT:const [k,l]=h;f[k]=l;break;case GPMigration_.RENAME:const [m,
p]=h;m in f&&(f[p]=f[m],delete f[m]);break;case GPMigration_.REMOVE:[g]=h,delete f[g]}});localStorage.setItem(e,JSON.stringify(f))}}static init(a){let b=localStorage.getItem("gp_latest-version")||localStorage.getItem("gp_update");b!==a&&b&&(this.migrate(b),localStorage.setItem("gp_latest-version",a))}}window.GPMigration_=GPMigration_;(()=>{function a(d,e,f){c.ws=d;c.mm=new GPModulesManager_(e,f);c.sm=c.mm.getSettingsManager();c.app=b;c.mm.setModules([{id:0,name:"GPProxy_",required:!0,hidden:!0},{id:6,name:"GPAbout_",required:!0,hidden:!0},{id:9,name:"GPActivation_",required:!0,hidden:!0},{id:10,name:"GPAvatars_",required:!0,hiddenSettings:!0},{id:5,name:"GPAntiCheat_",hiddenSettings:!0},{id:1,name:"GPModeration_"},{id:2,name:"GPPlayersManager_"},{id:3,name:"GPArtBroadcaster_"},{id:7,name:"GPTimer_"},{id:8,name:"GPReference_"},
{id:4,name:"GPPainter_"},{id:11,name:"GPGlobalBanlist_",required:!0}],this,c)}const b={author:"liliezzzz",name:"gp-mod",tag:"gpmod",version:"10.5",betaFlag:!0,changelogURL:"https://discord.com/channels/929715202600095775/953145081471324270/1476247598611435617",summaryURL:"https://discord.com/channels/929715202600095775/929715202600095778/1476267642649182348",updateNoticeFlag:!0,updateNoticeText:"",discordURL:"https://discord.gg/xxtCmzt8uA",subscribeURL:"https://boosty.to/gpmod"};if(function(){return navigator?.userAgentData?.brands.some(d=>
"Chromium"===d.brand)||navigator.userAgent.toLowerCase().includes("firefox")}()){var c={ws:null,prx:null,tmr:null,ref:null,act:null,av:null,ac:null,abt:null};document.addEventListener("_ws",({detail:{ws:d,authData:e,l10n:f}})=>{c.prx?c.prx.setWebSocket(d):a(d,e,f);window.ws=d});document.getElementById("__next")?.classList.toggle("gp-ad-not-found_",!document.querySelector("#__next > .side > div")?.firstElementChild?.getBoundingClientRect().height);GPMigration_.init(b.version);document.dispatchEvent(new Event("gp:ready"));
console.log(`${b.tag} (v${b.version}${b.betaFlag?"-beta":""}): loaded`)}else console.error(`${b.tag}: Browser not supported`)})();class GPAbout_ extends EventTarget{static ANALYTICS_CHANNEL_URL="https://discord.com/channels/929715202600095775/1316862441426260000";static SUBSCRIBE_URL="https://boosty.to/gpmod";static HEADER_MIN_SCALE=.625;static NOTICE_TYPE={SCRIPTS:"scripts",ANALYTICS:"analytics",DISCONNECTION:"disconnection",SUB_EXPIRED:"sub_expired",UPDATE:"update",TWITCH_OAUTH_TOKEN:"twitch_oauth_token",TWITCH_TOKEN:"twitch_token",TWITCH_TOKEN2:"twitch_token2",RAID:"raid",NORMAL:"normal"};static NOTICE={[this.NOTICE_TYPE.SCRIPTS]:{priority:9,
unique:!0},[this.NOTICE_TYPE.ANALYTICS]:{priority:8,unique:!0,icon:!0},[this.NOTICE_TYPE.DISCONNECTION]:{priority:7,unique:!0,icon:!0},[this.NOTICE_TYPE.SUB_EXPIRED]:{priority:6,unique:!0,icon:!0},[this.NOTICE_TYPE.UPDATE]:{priority:5,unique:!0,icon:!0},[this.NOTICE_TYPE.TWITCH_OAUTH_TOKEN]:{priority:4,unique:!0,icon:!0},[this.NOTICE_TYPE.TWITCH_TOKEN]:{priority:3,unique:!0,icon:!0},[this.NOTICE_TYPE.TWITCH_TOKEN2]:{priority:3,unique:!0,icon:!0},[this.NOTICE_TYPE.RAID]:{priority:2,unique:!0},[this.NOTICE_TYPE.NORMAL]:{priority:1,
unique:!1}};static NOTICE_BUTTON_ICONS={DISCORD:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 127.14 96.36"><path fill="currentColor" d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.37,72.37,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.79,32.65-1.71,56.6.54,80.21h0A105.73,105.73,0,0,0,32.71,96.36,77.7,77.7,0,0,0,39.6,85.25a68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2a75.57,75.57,0,0,0,64.32,0c.87.71,1.76,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1A105.25,105.25,0,0,0,126.6,80.22h0C129.24,52.84,122.09,29.11,107.7,8.07ZM42.45,65.69C36.18,65.69,31,60,31,53s5-12.74,11.43-12.74S54,46,53.89,53,48.84,65.69,42.45,65.69Zm42.24,0C78.41,65.69,73.25,60,73.25,53s5-12.74,11.44-12.74S96.23,46,96.12,53,91.08,65.69,84.69,65.69Z"/></svg>',
BOOSTY:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 235.6 292.2" transform="scale(1.5)"><path fill="currentColor" d="M44.3 164.5 76.9 51.6H127l-10.1 35-.3.6L90 179.6h24.8c-10.4 25.9-18.5 46.2-24.3 60.9-45.8-.5-58.6-33.3-47.4-72.1m47.6 72.2 60.4-86.9h-25.6L147.8 98c38.2 4 56.2 34.1 45.6 70.5-11.3 39.1-57.1 72.1-101.7 72.1h-1z"/></svg>'};static DEFAULT_SETTINGS={windowsInkWarning:null,lastNotifiedVersion:null};static MODULE={title:"About",alias:"abt",settings:{storage:"gp_about",defaultSettings:this.DEFAULT_SETTINGS}};constructor(a){super();
this.mm=a.mm;this.app=a.app;this.s=a.sm.setSettings(this,this.updateSettings);const {version:b,changelogURL:c,summaryURL:d,updateNoticeFlag:e,updateNoticeText:f}=this.app;this.version=b;this.summaryURL=d||c;this.updateNoticeFlag=e;this.updateNoticeText=f;this.notificationQueue=[];this.notificationId=0;this.noticeDurationTimer=this.currentNotice=null;GPUtils_.bindMethods([this.closeNotice,this.resizeHandler],this);window.addEventListener("resize",this.resizeHandler);document.addEventListener("_gp_notice",
({detail:g})=>{this.addNotice(g)});document.addEventListener("_outdated-scripts",({detail:{outdatedScripts:g}})=>{g.size&&(this.printOutdatedScripts(g),this.addNotice({type:GPAbout_.NOTICE_TYPE.SCRIPTS,scripts:g}))});this.render();this.resizeHandler();this.shouldUpdateNoticeBeShown()&&(this.mm.isFirstRun()?this.s.lastNotifiedVersion=this.version:this.showUpdateNotice());this.s.windowsInkWarning&&this.addNotice({type:GPAbout_.NOTICE_TYPE.NORMAL,text:this.l.WINDOWS_INK_WARNING,onClose:()=>{this.s.windowsInkWarning=
!1}});this.requestOutdatedScripts()}render(){const {name:a,version:b,betaFlag:c,changelogURL:d,discordURL:e,subscribeURL:f}=this.app;this.container=document.createElement("div");this.container.className="gp-about_";this.container.innerHTML=`${a} <span class="version_${c?" beta_":""}">v<span class="version-number_"><a class="changelog-link_" target="_blank" href="${d}" title="${this.l.CHANGELOG_TTL}">${b}</a></span></span>`;this.versionElem=this.container.querySelector(".version-number_");if(f){var g=
document.createTextNode("\u00a0\u00a0|\u00a0\u00a0");this.container.appendChild(g);g=document.createElement("a");g.className="subscribe-link_ has-icon_";g.target="_blank";g.href=f;g.title=this.l.SUBSCRIBE_TTL;g.textContent="boosty";this.container.appendChild(g)}e&&(g=document.createTextNode("\u00a0\u00a0|\u00a0\u00a0"),this.container.appendChild(g),g=document.createElement("a"),g.className="discord-link_ has-icon_",g.target="_blank",g.href=e,g.title=this.l.DISCORD_LINK_TTL,g.textContent=e.split("//")[1],
this.container.appendChild(g));document.body.appendChild(this.container)}resizeHandler(a){a=this.getContainerScale();a=Math.min((window.innerHeight-706*a)/2,41);this.container.style.fontSize=`${Math.min(16,Math.max(a-12,12))}px`;this.container.style.lineHeight=`${a+2}px`;this.updateUpdateNoticePos()}getContainerScale(){let a=(window.innerWidth-180)/1150;766*a>window.innerHeight&&(a=window.innerHeight/766);return a}shouldUpdateNoticeBeShown(){return this.updateNoticeFlag?this.isNewVersion(this.version,
this.s.lastNotifiedVersion??"0.0",2):!1}isNewVersion(a,b,c=0){const [d,e]=[a,b].map(f=>f.split(".").map(g=>+g));a=Math.max(d.length,e.length);a=c&&Math.min(a,c)||a;for(c=0;c<a;c++){b=d[c]??0;const f=e[c]??0;if(b!==f)return b>f}return!1}updateUpdateNoticePos(){if(this.notice){var {width:a}=this.versionElem.getBoundingClientRect(),{width:b}=this.notice.getBoundingClientRect();this.notice.style.left=`calc(-${Math.floor((b-a)/2)}px)`}}requestOutdatedScripts(){document.dispatchEvent(new Event("_get-outdated-scripts"))}printOutdatedScripts(a){a.size&&
console.warn(`Outdated Scripts:\n${[...a.values()].map(b=>`${b.name} (${b.version} \u2794 ${b.latestVersion}): ${b.url}?${Date.now()}.user.js`).join("\n")}`)}updateScript(a){document.dispatchEvent(new CustomEvent("_update-script",{detail:{name:a}}))}addNotice(a){const b=Object.assign({},a,{id:++this.notificationId});GPAbout_.NOTICE[b.type].unique?this.currentNotice?.type===b.type?b.same&&b.duration===this.currentNotice?.duration||(this.closeNotice(),this.notificationQueue.push(b)):(a=this.notificationQueue.findIndex(c=>
c.type===b.type),~a&&this.notificationQueue.splice(a,1),this.notificationQueue.push(b)):this.notificationQueue.push(b);this.notificationQueue.sort((c,d)=>GPAbout_.NOTICE[d.type].priority-GPAbout_.NOTICE[c.type].priority);this.currentNotice&&GPAbout_.NOTICE[this.currentNotice.type].priority===GPAbout_.NOTICE[this.notificationQueue[0].type].priority||this.showNotice(this.notificationQueue[0])}showNotice(a){this.currentNotice=a;this.notice?.remove();clearTimeout(this.noticeDurationTimer);this.notice=
document.createElement(a.url?"a":"div");this.notice.className="notice_";this.notice.dataset.type=a.type;var b=a.text||(a.type===GPAbout_.NOTICE_TYPE.UPDATE?this.l.UPDATE_NOTICE:"");if(b){const d=document.createElement("div");d.className="text-container";b.split("\n\n").forEach(e=>{const f=document.createElement("div");f.className="text_";f.textContent=e;d.appendChild(f)});this.notice.appendChild(d);b=!1;if(a.buttons){const e=document.createElement("div");e.className="buttons_";a.buttons.forEach(([f,
g,h])=>{const k=document.createElement(h?"a":"div");k.className="btn_";k.textContent=f;h&&(h.startsWith("https://discord.com/")?(f=document.createElement("div"),f.classList.add("icon_"),f.innerHTML=GPAbout_.NOTICE_BUTTON_ICONS.DISCORD,k.appendChild(f)):h.startsWith("https://boosty.to/")&&(f=document.createElement("div"),f.classList.add("icon_"),f.innerHTML=GPAbout_.NOTICE_BUTTON_ICONS.BOOSTY,k.appendChild(f)),k.href=h,k.target="_blank");g&&k.addEventListener("click",l=>{g();this.closeNotice()});e.appendChild(k)});
this.notice.appendChild(e);this.notice.classList.add("with-buttons_");b=!0}if(GPAbout_.NOTICE[a.type].icon){const e=document.createElement("div");e.className="icon_";e.style.gridRowEnd=(b?1:0)+2;this.notice.appendChild(e);this.notice.classList.add("with-icon_");a.type===GPAbout_.NOTICE_TYPE.UPDATE&&(e.dataset.version=`v${this.version.split(".").slice(0,2).join(".")}`)}}if(a.style)for(var c in a.style)this.notice.style[c]=a.style[c];a.url&&(this.notice.href=a.url,this.notice.target="_blank",this.notice.title=
this.l.NOTICE_URL_TTL);a.onClick&&(this.notice.classList.add("clickable_"),this.notice.addEventListener("click",a.onClick));(a.url||a.onClick)&&this.notice.addEventListener("click",this.closeNotice);a.duration&&(c=document.createElementNS("http://www.w3.org/2000/svg","svg"),c.classList.add("timer_"),c.setAttribute("viewBox","0 0 16 16"),c.innerHTML="<circle></circle>",c.style.setProperty("--duration",`${a.duration}ms`),this.notice.appendChild(c),this.noticeDurationTimer=setTimeout(this.closeNotice,
a.duration));a.scripts&&(c=this.buildScripts(a.scripts),this.notice.appendChild(c));c=document.createElement("div");c.className="close-btn_";c.textContent="\u2716";c.title="";c.addEventListener("click",d=>{if(a.onClose)a.onClose();this.closeNotice();d.preventDefault();d.stopPropagation()});this.notice.appendChild(c);this.versionElem.appendChild(this.notice);this.updateUpdateNoticePos()}closeNotice(a=null){if(a&&(this.notificationQueue=this.notificationQueue.filter(c=>c.type!==a),a!==this.currentNotice?.type))return;
this.currentNotice.type===GPAbout_.NOTICE_TYPE.UPDATE&&(this.s.lastNotifiedVersion=this.version);this.notice.remove();this.notice=null;const b=this.notificationQueue.indexOf(this.currentNotice);~b&&this.notificationQueue.splice(b,1);this.currentNotice=null;clearTimeout(this.noticeDurationTimer);this.showNextNotice()}showNextNotice(){this.notificationQueue.length&&this.showNotice(this.notificationQueue[0])}buildNoticeMessage(a){return a?a.split("\n\n").map(b=>`<div class="text_">${b}</div>`).join(""):
""}buildScripts(a){const b=document.createElement("div");b.className="scripts_";var c=document.createElement("div");c.className="title_";c.textContent=this.l.UPDATE_SCRIPTS_TITLE;b.appendChild(c);const d=document.createElement("div");d.className="reload-row_";c=document.createElement("a");c.className="reload-btn_";c.href="/";c.textContent=this.l.RELOAD_BTN;c.addEventListener("click",f=>{f.preventDefault();window.onbeforeunload=null;location.reload()});c.addEventListener("auxclick",f=>{f.preventDefault()});
d.appendChild(c);const e=new Set;Array.from(a.values()).forEach((f,g)=>{var h=`${f.url}?${Date.now()}.user.js`;const k=document.createElement("div");k.className="oudated-script_";var l=document.createElement("div");l.textContent=f.name;k.appendChild(l);l=document.createElement("div");l.textContent=`${f.version} \u2794 ${f.latestVersion}`;k.appendChild(l);l=document.createElement("div");k.appendChild(l);const m=document.createElement("a");m.className="script-update-link_";m.href=h;m.target="_blank";
m.textContent=this.l.UPDATE_SCRIPT;h=p=>{e.add(g);e.size>=a.size&&d.classList.add("shown_");m.closest(".oudated-script_").classList.add("clicked_");"click"===p.type&&(this.updateScript(f.name),p.preventDefault())};m.addEventListener("click",h);m.addEventListener("auxclick",h);l.appendChild(m);b.appendChild(k)});b.appendChild(d);return b}getVersion(){return this.version}getWindowsInkWarningState(){return this.s.windowsInkWarning}setWindowsInkWarningState(a){this.s.windowsInkWarning=a}showUpdateNotice(){const [a,
b]=this.l.UPDATE_NOTICE.split("|");this.addNotice({type:GPAbout_.NOTICE_TYPE.UPDATE,text:this.updateNoticeText||a,buttons:[[b,()=>{},this.summaryURL]]})}showAnalyticsNotice(){const [a,b,c]=this.l.ANALYTICS_NOTICE.split("|");this.addNotice({type:GPAbout_.NOTICE_TYPE.ANALYTICS,text:a,buttons:[[b,null,GPAbout_.ANALYTICS_CHANNEL_URL],[c,()=>{document.dispatchEvent(new Event("gp.abt.analytics_consent_granted"))}]]})}showDisconnectionNotice(){const [a,b]=this.l.DISCONNECTION_WARNING.split("|");this.addNotice({type:GPAbout_.NOTICE_TYPE.DISCONNECTION,
text:a,same:!0,buttons:[[b,()=>{this.mm.reloadPage()}]]})}showSubExpiredNotice(){const [a,b]=this.l.SUB_EXPIRED_NOTICE.split("|");this.addNotice({type:GPAbout_.NOTICE_TYPE.SUB_EXPIRED,text:a,buttons:[[b,null,GPAbout_.SUBSCRIBE_URL]]})}showTwitchOAuthTokenNotice({onButtonClick:a}){const [b,c]=this.l.INVALID_TWITCH_OAUTH_TOKEN.split("|");this.addNotice({type:GPAbout_.NOTICE_TYPE.TWITCH_OAUTH_TOKEN,text:b,buttons:[[c,()=>{a()}]]})}showTwitchTokenNotice({onButtonClick:a,onClose:b}){const [c,d]=this.l.INVALID_TWITCH_TOKEN.split("|");
this.addNotice({type:GPAbout_.NOTICE_TYPE.TWITCH_TOKEN,text:c,buttons:[[d,()=>{a()}]],onClose:b})}showTwitchToken2Notice({onButtonClick:a,onClose:b}){const [c,d]=this.l.INVALID_TWITCH_TOKEN2.split("|");this.addNotice({type:GPAbout_.NOTICE_TYPE.TWITCH_TOKEN2,text:c,buttons:[[d,()=>{a()}]],onClose:b})}}window.GPAbout_=GPAbout_;class GPActivation_ extends EventTarget{static AUTH_FILENAME_STORAGE="gp_auth-filename";static ACTIVATION_KEY_PATTERN=/^[a-zA-Z0-9]{32}:\d{14,16}$/;static DEFAULT_SETTINGS={activationKey:"",publicKey:"",filename:""};static SETTINGS_UI={activationKey:{type:"input",args:{secure:!0},description:"\u041a\u043b\u044e\u0447 \u0430\u043a\u0442\u0438\u0432\u0430\u0446\u0438\u0438"}};static MODULE={title:"Activation",alias:"act",settings:{storage:"gp_activation",defaultSettings:this.DEFAULT_SETTINGS,ui:this.SETTINGS_UI}};constructor(a){super();
this.s=a.sm.setSettings(this,this.updateSettings);this.subsStatus=!1;this.keyHash=null;GPUtils_.bindMethods([this.updateSubsStatus,this.broadcastSubsStatus,this.setActivationKey],this);document.addEventListener("gp:act.auth_perms",this.updateSubsStatus);this.initAuthFilenameStorage();this.updateKeyHash();this.broadcastPublicKey();document.dispatchEvent(new CustomEvent("gp:act.init",{detail:{pasteKey:this.setActivationKey}}))}initAuthFilenameStorage(){localStorage.setItem(GPActivation_.AUTH_FILENAME_STORAGE,
this.s.filename)}broadcastPublicKey(){document.dispatchEvent(new CustomEvent("gp:act.auth_key",{detail:{publicKey:this.s.publicKey}}))}updateKeyHash(){this.keyHash=this.s.publicKey?String(GPUtils_.computeHash(this.s.publicKey)):null}getKeyHash(){return this.keyHash}updateSubsStatus({detail:{ps:a}}){this.subsStatus=!!(256&a);this.broadcastSubsStatus(a)}broadcastSubsStatus(a){document.dispatchEvent(new CustomEvent("gp:act.subs_status",{detail:{status:this.subsStatus,ps:a}}))}setActivationKey(a){return GPActivation_.ACTIVATION_KEY_PATTERN.test(a)?
(this.s.activationKey=a,!0):!1}updateSettings({detail:{settings:a}}){if("activationKey"in a){const [b,c]=a.activationKey.split(":");this.s.publicKey=b??"";this.s.filename=c??"";this.initAuthFilenameStorage();this.updateKeyHash();this.broadcastPublicKey();document.dispatchEvent(new Event("gp:act.auth_key_changed"))}}}window.GPActivation_=GPActivation_;class GPAntiCheat_ extends EventTarget{static MIN_STROKES_TRIGGER=100;static MIN_PERCENTAGE_TRIGGER=75;static SEQUENCE_MIN_SIZE=5;static SEQUENCES_COUNT_TRIGGER=10;static MAX_SEQUENCE_TRIGGER=80;static CM_SEQUENCE_TRIGGER=4;static CANVAS_WIDTH=758;static CANVAS_HEIGHT=424;static M_STROKE_OFFSET=67;static DEFAULT_SETTINGS={enabled:!0,activatedForOwnerOnly:!0,sendReports:!0};static SETTINGS_UI={enabled:{type:"switch",description:"\u0410\u043a\u0442\u0438\u0432\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0410\u043d\u0442\u0438-\u0427\u0438\u0442"},
activatedForOwnerOnly:{type:"switch",description:"\u0410\u043a\u0442\u0438\u0432\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0410\u043d\u0442\u0438-\u0427\u0438\u0442, \u0442\u043e\u043b\u044c\u043a\u043e \u0435\u0441\u043b\u0438 \u0412\u044b \u044f\u0432\u043b\u044f\u0435\u0442\u0435\u0441\u044c \u0432\u043b\u0430\u0434\u0435\u043b\u044c\u0446\u0435\u043c \u043a\u043e\u043c\u043d\u0430\u0442\u044b"},_1:{text:"Reports"},sendReports:{type:"switch",description:"\u041e\u0442\u0441\u044b\u043b\u0430\u0442\u044c \u043e\u0442\u0447\u0451\u0442\u044b \u043e \u0440\u0438\u0441\u0443\u043d\u043a\u0430\u0445, \u043f\u043e\u043c\u0435\u0447\u0435\u043d\u043d\u044b\u0435 \u0410\u043d\u0442\u0438-\u0427\u0438\u0442\u043e\u043c \u043a\u0430\u043a \u043f\u043e\u0434\u043e\u0437\u0440\u0438\u0442\u0435\u043b\u044c\u043d\u044b\u0435\n\u0412 \u0446\u0435\u043b\u044f\u0445 \u0443\u043b\u0443\u0447\u0448\u0435\u043d\u0438\u044f \u0410\u043d\u0442\u0438-\u0427\u0438\u0442\u0430"}};static MODULE={title:"Anti-Cheat",
alias:"ac",dependencies:["GPUtils_","GPAssets_","GPAlbumObserver_","GPImageReportSender_"],settings:{storage:"gp_anti-cheat",defaultSettings:GPAntiCheat_.DEFAULT_SETTINGS,ui:GPAntiCheat_.SETTINGS_UI},useCSS:!0};constructor(a){super();this.prx=a.prx;this.s=a.sm.setSettings(this);this.isSubscribed=!1;this.itemsTriggers=new Map;this.isGameMWActivated=this.isAlbumMWActivated=!1;this.suspiciousItems=new Set;this.reportSender=new GPImageReportSender_(GPImageReportSender_.ANTI_CHEAT,this.prx,a.act);GPUtils_.bindMethods([this.gameMiddleware,
this.albumMiddleware],this);this.prx.addEventListener("gallery_started",b=>{this.itemsTriggers.clear();this.suspiciousItems.clear()});this.prx.addEventListener("rejoin",({detail:{stage:b}})=>{switch(b){case GPProxy_.STAGE.GAME:this.prx.addWSMsgMiddleware([GPProxy_.EVENT.TURN_STARTED],this.gameMiddleware);this.isGameMWActivated=!0;break;case GPProxy_.STAGE.ALBUM:this.prx.addWSMsgMiddleware([GPProxy_.EVENT.ALBUM_ITEM,GPProxy_.EVENT.ALBUM_INFO],this.albumMiddleware),this.isAlbumMWActivated=!0}});this.prx.addEventListener("data",
({detail:{event:b}})=>{b===GPProxy_.EVENT.GAME_STARTED?(this.prx.addWSMsgMiddleware([GPProxy_.EVENT.TURN_STARTED],this.gameMiddleware),this.isGameMWActivated=!0):b===GPProxy_.EVENT.GALLERY_SETTINGS?(this.prx.addWSMsgMiddleware([GPProxy_.EVENT.ALBUM_ITEM,GPProxy_.EVENT.ALBUM_INFO],this.albumMiddleware),this.isAlbumMWActivated=!0,this.prx.removeWSMsgMiddleware(this.gameMiddleware),this.isGameMWActivated=!1):this.isAlbumMWActivated&&[GPProxy_.EVENT.NEW_GAME,GPProxy_.EVENT.ALBUM_SCORE,GPProxy_.EVENT.GAME_QUIT,
GPProxy_.EVENT.GAME_STARTED].includes(b)&&(this.prx.removeWSMsgMiddleware(this.albumMiddleware),this.isAlbumMWActivated=!1)});document.addEventListener("gp:act.subs_status",({detail:{status:b}})=>{this.isSubscribed=b;GPAntiCheat_.toggleSettingsVisibility(b)})}gameMiddleware([a,b]){if(!this.s.enabled||this.s.activatedForOwnerOnly&&!this.prx.isHost())return[a,b];if(a[1]===GPProxy_.EVENT.TURN_STARTED&&a[2].previous?.user?.id!==this.prx.getUser().id)if(a[2].screen===GPProxy_.SCREEN_ID.DESCRIPTION&&a[2].previous?.type===
GPProxy_.ALBUM_ITEM_TYPE.IMAGE&&a[2].previous?.data?.length){var c=this.prx.getCurrentTurnId();c=this.getTriggers(`t_${c}`,a[2].previous.data,a[2].previous.user.nick);c.size&&this.isSubscribed&&(a[2].previous.data=this.getPlaceholder(c),b=!0)}else a[2].screen===GPProxy_.SCREEN_ID.PAINTER&&(a[2].background?.length||a[2].lastDraw?.length)&&(a[2].background&&(c=this.prx.getCurrentTurnId(),this.getTriggers(`tbg_${c}`,a[2].background).size&&this.isSubscribed&&(a[2].background=[],b=!0)),a[2].lastDraw&&
a[2].previous?.type===GPProxy_.ALBUM_ITEM_TYPE.IMAGE&&(c=this.prx.getCurrentTurnId(),c=this.getTriggers(`t_${c}`,a[2].previous.data,a[2].previous.user.nick),c.size&&this.isSubscribed&&(a[2].lastDraw=[],a[2].previous.data=this.getPlaceholder(c),b=!0)));return[a,b]}albumMiddleware([a,b]){if(!this.s.enabled||this.s.activatedForOwnerOnly&&!this.prx.isHost())return[a,b];if(a[1]===GPProxy_.EVENT.ALBUM_ITEM&&a[2].user?.id!==this.prx.getUser().id&&a[2].type===GPProxy_.ALBUM_ITEM_TYPE.IMAGE&&a[2].data)if(a[2].bg){var c=
a[2].id,d=this.prx.getCurrentAlbumId(),e=this.getTriggers(`${d}`,this.prx.getAlbumBackground(d));e.size&&this.isSubscribed&&(a[2].bg=!1,a[2].data=this.getPlaceholder(e),this.dispatchEvent(new CustomEvent("trigger",{detail:{itemId:c,albumId:d}})),b=!0)}else a[2].data?.length&&(c=a[2].id,d=this.prx.getCurrentAlbumId(),e=this.getTriggers(`${d}_${c}`,a[2].data,a[2].user.nick),e.size&&(this.isSubscribed&&(a[2].data=this.getPlaceholder(e),this.dispatchEvent(new CustomEvent("trigger",{detail:{itemId:c,albumId:d}})),
b=!0),!this.s.sendReports&&this.isSubscribed||this.reportSender.send({itemId:c,albumId:d,triggers:e})));else a[1]===GPProxy_.EVENT.ALBUM_INFO&&(a[2].background?.length&&a[2].bookAuthor.id!==this.prx.getUser().id&&(c=this.prx.getCurrentAlbumId(),this.getTriggers(`${c}`,a[2].background,a[2].bookAuthor.nick).size&&this.isSubscribed&&(a[2].background=[],b=!0)),a[2].timeline?.length&&(a[2].timeline=a[2].timeline.map(f=>{if(!f.type||f.user?.id===this.prx.getUser().id||f.type!==GPProxy_.ALBUM_ITEM_TYPE.IMAGE)return f;
if(f.bg){var g=this.prx.getCurrentAlbumId();g=this.getTriggers(`${g}`,this.prx.getAlbumBackground(g));g.size&&this.isSubscribed&&(f.bg=!1,f.data=this.getPlaceholder(g),b=!0)}else f.data?.length&&(g=this.prx.getCurrentAlbumId(),g=this.getTriggers(`${g}_${f.id}`,f.data,f.user.nick),g.size&&this.isSubscribed&&(f.data=this.getPlaceholder(g),b=!0));return f})));return[a,b]}getPlaceholder(a){return this.isForgery(a)?GPAssets_.AC_FORGERY_PH[this.l.lang]??Object.values(GPAssets_.AC_FORGERY_PH)[0]:GPAssets_.AC_SUSPICIOUS_PH[this.l.lang]??
Object.values(GPAssets_.AC_SUSPICIOUS_PH)[0]}getTriggers(a,b,c){let d=this.itemsTriggers.get(a);d||(d=this.calcTriggers(b,c),this.itemsTriggers.set(a,d),d.size&&this.isSubscribed&&this.suspiciousItems.add(a));return d}calcTriggers(a,b){const c=new Set;var d=a.findLastIndex(n=>11===n[0]);a=a.slice(d+1);if(!a?.length)return c;const {animate:e}=this.prx.getGameConfig();let f=0;var g=0;let h=null,k=null,l=0,m=0;d=[];let p=[],r=0,q=0;for(let n=0;n<a.length;n++){const u=a[n],v=u[0];if(b&&this.isMStroke(u)){const {code:x,
author:w}=this.decodeMStroke(u);x!==this.prx.getGameCode()&&c.add(20);w!==this.prx.formatNickname(b)&&c.add(21)}if(1===v){1===e&&2===u[2][1]&&4===u.length&&f++;const x=u.length-3,[w,t]=u[3];w===h&&3>x?l++:(l>GPAntiCheat_.SEQUENCE_MIN_SIZE&&(r=Math.max(r,l),d.push(l)),l=0);t===k&&3>x?m++:(m>GPAntiCheat_.SEQUENCE_MIN_SIZE&&(q=Math.max(q,m),p.push(m)),m=0);h=w;k=t}else 8===v&&g++;1!==v&&(h=k=null,l=m=0)}b=f/a.length*100;g=g/a.length*100;a.length>=GPAntiCheat_.MIN_STROKES_TRIGGER&&(b>GPAntiCheat_.MIN_PERCENTAGE_TRIGGER||
g>GPAntiCheat_.MIN_PERCENTAGE_TRIGGER)&&c.add(1);(d.length>GPAntiCheat_.SEQUENCES_COUNT_TRIGGER||p.length>GPAntiCheat_.SEQUENCES_COUNT_TRIGGER)&&c.add(2);(r>GPAntiCheat_.MAX_SEQUENCE_TRIGGER||q>GPAntiCheat_.MAX_SEQUENCE_TRIGGER)&&c.add(3);return c}isForgery(a){return a.has(20)||a.has(21)}isMStroke(a){return!(1===a[0]&&a[3][0]>GPAntiCheat_.CANVAS_WIDTH&&a[3][1]>GPAntiCheat_.CANVAS_HEIGHT)||a[3][0]-GPAntiCheat_.CANVAS_WIDTH-GPAntiCheat_.M_STROKE_OFFSET||a.at(-1)[1]-GPAntiCheat_.CANVAS_HEIGHT-GPAntiCheat_.M_STROKE_OFFSET?
!1:!0}decodeMStroke(a){const [b,c,d]=a.slice(3).flat().map((e,f)=>e-GPAntiCheat_.M_STROKE_OFFSET-(f%2?GPAntiCheat_.CANVAS_HEIGHT:GPAntiCheat_.CANVAS_WIDTH)).filter(Boolean).map(e=>String.fromCodePoint(e)).join("").split("@");return{code:b,author:c,timestamp:d}}getSuspiciousItems(){return this.suspiciousItems}isSuspicious(a){return this.suspiciousItems.has(a)}}window.GPAntiCheat_=GPAntiCheat_;class GPArtBroadcaster_ extends EventTarget{static IMAGE_DENSITY=1;static IMAGE_BACKGROUND_COLOR="#ffffff";static SERVICES=["discord","telegram","vk"];static DISCORD_BUTTONS=["player","process"];static DEFAULT_SETTINGS={services:[],discordButtons:["player","process"],discordBorderColor:"#c958fe",discordBotToken:"",discordServerID:"",discordArtsChannelID:"",discordPlayerChannelID:"",discordArchiveChannelID:"",telegramBotToken:"",telegramChannel:"",telegramPlayerButton:!0,telegramSourceButton:!1,vkAccessToken:"",
vkGroupID:"",vkAlbumID:"",vkPhotoDescription:"\u0410\u0432\u0442\u043e\u0440: {author}"};static SETTINGS_UI={services:{type:"list-multiple",args:{items:this.SERVICES},description:"\u0421\u0435\u0440\u0432\u0438\u0441\u044b \u0434\u043b\u044f \u043f\u0443\u0431\u043b\u0438\u043a\u0430\u0446\u0438\u0438 \u0440\u0438\u0441\u0443\u043d\u043a\u043e\u0432"},_1:{text:"Discord"},discordButtons:{type:"list-multiple",args:{items:this.DISCORD_BUTTONS},l10n:["PLAYER_BTN","SOURCE_BTN"],description:"\u041a\u043d\u043e\u043f\u043a\u0438 \u043f\u043e\u0434 \u0440\u0438\u0441\u0443\u043d\u043a\u043e\u043c \u0432 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0438 Discord"},
discordBorderColor:{type:"color",description:"\u0426\u0432\u0435\u0442 \u043b\u0435\u0432\u043e\u0439 \u0440\u0430\u043c\u043a\u0438 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f \u0441 \u043e\u043f\u0443\u0431\u043b\u0438\u043a\u043e\u0432\u0430\u043d\u043d\u044b\u043c \u0440\u0438\u0441\u0443\u043d\u043a\u043e\u043c"},discordBotToken:{type:"input",args:{secure:!0},description:"\u0422\u043e\u043a\u0435\u043d Discord-\u0431\u043e\u0442\u0430"},discordServerID:{type:"input",description:"ID Discord-\u0441\u0435\u0440\u0432\u0435\u0440\u0430 \u0434\u043b\u044f \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0438 \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u0438 \u043e\u0431 \u0430\u0432\u0442\u043e\u0440\u0438\u0437\u0438\u0440\u043e\u0432\u0430\u043d\u043d\u044b\u0445 \u0438\u0433\u0440\u043e\u043a\u0430\u0445"},
discordArtsChannelID:{type:"input",description:"ID \u043a\u0430\u043d\u0430\u043b\u0430 \u0434\u043b\u044f \u043f\u0443\u0431\u043b\u0438\u043a\u0430\u0446\u0438\u0438 \u0440\u0438\u0441\u0443\u043d\u043a\u043e\u0432"},discordPlayerChannelID:{type:"input",description:"ID \u043a\u0430\u043d\u0430\u043b\u0430 \u0434\u043b\u044f \u043f\u0443\u0431\u043b\u0438\u043a\u0430\u0446\u0438\u0438 \u0440\u0438\u0441\u0443\u043d\u043a\u043e\u0432 \u0441 \u0441\u0441\u044b\u043b\u043a\u043e\u0439 \u043d\u0430 \u043f\u043b\u0435\u0435\u0440 \u0438 \u0438\u0441\u0445\u043e\u0434\u043d\u0438\u043a"},
discordArchiveChannelID:{type:"input",hidden:!0,description:"ID \u043a\u0430\u043d\u0430\u043b\u0430 \u0434\u043b\u044f \u0438\u0441\u0445\u043e\u0434\u043d\u0438\u043a\u043e\u0432 \u0440\u0438\u0441\u0443\u043d\u043a\u043e\u0432"},_2:{text:"Telegram"},telegramBotToken:{type:"input",args:{secure:!0},description:"\u0422\u043e\u043a\u0435\u043d Telegram-\u0431\u043e\u0442\u0430"},telegramChannel:{type:"input",description:"\u041d\u0430\u0437\u0432\u0430\u043d\u0438\u0435 \u0438\u043b\u0438 ID \u043a\u0430\u043d\u0430\u043b\u0430 (\u0432 \u0444\u043e\u0440\u043c\u0430\u0442\u0435 @channel_name)"},
telegramPlayerButton:{type:"switch",description:"\u0414\u043e\u0431\u0430\u0432\u043b\u044f\u0442\u044c \u043a\u043d\u043e\u043f\u043a\u0443 \u0434\u043b\u044f \u043f\u0440\u043e\u0441\u043c\u043e\u0442\u0440\u0430 \u043f\u0440\u043e\u0446\u0435\u0441\u0441\u0430 \u0440\u0438\u0441\u043e\u0432\u0430\u043d\u0438\u044f \u0432 \u043f\u043b\u0435\u0435\u0440\u0435"},telegramSourceButton:{type:"switch",description:"\u0414\u043e\u0431\u0430\u0432\u043b\u044f\u0442\u044c \u043a\u043d\u043e\u043f\u043a\u0443 \u0434\u043b\u044f \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u044f \u0438\u0441\u0445\u043e\u0434\u043d\u0438\u043a\u0430 \u0440\u0438\u0441\u0443\u043d\u043a\u0430"},
_3:{text:"VK (\u0412 \u041a\u043e\u043d\u0442\u0430\u043a\u0442\u0435)"},vkAccessToken:{type:"input",args:{secure:!0},description:"VK \u0442\u043e\u043a\u0435\u043d"},vkGroupID:{type:"input",description:"ID \u0433\u0440\u0443\u043f\u043f\u044b \u0438\u043b\u0438 \u0441\u043e\u043e\u0431\u0449\u0435\u0441\u0442\u0432\u0430 \u0441 \u0430\u043b\u044c\u0431\u043e\u043c\u043e\u043c \u0434\u043b\u044f \u043f\u0443\u0431\u043b\u0438\u043a\u0430\u0446\u0438\u0438 \u0440\u0438\u0441\u0443\u043d\u043a\u043e\u0432"},
vkAlbumID:{type:"input",description:"ID \u0430\u043b\u044c\u0431\u043e\u043c\u0430 \u0434\u043b\u044f \u043f\u0443\u0431\u043b\u0438\u043a\u0430\u0446\u0438\u0438 \u0440\u0438\u0441\u0443\u043d\u043a\u043e\u0432"},vkPhotoDescription:{type:"input",description:"\u0428\u0430\u0431\u043b\u043e\u043d \u043e\u043f\u0438\u0441\u0430\u043d\u0438\u044f \u0440\u0438\u0441\u0443\u043d\u043a\u0430 \u0432 \u0430\u043b\u044c\u0431\u043e\u043c\u0435 VK. \u041f\u043e\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u043c\u044b\u0435 \u043f\u0435\u0440\u0435\u043c\u0435\u043d\u043d\u044b\u0435: {author}, {date}"}};static MODULE={title:"Art Broadcaster",
alias:"ab",dependencies:["GPUtils_","GPPacketParser_"],settings:{storage:"gp_art-broadcaster",defaultSettings:this.DEFAULT_SETTINGS,ui:this.SETTINGS_UI},useCSS:!0};constructor(a){super();this.prx=a.prx;this.s=a.sm.setSettings(this);this.observerConfig={childList:!0,subtree:!0};this.observer=new MutationObserver(this.observerCallback.bind(this));this.monitorTimer;this.state={};this.itemsElems=[];this.buttons={};this.timeline={};this.nextItemID=null;this.gpContent=document.querySelector("#content");
GPUtils_.bindMethods([this.sendResultHandler,this.emitSettings],this);this.addEventListener("settings_updated",this.emitSettings);this.addEventListener("settings_updated",this.toggleSendButtons);this.prx.addEventListener("data",({detail:{event:b}})=>{b===GPProxy_.EVENT.GALLERY_SETTINGS?this.startMonitor():b===GPProxy_.EVENT.TURNS_ENDED?this.init():[GPProxy_.EVENT.NEW_GAME,GPProxy_.EVENT.ALBUM_SCORE,GPProxy_.EVENT.GAME_QUIT,GPProxy_.EVENT.GAME_STARTED].includes(b)?this.terminate():b===GPProxy_.EVENT.ALBUM_INFO&&
(this.itemsElems=[],this.buttons={},this.nextItemID=null)});this.prx.addEventListener("album_item",({detail:{itemId:b,albumId:c,item:d}})=>{this.timeline[c]||(this.timeline[c]={});this.timeline[c][b]=d;(c=this.itemsElems[b])&&this.renderButton(c,d,b)});this.prx.addEventListener("rejoin",({detail:{stage:b}})=>{b===GPProxy_.STAGE.ALBUM&&(this.startMonitor(),this.init())});this.prx.addEventListener("album_item_loading",({detail:{id:b}})=>{this.nextItemID=b});this.emitSettings();this.toggleSendButtons()}init(){document.addEventListener("gp:ab.send_image_complete",
this.sendResultHandler);document.dispatchEvent(new CustomEvent("gp:ab.update_urls_avatars_cache",{detail:{users:this.prx.getUsers().map(a=>a.nick),authType:this.prx.authType}}))}terminate(){this.stopMonitor();this.itemsElems=[];this.timeline={};this.buttons={};this.state={};this.nextItemID=null;document.removeEventListener("gp:ab.send_image_complete",this.sendResultHandler)}renderButton(a,b,c){if(b.type===GPProxy_.ALBUM_ITEM_TYPE.IMAGE){a.style.position="relative";var d=document.createElement("div");
d.className="send-drawing-btn_";d.classList.add("hidden");d.addEventListener("click",f=>{d.classList.remove("hidden");f.ctrlKey?(GPArtBroadcaster_.SERVICES.forEach(g=>{delete d.dataset[g]}),this.sendImage(this.s.services,b,c,d)):(f=this.s.services.filter(g=>{if(d.dataset[g]&&"false"!==d.dataset[g])return!1;delete d.dataset[g];return!0}),f.length&&this.sendImage(f,b,c,d))});this.setInitialButtonState(d,c);var e=document.createElement("div");e.className="media_";GPArtBroadcaster_.SERVICES.forEach(f=>
{const g=document.createElement("div");g.className=`${f}_ icon_`;e.appendChild(g)});d.appendChild(e);a.appendChild(d);this.buttons[c]=d}}startMonitor(){if(!this.inProgress){var a=document.querySelector(".scrapbook");a?(this.observer.observe(a,this.observerConfig),this.inProgress=!0):this.monitorTimer=setTimeout(()=>{this.startMonitor()},200)}}stopMonitor(){clearTimeout(this.monitorTimer);this.inProgress&&(this.observer.disconnect(),this.inProgress=!1)}observerCallback(a,b){for(const d of a)if("childList"===
d.type&&d.addedNodes.length&&(a=d.addedNodes[0],d.target.classList.contains("scrollElements")&&a.classList.contains("item"))){var c=this.prx.getCurrentAlbumId();b=this.nextItemID;null===b&&(b=[...a.parentElement.children].filter(e=>e.classList.contains("item")).indexOf(a),(c=this.timeline[c]?.[b])&&this.renderButton(a,c,b));this.itemsElems[b]=a}}sendImage(a,b,c,d){const {data:e,background:f,canvasTypeId:g,meta:h}=b,[k,l]=GPUtils_.getCanvasDimensionsById(g);var m=GPArtBroadcaster_.IMAGE_DENSITY;const p=
k*m,r=l*m,q=document.createElement("canvas");q.width=p;q.height=r;var n=q.getContext("2d");n.fillStyle=GPArtBroadcaster_.IMAGE_BACKGROUND_COLOR;n.fillRect(0,0,p,r);f&&this.drawFunction(n,f,m,!1);n=document.createElement("canvas");n.width=p;n.height=r;var u=n.getContext("2d");this.drawFunction(u,e,m,!0);m=document.createElement("canvas");m.width=p;m.height=r;u=m.getContext("2d");u.drawImage(q,0,0,p,r);u.drawImage(n,0,0,p,r);m.toBlob(async v=>{d.classList.remove("complete_");d.classList.add("uploading_");
var x=(new Date(h.date)).toLocaleDateString("ru-RU");x=`${h.author} - ${h.title} (${x})`;v=new File([v],`${x}.png`);const w=await GPUtils_.compressImageData(b);x=new File([w],`${x}.gpimg`);document.dispatchEvent(new CustomEvent("gp:ab.send_to_media",{detail:{services:a,artFile:v,sourceFile:x,meta:h,buttons:this.s.discordButtons,canvasType:GPUtils_.getCanvasTypeById(g),authType:this.prx.authType,albumId:this.prx.getCurrentAlbumId(),itemId:c}}))})}sendResultHandler({detail:{service:a,success:b,albumId:c,
itemId:d}}){this.setState(a,b,c,d);if(c===this.prx.getCurrentAlbumId()){const e=this.buttons[d];e.dataset[a]=b;let f=!0,g=!0;this.s.services.forEach(h=>{e.dataset[h]?"true"!==e.dataset[h]&&(f=!1):g=f=!1});g&&(e.classList.remove("uploading_"),f&&e.classList.add("complete_"))}}setState(a,b,c,d){let e,f;((f=(e=this.state)[c]??(e[c]={}))[d]??(f[d]={}))[a]=b}setInitialButtonState(a,b){const c=this.prx.getCurrentAlbumId();b=this.state[c]?.[b];for(const d in b)a.dataset[d]=b[d];this.s.services.length&&this.s.services.every(d=>
"true"===a.dataset[d])?a.classList.add("complete_"):a.classList.remove("hidden")}emitSettings(){document.dispatchEvent(new CustomEvent("gp:ab.update_settings",{detail:{settings:window.structuredClone(this.settings)}}))}toggleSendButtons(a){(a=(a?.detail?.settings||this.settings).services)&&this.gpContent.classList.toggle("gp-sm-hidden_",!a.length)}drawFunction(a,b,c=this.density,d=!1,e=!1){GPUtils_.drawFunction(a,b,c,d,e)}}window.GPArtBroadcaster_=GPArtBroadcaster_;class GPAssets_{}
GPAssets_.GIRL_PORTRAIT=[[1,1,["#FFFFFF",869,1],[379,212]],[1,2,["#000000",2,1],[152,185],[151,188],[149,196],[148,208],[148,224],[150,232],[153,239],[156,245],[159,250],[162,253]],[1,3,["#000000",2,1],[190,264],[190,265],[191,265],[193,265],[196,265],[201,265],[205,264],[208,263]],[1,4,["#000000",2,1],[248,228],[248,227],[248,226],[248,227],[246,229],[244,233],[241,240],[239,245],[236,249],[232,254],[229,257],[226,258],[223,260],[219,262],[215,263],[211,264],[209,264]],[1,5,["#000000",2,1],[187,
244],[188,244],[190,244],[192,244],[196,244],[198,244],[200,246],[201,247],[202,247]],[1,6,["#000000",2,1],[216,207],[217,208]],[1,7,["#000000",2,1],[214,210],[214,209],[215,208],[216,207],[219,205],[223,203],[229,202],[234,202],[238,203],[241,204],[243,205],[245,206],[246,207],[246,208],[246,209]],[1,8,["#000000",2,1],[246,209],[247,211],[248,213],[248,214]],[1,9,["#000000",2,1],[214,210],[215,210],[215,209],[217,209],[219,208],[223,206],[231,205],[235,206],[237,208],[240,210],[240,211]],[1,10,["#000000",
2,1],[241,211],[242,212],[243,213],[244,215],[244,216],[244,218]],[1,11,["#000000",2,1],[243,219],[244,218],[244,217],[245,216],[246,215],[248,214],[249,214]],[1,12,["#000000",2,1],[219,208],[218,208],[219,207],[220,207],[221,206],[225,205],[232,204],[236,204],[240,205],[241,206],[242,206]],[1,13,["#000000",2,1],[229,204],[230,204],[230,203],[232,203],[235,203],[238,204],[241,205],[243,207],[244,210],[245,210],[245,211],[245,210],[244,210],[244,209],[243,209],[242,208],[240,208],[239,206],[239,205],
[238,205],[237,205],[236,205],[237,206],[238,207],[239,208],[240,208],[242,209],[244,211],[245,212],[246,213],[245,213],[244,213],[243,211],[241,210],[240,207],[239,206],[239,205],[239,206],[239,207],[240,209],[243,212],[244,214],[245,214],[245,213],[244,213],[244,210],[244,209],[244,208],[245,208],[245,209],[245,210],[245,211]],[1,14,["#000000",2,1],[149,204],[150,205],[151,207],[152,208],[153,209],[155,211],[157,213]],[1,15,["#000000",2,1],[154,210],[153,210],[153,208],[154,206],[155,204],[158,
201],[163,198],[167,197],[171,197],[173,197]],[1,16,["#000000",2,1],[150,205],[150,204],[150,203],[152,201],[154,199],[157,197],[163,195],[168,195],[172,196],[176,197],[179,198],[180,199],[180,200],[181,201],[182,201]],[1,17,["#000000",2,1],[177,198],[178,198],[179,198],[180,198],[180,199],[181,200],[182,202],[183,203],[184,204]],[1,18,["#000000",2,1],[151,206],[151,205],[152,204],[154,202],[156,200],[160,198],[163,197],[164,197],[166,197],[166,198],[165,198],[164,198],[163,198],[162,199],[161,199],
[160,199],[158,200],[157,201],[156,202],[155,203],[154,204],[153,205],[153,206]],[1,19,["#000000",2,1],[234,206],[234,207],[235,208],[236,211],[236,219],[234,224],[232,228],[229,230],[226,231],[225,230],[225,229]],[1,20,["#000000",2,1],[219,211],[218,215],[218,220],[218,224],[220,227],[224,230],[227,230]],[1,21,["#000000",2,1],[169,197],[168,197],[167,197],[166,198],[164,200],[163,203],[162,206],[162,210],[162,215],[164,218],[165,221],[168,222]],[1,22,["#000000",2,1],[168,223],[169,223],[170,224],
[171,224],[172,224],[174,224],[176,222],[179,217],[181,213],[181,208],[182,204],[182,203]],[1,23,["#000000",2,1],[178,200],[179,200],[180,201],[180,203],[181,205],[181,208]],[1,24,["#000000",2,1],[166,218],[166,217],[167,216],[168,215],[169,214],[171,213],[173,213],[175,213],[176,216],[177,218],[177,219]],[1,25,["#000000",2,1],[172,216],[171,216],[171,215],[171,214],[171,213],[171,212],[172,211],[173,211],[174,211],[174,212],[174,213],[174,214],[173,216],[172,216],[172,215],[172,213],[172,212]],[1,
26,["#000000",2,1],[220,224],[220,223],[220,222],[222,220],[223,219],[226,218],[228,218],[231,219],[232,221],[233,223],[233,224],[233,225],[234,225]],[1,27,["#000000",2,1],[226,220],[226,219],[226,218],[226,217],[226,218],[227,218],[227,219],[227,221],[226,221],[226,220],[226,219],[226,217],[226,216],[227,215],[228,216],[228,218],[228,219],[227,220],[226,219],[226,218],[227,218],[227,217],[228,218],[228,219],[227,220],[226,221],[226,220],[226,219],[226,217],[228,217],[228,218],[228,219],[228,221],
[227,222],[227,221]],[1,28,["#000000",2,1],[220,207],[220,208],[219,208],[219,209],[219,211],[218,214],[218,215]],[8,29,["#000000",1],220,209,14,5,0,234,210,1,4,0,220,213,1,8,0,220,214,6,1,0,228,214,7,1,0,221,209,13,1,0,222,208,12,1,0,223,208,11,1,0,224,207,9,1,0,227,207,6,1,0,220,215,1,5,0,219,217,1,5,0,229,215,7,1,0,229,215,6,1,0,229,216,6,2,0,221,215,5,1,0,230,217,5,1,0,221,215,1,4,0,220,220,1,1,0,231,218,4,1,0,222,215,4,2,0,222,217,1,2,0,235,213,1,2,0,222,217,2,1,0,232,218,3,1,0,232,219,3,1,0,
233,219,2,1,0,233,220,1,1,0,222,218,1,1,0,234,221,1,1,0],[8,30,["#000000",1],164,205,16,5,0,180,206,1,4,0,163,208,1,6,0,164,210,8,1,0,175,210,5,1,0,164,204,16,1,0,164,204,15,1,0,165,202,15,2,0,165,201,14,1,0,165,201,12,1,0,166,200,12,1,0,166,200,11,1,0,167,199,11,1,0,167,199,9,1,0,169,198,7,1,0,164,211,7,1,0,164,211,7,2,0,164,213,6,1,0,164,213,5,1,0,175,211,5,1,0,176,212,4,1,0,164,214,4,1,0,164,214,4,1,0,176,213,4,1,0,177,213,3,1,0,164,215,3,1,0,164,215,2,1,0,177,214,3,1,0,177,214,2,1,0,177,215,2,
1,0,164,216,2,1,0,165,216,1,1,0,178,216,1,1,0],[8,31,["#ffe194",1],221,225,12,1,0,221,226,11,1,0,221,224,11,2,0,221,223,11,1,0,221,226,11,1,0,222,227,10,1,0,228,223,4,1,0,221,223,5,1,0,223,227,8,1,0,223,228,7,1,0,226,228,3,1,0,222,222,5,1,0,222,222,3,1,0,229,222,3,1,0,223,221,3,1,0,226,229,2,1,0,223,221,2,1,0,229,222,2,1,0,229,221,2,1,0,224,220,2,1,0,229,220,1,1,0],[8,32,["#ffe194",1],167,218,9,3,0,176,219,1,2,0,166,219,1,1,0,169,221,7,1,0,168,217,8,1,0,174,217,2,1,0,168,217,2,1,0,169,221,6,1,0,169,
222,6,1,0,170,222,4,1,0,171,223,3,1,0,169,216,2,1,0,169,216,1,1,0,174,216,1,1,0,170,215,1,1,0],[1,33,["#ffffff",2,1],[223,210],[223,211],[223,212],[222,212],[221,212],[221,211],[221,210],[222,211],[223,211],[223,212],[223,211],[223,210],[224,210],[224,211],[224,212],[223,212],[222,212],[222,211],[222,210],[223,210],[223,211],[223,212],[222,212]],[1,34,["#ffffff",2,1],[167,204],[166,205],[165,206],[164,205],[165,205],[165,204],[166,204],[166,205],[165,206],[164,207],[163,206],[163,205],[164,204],[165,
204],[166,203],[166,204],[166,205],[165,206],[164,206],[164,205],[165,204],[166,204]],[1,35,["#000000",2,1],[174,123],[173,124],[173,125],[171,128],[168,134],[164,143],[159,154],[154,171],[153,180],[153,188],[155,193]],[1,36,["#000000",2,1],[157,193],[157,192],[157,191],[158,190],[159,189],[160,189],[161,189],[162,189],[163,190],[163,191]],[1,37,["#000000",2,1],[171,148],[170,150],[169,154],[167,161],[165,170],[163,183],[163,189]],[1,38,["#000000",2,1],[172,148],[172,147],[172,146],[171,148],[170,
153],[168,160],[166,174],[166,182],[166,187],[166,189],[167,190]],[1,39,["#000000",2,1],[168,191],[168,190],[169,190],[170,189],[171,189],[172,189]],[1,40,["#000000",2,1],[186,130],[186,131],[184,133],[182,138],[180,145],[176,154],[174,165],[172,180],[172,186],[172,190]],[1,41,["#000000",2,1],[181,145],[181,146],[179,151],[178,157],[177,165],[176,178],[176,185],[176,189],[176,191]],[1,42,["#000000",2,1],[177,192],[178,191],[180,190],[182,189],[184,189],[186,189],[187,191],[187,193]],[1,43,["#000000",
2,1],[199,130],[198,134],[196,141],[193,151],[190,163],[187,181],[187,188],[187,192]],[1,44,["#000000",2,1],[199,134],[199,136],[197,140],[196,147],[193,161],[192,172],[192,181],[192,187],[192,191]],[1,45,["#000000",2,1],[193,192],[194,192],[195,191],[196,191]],[1,46,["#000000",2,1],[200,154],[200,153],[200,152],[200,153],[199,155],[198,159],[197,165],[196,177],[196,185],[196,190],[197,191]],[1,47,["#000000",2,1],[201,152],[201,153],[201,156],[200,165],[199,173],[199,180],[200,188],[201,190],[202,
191]],[1,48,["#000000",2,1],[203,192],[204,191],[205,190],[207,190],[208,190],[210,192],[211,193]],[1,49,["#000000",2,1],[217,129],[217,133],[217,145],[216,157],[215,170],[213,181],[212,188],[211,192],[210,192]],[1,50,["#000000",2,1],[217,161],[217,160],[218,161],[218,163],[218,169],[218,176],[217,183],[216,188],[215,191]],[1,51,["#000000",2,1],[215,190],[216,190],[216,191],[217,191],[217,192],[219,192],[220,193],[221,195],[222,195],[223,194],[224,193],[224,192],[225,192],[226,191],[227,191],[228,
191]],[1,52,["#000000",2,1],[229,122],[230,123],[230,125],[232,131],[234,140],[235,151],[235,163],[234,173],[232,180],[230,186],[229,188],[229,190]],[1,53,["#000000",2,1],[236,161],[237,164],[237,168],[236,175],[235,182],[234,190],[232,193],[232,194]],[1,54,["#000000",2,1],[231,197],[232,196],[233,196],[234,196],[234,195],[235,195]],[1,55,["#000000",2,1],[243,142],[244,145],[244,149],[244,157],[243,167],[240,182],[238,189],[236,195],[235,197],[235,198]],[1,56,["#000000",2,1],[244,154],[244,153],[244,
154],[245,155],[245,158],[245,164],[244,170],[243,178],[241,187],[240,191],[239,194],[239,195],[239,197],[240,196]],[1,57,["#000000",2,1],[239,196],[240,196],[241,196],[243,197],[244,199],[244,200],[244,201],[245,201]],[1,58,["#000000",2,1],[238,118],[240,120],[243,128],[246,138],[249,152],[250,169],[251,198],[250,216],[249,233],[248,246],[246,258],[245,262],[244,265],[244,266]],[1,59,["#000000",2,1],[247,202],[248,201],[248,198],[250,195],[251,192],[252,192]],[1,60,["#000000",2,1],[245,260],[245,
261],[245,262],[245,263],[243,269],[241,276],[238,282],[236,288],[235,289]],[1,61,["#000000",2,1],[244,277],[243,278],[241,282],[239,286],[237,290],[236,291],[236,292]],[1,62,["#000000",2,1],[244,276],[243,279],[243,282],[241,287],[240,289],[240,290]],[1,63,["#000000",2,1],[241,288],[241,289],[242,288],[244,288],[246,288],[249,288],[251,287]],[1,64,["#000000",2,1],[267,194],[267,193],[267,195],[267,200],[267,209],[266,222],[263,237],[259,260],[256,272],[254,281],[252,286],[251,288]],[1,65,["#000000",
2,1],[254,287],[254,290],[254,298],[255,305],[255,311],[256,314]],[1,66,["#000000",2,1],[171,100],[170,100],[169,101],[168,101],[166,102],[163,104],[160,106],[155,110],[149,115],[140,126],[133,134],[126,145],[121,155],[117,167],[114,181],[112,203],[110,220],[108,235],[107,254],[107,263],[107,267]],[1,67,["#000000",2,1],[166,103],[167,103],[168,102],[171,100],[180,96],[190,95],[203,96],[217,99],[235,104],[243,107]],[1,68,["#000000",2,1],[243,107],[246,107],[250,109],[255,113],[262,119],[273,133],[278,
143],[281,152],[283,159],[284,162]],[1,69,["#000000",2,1],[284,168]],[1,70,["#000000",2,1],[282,159],[283,159],[284,161],[285,164],[286,169],[287,184],[288,201],[288,221],[288,240],[289,266],[290,280],[292,292],[294,302],[296,308],[298,311]],[1,71,["#000000",2,1],[172,251],[172,252],[172,251],[172,250],[172,249],[172,247],[172,244],[172,242],[171,241],[171,240],[170,240],[170,239],[169,239],[169,240],[168,241],[168,242],[167,244],[167,246],[166,248],[166,249],[165,250],[165,251],[164,251],[164,252],
[163,252],[163,253],[164,253]],[1,72,["#000000",2,1],[163,253],[162,253],[162,254],[162,255],[161,256],[161,260],[161,262],[161,265],[161,266]],[1,73,["#000000",2,1],[172,254],[172,253],[173,253],[174,253],[179,253],[185,253],[192,253],[199,253],[202,253],[203,254]],[1,74,["#000000",2,1],[203,254],[204,254],[205,254],[206,254],[207,255],[207,256],[207,257],[204,259],[201,260],[197,260],[195,260],[192,260],[191,260]],[1,75,["#000000",2,1],[189,261],[189,262],[189,263],[189,264],[189,265],[189,266],
[188,266],[187,266],[186,266],[186,267],[187,267],[187,268],[187,269],[186,269],[186,270],[186,271],[186,272],[185,272],[184,272],[183,272],[182,272],[181,272],[181,273],[181,274],[180,275],[180,276],[180,277]],[1,76,["#000000",2,1],[150,276],[150,277],[150,278],[149,278],[149,276],[151,272],[154,269],[157,266],[161,264],[168,265],[173,268],[176,271],[179,274],[181,276],[182,278],[184,279]],[1,77,["#000000",2,1],[183,277],[185,281],[187,285],[189,290],[191,298],[192,306],[193,316],[193,320],[194,
323]],[1,78,["#000000",2,1],[188,269],[190,270],[192,271],[195,271],[198,271],[204,269],[207,267],[209,266]],[1,79,["#000000",2,1],[211,265],[211,266],[211,267],[211,269],[212,269],[213,270]],[1,80,["#000000",2,1],[212,268],[212,269],[211,269],[209,269],[207,270],[204,272],[202,273],[200,274],[199,275],[199,274],[200,274],[201,273]],[1,81,["#000000",2,1],[201,275],[202,275],[204,275],[205,276],[206,278],[207,282],[206,285],[204,287],[203,288],[203,289]],[1,82,["#000000",2,1],[203,287],[204,288],[205,
289],[206,291],[207,293],[208,294],[208,295]],[1,83,["#000000",2,1],[208,292],[208,293],[208,294],[208,296],[208,297]],[1,84,["#000000",2,1],[203,297],[204,297],[205,297],[207,297]],[1,85,["#000000",2,1],[200,289],[200,291],[201,293],[203,295],[203,296],[204,297]],[1,86,["#000000",2,1],[198,289],[198,290],[198,294],[199,296]],[1,87,["#000000",2,1],[199,295],[200,296],[201,297],[201,298],[201,299]],[1,88,["#000000",2,1],[199,298],[200,298],[200,299],[199,299],[198,300],[197,301],[196,302]],[1,89,["#000000",
2,1],[192,298],[193,298],[194,299],[195,299],[197,299],[198,299]],[1,90,["#000000",2,1],[192,294],[192,295],[191,297],[191,298],[191,299]],[1,91,["#000000",2,1],[193,290],[193,291],[193,293],[193,294],[194,294]],[1,92,["#000000",2,1],[186,280],[186,279],[186,278],[186,277],[186,276],[188,275],[189,274],[190,274]],[1,93,["#000000",2,1],[188,273],[188,274],[189,275],[190,275],[193,275],[196,275],[200,273],[201,273]],[1,94,["#000000",2,1],[198,277],[198,278],[199,278],[200,278],[201,278],[203,279],[203,
281],[203,282],[203,283],[203,284],[202,284]],[1,95,["#000000",2,1],[199,277],[199,278],[199,279],[198,280],[198,281],[198,282],[199,281],[200,281],[200,282],[201,283],[201,284]],[1,96,["#000000",2,1],[199,282],[198,284],[198,285],[197,285]],[1,97,["#000000",2,1],[193,283],[193,284],[194,284],[195,285],[196,285],[196,286],[197,286],[197,287]],[1,98,["#000000",2,1],[192,283],[192,282],[192,281],[193,281],[193,280],[194,280],[195,280]],[1,99,["#000000",2,1],[192,283],[193,279],[193,280],[193,282]],
[1,100,["#000000",2,1],[193,277],[192,278],[191,279],[190,280],[190,281],[190,282],[190,283],[190,284],[191,285],[193,286]],[1,101,["#000000",2,1],[209,285],[210,285],[210,284],[212,283],[215,282],[219,282],[221,282],[223,284],[224,284]],[1,102,["#000000",2,1],[212,270],[213,270],[213,271],[214,272],[215,273],[217,275],[221,276],[227,278],[231,278],[234,279],[236,279],[238,279],[239,280],[241,281],[241,282]],[1,103,["#000000",2,1],[237,297],[237,298],[236,298],[236,299],[236,300],[236,303],[236,304],
[236,305]],[1,104,["#000000",2,1],[195,307],[195,308],[195,309],[195,310],[194,313],[194,316],[195,319],[195,321],[197,324]],[1,105,["#000000",2,1],[191,306],[191,305],[192,305],[193,305],[194,305],[195,305],[196,305],[197,305],[197,306],[196,306],[196,307],[195,308],[196,308],[196,307],[197,306],[200,305],[203,305],[206,304],[209,304],[213,303]],[1,106,["#000000",2,1],[211,304],[212,304],[213,304],[214,303],[215,303],[216,303],[216,304],[216,305],[215,306],[214,307],[213,308],[214,308],[215,308],
[216,307],[219,306],[221,306],[224,305],[229,304],[231,303]],[1,107,["#000000",2,1],[215,308],[215,309],[214,309],[213,312],[212,315],[210,318],[209,321],[209,322],[210,322]],[1,108,["#000000",2,1],[195,326],[197,326],[198,326],[201,326],[204,325],[207,323],[209,321]],[1,109,["#000000",2,1],[211,321],[212,323],[214,323],[216,323],[218,322]],[1,110,["#000000",2,1],[232,302],[232,303],[232,302],[233,302],[233,303],[232,303],[231,304],[229,305],[225,310],[222,314],[219,319],[218,322],[218,324]],[1,111,
["#000000",2,1],[235,307],[232,309],[230,311],[228,314],[225,319],[221,325],[220,327],[220,328]],[1,112,["#000000",2,1],[235,309],[236,309],[237,309],[239,308],[240,307],[242,307],[243,307],[243,306],[244,306],[244,307],[245,307],[245,308],[245,309],[246,309],[246,308],[247,308],[248,308],[249,307],[250,306],[253,305]],[1,113,["#000000",2,1],[245,309],[245,310],[244,311],[243,313],[242,314],[242,316],[243,316]],[1,114,["#000000",2,1],[255,314],[254,316],[253,319],[251,324],[251,326]],[1,115,["#000000",
2,1],[256,313],[257,313],[258,313],[260,312],[263,311],[264,311],[265,311],[265,312],[264,314],[263,315],[262,317],[261,319],[259,321],[258,324],[257,325]],[1,116,["#000000",2,1],[232,302],[232,303],[231,303],[232,302],[233,302],[235,302],[237,302],[238,303],[238,304],[238,305],[238,306],[238,307]],[1,117,["#000000",2,1],[194,322],[193,322],[193,323],[193,324],[193,325],[193,328],[193,330],[194,331]],[1,118,["#000000",2,1],[194,328],[195,328],[196,328],[197,328],[199,328],[203,328],[209,329],[213,
329],[217,329]],[1,119,["#000000",2,1],[241,318],[241,317],[242,316],[243,316],[243,315],[245,315],[246,315],[248,315],[248,316],[249,316],[249,317],[249,318],[249,319],[249,320],[249,321],[250,321],[250,320]],[1,120,["#000000",2,1],[243,322],[242,322],[243,322],[244,322],[245,322],[246,322],[247,322],[249,322],[250,322]],[1,121,["#000000",2,1],[233,311],[233,312],[233,314],[233,315],[234,316],[235,316]],[1,122,["#000000",2,1],[227,314],[228,314],[230,315],[233,315],[234,316]],[1,123,["#000000",2,
1],[226,320],[226,321],[226,322],[227,323],[228,323],[229,324],[230,324],[232,324],[234,323],[235,323],[237,322],[238,322]],[1,124,["#000000",2,1],[234,322],[234,323],[233,323],[232,323],[231,324],[229,325],[228,325],[228,326],[227,327],[228,328],[229,329],[230,329],[231,330],[232,330]],[1,125,["#000000",2,1],[236,328],[235,329],[234,330]],[1,126,["#000000",2,1],[244,324],[245,326],[245,327],[247,327],[248,328],[248,329]],[1,127,["#000000",2,1],[237,318],[236,318],[235,319],[235,320],[235,322],[236,
323],[237,324],[239,324],[240,324],[242,323],[242,321],[242,320],[242,319],[241,318],[240,317],[239,318],[238,318],[237,318]],[1,128,["#000000",2,1],[236,328],[237,328],[238,327],[239,327],[240,328],[241,329],[241,330],[242,330]],[1,129,["#000000",2,1],[242,330],[243,330],[246,328],[247,328]],[1,130,["#000000",2,1],[107,264],[107,265],[107,268],[107,280],[107,291],[107,303],[108,313],[108,319],[109,322]],[4,131,["#000000",1,1],[98,95],[300,331]],[1,132,["#000000",2,1],[253,326],[253,325],[255,324],
[256,324],[257,324]],[1,133,["#000000",2,1],[220,323],[221,323],[222,323]],[1,134,["#000000",2,1],[219,329],[219,328],[220,328],[220,327],[221,327]],[8,135,["#ff8a8a",1],195,314,16,1,0,195,315,16,1,0,196,312,16,3,0,211,305,1,9,0,196,309,15,3,0,196,315,15,1,0,196,316,15,1,0,197,309,15,1,0,197,308,14,1,0,196,317,14,1,0,196,317,14,1,0,198,307,14,1,0,199,307,13,1,0,196,318,13,1,0,196,318,13,2,0,196,320,12,1,0,201,306,10,1,0,197,320,12,1,0,197,321,11,1,0,197,321,11,1,0,197,322,10,1,0,205,306,7,1,0,198,
322,9,1,0,198,323,8,1,0,212,305,1,7,0,198,323,7,1,0,212,309,1,2,0,212,305,1,2,0,198,324,6,1,0,207,305,4,1,0,198,324,5,1,0,198,325,2,1,0,213,305,1,2,0,213,305,1,1,0,214,305,1,1,0],[8,136,["#ff8a8a",1],193,307,1,1,0],[8,137,["#ff8a8a",1],214,314,8,1,0,214,314,7,1,0,214,312,7,2,0,221,307,1,6,0,215,311,7,2,0,214,315,7,1,0,213,315,1,7,0,214,316,6,1,0,214,317,4,5,0,213,316,1,6,0,215,310,6,1,0,216,310,6,1,0,217,317,2,1,0,222,307,1,6,0,217,308,5,2,0,222,307,1,5,0,216,309,1,1,0,212,317,1,5,0,217,317,1,4,0,
214,322,2,1,0,212,318,1,3,0,223,307,1,5,0,223,307,1,4,0,224,307,1,3,0,218,317,1,2,0,224,306,1,3,0,225,306,1,3,0,225,306,1,2,0,211,319,1,2,0,226,306,1,1,0,218,317,1,1,0,211,320,1,1,0,218,308,4,1,0,220,307,2,1,0,226,306,1,1,0],[8,138,["#ff8a8a",1],245,312,10,2,0,254,313,1,1,0,244,313,1,1,0,249,314,5,1,0,245,312,9,1,0,246,311,9,1,0,246,310,8,1,0,247,310,8,1,0,247,309,7,1,0,249,309,5,1,0,250,308,5,1,0,249,315,5,1,0,250,315,4,1,0,250,308,4,1,0,251,307,4,1,0,252,307,3,1,0,250,316,3,1,0,250,316,3,2,0,250,
318,2,2,0,253,306,1,1,0,251,319,1,1,0],[8,139,["#ff8a8a",1],255,318,6,1,0,255,318,6,1,0,255,316,6,2,0,261,313,1,4,0,256,315,5,1,0,255,319,5,1,0,255,319,5,1,0,257,314,4,1,0,254,319,1,4,0,255,320,4,1,0,255,321,4,1,0,255,322,3,1,0,254,321,1,3,0,261,313,1,3,0,259,314,2,1,0,262,313,1,3,0,253,322,1,2,0,262,313,1,2,0,253,323,1,1,0,263,313,1,1,0,260,313,1,1,0,263,312,1,1,0,255,323,3,1,0],[8,140,["#fbdc89",1],234,310,9,1,0,234,311,9,1,0,238,310,5,1,0,234,312,8,1,0,234,313,8,1,0,234,314,7,1,0,235,315,7,1,0,
236,315,5,1,0,236,316,5,1,0,243,308,1,2,0,239,309,4,1,0,236,316,3,1,0,240,309,3,1,0,241,308,3,1,0,236,317,3,1,0,244,308,1,2,0],[8,141,["#fbdc89",1],243,317,5,4,0,243,317,1,1,0,244,317,4,1,0,244,316,3,1,0],[8,142,["#fbdc89",1],236,320,5,2,0,239,321,2,1,0,237,319,4,1,0,239,322,2,1,0,239,323,1,1,0],[8,143,["#fbdc89",1],227,318,8,1,0,227,318,7,3,0,228,317,7,1,0,235,317,1,1,0,228,317,6,1,0,227,319,1,1,0,227,321,6,1,0,228,322,6,1,0,229,322,2,1,0,228,316,5,1,0,229,316,1,1,0,230,323,1,1,0],[8,144,["#fbdc89",
1],229,326,8,1,0,229,327,8,1,0,230,326,7,1,0,229,327,6,1,0,237,325,7,1,0,231,325,6,1,0,233,325,4,1,0,230,328,5,1,0,231,328,3,1,0,235,324,1,1,0,232,329,2,1,0,240,326,4,1,0,241,325,2,1,0,241,327,4,1,0,241,327,3,1,0,242,328,3,1,0,242,328,2,1,0,242,324,1,1,0,242,329,1,1,0,243,324,1,1,0],[1,145,["#000000",2,"1"],[150,275],[149,276],[147,279],[145,285],[142,294],[139,309],[138,316],[139,321],[140,324]],[1,146,["#000000",14,"0.61"],[115,311],[114,312],[114,308],[114,299],[117,279],[120,264],[121,252],[122,
245],[123,246],[122,254],[121,267],[121,282],[121,298],[121,310],[121,315],[122,309],[124,296],[126,278],[130,259],[133,240],[134,239],[134,249],[131,276],[128,297],[124,315],[122,324],[121,314],[123,295],[128,270],[134,248],[140,237],[144,239],[145,261],[143,280],[140,296],[137,304],[135,303],[135,284],[138,268],[142,257],[146,256],[146,264],[145,273],[142,278],[139,277],[139,269],[139,257],[142,248],[144,245],[147,248],[149,260],[149,267],[148,268],[147,264],[147,253],[147,236],[148,230],[149,229],
[149,237],[147,243],[144,244],[142,242],[138,228],[138,216],[138,204],[138,197],[139,199],[141,208],[141,225],[139,234],[138,237],[137,231],[137,216],[139,187],[140,168],[140,154],[141,154],[139,167],[137,187],[132,209],[125,240],[121,249],[120,248],[120,238],[122,221],[127,199],[136,168],[140,159],[141,160],[139,172],[135,192],[126,224],[119,242],[113,252],[109,249],[109,235],[112,213],[120,186],[134,148],[141,134],[144,129],[145,131],[145,138],[142,150],[138,170],[134,182],[132,189],[131,188],[134,
178],[143,155],[150,140],[157,128],[162,123],[161,130],[157,146],[152,163],[144,183],[142,186],[142,181],[146,167],[153,150],[160,136],[166,127],[166,133],[163,147],[158,165],[152,180],[148,184],[149,174],[155,156],[167,128],[174,118],[176,117],[176,128],[170,154],[164,168],[161,173],[160,168],[164,155],[175,128],[182,116],[186,112],[186,117],[182,131],[176,147],[168,161],[166,160],[167,150],[177,130],[184,120],[188,119],[188,129],[181,153],[176,168],[170,177],[167,178],[167,171],[174,155],[180,145],
[184,141],[185,144],[183,155],[178,169],[171,184],[168,186],[168,181],[173,164],[180,152],[187,144],[191,142],[191,151],[188,161],[184,169],[182,171],[182,166],[187,149],[194,136],[201,125],[207,120],[209,125],[208,137],[201,159],[196,168],[193,170],[195,160],[201,147],[208,133],[214,124],[217,126],[216,138],[213,154],[208,168],[204,176],[202,172],[203,162],[207,149],[211,139],[212,135],[212,140],[207,158],[202,169],[198,174],[197,167],[200,156],[204,146],[208,141],[210,149],[209,162],[207,175],[205,
183],[205,182],[209,167],[215,152],[222,137],[229,128],[233,127],[234,136],[232,159],[227,172],[224,179],[222,176],[224,166],[227,153],[231,141],[234,135],[234,142],[233,156],[230,171],[227,181],[225,182],[226,173],[230,158],[235,144],[239,135],[242,133],[245,146],[245,161],[244,174],[243,182],[242,179],[244,169],[247,157],[254,146],[257,148],[259,157],[260,170],[259,184],[257,193],[256,190],[256,181],[257,170],[258,160],[259,158],[261,169],[262,185],[263,202],[262,223],[262,229],[261,228],[260,221],
[259,205],[260,197],[260,195],[261,201],[261,216],[263,243],[263,261],[262,274],[261,281],[260,279],[259,270],[259,244],[261,223],[263,208],[265,205],[265,216],[263,232],[261,248],[257,265],[255,270],[254,270],[253,267],[253,264],[253,265],[253,266],[252,269],[251,271],[251,272],[250,273],[249,276],[249,279],[248,281],[248,284],[248,285],[249,285],[249,284],[253,278],[256,272],[260,264],[264,259],[268,258],[271,267],[272,277],[273,288],[274,298],[275,305],[275,307],[275,302],[273,295],[270,286],[267,
279],[267,280],[267,285],[269,293],[272,304],[274,308],[274,309],[274,306],[271,301],[268,294],[264,289],[263,289],[262,293],[262,298],[262,301],[263,302],[264,301],[265,297],[268,290],[269,288],[270,288],[272,292],[272,301],[272,307],[273,310],[274,310],[276,309],[278,307],[281,305],[283,306],[284,309],[284,314],[284,319],[284,323],[285,322],[287,322],[288,322],[287,322],[286,322],[282,322],[277,322],[274,321],[273,319],[274,318],[277,319],[281,322],[286,325],[289,327],[291,328],[292,329],[293,329],
[294,328],[295,323],[295,319],[294,316],[291,317],[286,322],[282,325],[280,328],[279,329],[282,327],[284,323],[286,318],[286,309],[285,296],[278,265],[271,241],[266,219],[263,196],[262,186],[262,179],[262,177],[262,184],[263,199],[266,220],[269,244],[273,268],[276,287],[278,298],[279,294],[279,280],[277,257],[274,229],[270,190],[269,177],[269,180],[271,209],[273,234],[276,258],[277,274],[278,274],[277,261],[276,240],[274,215],[271,190],[270,174],[269,176],[269,189],[271,206],[272,219],[272,223],[272,
213],[270,197],[267,177],[263,155],[263,152],[264,159],[267,173],[272,195],[274,202],[274,203],[274,196],[273,183],[272,161],[271,152],[271,153],[272,165],[274,184],[277,207],[278,237],[278,248],[277,250],[277,236],[277,221],[278,202],[277,187],[277,185],[276,199],[276,216],[275,231],[273,239],[269,231],[266,216],[263,197],[260,177],[257,161],[254,154],[250,158],[248,166],[246,171],[243,176],[241,177],[239,177],[236,177],[232,179],[231,180],[232,181],[234,182],[236,182],[239,184],[243,186],[246,188],
[248,188],[250,187],[250,185],[251,185],[251,187],[251,191],[251,193],[251,192],[251,191],[251,189],[251,189],[251,191],[251,192],[251,191],[249,187],[244,181],[241,179],[237,179],[233,180],[230,182],[228,184],[226,185],[225,186],[225,187],[225,188],[226,187],[226,185],[226,183],[225,182],[224,183],[222,186],[221,188],[221,189],[221,185],[222,179],[224,174],[224,171],[225,170],[224,171],[221,175],[218,175],[216,172],[213,164],[212,160],[211,159],[209,161],[207,168],[204,170],[202,171],[201,171],[200,
171],[200,176],[199,179],[199,180],[199,181],[199,180],[200,180],[204,179],[207,180],[209,181],[209,180],[206,176],[202,174],[198,174],[194,177],[191,182],[189,185],[188,184],[187,184],[185,184],[182,183],[179,182],[177,179],[176,176],[175,176],[175,178],[175,180],[175,183],[174,184],[173,183],[172,182],[170,181],[167,180],[162,180],[160,180],[159,180],[157,181],[156,183],[155,185],[153,187],[150,190],[148,190],[146,191],[143,191],[140,191],[138,192],[137,192],[136,192],[136,191],[136,195],[136,201],
[137,208],[138,220],[138,227],[137,232],[137,234],[136,234],[136,231],[136,223],[136,211],[139,197],[144,183],[153,165],[160,156],[166,148],[171,143],[174,140],[176,136],[177,134],[178,132],[179,130],[178,131],[177,132],[173,137],[164,144],[157,148],[151,151],[147,152],[146,145],[151,137],[159,127],[169,117],[180,111],[187,110],[190,113],[187,123],[181,131],[174,137],[161,143],[154,143],[150,143],[150,141],[153,135],[160,129],[169,121],[182,114],[196,110],[211,112],[214,117],[212,123],[205,129],[194,
134],[181,139],[162,143],[155,143],[151,141],[150,136],[153,131],[155,127],[158,124],[160,122],[162,122],[162,121],[163,121],[163,122],[161,125],[157,129],[151,133],[146,136],[143,137],[142,136],[144,131],[149,125],[158,116],[175,106],[185,104],[192,106],[194,111],[191,119],[183,125],[172,130],[161,134],[153,135],[149,133],[150,126],[156,119],[165,111],[179,104],[195,100],[218,103],[229,109],[236,115],[240,119],[239,119],[238,119],[234,118],[224,116],[216,114],[213,112],[212,111],[215,109],[227,109],
[237,112],[247,117],[254,123],[257,129],[256,132],[247,134],[236,132],[223,128],[209,119],[207,116],[209,115],[218,115],[239,122],[253,131],[262,142],[267,150],[267,155],[262,154],[257,149],[252,140],[248,128],[247,120],[250,118],[259,127],[265,140],[271,152],[275,165],[275,167],[274,165],[270,154],[268,146],[266,140],[266,139],[267,144],[270,154],[274,170],[276,178],[276,182],[276,181],[276,179],[274,172],[272,158],[270,151],[270,148],[272,154],[275,163],[277,173],[279,183],[280,193],[280,195],[280,
194],[279,189],[279,181],[276,165],[274,155],[273,149],[273,146],[273,145],[273,144],[273,143],[273,141],[272,140],[271,138],[270,137],[270,138],[272,144],[275,154],[278,167],[280,182],[282,207],[283,223],[284,237],[284,249],[285,259],[287,265],[288,268],[288,265],[288,257],[286,237],[284,220],[283,201],[283,187],[283,180],[283,181],[283,188],[283,196],[283,208],[283,226],[284,238],[284,249],[284,257],[285,265],[285,272],[286,282],[287,287],[288,291],[289,295],[291,298],[292,300],[294,303],[296,306],
[298,309],[299,312],[300,314],[300,315],[299,312],[295,305],[289,292],[277,263],[271,242],[268,224],[267,211],[266,203],[266,205],[266,208],[265,211],[264,218],[263,227],[262,236],[261,245],[259,255],[259,259],[258,262],[258,263],[257,262],[256,260],[255,257],[255,253],[255,242],[256,232],[257,221],[257,213],[257,210],[257,212],[256,221],[256,234],[257,248],[257,260],[257,269],[257,268],[257,267],[256,261],[256,253],[257,237],[258,223],[259,210],[260,203],[259,207],[258,217],[257,232],[256,256],[255,
270],[255,276],[255,277],[255,272],[256,262],[258,245],[259,236],[259,232],[258,233],[255,238]],[1,147,["#000000",14,"0.61"],[147,253],[148,254],[148,255],[149,258],[149,262],[149,264],[149,263],[149,262],[149,259],[149,257],[150,256],[151,258],[152,260]],[1,148,["#000000",14,"0.61"],[257,238],[256,238],[255,239],[254,241],[252,243],[248,247],[242,256],[236,262],[232,267],[228,270],[226,269],[226,267],[226,264],[226,262],[225,262],[225,263],[225,264],[224,265],[224,267],[223,267],[223,268],[222,268],
[223,268],[224,268],[225,269],[227,270],[230,271],[232,272],[235,273],[240,273],[243,272],[245,270],[246,269],[245,269],[244,270],[242,271],[240,271],[239,271],[238,269],[239,263],[241,258],[243,252],[245,246],[248,237],[248,235],[247,235],[246,239],[243,248],[240,254],[239,258],[238,260],[238,259],[238,258],[238,254]],[1,149,["#000000",14,"0.61"],[115,243],[115,242],[115,243],[114,249],[113,258],[113,271],[113,287],[114,308],[116,318],[119,323],[120,325],[121,324],[122,321],[122,317],[123,312]],
[1,150,["#000000",14,"0.61"],[130,316],[131,316],[132,316],[133,316],[134,316],[135,317]],[1,151,["#000000",14,"0.61"],[119,205],[115,223],[112,238],[110,248],[109,249],[110,241],[113,225],[119,203],[127,177],[138,151],[154,121],[162,111],[167,108],[169,109],[169,114],[168,118],[165,122],[161,126],[155,135],[151,142],[145,149],[139,157],[131,172],[127,183],[124,191],[124,194],[125,192],[127,188],[137,169],[146,153],[157,136],[167,123],[174,116],[173,121],[170,132],[165,146],[157,163],[154,167],[154,
165],[156,158],[164,142],[169,134],[172,130],[172,134],[170,144],[166,159],[161,176],[159,179],[161,174],[166,162],[176,141],[182,131],[186,127],[186,132],[183,151],[179,165],[175,175],[174,177],[176,167],[181,155],[186,143],[190,136],[191,136],[191,144],[187,162],[184,171],[183,173],[184,168],[188,150],[192,137],[196,128],[198,126],[198,138],[196,153],[195,166],[193,172],[194,167],[197,156],[201,144],[205,135],[208,132],[209,136],[209,154],[207,163],[206,166],[206,162],[209,145],[211,133],[212,127],
[213,127],[213,144],[211,157],[209,164],[207,164],[205,151],[203,138],[201,127],[198,122],[193,122],[187,129],[180,138],[178,138],[178,135],[182,127],[193,115],[201,109],[206,107],[208,107],[206,111],[205,112],[204,112],[205,112],[208,118],[211,123],[214,127],[216,128],[218,126],[220,125],[225,128],[229,136],[231,146],[232,156],[232,162],[231,160],[230,154],[229,145],[228,137],[227,140],[227,150],[226,170],[225,182],[223,186],[221,182],[221,172],[221,159],[223,143],[225,140],[228,148],[231,162],[234,
178],[236,190],[236,187],[236,176],[236,162],[237,143],[240,138],[245,143],[250,157],[258,180],[261,191],[262,193],[261,189],[260,179],[259,162],[259,156],[260,155],[261,163],[263,177],[265,201],[265,217],[266,228],[266,231],[267,228],[267,221],[266,209],[263,180],[262,162],[262,152],[264,154],[266,165],[269,185],[273,221],[274,241],[274,251],[272,252],[270,241],[263,209],[259,181],[256,156],[256,141],[258,135],[260,138],[263,146],[268,166],[273,186],[278,209],[283,234],[286,258],[288,279],[287,299],
[286,303],[284,300],[280,289],[276,270],[269,230],[267,202],[266,180],[267,170],[269,172],[271,187],[274,210],[277,245],[277,259],[277,262],[275,256],[272,239],[268,214],[262,172],[260,157],[259,157],[258,170],[257,192],[257,227],[257,244],[257,253],[257,257],[255,260],[255,264],[255,267],[256,268],[256,266],[256,261],[257,253],[257,246],[258,243],[259,246],[263,264],[265,279],[267,291],[268,299],[269,304],[271,304],[272,304],[272,303],[270,292],[268,277],[265,253],[263,207],[265,179],[269,159],[272,
147],[274,145],[275,150],[274,160],[271,167],[267,165],[263,158],[258,147],[253,132],[249,125],[245,121],[241,119],[236,115],[234,112],[231,111],[227,111],[224,112],[220,116],[216,118],[212,119],[209,117],[207,112],[207,109],[208,108],[209,108],[209,109],[206,110],[201,110],[194,110],[186,111],[172,117],[162,125],[151,136],[135,156],[126,172],[120,186],[117,197],[115,205],[115,211],[115,216],[115,217],[116,216],[118,211],[120,204],[124,192],[124,189],[124,193],[122,205],[120,233],[117,253],[116,269],
[115,277],[117,272],[120,260],[126,240],[133,215],[140,190],[145,172],[146,175],[143,188],[140,205],[136,224],[133,244],[133,246],[133,242],[136,230],[142,204],[146,188],[149,178],[150,180],[149,191],[147,207],[144,224],[142,238],[141,247],[139,252],[139,253],[139,256],[139,260],[138,267],[136,274],[135,276],[134,277],[134,278],[133,283],[132,288],[130,293],[128,299],[126,302],[125,304],[125,302],[125,300],[127,293],[128,288],[128,290],[127,297],[125,303],[123,306],[122,302],[124,294],[127,287],[130,
283],[131,284],[131,289],[131,292],[131,291],[131,289],[130,288],[128,290],[127,295],[126,299],[125,300],[128,296],[131,295],[133,295]],[1,152,["#000000",14,"0.61"],[225,276],[225,277],[225,276],[226,274],[229,270],[233,264],[238,255],[243,248],[246,244],[245,246],[243,251],[239,257],[235,262],[235,263],[236,263],[238,261],[242,255]],[1,153,["#000000",14,"0.61"],[281,318],[280,319],[279,321],[278,321],[278,320],[278,318],[278,315],[279,313],[281,313],[284,315],[287,319],[289,322],[290,323],[290,320],
[289,314],[288,306],[288,304],[289,305],[291,308],[294,311],[296,312],[296,309],[297,306],[297,304]],[1,154,["#000000",14,"0.61"],[179,182],[179,184],[178,186],[178,185],[178,183],[178,180],[181,168],[183,161],[185,159]],[1,155,["#000000",14,"0.61"],[206,178],[205,179],[205,177],[205,171],[207,164],[209,157],[211,155]],[1,156,["#000000",14,"0.61"],[241,186],[240,186],[239,183],[239,176],[240,166]],[1,157,["#000000",14,"0.61"],[178,109],[179,108],[184,105],[192,102],[202,102],[212,105],[225,115]],
[1,158,["#000000",14,"0.61"],[249,117],[250,116],[255,117],[262,124],[269,135],[277,152],[285,185],[288,207],[290,224],[291,233]],[1,159,["#000000",14,"0.61"],[234,125],[237,132],[241,146],[245,164]],[1,160,["#000000",14,"0.61"],[129,247],[129,243],[130,242],[132,247],[136,266],[139,283],[140,292]],[1,161,["#FEE6DB",10,"0.61"],[155,225],[155,224],[154,224],[154,223],[155,225],[156,228],[157,230],[157,229],[157,228],[156,224],[154,220],[153,218],[153,217],[153,219],[155,222],[157,226],[159,229],[159,
230],[160,230],[160,228],[159,226],[159,224],[159,225],[159,228],[159,232],[159,237],[159,239],[159,242],[159,244],[160,245],[160,244],[160,243],[160,244],[161,245],[161,244],[161,242],[162,240],[164,238],[165,237],[166,236],[167,236],[168,236],[169,236],[170,236],[172,235],[173,234],[174,234],[174,235],[175,236],[176,237],[177,238],[177,239],[177,240],[177,241],[176,242],[177,242],[177,243],[177,244],[177,245],[177,246],[177,247],[177,246],[177,245],[177,242],[178,238],[178,235],[178,234],[177,234],
[176,234],[175,233],[174,232],[174,231],[175,231],[176,230],[178,230],[181,233],[183,234],[185,234],[186,234],[185,233],[183,232],[181,231],[181,229],[181,228],[184,227],[187,225],[191,223],[193,220],[195,217],[195,214],[195,213],[195,211],[194,211],[193,213],[192,215],[190,217],[188,220],[185,222],[185,223],[185,222],[187,216],[191,209],[194,203],[197,197],[198,194],[197,197],[195,203],[192,210],[190,216],[188,220],[188,221],[189,216],[192,210],[195,205],[197,203],[198,207],[198,215],[197,222],[195,
228],[195,229],[196,226],[197,223],[199,221],[199,222],[198,223],[196,224],[195,225],[192,228],[191,230],[190,231],[189,231],[189,232],[189,233],[188,234],[187,234],[187,233],[187,234],[187,235],[187,236],[187,238],[186,239],[186,238],[186,237],[186,238],[186,239],[185,240],[184,241],[183,241],[182,242],[182,243],[182,244],[182,245],[183,246],[184,246],[184,245],[183,245],[183,244],[182,244],[182,245],[183,245],[183,244],[182,243],[182,241],[182,239],[182,237],[184,236],[186,234],[190,233],[193,233],
[196,234],[199,235],[203,237],[204,237],[204,236],[204,235],[203,234],[201,234],[200,234],[201,235],[202,235],[203,236],[201,236],[199,236],[196,236],[195,236],[196,236],[197,237],[199,238],[200,238],[202,239],[203,239],[204,240],[205,241],[205,242],[206,242],[207,243],[208,245],[209,246],[208,245],[208,243],[207,240],[203,230],[200,222],[198,217],[198,216],[200,220],[202,226],[205,234],[207,239],[207,240],[207,234],[205,224],[203,213],[201,204],[200,199],[201,203],[203,212],[204,221],[206,227],[206,
228],[206,222],[206,214],[206,203],[206,200],[206,201],[206,205],[207,209],[207,212],[207,213],[208,211],[209,208],[209,205],[209,203],[208,202],[208,201],[209,201],[211,201],[212,201],[214,201],[214,200],[215,199],[216,199],[217,199],[217,198],[217,197],[218,197],[218,196],[219,196],[218,196],[216,196],[210,196],[206,196],[202,196],[199,196],[196,196],[194,196],[191,196],[190,195],[189,195],[188,195],[187,195],[186,195],[186,194],[185,194],[185,195],[184,195],[183,195],[185,196],[186,196],[187,196],
[188,197],[190,197],[192,198],[193,198],[196,198],[198,198],[203,198],[205,198],[207,197],[209,196],[210,196],[211,196],[212,196],[213,196],[215,196],[216,197],[217,197],[216,197],[215,197],[213,197],[211,198],[208,199],[206,201],[204,204],[203,206],[203,212],[203,217],[205,222],[207,226],[209,230],[209,232],[210,233],[210,232],[210,229],[211,226],[213,226],[215,230],[217,236],[218,242],[218,243],[218,241],[217,234],[215,229],[214,226],[214,228],[215,229],[217,235],[220,242],[221,244],[222,245],[222,
246],[222,247],[222,248],[221,248],[220,247],[220,246],[221,245],[222,244],[224,242],[228,238],[230,236],[233,234],[234,233],[235,233],[235,232],[235,233],[234,233],[234,234],[234,235],[234,234],[235,230],[237,226],[238,222],[239,221],[239,220],[240,220],[241,219],[242,219],[242,220],[243,220],[243,221],[243,222],[242,223],[241,225],[240,227],[239,229],[238,231],[236,233],[235,234],[234,235],[233,236],[232,237],[232,238],[231,240],[231,242],[231,243],[230,245]],[1,162,["#FEE6DB",10,"0.61"],[165,259],
[165,260],[165,261],[165,260],[165,259],[166,258],[166,257],[167,256],[169,254],[169,253],[171,251],[171,250],[171,249],[171,248],[171,247],[170,248],[170,250],[170,254],[169,257],[169,259],[170,259],[171,259],[172,260],[173,260],[174,260],[176,261],[178,261],[179,260],[181,259],[179,261],[176,263],[176,264],[176,265],[176,266],[177,267],[178,268],[179,268],[179,267],[179,266],[179,265],[179,264],[181,261],[183,259],[186,256],[189,255],[191,255],[192,255],[192,256],[193,257],[194,257],[194,256],[195,
255],[196,255],[197,255],[198,255],[199,256],[200,256],[201,256],[200,256],[199,256],[197,257],[196,257],[195,257],[195,256],[194,256],[194,255],[194,254],[193,254],[192,253],[191,253],[192,253],[193,253],[194,254],[194,255],[195,255],[196,255]],[1,163,["#FEE6DB",10,"0.61"],[215,254],[215,255],[215,254],[216,253],[217,253],[219,252],[220,253],[220,254],[220,256]],[1,164,["#FEE6DB",10,"0.61"],[212,278],[212,277],[211,277],[212,279],[213,282],[214,286],[215,290],[215,292],[215,293],[215,294],[215,295],
[215,296],[214,297],[214,298],[213,298],[213,297],[213,296],[212,296],[211,296],[211,297],[209,297],[209,298],[209,297],[210,297],[213,296],[216,295],[221,294],[225,293],[228,293],[230,293],[231,294],[231,295],[231,294],[230,292],[229,291],[228,292],[227,293],[227,294],[227,293],[228,292],[228,291],[230,287],[230,285],[231,285],[231,284],[231,283],[231,282],[231,281],[232,281],[233,282],[234,283],[235,285],[236,287],[236,289],[237,291],[238,292],[239,292],[241,293],[242,294],[243,294],[243,295],[244,
296],[245,296],[246,295],[247,295],[247,296],[248,297],[248,299],[248,300],[247,300],[247,301],[247,300],[248,298],[248,297],[249,296],[250,298],[251,300],[250,302],[249,302],[247,301],[245,299],[243,298],[244,298]],[8,165,["#fbdc89","1"],190,286,1,5,0,191,287,1,4,0,190,286,1,3,0,191,291,2,2,0,192,287,4,2,0,189,286,1,2,0,189,286,2,1,0,196,288,1,1,0,194,289,3,4,0,194,287,2,1,0,195,293,2,5,0,197,295,1,3,0,195,295,1,3,0,194,295,1,3,0,198,296,1,2,0,193,295,1,2,0,193,296,1,1,0,194,286,1,1,0,189,285,1,
1,0,191,292,1,1,0,188,276,1,9,0,189,276,1,3,0,188,277,1,8,0,187,277,1,7,0,187,281,1,1,0,190,276,1,3,0,190,276,1,2,0,191,276,1,2,0,191,276,1,1,0,192,276,1,1,0],[8,166,["#fbdc89","1"],198,286,4,2,0,201,288,1,3,0,199,286,4,1,0,202,285,2,1,0,199,285,3,1,0,199,285,1,1,0,200,284,1,1,0,204,285,1,1,0,204,277,1,8,0,205,279,1,6,0,204,278,1,1,0,205,280,1,4,0,203,278,1,1,0,202,277,2,1,0,200,277,2,1,0,200,276,4,1,0,202,290,3,1,0,202,291,3,2,0,205,291,1,1,0,202,292,4,1,0,203,293,3,1,0,203,293,3,1,0,204,294,2,1,
0,204,294,1,1,0,204,295,1,1,0],[8,167,["#fbdc89","1"],194,276,3,3,0,197,279,1,1,0,194,278,1,1,0,196,279,1,5,0,197,283,1,1,0,196,281,1,3,0,195,281,1,3,0,194,281,1,2,0],[8,168,["#fbdc89","1"],189,271,1,2,0,190,272,1,2,0,187,271,2,1,0,191,272,7,1,0,198,272,1,1,0,191,273,6,1,0,191,274,4,1,0,187,271,2,1,0,187,270,1,1,0],[8,169,["#fbdc89","1"],205,269,1,1,0],[1,170,["#FEE6DB",6,"0.59"],[194,268],[195,268],[196,268],[197,268],[197,267],[198,267],[200,267],[201,266],[203,266],[204,265]],[1,171,["#99BCFF",
6,"0.59"],[96,110],[95,110],[95,109],[96,108],[99,104],[104,99],[109,94],[112,92],[113,93],[108,101],[102,109],[95,117],[90,122],[89,123],[95,117],[104,108],[119,98],[124,97],[123,102],[117,113],[107,125],[95,137],[93,137],[98,131],[109,121],[122,110],[133,103],[136,103],[129,110],[116,121],[103,131],[94,136],[99,132],[110,122],[133,104],[144,97],[146,96],[140,103],[127,113],[105,130],[97,135],[98,133],[108,123],[122,110],[138,98],[150,90],[147,95],[135,107],[120,122],[98,144],[91,150],[94,148],[113,
131],[130,115],[144,101],[150,95],[146,99],[127,120],[110,137],[97,152],[91,158],[94,156],[105,144],[129,119],[142,105],[148,101],[144,108],[127,132],[113,149],[102,160],[100,162],[108,153],[120,140],[130,130],[135,128],[130,143],[120,160],[109,177],[99,194],[92,206],[90,210],[95,209],[98,207]],[1,172,["#99BCFF",6,"0.59"],[236,101],[238,101],[243,102],[251,105],[261,111],[272,120],[286,139],[292,153],[296,165],[298,175],[298,177],[298,178],[298,175],[294,163],[289,150],[281,135],[272,120],[264,109],
[256,100],[254,98],[253,98],[252,97],[251,97],[252,97],[253,98],[255,100],[261,107],[276,122],[285,132],[293,141],[297,147],[298,150],[296,148],[292,141],[285,130],[271,111],[263,100],[258,95],[257,94],[260,98],[266,108],[281,127],[291,139],[299,146],[301,148],[296,139],[289,127],[279,114],[273,105],[274,104],[280,112],[289,122],[296,129],[299,131],[296,126],[291,117],[285,109],[281,104],[282,104],[289,114],[293,120],[294,121],[291,117],[284,104],[281,97],[282,97],[287,102],[294,111],[296,112],[296,
108],[296,100],[303,97]],[1,173,["#99BCFF",6,"0.59"],[296,174],[296,173],[296,171],[296,170],[296,171],[296,176],[297,188],[297,208],[297,232],[297,267],[298,281],[298,287],[298,289],[298,288],[298,285]],[1,174,["#99BCFF",6,"0.59"],[108,185],[107,185]],[1,175,["#99BCFF",6,"0.59"],[108,185],[108,180],[108,178],[107,179],[107,181],[106,184],[104,193],[101,220],[100,246],[99,273],[99,293],[101,309],[102,315],[103,317],[104,318],[104,319],[103,319],[102,319],[101,318],[100,318],[100,319],[101,319],[101,
322],[102,323],[103,325],[104,327],[105,327],[106,327],[106,326],[106,324],[106,323],[106,317],[106,306],[106,291],[106,268],[106,256]],[1,176,["#99BCFF",6,"0.59"],[99,185],[99,183],[101,177],[106,167],[121,142],[135,123],[149,107],[161,96],[168,89],[171,89],[171,92],[168,96],[164,100],[160,104],[155,107],[149,111]],[1,177,["#99BCFF",6,"0.59"],[111,111],[116,106],[123,101],[125,100]],[1,178,["#99BCFF",6,"0.59"],[98,127],[98,126],[100,123],[111,110],[122,100],[130,91],[135,88],[135,90],[126,104],[117,
115],[108,125],[102,133],[100,135],[103,132],[114,121],[123,114],[128,111],[127,118],[121,130],[113,143],[107,152],[105,156],[109,152],[116,144],[123,135],[128,130],[127,134],[121,142],[114,151],[108,158],[106,159],[108,157],[117,146],[124,139],[128,136],[126,143],[119,156],[112,169],[106,182],[100,194],[100,196],[102,195],[103,193]]];
GPAssets_.AC_SUSPICIOUS_PH={ru:[...GPAssets_.GIRL_PORTRAIT,[1,200,["#cc6969",4,1],[369,156.5],[369,160],[369.5,163.5],[370.5,167.5],[371,172.5],[371.5,177],[371.5,181.5],[372,186],[372,188.5],[372,190.5],[372,190.5],[372,190.5],[372,190]],[1,201,["#cc6969",4,1],[371.5,156.5],[371.5,156],[372.5,156],[374,156],[376.5,156],[380.5,155],[383,155],[384.5,154.5],[386,154.5],[386.5,154.5],[387,154.5],[387,155],[387,155.5],[386.5,156],[386.5,158.5],[386.5,161],[386.5,163.5],[386.5,166],[386.5,169.5],[387,
174],[387,177],[387,180],[387,182.5],[387,186],[387.5,187.5],[388,188],[388,189],[388.5,189],[388.5,189.5],[388.5,189],[388.5,188.5]],[1,202,["#cc6969",4,1],[401,172.5],[400,173.5],[399.5,176.5],[399.5,179],[399.5,181],[399.5,183],[400.5,184.5],[403,186.5],[404.5,187],[406.5,187.5],[408.5,187],[411,186],[411.5,185],[413,182.5],[413.5,180.5],[414,178.5],[413.5,175],[413,173.5],[411,172.5],[409.5,171.5],[406.5,171.5],[404.5,171.5],[403.5,172.5],[402.5,174],[402.5,175]],[1,203,["#cc6969",4,1],[434,174],
[433,172],[432.5,171],[430,171],[428.5,171],[426,171.5],[425,173],[424,175],[423,177.5],[422.5,181.5],[423,183.5],[424,185.5],[427,187],[429,187.5],[431,187.5],[432.5,187],[433.5,186],[435,183.5],[435.5,181.5],[436,178.5],[436,176],[436,174.5],[436,175],[436,176],[436.5,177],[437,180],[438,185],[439.5,188.5],[441.5,192.5],[443.5,195.5],[447,199.5],[448.5,201.5],[449.5,203],[449.5,204],[449,204.5],[448,205],[445,205],[442,205],[439.5,205],[435.5,205],[434,204],[433,203],[433,201.5],[433,199.5],[434,
197],[436,195.5],[437.5,195]],[1,204,["#cc6969",4,1],[447,174.5],[446.5,174.5],[446.5,176.5],[446.5,179],[446.5,181.5],[448.5,184],[449.5,185.5],[451.5,186],[453,186],[455,186],[457.5,184.5],[459,183],[459.5,181.5],[459.5,179],[458,175.5],[456.5,173],[455,172],[453.5,171.5],[452,171.5],[449,173],[447.5,174.5],[447.5,177.5],[447.5,179]],[1,205,["#cc6969",4,1],[466.5,173.5],[466,172.5],[467.5,170],[469,169.5],[471,169],[473,169],[475,170],[475.5,171],[475.5,174],[474.5,176.5],[473,178],[472.5,179],
[473,179],[476,178.5],[479,178.5],[481.5,179],[483.5,181],[484.5,182.5],[485.5,185],[485.5,186.5],[485,188.5],[484,190],[481.5,192],[479.5,192.5],[477,193],[474.5,193],[472,192.5],[469.5,192],[469,191.5],[468.5,190.5],[470,189],[471,188.5]],[1,206,["#cc6969",4,1],[488,171.5],[489.5,174.5],[491,178.5],[492.5,182],[494.5,186],[495.5,189.5],[496,191],[496.5,192.5],[496.5,193],[496.5,193.5]],[1,207,["#cc6969",4,1],[490,171.5],[491,169.5],[493.5,169],[496.5,169],[499,169.5],[501.5,170],[503,171.5],[504.5,
174],[505,175],[505,177],[504.5,178.5],[503.5,179.5],[502,180.5],[501.5,181.5],[499.5,181.5],[498.5,181.5],[498,181.5]],[1,208,["#cc6969",4,1],[512.5,168],[512.5,168],[512.5,169],[512.5,172],[513,173.5],[514,175.5],[514.5,177],[516.5,179],[517.5,179],[519,179],[519.5,179],[520.5,179],[522,176.5],[523,175],[523.5,173.5]],[1,209,["#cc6969",4,1],[525.5,166],[525.5,167],[525.5,169.5],[526.5,171.5],[527,173.5],[528,175.5],[528.5,177.5],[528.5,179],[529,179.5],[530,180],[530,180.5]],[1,210,["#cc6969",4,
1],[542.5,167.5],[542.5,168.5],[543.5,170.5],[544,174],[544.5,176],[545,177],[545,178],[545,178.5]],[1,211,["#cc6969",4,1],[536.5,168.5],[537,168],[537.5,168],[539,168],[543,167],[545.5,166],[547.5,165.5],[550,164.5],[551.5,164],[552,163.5],[552.5,163.5]],[1,212,["#cc6969",4,1],[564.5,174.5],[565.5,174],[567.5,172.5],[569.5,172],[570.5,171],[571.5,170],[572,169.5],[572,168.5],[572,168],[571,167.5],[569.5,166.5],[567.5,166.5],[566.5,166.5],[565,167],[564,168],[563,168.5],[561.5,170],[561,171.5],[561,
172.5],[561,174.5],[562,177],[563,179],[564,180],[565,180.5],[567,181],[568.5,181],[571,181],[572,180],[574,179.5],[576,179]],[1,213,["#cc6969",4,1],[587.5,165.5],[587,168.5],[586.5,170.5],[586.5,173],[586,175],[585,178],[585,179],[585,179.5],[585,180]],[1,214,["#cc6969",4,1],[589.5,164.5],[592,168.5],[594.5,172],[596,174],[597.5,176],[598.5,177.5],[599.5,179],[599.5,179.5],[600,180],[600,180.5]],[1,215,["#cc6969",4,1],[603,163.5],[602.5,163.5],[602.5,164.5],[603.5,166.5],[604.5,169.5],[605,172.5],
[606,175],[607,178],[607,179],[607,179.5],[607,180]],[1,216,["#cc6969",4,1],[606.5,170],[611.5,168.5],[613.5,168.5],[615.5,168.5],[618,170],[619.5,171],[620,173],[620,174.5],[620,175.5],[619,176.5],[617.5,177.5],[616,178.5],[615,179],[613.5,179],[613.5,179.5],[613,179.5]],[1,217,["#cc6969",4,1],[627.5,164],[630,170],[631,172.5],[631.5,174.5],[632.5,177],[633,178],[633,179],[633,180],[633.5,180]],[1,218,["#cc6969",4,1],[635,173.5],[635.5,173.5],[637.5,173],[638.5,172.5],[639,172.5],[639.5,172],[640,
172]],[1,219,["#cc6969",4,1],[641.5,165],[641,165.5],[642,169],[642.5,171.5],[643,173.5],[644,175.5],[644,177],[645,178],[645.5,178.5],[646,179],[646.5,179],[647,179]],[1,220,["#cc6969",4,1],[661.5,168],[659,165],[657.5,163.5],[656.5,163],[654.5,162.5],[653,162.5],[652.5,163],[651,163.5],[650.5,165],[650.5,166.5],[650.5,170],[650.5,172.5],[651,174.5],[652.5,177],[653,178],[654,179],[655,179],[656,179],[657.5,178.5],[659,177],[659.5,175.5],[660.5,174],[661,171.5],[661,169.5],[661,168],[661,167],[661,
167.5],[662,169],[662,171],[662.5,174.5],[662.5,176],[663,177],[663,178.5],[663.5,179],[663.5,179],[664,179],[664,179.5]],[1,221,["#cc6969",4,1],[672.5,172.5],[672.5,173.5],[673,174.5],[673,176],[674,176.5],[675,177],[676,177],[678,175],[679,174.5],[681,172.5],[682,171],[683.5,169.5],[684,166],[684,164.5],[684,163],[684,161.5],[683,160.5],[682,160],[680.5,159.5],[679,159.5],[677.5,160],[675.5,161],[675,162],[675,163],[675,163.5],[675.5,165],[676.5,165.5],[677.5,166.5],[679,167.5],[680,168],[682.5,
168.5],[684.5,169],[686.5,169.5],[688.5,170],[690.5,171],[690.5,172],[691,172.5],[691,173.5],[690.5,174.5],[690,175.5],[689.5,176.5],[689.5,177]],[1,222,["#cc6969",4,1],[395.5,234],[395.5,231],[395.5,230.5],[395.5,230],[395.5,229.5],[395.5,230.5],[395.5,231],[394.5,235.5],[394,240.5],[393,246.5],[392,253],[391.5,258.5],[391,264.5],[391,267.5],[391,269],[391,269.5],[391,268.5],[391,266.5]],[1,223,["#cc6969",4,1],[397.5,233.5],[397.5,232.5],[397.5,232],[397.5,231.5],[397.5,231],[397.5,231.5],[398.5,
233],[399.5,235],[400.5,238.5],[402.5,244],[404,248.5],[404.5,253],[406,257],[406.5,259.5],[407.5,263],[408,264.5],[408,265.5],[408,266],[408,265.5],[408,264.5],[408,264],[407.5,262.5],[407.5,262]],[1,224,["#cc6969",4,1],[397,255],[398,255],[399,255],[400,254],[401,253.5],[402,253.5],[403,253.5]],[1,225,["#cc6969",4,1],[415,246],[414.5,245.5],[415,246.5],[416,248.5],[417.5,252.5],[419,257.5],[419.5,260.5],[420,262.5],[420,264],[420,265],[420,265.5],[420,264.5],[420,264]],[1,226,["#cc6969",4,1],[424,
244],[426,244.5],[426,245.5],[426,246.5],[426,249],[425.5,251],[424.5,253],[424,254.5],[423.5,256],[423,257],[422.5,257.5],[422,258],[422,258.5],[422.5,258.5],[423,258.5],[423.5,258.5],[424.5,259],[426.5,260],[428,261],[430,262],[430.5,262.5],[432,263],[433,264]],[1,227,["#cc6969",4,1],[438,246.5],[439,251],[441,254],[442,256.5],[443,258.5],[443.5,260.5],[443.5,261.5],[443.5,262],[443.5,262],[443.5,261.5]],[1,228,["#cc6969",4,1],[433,248],[433.5,248],[434,248],[436.5,248],[439,247],[441,246.5],[443.5,
245.5],[446,244.5],[447,244],[447.5,244],[448,244]],[1,229,["#cc6969",4,1],[455.5,245.5],[455.5,246.5],[456,248.5],[456.5,251],[457.5,253],[458.5,255],[460.5,257.5],[461.5,258],[463,258],[464.5,257.5],[465.5,256],[465.5,254.5],[466,253],[466,250.5],[466,248.5],[466,246],[465.5,245],[465.5,244],[465.5,243.5],[465.5,244],[465.5,246],[466,248.5],[467.5,252.5],[468,255],[469,257],[470,258.5],[470,259.5],[470.5,259.5],[471,259.5]],[1,230,["#cc6969",4,1],[477,243.5],[479,241],[480,240],[481,239],[483.5,
237],[486.5,233],[488,231],[489,229],[489.5,227],[489.5,225.5],[488,224],[486,223],[484,222.5],[482,222.5],[479,224.5],[476.5,226],[474.5,228.5],[473.5,231.5],[472.5,235],[472.5,238],[473.5,243.5],[474.5,246.5],[475.5,250],[478.5,254],[480.5,256],[482,257.5],[484,258],[485.5,258],[487,258],[489,256],[490,254.5],[490.5,252.5],[490.5,249.5],[490.5,248],[489.5,246.5],[487.5,245],[486,244.5],[484.5,244],[482,245.5],[480.5,247],[479.5,249],[479.5,250]],[1,231,["#cc6969",4,1],[497,242],[497.5,243.5],[498.5,
245.5],[499,248],[500,250.5],[501,252.5],[501,255],[501.5,255],[502,255.5]],[1,232,["#cc6969",4,1],[503,249.5],[504.5,249.5],[505.5,249],[506.5,248.5],[507.5,248.5],[507.5,248.5],[508,247.5],[508.5,247]],[1,233,["#cc6969",4,1],[510,242],[510,244],[510.5,246],[511,248],[511.5,251],[512,252],[512.5,253],[513,253.5],[513.5,253.5],[514,253.5]],[1,234,["#cc6969",4,1],[518,243],[518,246],[518.5,248.5],[520,250.5],[520.5,251.5],[521.5,252.5],[523,253],[524,253],[525,253],[526,252.5],[527,251],[528.5,248.5],
[529.5,247],[529.5,245.5],[529.5,244],[529,242],[527.5,241],[526.5,239.5],[525,239.5],[523,239],[520.5,239],[518,239.5],[517,241],[516.5,242.5],[517.5,245.5]],[1,235,["#cc6969",4,1],[546.5,239.5],[546,238.5],[545,237.5],[543,237.5],[542,237],[540.5,237],[539,238],[538,241.5],[538,244],[538,246.5],[539.5,248.5],[542,250.5],[544.5,251],[547,251],[549.5,250.5],[551,249],[553.5,247.5]],[1,236,["#cc6969",4,1],[560,238.5],[559.5,239.5],[560,242],[560,244],[560.5,246.5],[561,248.5],[561.5,249.5],[561.5,
250],[562,250.5],[562,250]],[1,237,["#cc6969",4,1],[556.5,238.5],[555,238],[555.5,238],[556,238],[557.5,238],[559.5,238],[561,237.5],[563,237.5],[565.5,237.5],[566.5,237.5],[567.5,237]],[1,238,["#cc6969",4,1],[576,235],[576,236.5],[577,238.5],[577.5,240.5],[578,243],[578.5,245],[579.5,247],[580,248],[580,248.5],[580,248.5],[580,248]],[1,239,["#cc6969",4,1],[580.5,242],[583.5,240],[586,240],[587.5,240],[589,241],[590.5,241.5],[591,242.5],[592,243.5],[592,244],[592,244.5],[592,245],[591,246],[590.5,
246.5],[589,247],[588.5,248],[587,248],[586,248.5]]],en:[...GPAssets_.GIRL_PORTRAIT,[1,4,["#cc6969",4,1],[389,160],[388,152],[385,146],[378,144],[371,149],[367,160],[370,166],[382,175],[392,185],[396,195],[388,207],[375,209],[364,205],[361,199]],[1,7,["#cc6969",4,1],[404,174],[403,183],[404,193],[408,205],[414,212],[422,213],[428,205],[430,190],[429,181],[428,178],[427,178]],[1,8,["#cc6969",4,1],[445,175],[438,181],[436,185],[437,188],[442,188],[450,192],[455,195],[454,202],[447,205],[439,207],[436,
206],[436,205]],[1,9,["#cc6969",4,1],[455,179],[458,187],[463,200],[465,208],[467,211],[462,203],[459,194],[458,181],[461,174],[468,170],[475,170],[481,175],[483,185],[480,192],[473,195],[468,196]],[1,10,["#cc6969",4,1],[492,174],[492,182],[492,190],[493,195]],[1,11,["#cc6969",4,1],[495,158],[493,156],[491,156],[488,156],[487,160],[491,162],[495,160],[495,158],[492,159],[492,159]],[1,13,["#cc6969",4,1],[520,173],[512,171],[508,172],[505,176],[503,185],[504,192],[508,197],[515,197],[522,195],[525,
194]],[1,14,["#cc6969",4,1],[531,174],[532,184],[534,193],[534,196],[534,198],[535,197]],[1,15,["#cc6969",4,1],[530,156],[528,156],[527,158],[526,162],[527,164],[531,164],[534,163],[534,160],[532,158],[529,157],[528,157]],[1,16,["#cc6969",4,1],[529,160],[532,161],[532,160],[531,159],[530,159],[530,159]],[1,17,["#cc6969",4,1],[552,173],[547,171],[544,171],[540,172],[538,175],[538,183],[539,191],[545,197],[552,198],[559,197],[565,190],[563,180],[558,174],[552,172],[548,173]],[1,21,["#cc6969",4,1],[572,
170],[572,175],[572,180],[575,189],[578,194],[583,195],[589,192],[593,184],[595,178],[593,174],[590,170],[589,168],[589,169]],[1,22,["#cc6969",4,1],[607,168],[605,167],[602,168],[598,173],[598,175],[602,178],[608,178],[615,179],[620,184],[620,188],[614,192],[608,193],[603,193],[602,192],[602,192]],[1,23,["#cc6969",4,1],[503,272],[506,258],[511,242],[516,225],[518,216],[519,213],[522,215],[525,228],[530,245],[533,262],[535,269],[535,272],[535,272]],[1,24,["#cc6969",4,1],[515,258],[516,258],[522,258],
[529,258],[533,258],[533,259],[533,259]],[1,26,["#cc6969",4,1],[553,245],[550,245],[545,245],[541,248],[539,258],[542,266],[552,272],[558,271],[561,270]],[1,29,["#cc6969",4,1],[565,221],[565,235],[567,251],[568,258],[568,260],[568,262],[568,260],[568,260]],[1,30,["#cc6969",4,1],[552,238],[562,238],[570,235],[576,235],[578,235]],[1,31,["#cc6969",4,1],[586,244],[587,251],[588,259],[588,263],[588,264]],[1,32,["#cc6969",4,1],[588,224],[585,222],[584,223],[584,225],[585,227],[588,227],[590,226],[590,225],
[587,224],[586,225],[586,225]],[1,37,["#cc6969",4,1],[596,241],[600,247],[604,254],[605,260],[607,264],[608,265],[608,264],[608,258],[609,251],[612,242],[612,238]],[1,38,["#cc6969",4,1],[622,239],[623,246],[624,252],[625,259],[625,262],[625,262],[625,262]],[1,39,["#cc6969",4,1],[620,225],[619,225],[618,225],[616,226],[616,228],[618,231],[619,231],[622,229],[622,228],[622,226],[620,225],[619,225]],[1,40,["#cc6969",4,1],[635,211],[638,227],[639,240],[641,252],[642,255]],[1,41,["#cc6969",4,1],[629,232],
[631,232],[636,232],[645,230],[649,228]],[1,49,["#cc6969",4,1],[653,235],[652,238],[652,242],[655,248],[665,251],[672,250],[678,242],[678,238],[678,235],[678,234],[678,233],[678,235],[679,239],[682,248],[683,262],[680,272],[672,279],[661,280],[652,278],[649,274],[650,271],[654,270]]],es:[...GPAssets_.GIRL_PORTRAIT,[1,200,["#cc6969",4,1],[400,217],[402,203],[406,174],[412,152],[417,134],[420,129],[421,128],[422,132],[425,148],[428,172],[433,195],[438,211],[439,214],[438,215],[437,215],[437,215]],[1,
201,["#cc6969",4,1],[411,195],[420,195],[427,195],[432,195],[434,195],[435,195]],[1,202,["#cc6969",4,1],[463,187],[463,181],[460,175],[455,172],[448,172],[444,179],[443,189],[445,199],[452,205],[461,205],[463,203],[463,203]],[1,203,["#cc6969",4,1],[472,152],[474,169],[477,188],[478,205],[479,210],[479,210],[479,208],[479,208]],[1,204,["#cc6969",4,1],[457,164],[461,164],[469,164],[476,164],[481,164],[484,165]],[1,205,["#cc6969",4,1],[491,174],[492,182],[494,192],[495,198],[495,202],[495,202]],[1,206,
["#cc6969",4,1],[493,152],[492,150],[491,148],[489,148],[489,150],[491,153],[494,152],[495,148],[492,146],[489,147]],[1,207,["#cc6969",4,1],[503,170],[504,174],[507,182],[511,193],[511,198],[513,202],[514,203],[514,202],[516,195],[518,187],[521,174],[521,168],[521,166],[521,166],[521,166]],[1,208,["#cc6969",4,1],[532,167],[534,175],[535,186],[536,195],[536,197],[536,197]],[1,209,["#cc6969",4,1],[560,175],[554,171],[551,169],[548,169],[545,175],[545,183],[546,189],[550,196],[555,198],[562,194],[564,
187],[564,179],[563,178]],[1,210,["#cc6969",4,1],[565,184],[565,172],[563,156],[562,146],[560,139],[560,138],[560,138]],[1,211,["#cc6969",4,1],[577,172],[576,164],[578,159],[585,156],[590,157],[596,167],[598,178],[599,188],[600,192]],[1,212,["#cc6969",4,1],[594,181],[588,178],[582,178],[577,178],[575,181],[574,186],[574,190],[580,193],[586,193],[591,192],[594,190]],[1,213,["#cc6969",4,1],[629,178],[621,172],[616,172],[611,172],[609,175],[607,182],[609,188],[613,192],[621,193],[625,192],[628,190],
[629,189],[631,188],[631,186],[631,185]],[1,214,["#cc6969",4,1],[632,188],[631,171],[629,153],[629,138],[629,135],[630,135],[630,135]],[1,215,["#cc6969",4,1],[412,244],[409,238],[403,236],[395,238],[385,244],[382,249],[382,253],[387,254],[398,256],[408,260],[418,268],[421,277],[417,282],[403,282],[388,278],[382,275],[381,274],[382,273],[382,273]],[1,216,["#cc6969",4,1],[445,262],[443,258],[440,257],[436,257],[431,258],[429,262],[428,265],[428,268],[430,272],[434,274],[437,275],[441,275],[445,273],
[447,268],[447,264],[447,262],[446,260]],[1,217,["#cc6969",4,1],[472,252],[466,249],[461,250],[458,254],[458,257],[461,258],[468,262],[473,265],[476,270],[472,275],[465,275],[460,275],[459,273],[459,273]],[1,218,["#cc6969",4,1],[485,261],[488,272],[489,280],[489,284],[489,285]],[1,219,["#cc6969",4,1],[486,264],[484,258],[485,254],[491,250],[495,250],[502,252],[505,257],[506,262],[501,268],[494,271],[488,272],[487,272]],[1,220,["#cc6969",4,1],[523,261],[528,257],[530,253],[531,250],[528,248],[523,
249],[517,252],[515,258],[515,265],[521,272],[529,275],[534,274],[536,272],[536,271],[536,271]],[1,221,["#cc6969",4,1],[559,251],[553,250],[548,250],[544,252],[542,258],[543,262],[548,267],[554,268],[560,268],[562,266],[562,266],[562,266]],[1,222,["#cc6969",4,1],[569,233],[571,241],[573,252],[574,261],[576,266],[576,266],[576,264],[576,258],[579,251],[584,248],[590,248],[594,252],[597,260],[597,265],[597,270],[597,270],[597,270]],[1,223,["#cc6969",4,1],[617,250],[615,248],[612,248],[609,250],[607,
252],[607,257],[609,262],[612,264],[618,265],[622,265],[626,263],[627,259],[626,254],[623,251],[619,250],[619,250],[619,250]],[1,224,["#cc6969",4,1],[647,249],[647,246],[644,245],[639,245],[635,247],[634,250],[634,252],[641,255],[646,258],[649,262],[650,267],[644,270],[637,270],[634,268],[633,265],[634,264],[634,264]],[1,225,["#cc6969",4,1],[660,248],[659,247],[659,243],[660,240],[663,238],[668,238],[673,246],[676,254],[677,260],[678,265],[678,267]],[1,226,["#cc6969",4,1],[674,256],[669,254],[664,
252],[662,252],[659,253],[658,258],[659,262],[664,268],[669,268],[676,266],[678,264],[678,262],[678,262]],[1,227,["#cc6969",4,1],[530,152],[529,151],[528,151],[526,152],[526,155],[530,158],[531,158],[532,156],[532,153],[532,151],[530,150],[529,150],[529,152],[530,152],[530,152]]]};
GPAssets_.AC_FORGERY_PH={ru:[...GPAssets_.GIRL_PORTRAIT,[1,200,["#cc6969",4,1],[425,196.5],[425,200],[425.5,203.5],[426.5,207.5],[427,212.5],[427.5,217],[427.5,221.5],[428,226],[428,228.5],[428,230.5],[428,230.5],[428,230.5],[428,230]],[1,201,["#cc6969",4,1],[427.5,196.5],[427.5,196],[428.5,196],[430,196],[432.5,196],[436.5,195],[439,195],[440.5,194.5],[442,194.5],[442.5,194.5],[443,194.5],[443,195],[443,195.5],[442.5,196],[442.5,198.5],[442.5,201],[442.5,203.5],[442.5,206],[442.5,209.5],[443,214],
[443,217],[443,220],[443,222.5],[443,226],[443.5,227.5],[444,228],[444,229],[444.5,229],[444.5,229.5],[444.5,229],[444.5,228.5]],[1,202,["#cc6969",4,1],[458,212.5],[457,213.5],[456.5,216.5],[456.5,219],[456.5,221],[456.5,223],[457.5,224.5],[460,226.5],[461.5,227],[463.5,227.5],[465.5,227],[468,226],[468.5,225],[470,222.5],[470.5,220.5],[471,218.5],[470.5,215],[470,213.5],[468,212.5],[466.5,211.5],[463.5,211.5],[461.5,211.5],[460.5,212.5],[459.5,214],[459.5,215]],[1,203,["#cc6969",4,1],[492,214],[491,
212],[490.5,211],[488,211],[486.5,211],[484,211.5],[483,213],[482,215],[481,217.5],[480.5,221.5],[481,223.5],[482,225.5],[485,227],[487,227.5],[489,227.5],[490.5,227],[491.5,226],[493,223.5],[493.5,221.5],[494,218.5],[494,216],[494,214.5],[494,215],[494,216],[494.5,217],[495,220],[496,225],[497.5,228.5],[499.5,232.5],[501.5,235.5],[505,239.5],[506.5,241.5],[507.5,243],[507.5,244],[507,244.5],[506,245],[503,245],[500,245],[497.5,245],[493.5,245],[492,244],[491,243],[491,241.5],[491,239.5],[492,237],
[494,235.5],[495.5,235]],[1,204,["#cc6969",4,1],[518,213],[517,211],[516.5,210],[514,210],[512.5,210],[510,210.5],[509,212],[508,214],[507,216.5],[506.5,220.5],[507,222.5],[508,224.5],[511,226],[513,226.5],[515,226.5],[516.5,226],[517.5,225],[519,222.5],[519.5,220.5],[520,217.5],[520,215],[520,213.5],[520,214],[520,215],[520.5,216],[521,219],[522,224],[523.5,227.5],[525.5,231.5],[527.5,234.5],[531,238.5],[532.5,240.5],[533.5,242],[533.5,243],[533,243.5],[532,244],[529,244],[526,244],[523.5,244],[519.5,
244],[518,243],[517,242],[517,240.5],[517,238.5],[518,236],[520,234.5],[521.5,234]],[1,205,["#cc6969",4,1],[536.5,217.5],[537.5,217],[539.5,215.5],[541.5,215],[542.5,214],[543.5,213],[544,212.5],[544,211.5],[544,211],[543,210.5],[541.5,209.5],[539.5,209.5],[538.5,209.5],[537,210],[536,211],[535,211.5],[533.5,213],[533,214.5],[533,215.5],[533,217.5],[534,220],[535,222],[536,223],[537,223.5],[539,224],[540.5,224],[543,224],[544,223],[546,222.5],[548,222]],[1,206,["#cc6969",4,1],[560.5,209.5],[560,212.5],
[559.5,214.5],[559.5,217],[559,219],[558,222],[558,223],[558,223.5],[558,224]],[1,207,["#cc6969",4,1],[562.5,208.5],[565,212.5],[567.5,216],[569,218],[570.5,220],[571.5,221.5],[572.5,223],[572.5,223.5],[573,224],[573,224.5]],[1,208,["#cc6969",4,1],[579,207],[578.5,206.5],[579,207.5],[580,209.5],[581.5,213.5],[583,218.5],[583.5,221.5],[584,223.5],[584,225],[584,226],[584,226.5],[584,225.5],[584,225]],[1,209,["#cc6969",4,1],[588,205],[590,205.5],[590,206.5],[590,207.5],[590,210],[589.5,212],[588.5,
214],[588,215.5],[587.5,217],[587,218],[586.5,218.5],[586,219],[586,219.5],[586.5,219.5],[587,219.5],[587.5,219.5],[588.5,220],[590.5,221],[592,222],[594,223],[594.5,223.5],[596,224],[597,225]],[1,210,["#cc6969",4,1],[614.5,211],[612,208],[610.5,206.5],[609.5,206],[607.5,205.5],[606,205.5],[605.5,206],[604,206.5],[603.5,208],[603.5,209.5],[603.5,213],[603.5,215.5],[604,217.5],[605.5,220],[606,221],[607,222],[608,222],[609,222],[610.5,221.5],[612,220],[612.5,218.5],[613.5,217],[614,214.5],[614,212.5],
[614,211],[614,210],[614,210.5],[615,212],[615,214],[615.5,217.5],[615.5,219],[616,220],[616,221.5],[616.5,222],[616.5,222],[617,222],[617,222.5]]],en:[...GPAssets_.GIRL_PORTRAIT,[1,45,["#cc6969",4,1],[440,243],[439,245],[438,243],[435,232],[433,213],[432,186],[435,169],[438,160],[443,157],[448,158],[452,165],[456,178],[458,190],[460,198],[460,201]],[1,46,["#cc6969",4,1],[427,210],[437,210],[442,210]],[1,49,["#cc6969",4,1],[460,215],[458,215],[455,215],[450,218],[448,222],[448,228],[452,235],[458,
241],[466,241],[472,238],[476,229],[475,223],[468,217],[464,215],[461,215],[461,215]],[1,72,["#cc6969",4,1],[482,212],[482,216],[485,225],[488,232],[489,235],[489,235],[489,232],[488,225],[487,218],[488,212],[492,210],[496,208],[498,208],[498,208],[499,209],[501,209],[502,209],[502,211],[502,211]],[1,75,["#cc6969",4,1],[519,215],[514,213],[509,213],[505,215],[504,222],[505,227],[509,233],[515,234],[521,232],[525,228],[525,225],[523,222],[522,221],[525,223],[528,230],[531,241],[529,252],[521,258],
[508,262],[502,260],[499,255],[499,252],[503,249],[508,248],[512,248],[512,248]],[1,78,["#cc6969",4,1],[538,222],[543,221],[548,218],[551,213],[551,208],[547,206],[539,206],[535,212],[532,222],[532,228],[539,234],[548,235],[556,232],[561,229],[561,228],[561,228]],[1,79,["#cc6969",4,1],[559,211],[559,212],[562,215],[566,224],[568,229],[568,231],[568,229],[565,224],[565,216],[566,210],[572,208],[579,208],[584,208],[584,207],[584,207]],[1,80,["#cc6969",4,1],[579,217],[579,218],[581,223],[585,227],[592,
228],[598,225],[602,218],[603,213],[602,211],[600,210],[600,212],[605,218],[608,228],[610,244],[606,253],[595,258],[586,258],[581,257],[580,248],[584,243],[592,240],[599,240],[603,240],[603,240],[603,240]]],es:[...GPAssets_.GIRL_PORTRAIT,[1,117,["#cc6969",4,1],[438,205],[441,225],[445,246],[445,254]],[1,120,["#cc6969",4,1],[436,208],[442,202],[449,199],[459,199],[466,205],[468,215],[463,224],[454,228],[449,228],[448,228],[448,228]],[1,122,["#cc6969",4,1],[472,196],[473,209],[477,224],[480,236],[481,
245]],[1,125,["#cc6969",4,1],[484,220],[484,215],[488,210],[495,208],[501,211],[508,219],[511,228],[512,234],[512,235],[511,238],[511,238]],[1,126,["#cc6969",4,1],[508,226],[503,222],[499,222],[495,222],[490,225],[487,229],[485,234],[487,237],[494,240],[501,240],[507,239],[508,238],[509,237]],[1,129,["#cc6969",4,1],[539,218],[538,214],[535,212],[529,210],[525,211],[521,214],[518,219],[518,225],[521,231],[525,234],[533,235],[538,232],[542,228],[542,225]],[1,130,["#cc6969",4,1],[541,218],[541,220],
[543,225],[546,235],[546,245],[542,255],[535,259],[526,259],[522,256],[518,250],[517,246],[519,246],[519,246]],[1,131,["#cc6969",4,1],[552,210],[553,215],[555,222],[558,228]],[1,133,["#cc6969",4,1],[549,195],[549,194],[549,194],[548,194],[547,195],[547,198],[549,198],[552,198],[553,196],[552,194],[552,193],[549,192]],[1,140,["#cc6969",4,1],[578,208],[574,206],[571,206],[567,207],[566,208],[565,213],[565,218],[567,222],[570,226],[575,227],[580,227],[585,225],[588,218],[588,215],[585,208],[582,206]]]};
window.GPAssets_=GPAssets_;class GPAvatarEditor_ extends EventTarget{static AVATAR_WIDTH=42;static AVATAR_HEIGHT=50;static AVATAR_PADDING=1;static AVATAR_SMOOTH_DENSITY=2;static AVATAR_DENSITY=3;static AVATAR_FRAME_WIDTH=46;static AVATAR_FRAME_BORDER_WIDTH=2;static VIEWFINDER_WIDTH=380;static VIEWFINDER_HEIGHT=240;static OVERFLOWING_AREA_BORDER_WIDTH=2;static COLOR_PICKER_UPDATE_INTERVAL=50;static LIVE_PREVIEW_ENABLED=!0;static ZOOM_SENSITIVITY=1.03;static HAS_FOREGROUND=!0;static BACKGROUND_COLOR="#eaf1fd";static AVATAR_TYPE="image/webp";static AVATAR_QUALITY=1;static IMAGE_TYPES=new Set("image/jpeg image/png image/gif image/webp image/svg+xml image/bmp image/avif".split(" "));static IMAGE_TYPES_WITHOUT_TRANSPARENCY=["image/jpeg"];static CHANGE={LOADED:"loaded",
POSITION:"position",SCALE:"scale",RESET:"reset",MIRROR:"mirror",FOREGROUND:"foreground",BACKGROUND:"background",SMOOTHING:"smoothing"};static REQUEST_TYPE={REVIEW:"review",REMOVAL:"removal"};constructor(a,b,c,d,e,f){super();this.l=f;GPUtils_.bindMethods([this.updatePreview,this.onZoomerChange,this.onZoomerReset,this.handleFile],this);this.livePreviewEnabled=a??GPAvatarEditor_.LIVE_PREVIEW_ENABLED;this.zoomSensitivity=b??GPAvatarEditor_.ZOOM_SENSITIVITY;this.hasForeground=d??GPAvatarEditor_.HAS_FOREGROUND;
this.backgroundColor=e??GPAvatarEditor_.BACKGROUND_COLOR;this.previewCanvas=null;this.isNativeAvatar=this.isChanged=this.isDragging=!1;this.nativeAvatarId=null;this.addEventListener("change",({detail:{type:g}})=>{this.hasForeground?g!==GPAvatarEditor_.CHANGE.BACKGROUND&&this.setOpaqueBackgroundState(this.hasOpaqueBackground()):this.setOpaqueBackgroundState(!1);this.clearSubmitMessage()});this.render(c);this.updateAvatarViews()}getElement(){return this.container}render(a){this.container=document.createElement("div");
this.container.className="avatar-editor_";this.container.dataset.lang=this.l.lang;this.container.classList.toggle("has-foreground_",this.hasForeground);this.container.style.setProperty("--av-editor-viewfinder-width",`${GPAvatarEditor_.VIEWFINDER_WIDTH}px`);this.container.style.setProperty("--av-editor-viewfinder-height",`${GPAvatarEditor_.VIEWFINDER_HEIGHT}px`);this.container.style.setProperty("--av-editor-focus-width",`${GPAvatarEditor_.AVATAR_WIDTH*GPAvatarEditor_.AVATAR_DENSITY}px`);this.container.style.setProperty("--av-editor-focus-height",
`${GPAvatarEditor_.AVATAR_HEIGHT*GPAvatarEditor_.AVATAR_DENSITY}px`);this.container.style.setProperty("--av-editor-focus-frame-width",`${GPAvatarEditor_.AVATAR_FRAME_WIDTH*GPAvatarEditor_.AVATAR_DENSITY}px`);this.container.style.setProperty("--av-editor-focus-frame-border-width",`${GPAvatarEditor_.AVATAR_FRAME_BORDER_WIDTH*GPAvatarEditor_.AVATAR_DENSITY}px`);this.container.style.setProperty("--av-editor-focus-frame-shadow-radius",`${(Math.ceil(Math.sqrt(GPAvatarEditor_.VIEWFINDER_WIDTH**2+GPAvatarEditor_.VIEWFINDER_HEIGHT**
2))-GPAvatarEditor_.AVATAR_FRAME_WIDTH)/2}px`);this.container.style.setProperty("--av-editor-overflowing-area-width",`${GPAvatarEditor_.AVATAR_WIDTH*GPAvatarEditor_.AVATAR_DENSITY+2*GPAvatarEditor_.OVERFLOWING_AREA_BORDER_WIDTH}px`);this.container.style.setProperty("--av-editor-overflowing-area-height",`${(GPAvatarEditor_.AVATAR_HEIGHT-GPAvatarEditor_.AVATAR_WIDTH/2)*GPAvatarEditor_.AVATAR_DENSITY+2*GPAvatarEditor_.OVERFLOWING_AREA_BORDER_WIDTH}px`);this.container.style.setProperty("--av-editor-overflowing-area-border-width",
`${GPAvatarEditor_.OVERFLOWING_AREA_BORDER_WIDTH}px`);this.container.style.setProperty("--av-editor-avatar-background",this.backgroundColor);this.viewfinder=document.createElement("div");this.viewfinder.className="viewfinder_";this.container.appendChild(this.viewfinder);this.viewfinder.addEventListener("pointerdown",g=>{if(0!==g.button||g.ctrlKey)(1===g.button||0===g.button&&g.ctrlKey)&&this.isChanged&&this.saveCanvas(this.previewCanvas);else{this.isDragging=!0;this.livePreviewEnabled||(this.clearViewfinderFocus(),
this.focusFrame.classList.remove("rendered_"));const h=g.pageX,k=g.pageY;this.viewfinder.addEventListener("pointerup",l=>{this.isDragging=!1;if(h!==l.pageX||k!==l.pageY)this.onZoomerChange(l)},{once:!0})}});this.viewfinder.addEventListener("wheel",g=>{this.onZoomerChange(g);!this.livePreviewEnabled&&this.isDragging&&this.clearViewfinderFocus()});const b=this.container;let c;b.addEventListener("dragenter",g=>{g.preventDefault();c=g.target;b.classList.add("drop_")});b.addEventListener("dragleave",g=>
{g.target===c&&(g.preventDefault(),b.classList.remove("drop_"))});b.addEventListener("drop",g=>{g.preventDefault();this.handleFile(g);b.classList.remove("drop_")});b.addEventListener("dragover",g=>{g.preventDefault();g.dataTransfer.dropEffect="move"});this.source=document.createElement("canvas");this.source.className="source_ inactive_";this.source.width=GPAvatarEditor_.VIEWFINDER_WIDTH;this.source.height=GPAvatarEditor_.VIEWFINDER_HEIGHT;this.viewfinder.appendChild(this.source);this.source.addEventListener("pointerdown",
g=>{this.isNativeAvatar&&g.stopImmediatePropagation()});this.source.addEventListener("wheel",g=>{this.isNativeAvatar&&g.stopImmediatePropagation()});this.source.addEventListener("contextmenu",g=>{this.isNativeAvatar&&(g.stopImmediatePropagation(),g.preventDefault())});this.sourceCtx=this.source.getContext("2d");this.zoomer=new GPCanvasZoomer_(this.source,null,this.zoomSensitivity,a);this.zoomer.addEventListener("change",this.onZoomerChange);this.zoomer.addEventListener("reset",this.onZoomerReset);
a=document.createElement("div");a.className="blackout_";this.viewfinder.appendChild(a);a=document.createElement("div");a.className="overflowing-area_";this.viewfinder.appendChild(a);this.focusFrame=document.createElement("div");this.focusFrame.className="focus-frame_";this.viewfinder.appendChild(this.focusFrame);this.focus=document.createElement("canvas");this.focus.className="focus_";this.focus.width=GPAvatarEditor_.AVATAR_WIDTH*GPAvatarEditor_.AVATAR_DENSITY*2;this.focus.height=GPAvatarEditor_.AVATAR_HEIGHT*
GPAvatarEditor_.AVATAR_DENSITY*2;this.viewfinder.appendChild(this.focus);this.focusCtx=this.focus.getContext("2d");this.focusCtx.imageSmoothingQuality="high";this.preview=document.createElement("div");this.preview.className="preview_";this.preview.innerHTML='<div class="user_"><div class="avatar_"><div class="icon_"></div></div></div>';this.container.appendChild(this.preview);this.previewAvatar=this.preview.querySelector(".icon_");a=document.createElement("div");a.className="buttons_";this.fgModeBtn=
document.createElement("div");this.fgModeBtn.className="fg-mode_ btn_";this.fgModeBtn.title=this.l.FG_MODE_BTN_TTL;this.fgModeBtn.addEventListener("click",g=>{this.isNativeAvatar||this.toggleForegroundMode()});a.appendChild(this.fgModeBtn);var d=document.createElement("div");d.className="mirror_ btn_";d.title=this.l.MIRROR_BTN_TTL;d.addEventListener("click",g=>{this.isNativeAvatar||this.mirror()});a.appendChild(d);const e=document.createElement("input");e.className="bg-color-input_";e.type="color";
e.addEventListener("input",g=>{this.container.style.setProperty("--av-editor-avatar-background",g.target.value);clearTimeout(this.bgColorTimer);this.bgColorTimer=setTimeout(()=>{this.setBackground(g.target.value,!1)},GPAvatarEditor_.COLOR_PICKER_UPDATE_INTERVAL)});e.addEventListener("change",g=>{clearTimeout(this.bgColorTimer);this.setBackground(g.target.value)});d=document.createElement("div");d.className="bg-color_ btn_";d.title=this.l.BG_COLOR_BTN_TTL;d.appendChild(e);d.addEventListener("click",
g=>{this.isNativeAvatar||e.showPicker()});a.appendChild(d);const f=document.createElement("input");f.type="file";f.accept=[...GPAvatarEditor_.IMAGE_TYPES].join();f.addEventListener("change",this.handleFile);d=document.createElement("div");d.className="open-image_ btn_";d.title=this.l.OPEN_IMAGE_BTN_TTL;d.addEventListener("click",g=>{f.click()});a.appendChild(d);this.container.appendChild(a);this.dragFileHint=document.createElement("div");this.dragFileHint.className="drag-file-hint_";this.dragFileHint.textContent=
this.l.DRAG_FILE_HINT;this.dragFileHint.addEventListener("click",g=>{f.click()});this.container.appendChild(this.dragFileHint);this.submitStatus=document.createElement("div");this.submitStatus.className="submit-status_";this.submitStatus.addEventListener("pointerdown",g=>{"A"!==g.target.tagName&&this.submitStatus.classList.add("fade-out_")});this.submitStatus.addEventListener("animationend",g=>{"av_fade-out_"===g.animationName&&(this.submitStatus.classList.remove("fade-out_"),delete this.submitStatus.dataset.status)});
this.container.appendChild(this.submitStatus)}showSuccessMessage(a){this.submitStatus.dataset.status="success";if("review"===a){const [b,c]=this.l.AVATAR_SUBMITTED.split("|");this.submitStatus.innerHTML=`<div class="message_">${b}<div class="hint_">${c}</div></div>`}else this.submitStatus.innerHTML=`<div class="message_">${this.l.REQUEST_SUBMITTED}</div>`}showErrorMessage(a){this.submitStatus.dataset.status="error";const b=this.l.REQUEST_FAILED_HINT.replace("discord.com",'<a href="https://discord.com" target="_blank" rel="noreferrer">$&</a>');
this.submitStatus.innerHTML=`<div class="message_">${"review"===a?this.l.AVATAR_FAILED:this.l.REQUEST_FAILED}<div class="hint_">${b}</div></div>`}clearSubmitMessage(){delete this.submitStatus.dataset.status}buildAvatar(){const a=GPAvatarEditor_.AVATAR_SMOOTH_DENSITY;var b=GPAvatarEditor_.AVATAR_WIDTH*GPAvatarEditor_.AVATAR_DENSITY*a,c=GPAvatarEditor_.AVATAR_HEIGHT*GPAvatarEditor_.AVATAR_DENSITY*a;const d=b/2,e=document.createElement("canvas");e.width=b;e.height=c;var f=e.getContext("2d");f.beginPath();
f.arc(d,c-d,d,0,2*Math.PI);f.fill();(this.hasForeground||this.isNativeAvatar)&&f.fillRect(0,0,b,c-b/2);f=document.createElement("canvas");f.width=b;f.height=c;const g=f.getContext("2d");g.fillStyle=this.isNativeAvatar?"rgb(234, 241, 253)":this.backgroundColor;g.beginPath();g.arc(d,c-d,d,0,2*Math.PI);g.fill();g.drawImage(this.source,(GPAvatarEditor_.VIEWFINDER_WIDTH-b/a)/2,(GPAvatarEditor_.VIEWFINDER_HEIGHT-(c/a*2-b/a))/2,b/a,c/a,0,0,b,c);g.globalCompositeOperation="destination-in";g.drawImage(e,0,
0);b=document.createElement("canvas");b.width=f.width/a+2*GPAvatarEditor_.AVATAR_PADDING*GPAvatarEditor_.AVATAR_DENSITY;b.height=f.height/a;c=b.getContext("2d");c.imageSmoothingQuality="high";c.drawImage(f,GPAvatarEditor_.AVATAR_PADDING*GPAvatarEditor_.AVATAR_DENSITY,0,f.width/a,f.height/a);return b}saveCanvas(a){const b=document.createElement("canvas");b.width=a.width;b.height=a.height;b.getContext("2d").drawImage(a,0,0,a.width,a.height);a=document.createElement("a");a.href=b.toDataURL(GPAvatarEditor_.AVATAR_TYPE,
GPAvatarEditor_.AVATAR_QUALITY);a.download=`gp-avatar.${GPAvatarEditor_.AVATAR_TYPE.split("/")[1]}`;a.click()}onZoomerChange(a){if("change"===a.type||0===a.button)if(this.livePreviewEnabled||"pointerup"===a.type||"wheel"===a.type){this.updateAvatarViews();let b;switch(a.type){case "pointerup":b=GPAvatarEditor_.CHANGE.POSITION;break;case "wheel":b=GPAvatarEditor_.CHANGE.SCALE}b&&this.dispatchChange(b)}}onZoomerReset(a){this.dispatchChange(GPAvatarEditor_.CHANGE.RESET)}updateAvatarViews(){this.updateViewfinderFocus();
this.updatePreview()}updatePreview(){this.previewCanvas=this.buildAvatar();const a=this.previewCanvas.toDataURL(GPAvatarEditor_.AVATAR_TYPE,GPAvatarEditor_.AVATAR_QUALITY);this.previewAvatar.style.backgroundImage=`url(${a})`}updateViewfinderFocus(){this.focusFrame.classList.add("rendered_");this.focusCtx.save();const a=GPAvatarEditor_.AVATAR_WIDTH*GPAvatarEditor_.AVATAR_DENSITY*2,b=GPAvatarEditor_.AVATAR_HEIGHT*GPAvatarEditor_.AVATAR_DENSITY*2,c=a/2,d=document.createElement("canvas");d.width=a;d.height=
b;const e=d.getContext("2d");e.beginPath();e.arc(c,b-c,c,0,2*Math.PI);e.fill();(this.hasForeground||this.isNativeAvatar)&&e.fillRect(0,0,a,b-a/2);this.focusCtx.clearRect(0,0,a,b);this.focusCtx.fillStyle=this.isNativeAvatar?"rgb(234, 241, 253)":this.backgroundColor;this.focusCtx.beginPath();this.focusCtx.arc(c,b-c,c,0,2*Math.PI);this.focusCtx.fill();this.focusCtx.drawImage(this.source,(GPAvatarEditor_.VIEWFINDER_WIDTH-a/2)/2,(GPAvatarEditor_.VIEWFINDER_HEIGHT-(b/2*2-a/2))/2,a/2,b/2,0,0,a,b);this.focusCtx.globalCompositeOperation=
"destination-in";this.focusCtx.drawImage(d,0,0);this.focusCtx.restore()}clearViewfinderFocus(){this.focusCtx.clearRect(0,0,this.focus.width,this.focus.height)}setSource(a){const b=new Image;b.src=a;b.decode().then(()=>{this.isNativeAvatar=!1;this.nativeAvatarId=null;this.zoomer.setImage(b);this.updateAvatarViews();this.isChanged||(this.dragFileHint.classList.add("hidden"),this.isChanged=!0);this.container.classList.remove("is-native-avatar_");this.dispatchChange(GPAvatarEditor_.CHANGE.LOADED)})}setNativeAvatar(a,
b){this.isNativeAvatar=!0;this.nativeAvatarId=b;this.container.classList.add("is-native-avatar_");this.zoomer.setImage(a);this.zoomer.matrix=this.zoomer.matrix.translate(0,-((GPAvatarEditor_.AVATAR_HEIGHT-GPAvatarEditor_.AVATAR_WIDTH)*GPAvatarEditor_.AVATAR_DENSITY/2/4*3));this.zoomer.redraw();this.updateAvatarViews();this.isChanged||(this.dragFileHint.classList.add("hidden"),this.isChanged=!0);this.dispatchChange(GPAvatarEditor_.CHANGE.LOADED)}async imageCantHaveAlphaChannel(a){return GPAvatarEditor_.IMAGE_TYPES_WITHOUT_TRANSPARENCY.includes(a.type)?
!0:!1}pngHasAlpha(a){a=new DataView(a);if(2303741511===a.getUint32(0)&&218765834===a.getUint32(4))return a=a.getUint8(25),4===a||6===a}async handleFile(a){a.preventDefault();a=a.target.files||a.dataTransfer.files;if(a?.length&&(a=Array.from(a).find(b=>GPAvatarEditor_.IMAGE_TYPES.has(b.type)))){const b=await this.imageCantHaveAlphaChannel(a);b&&this.setForegroundState(!1);this.changeFgModeBtnState(b);const c=new FileReader;c.addEventListener("loadend",d=>{this.setSource(c.result)});c.readAsDataURL(a)}}dispatchChange(a){!this.isChanged||
this.isNativeAvatar&&a!==GPAvatarEditor_.CHANGE.LOADED||this.dispatchEvent(new CustomEvent("change",{detail:{type:a}}))}setLivePreview(a){this.livePreviewEnabled=!!a}setBackground(a,b=!0){this.backgroundColor=a;this.isDragging||(this.updateAvatarViews(),b&&this.dispatchChange(GPAvatarEditor_.CHANGE.BACKGROUND));this.dispatchEvent(new CustomEvent("background_color_changed",{detail:{backgroundColor:a}}))}setForegroundState(a){a!==this.hasForeground&&(this.hasForeground=a,this.container.classList.toggle("has-foreground_",
this.hasForeground),this.updateAvatarViews(),this.dispatchChange(GPAvatarEditor_.CHANGE.FOREGROUND),this.dispatchEvent(new CustomEvent("foreground_mode_changed",{detail:{foregroundMode:a}})))}setOpaqueBackgroundState(a){this.container.classList.toggle("has-opaque-background_",a);this.dispatchEvent(new CustomEvent("opaque_bg_blocker_update",{detail:{state:a}}))}hasOpaqueBackground(){var a=this.previewCanvas.getContext("2d");const b=a.getImageData(0,0,a.canvas.width,a.canvas.height).data,c=GPAvatarEditor_.AVATAR_PADDING*
GPAvatarEditor_.AVATAR_DENSITY;a=a.canvas.width-2*c;for(let d=4*c;d<4*(a+c);d+=8)if(255!==b[d+3])return!1;return!0}setZoomSensitivity(a){this.zoomSensitivity=a;this.zoomer.setScaleFactor(a)}setImageSmoothing(a){this.zoomer.setImageSmoothing(a);this.updateAvatarViews();this.dispatchChange(GPAvatarEditor_.CHANGE.SMOOTHING)}toggleForegroundMode(){this.setForegroundState(!this.hasForeground)}changeFgModeBtnState(a){this.fgModeBtn.classList.toggle("disabled_",!!a)}mirror(){this.zoomer.mirror();this.updateAvatarViews();
this.dispatchChange(GPAvatarEditor_.CHANGE.MIRROR)}requestAvatar(){return new Promise((a,b)=>{if(!this.isChanged)return b();this.previewCanvas.toBlob(a,GPAvatarEditor_.AVATAR_TYPE,GPAvatarEditor_.AVATAR_QUALITY)})}getNativeAvatarId(){return this.nativeAvatarId??window.localStorage.getItem("avatar")??0}setNativeAvatarId(a){window.localStorage.setItem("avatar",a)}getPreviewCanvas(){return this.previewCanvas}isNativeAvatar;}window.GPAvatarEditor_=GPAvatarEditor_;class GPAvatars_ extends EventTarget{static AVATARS_BASE_URL="https://gpmod.github.io/avatars";static NATIVE_AVATARS_BASE_URL="https://garticphone.com/images/avatar";static REQUEST_TYPE={REVIEW:"review",REMOVAL:"removal"};static DEFAULT_SETTINGS={zoomSensitivity:1.03,livePreview:!0,imageSmoothing:!0,hasForeground:!1,backgroundColor:"#cb55e2",latestNativeAvatarId:61};static SETTINGS_UI={editor:{type:"component",getElement:this.getEditor},reviewButtons:{type:"buttons",getButtons:this.getButtons},_:{size:"small"},
livePreview:{type:"switch",description:"\u0412\u043a\u043b\u044e\u0447\u0438\u0442\u044c \u0433\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u044e \u043f\u0440\u0435\u0432\u044c\u044e \u0430\u0432\u0430\u0442\u0430\u0440\u0430 \u0432 \u0440\u0435\u0430\u043b\u044c\u043d\u043e\u043c \u0432\u0440\u0435\u043c\u0435\u043d\u0438\n\u0412\u043b\u0438\u044f\u0435\u0442 \u043d\u0430 \u043f\u0440\u043e\u0438\u0437\u0432\u043e\u0434\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u044c \u043f\u0440\u0438 \u043f\u043e\u0437\u0438\u0446\u0438\u043e\u043d\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0438 \u0430\u0432\u0430\u0442\u0430\u0440\u0430 \u0432 \u0440\u0435\u0434\u0430\u043a\u0442\u043e\u0440\u0435"},
zoomSensitivity:{type:"slider",args:{min:1.01,max:1.1,step:.01},formatter:this.zoomSensitivityFormatter,description:"\u0427\u0443\u0432\u0441\u0442\u0432\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u044c \u043c\u0430\u0441\u0448\u0442\u0430\u0431\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f \u0430\u0432\u0430\u0442\u0430\u0440\u0430 \u0432 \u0440\u0435\u0434\u0430\u043a\u0442\u043e\u0440\u0435"},imageSmoothing:{type:"switch",description:"\u0412\u043a\u043b\u044e\u0447\u0438\u0442\u044c \u0441\u0433\u043b\u0430\u0436\u0438\u0432\u0430\u043d\u0438\u0435 \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044f"}};static zoomSensitivityFormatter(a){return Math.trunc(100*
(a-1))}static getEditor(){return GPAvatars_.instance.getEditor()}static getButtons(){return[GPAvatars_.instance.reviewBtn,GPAvatars_.instance.nativeAvatarsBtn]}static MODULE={title:"Avatars",alias:"av",dependencies:["GPAvatarEditor_"],settings:{storage:"gp_avatars",defaultSettings:this.DEFAULT_SETTINGS,ui:this.SETTINGS_UI},useCSS:!0};constructor(a){if(GPAvatars_.instance)return GPAvatars_.instance;super();GPAvatars_.instance=this;this.prx=a.prx;this.act=a.act;this.mm=a.mm;this.s=a.sm.setSettings(this,
this.updateSettings);this.baseUrl=null;this.deferredQueue=[];this.avatarStates=new Map;this.pendingStates=new Set;this.isSubscribed=!1;GPUtils_.bindMethods([this.handlePlayer,this.handleAlbumItem,this.submit,this.openNativeAvatarsPanel],this);this.reviewBtn=document.createElement("div");this.reviewBtn.className="av-review-btn_";this.reviewBtn.classList.add("disabled_");this.reviewBtn.classList.toggle("inactivated_",!this.isSubscribed);this.reviewBtn.title=this.l.SUBMIT_BTN_TTL;this.reviewBtn.textContent=
this.l.SUBMIT_BTN;this.reviewBtn.addEventListener("click",this.submit);this.reviewBtn.addEventListener("animationend",()=>{this.reviewBtn.classList.remove("complete_")});this.nativeAvatarsBtn=document.createElement("div");this.nativeAvatarsBtn.className="av-native-btn_";this.nativeAvatarsBtn.classList.toggle("inactivated_",!this.isSubscribed);this.nativeAvatarsBtn.title=this.l.NATIVE_AVATARS_BTN_TTL;this.nativeAvatarsBtn.textContent=this.l.NATIVE_AVATARS_BTN;this.nativeAvatarsBtn.addEventListener("click",
this.openNativeAvatarsPanel);this.prx.isAuthorized&&this.initInitialState(this.prx.getAuthType(),this.prx.getUsername());const b=new GPContentObserver_(a.prx);this.prx.isAuthorized&&(b.addPlayerListHandler(this.handlePlayer),b.addAlbumItemsHandler(this.handleAlbumItem),b.addAlbumRankingHandler(this.handlePlayer),b.getPlayerItems().forEach(c=>{this.handlePlayer(c)}));this.mm.addEventListener("modules_loaded",({detail:{isSubscribed:c}})=>{c&&this.prx.isTwitchOAuth&&(b.addPlayerListHandler(this.handlePlayer),
b.addAlbumItemsHandler(this.handleAlbumItem),b.addAlbumRankingHandler(this.handlePlayer),this.initInitialState(GPProxy_.AUTH_TYPE.TWITCH,this.prx.twitchOAuthLogin),(c=b.getPlayerItems().get(this.prx.getNickname()))&&this.handlePlayer(c),b.getAlbumItems().forEach(d=>{this.handleAlbumItem(d)}),b.getRankingUsers().forEach(d=>{this.handlePlayer(d)}))});this.editor=new GPAvatarEditor_(this.s.livePreview,this.s.zoomSensitivity,this.s.imageSmoothing,this.s.hasForeground,this.s.backgroundColor,this.l);this.editor.addEventListener("foreground_mode_changed",
({detail:{foregroundMode:c}})=>{this.s.hasForeground=c});this.editor.addEventListener("background_color_changed",({detail:{backgroundColor:c}})=>{this.s.backgroundColor=c});this.editor.addEventListener("change",({})=>{this.reviewBtn.classList.remove("disabled_")});this.editor.addEventListener("opaque_bg_blocker_update",({detail:{state:c}})=>{this.reviewBtn.classList.toggle("opaque-bg-blocker_",c)});document.addEventListener("gp:av.submitted",({detail:{type:c}})=>{this.reviewBtn.classList.remove("loading_");
this.reviewBtn.classList.add("complete_");this.editor.showSuccessMessage(c)});document.addEventListener("gp:av.failed",({detail:{type:c}})=>{this.reviewBtn.classList.remove("loading_");this.reviewBtn.classList.remove("disabled_");this.editor.showErrorMessage(c)});document.addEventListener("gp:act.subs_status",({detail:{status:c}})=>{this.isSubscribed=c;this.reviewBtn.classList.toggle("inactivated_",!c);this.nativeAvatarsBtn.classList.toggle("inactivated_",!c);GPAvatars_.toggleSettingsVisibility(c)});
this.addEventListener("url_built",c=>{this.deferredQueue.forEach(([d,e])=>{this.requestAvatarURL(d,e)});this.deferredQueue.length=0},{once:!0})}initInitialState(a,b){this.buildBaseUrl(a);this.requestAvatarURL(b)}buildBaseUrl(a){this.baseUrl=`${GPAvatars_.AVATARS_BASE_URL}/${a?.[0]}`;this.dispatchEvent(new Event("url_built"))}async submit(){if(this.editor.isChanged){this.editor.clearSubmitMessage();if(this.editor.isNativeAvatar){var a=GPAvatars_.REQUEST_TYPE.REMOVAL;var b=this.editor.getNativeAvatarId();
this.editor.setNativeAvatarId(b)}else{a=GPAvatars_.REQUEST_TYPE.REVIEW;var c=await this.editor.requestAvatar()}this.sendRequest(a,c,b);this.reviewBtn.classList.add("loading_");this.reviewBtn.classList.add("disabled_")}}async openNativeAvatarsPanel(){if(!this.nativeAvatarsPanel){var a=await this.getLatestNativeAvatarId();this.s.latestNativeAvatarId=a;const b=document.createDocumentFragment();for(let c=0;c<=a;c++){const d=document.createElement("div");d.className="avatar_";d.dataset.id=c;const e=document.createElement("img");
e.classList.add("loading_");e.src=`${GPAvatars_.NATIVE_AVATARS_BASE_URL}/${c}.svg`;e.crossOrigin="anonymous";e.addEventListener("load",f=>{e.classList.remove("loading_")});d.appendChild(e);b.appendChild(d)}a=document.createElement("div");a.className="gp-native-avatars_";a.addEventListener("click",c=>{if(c.target.matches(".avatar_")){var d=c.target.querySelector("img");d.complete&&0<d.naturalWidth&&this.setNativeAvatar(d,c.target.dataset.id)}});a.appendChild(b);this.nativeAvatarsPanel=GPModalManager_.createModal("native-avatars",
{title:this.l.NATIVE_AVATARS_PANEL_TITLE,icon:"\ud83d\ude0a",content:a})}GPModalManager_.showModal("native-avatars")}async getLatestNativeAvatarId(){let a=this.s.latestNativeAvatarId??0;do{var b=`${GPAvatars_.NATIVE_AVATARS_BASE_URL}/${++a}.svg`;b=(await fetch(b,{method:"HEAD"})).status}while(404!==b);return a-1}setNativeAvatar(a,b){this.editor.setNativeAvatar(a,b)}sendRequest(a,b,c){if(this.isSubscribed){var {authId:d,nick:e}=this.prx.getUser(),f=this.prx.getAuthType(),g=this.act.getKeyHash();if(b){var h=
this.usernameHash(this.prx.formatNickname(e));h=new File([b],`${h}.${b.type.split("/")[1]}`)}document.dispatchEvent(new CustomEvent("gp:av.submit",{detail:{type:a,imageFile:h,avatarId:c,meta:{sender:e,senderId:d,keyHash:g,service:f}}}))}}getEditor(){return this.editor.getElement()}handlePlayer(a){const b=a.querySelector(".avatar > span");a=a.querySelector(".nick")?.textContent;this.prx.isTwitchOAuth?a===this.prx.getNickname()&&this.insertAvatar(this.prx.twitchOAuthLogin,b):(a=this.prx.formatNickname(a),
this.insertAvatar(a,b))}handleAlbumItem(a){const b=a.querySelector(".avatar > span");a=a.querySelector(":scope :is(.answerBalloon, .drawBalloon) > div:not(.avatar) > span")?.textContent;this.prx.isTwitchOAuth?a===this.prx.getNickname()&&this.insertAvatar(this.prx.twitchOAuthLogin,b):(a=this.prx.formatNickname(a),this.insertAvatar(a,b))}insertAvatar(a,b){this.requestAvatarURL(a,c=>{b.style.backgroundImage=`url(${c})`})}requestAvatarURL(a,b){if(this.baseUrl)if(this.pendingStates.has(a)){const c=({detail:{username:d,
url:e,isExists:f}})=>{d===a&&(f&&b?.(e),this.removeEventListener("state_changed",c))};this.addEventListener("state_changed",c)}else{const c=this.buildUrl(a),d=this.avatarStates.get(a);d?b?.(c):void 0===d&&(this.pendingStates.add(a),fetch(c,{method:"HEAD"}).then(e=>{e.ok?(b?.(c),this.avatarStates.set(a,!0)):this.avatarStates.set(a,!1)}).finally(()=>{this.pendingStates.delete(a);this.dispatchEvent(new CustomEvent("state_changed",{detail:{username:a,url:c,isExists:this.avatarStates.get(a)}}))}))}else this.deferredQueue.push([a,
b])}buildUrl(a){a=this.usernameHash(a);return`${this.baseUrl}/${a}`}usernameHash(a){return GPUtils_.computeHash(a,16).toString(36)}updateSettings({detail:{settings:a}}){"livePreview"in a&&this.editor.setLivePreview(a.livePreview);"zoomSensitivity"in a&&this.editor.setZoomSensitivity(a.zoomSensitivity);"imageSmoothing"in a&&this.editor.setImageSmoothing(a.imageSmoothing)}}window.GPAvatars_=GPAvatars_;class GPCanvasZoomer_ extends EventTarget{static SCALE_FACTOR=1.05;static ZOOM_STEP=.1;static IMAGE_SMOOTHING_ENABLED=!0;constructor(a,b,c,d){super();this.canvas=a;this.ctx=a.getContext("2d");this.image=b;this.scaleFactor=c??GPCanvasZoomer_.ZOOM_STEP;this.imageSmoothingEnabled=d??GPCanvasZoomer_.IMAGE_SMOOTHING_ENABLED;this.matrix=new DOMMatrix;this.lastX=a.width/2;this.lastY=a.height/2;this.dragStartPoint=null;this.initEvents();this.redraw()}initEvents(){this.canvas.addEventListener("contextmenu",
a=>{a.preventDefault()});this.canvas.addEventListener("pointerdown",a=>{0!==a.button||a.ctrlKey?2===a.button&&this.reset():(this.canvas.setPointerCapture(a.pointerId),this.dragStartPoint=this.getTransformedPoint(a.offsetX,a.offsetY))});this.canvas.addEventListener("pointermove",a=>{this.lastX=a.offsetX;this.lastY=a.offsetY;this.dragStartPoint&&(a=this.getTransformedPoint(this.lastX,this.lastY),this.matrix=this.matrix.translate(a.x-this.dragStartPoint.x,a.y-this.dragStartPoint.y),this.redraw())});
this.canvas.addEventListener("pointerup",()=>{this.dragStartPoint=null});this.canvas.addEventListener("wheel",a=>{a.preventDefault();const b=this.scaleFactor*(a.ctrlKey?100:a.shiftKey?10:a.altKey?.1:1);this.zoom(-a.deltaY/40*b,b)},{passive:!1})}getTransformedPoint(a,b){return(new DOMPoint(a,b)).matrixTransform(this.matrix.inverse())}redraw(){if(this.image){this.ctx.setTransform(this.matrix);var a=this.getTransformedPoint(0,0),b=this.getTransformedPoint(this.canvas.width,this.canvas.height);this.ctx.clearRect(Math.min(a.x,
b.x),Math.min(a.y,b.y),Math.abs(b.x-a.x),Math.abs(b.y-a.y));this.ctx.imageSmoothingEnabled=this.imageSmoothingEnabled;this.ctx.drawImage(this.image,(this.canvas.width-this.image.naturalWidth)/2,(this.canvas.height-this.image.naturalHeight)/2,this.image.naturalWidth,this.image.naturalHeight);this.dispatchEvent(new Event("change"))}}zoom(a){const b=this.getTransformedPoint(this.lastX,this.lastY);a=Math.pow(this.scaleFactor,a);this.matrix=this.matrix.translate(b.x,b.y).scale(a,a).translate(-b.x,-b.y);
this.redraw()}mirror(){if(this.image){var a=this.getTransformedPoint(this.canvas.width/2,this.canvas.height/2);this.matrix=this.matrix.translate(a.x,a.y).scale(-1,1).translate(-a.x,-a.y);this.redraw()}}reset(){this.matrix=new DOMMatrix;this.redraw();this.dispatchEvent(new Event("reset"))}setImage(a){this.image=a;this.reset()}setScaleFactor(a){this.scaleFactor=a}setImageSmoothing(a){this.imageSmoothingEnabled=!!a;this.redraw()}}window.GPCanvasZoomer_=GPCanvasZoomer_;class GPApp_{static setTooltip(a,b){let c=window.gpSettingsTooltip;c||(c=document.createElement("div"),c.className="gp-ui-tooltip_",document.body.appendChild(c),window.gpSettingsTooltip=c);const d=document.createDocumentFragment();a.split("\n").forEach(m=>{const p=document.createElement("span");p.textContent=m;d.appendChild(p);d.appendChild(document.createTextNode("\n"))});c.innerHTML="";c.appendChild(d);const {x:e,y:f,width:g,height:h}=b.getBoundingClientRect();({height:a}=c.getBoundingClientRect());
const k=b=f-(a-h)/2,l=window.innerHeight;b+a>l-8&&(b=l-a-8);8>b&&(b=8);c.style.top=`${b}px`;c.style.left=`${e+g+12}px`;c.style.setProperty("--offset-top",`${k-b}px`);return c}}window.GPApp_=GPApp_;class GPScreenObserver_ extends EventTarget{constructor(a){if(GPScreenObserver_.instance)return GPScreenObserver_.instance;super();GPScreenObserver_.instance=this;this.prx=a;this.currentScreen=this.findCurrentScreen();this.areModulesLoaded=!1;document.addEventListener("gp:mm.modules_loaded",()=>{this.areModulesLoaded=!0;this.currentScreen&&this.emitScreenChange(this.currentScreen)});this.init()}init(){const a=new MutationObserver((c,d)=>{for(const e of c)if(e.addedNodes.length){c=this.findCurrentScreen(e.target);
if(!c)break;if(c!==this.currentScreen){this.currentScreen=c;this.areModulesLoaded&&this.emitScreenChange(this.currentScreen);break}}}),b=document.querySelector("#content > .screen");a.observe(b,{childList:!0})}findCurrentScreen(a){a??=document.querySelector("#content > .screen");return a?[...a.firstElementChild.firstElementChild.classList].find(b=>!b.startsWith("jsx-")):null}getCurrentScreen(){return this.currentScreen}emitScreenChange(a){a={detail:{screen:a}};this.dispatchEvent(new CustomEvent("screen_changed",
a));document.dispatchEvent(new CustomEvent("gp:screen_changed",a))}}
class GPStaticObserver_{static MONITOR_INTERVAL=200;static MAX_ATTEMPTS=5;static handlers=new Map;static{this.isInitialized=!1,this.timer=null,this.handlers=new Map}static init(){this.so=new GPScreenObserver_;this.so.addEventListener("screen",this.onScreenChange.bind(this));this.isInitialized=!0}static addHandler(a,b,c){a=[a].flat();a.forEach(d=>{const e=this.handlers.get(d)??[];e.push([b,c]);this.handlers.set(d,e)});a.find(d=>d===this.so.getCurrentScreen())&&this.startMonitor([[b,c]])}static removeHandler(a,
b,c){a=[a].flat();a.forEach(d=>{const e=this.handlers.get(d);if(e){var f=e.findIndex(([g,h])=>g===b&&h===c);~f&&(e.splice(f,1),e.length||this.handlers.delete(d))}})}static onScreenChange({detail:{screen:a}}){(a=this.handlers.get(a))?this.startMonitor([...a]):this.stopMonitor()}static startMonitor(a,b=1){this.stopMonitor();a=a.filter(([c,d])=>{(c=document.querySelector(c))&&d(c);return!c});a.length&&b<this.MAX_ATTEMPTS&&(this.timer=setTimeout(()=>{this.startMonitor(a,b+1)},this.MONITOR_INTERVAL))}static stopMonitor(){clearTimeout(this.timer)}static SCREEN={START:"start",
LOBBY:"lobby",FIRST:"first",DRAW:"draw",WRITE:"write",REPLY:"reply",MEMORY:"memory",BOOK:"book",RESULT:"result"};static PRESET={PAINTER_HEADER:[[this.SCREEN.DRAW],".screen .draw .header"],PREVIEW:[[this.SCREEN.WRITE,this.SCREEN.MEMORY],".screen :is(.write, .memory) .core > div"]};constructor(){GPStaticObserver_.isInitialized||GPStaticObserver_.init()}addHandler(a,b,c){GPStaticObserver_.addHandler(a,b,c)}removeHandler(a,b,c){GPStaticObserver_.removeHandler(a,b,c)}}
class GPContentObserver_{static SCREEN={START:"start",LOBBY:"lobby",FIRST:"first",DRAW:"draw",WRITE:"write",REPLY:"reply",MEMORY:"memory",BOOK:"book",RESULT:"result"};static STAGE_ID={LOBBY:1,GAME:2,GALLERY_SETTINGS:5,ALBUM:3,SCORE:4};static ALBUM_ITEM_TYPE={IMAGE:"image",TEXT:"text",ANIMATION:"animation",MULTI_PIECE:"multi-piece",AI_IMAGE:"ai-image"};constructor(a){if(GPContentObserver_.instance)return GPContentObserver_.instance;GPContentObserver_.instance=this;this.prx=a;this.playerListHandlers=
new Set;this.painterHeaderHandlers=new Set;this.drawingPreviewHandlers=new Set;this.rankingUsersHandlers=new Set;this.albumHeaderHandlers=new Set;this.albumItemsHandlers=new Set;this.albumFooterHandlers=new Set;this.players=new Map;this.albumHeader=this.drawingPreview=this.painterHeader=null;this.albumItems=[];this.albumFooter=null;this.rankingUsers=[];this.nextAlbumItemId=null;this.so=new GPScreenObserver_(a);this.so.addEventListener("screen_changed",({detail:{screen:b}})=>{this.terminate();this.observe(b)});
this.prx.addEventListener("data",({detail:{event:b}})=>{b===GPProxy_.EVENT.ALBUM_INFO&&(this.albumItems.length=0,this.nextAlbumItemId=null)});this.prx.addEventListener("album_item_loading",({detail:{id:b}})=>{this.nextAlbumItemId=b});this.observers={playerList:{observer:new MutationObserver(this.playerListCallback.bind(this)),config:{childList:!0,subtree:!0},selector:"#content > .screen .players",handler:this.handlePlayerList.bind(this),screens:[GPContentObserver_.SCREEN.LOBBY,GPContentObserver_.SCREEN.BOOK,
GPContentObserver_.SCREEN.RESULT],stageIds:[GPContentObserver_.STAGE_ID.LOBBY,GPContentObserver_.STAGE_ID.ALBUM,GPContentObserver_.STAGE_ID.SCORE]},painterHeader:{static:!0,selector:"#content > .screen .draw .book > .header",handler:this.handlePainterHeader.bind(this),screens:[GPContentObserver_.SCREEN.DRAW],stageIds:[GPContentObserver_.STAGE_ID.GAME]},drawingPreview:{static:!0,selector:"#content > .screen :is(.write, .memory) .core > div",handler:this.handleDrawingPreview.bind(this),screens:[GPContentObserver_.SCREEN.WRITE,
GPContentObserver_.SCREEN.MEMORY],stageIds:[GPContentObserver_.STAGE_ID.GAME]},album:{observer:new MutationObserver(this.albumCallback.bind(this)),config:{childList:!0,subtree:!0},selector:"#content > .screen .timeline",handler:this.handleAlbum.bind(this),screens:[GPContentObserver_.SCREEN.BOOK],stageIds:[GPContentObserver_.STAGE_ID.ALBUM]},albumHeader:{observer:new MutationObserver(this.albumHeaderCallback.bind(this)),config:{characterData:!0,subtree:!0},selector:"#content > .screen .scrapbook > h4",
handler:this.handleAlbumHeader.bind(this),screens:[GPContentObserver_.SCREEN.BOOK],stageIds:[GPContentObserver_.STAGE_ID.ALBUM]},rankingUsers:{static:!0,selector:"#content > .screen .ranking",handler:this.handleRankingUsers.bind(this),screens:[GPContentObserver_.SCREEN.RESULT],stageIds:[GPContentObserver_.STAGE_ID.SCORE]}}}observe(a){Object.values(this.observers).forEach(b=>{if(b.screens.includes(a)){const c=document.querySelector(b.selector);c&&(b.observer&&b.observer?.observe(c,b.config),c&&b.handler(c))}})}addPlayerListHandler(...a){a.forEach(b=>
{this.playerListHandlers.add(b)})}addPainterHeaderHandler(...a){a.forEach(b=>{this.painterHeaderHandlers.add(b)})}addDrawingPreviewHandler(...a){a.forEach(b=>{this.drawingPreviewHandlers.add(b)})}addAlbumItemsHandler(...a){a.forEach(b=>{this.albumItemsHandlers.add(b)})}addAlbumHeaderHandler(...a){a.forEach(b=>{this.albumHeaderHandlers.add(b)})}addAlbumFooterHandler(...a){a.forEach(b=>{this.albumFooterHandlers.add(b)})}addAlbumRankingHandler(...a){a.forEach(b=>{this.rankingUsersHandlers.add(b)})}getPlayerItems(){return this.players}getPainterHeader(){return this.painterHeader}getDrawingPreview(){return this.drawingPreview}getAlbumHeader(){return this.albumHeader}getAlbumItems(){return this.albumItems}getAlbumFooter(){return this.albumFooter}getRankingUsers(){return this.rankingUsers}terminate(){this.players.clear();
this.albumHeader=this.drawingPreview=this.painterHeader=null;this.albumItems.length=0;this.albumFooter=null;this.rankingUsers.length=0;this.nextAlbumItemId=null;this.disconnectObservers()}disconnectObservers(){Object.values(this.observers).forEach(a=>{a.observer?.disconnect()})}playerListCallback(a,b){for(const c of a)if("childList"===c.type&&c.addedNodes.length&&c.target.classList.contains("scrollElements")){const d=c.addedNodes[0]?.querySelector(":scope > .user:not(.empty)");d&&(this.cachePlayer(d),
this.playerListHandlers.forEach(e=>e(d)))}}albumHeaderCallback(a,b){for(const c of a)if("characterData"===c.type){const d=a[0].target.parentElement;this.albumHeader=d;this.albumHeaderHandlers.forEach(e=>e(d))}}albumCallback(a,b){for(const c of a)if("childList"===c.type&&c.addedNodes.length&&1===c.addedNodes[0].nodeType)if(c.addedNodes[0].classList.contains("item")){const d=c.addedNodes[0];this.injectAlbumItemMetadata(d);this.albumItems.push(d);this.albumItemsHandlers.forEach(e=>e(d))}else if(c.addedNodes[0].matches("section:has(> .end)")){const d=
c.addedNodes[0].querySelector(":scope > .end > p");this.albumFooter=d;this.albumFooterHandlers.forEach(e=>e(d))}}handlePlayerList(a){a=a.querySelectorAll(".user:not(.empty)");Array.from(a).forEach(b=>{this.cachePlayer(b);this.playerListHandlers.forEach(c=>c(b))})}cachePlayer(a){const b=a.querySelector(".nick")?.textContent;b&&this.players.set(b,a)}handlePainterHeader(a){this.painterHeader=a;this.painterHeaderHandlers.forEach(b=>b(a))}handleDrawingPreview(a){this.drawingPreview=a;this.drawingPreviewHandlers.forEach(b=>
b(a))}handleAlbumHeader(a){this.albumHeader=a;this.albumHeaderHandlers.forEach(b=>b(a))}handleAlbum(a){this.handleAlbumItems(a);this.handleAlbumFooter(a)}handleAlbumItems(a){a=a.querySelectorAll(".item:has(> :is(.answerBalloon, .drawBalloon, .imgBalloon))");Array.from(a).forEach(b=>{this.injectAlbumItemMetadata(b);this.albumItems.push(b);this.albumItemsHandlers.forEach(c=>c(b))})}injectAlbumItemMetadata(a){const b=this.nextAlbumItemId??[...a.parentElement.children].filter(d=>d.classList.contains("item")).indexOf(a);
let c=null;a.querySelector(":scope > .drawingmode > .drawing")?c=GPContentObserver_.ALBUM_ITEM_TYPE.IMAGE:a.querySelector(":scope > .answer")?c=GPContentObserver_.ALBUM_ITEM_TYPE.TEXT:a.querySelector(":scope > section > .animationmode")?c=GPContentObserver_.ALBUM_ITEM_TYPE.ANIMATION:a.querySelector(":scope > section > .loopmode")?c=GPContentObserver_.ALBUM_ITEM_TYPE.MULTI_PIECE:a.querySelector(":scope > .img")&&(c=GPContentObserver_.ALBUM_ITEM_TYPE.AI_IMAGE);a.dataset.id=b;a.dataset.type=c}handleAlbumFooter(a){const b=
a.querySelector("section > .end > p");b&&(this.albumFooter=b,this.albumFooterHandlers.forEach(c=>c(b)))}handleRankingUsers(a){a=a.querySelectorAll(".user");Array.from(a).forEach(b=>{this.rankingUsers.push(b);this.rankingUsersHandlers.forEach(c=>c(b))})}}window.GPContentObserver_=GPContentObserver_;class GPImageReportSender_ extends EventTarget{static ANTI_CHEAT="ANTI_CHEAT";static BAN="BAN";static EVENTS={ANTI_CHEAT:"gp:ac.report",BAN:"gp:mod.ban_report"};static COLORS={ANTI_CHEAT:5358253,BAN:12467260};static ITEM_TYPE={IMAGE:1,TEXT:2};constructor(a,b,c){super();this.prx=b;this.eventType=GPImageReportSender_.EVENTS[a];this.noticeColor=GPImageReportSender_.COLORS[a];this.keyHash=c.getKeyHash();this.twitchIdsCache=new Map;this.reportedItems=new Set;document.addEventListener("gp:tw.ids_usernames",
({detail:{usernamesMap:d}})=>{this.updateTwitchIdsCache(d)});this.prx.addEventListener("data",({detail:{event:d}})=>{d===GPProxy_.EVENT.GALLERY_SETTINGS&&this.reportedItems.clear()})}async send({itemId:a,albumId:b,...c}){var d=`${b}_${a}`;if(!this.reportedItems.has(d)){this.reportedItems.add(d);var e=this.prx.getAlbumItem(a,b);if(e){var {first:f,turns:g,animate:h,keep:k}=this.prx.getGameConfig();d={first:f,turns:g,animate:h,keep:k};var {authId:l,nick:m}=this.prx.getUser(),{meta:{author:p,title:r,
date:q},data:n,type:u}=e,v=(new Date(q)).toLocaleDateString("ru-RU"),x=u===GPImageReportSender_.ITEM_TYPE.IMAGE;switch(u){case GPImageReportSender_.ITEM_TYPE.IMAGE:var w=`${p} - ${r} (${v})`;v=await GPUtils_.compressImageData(e);w=new File([v],`${w}.gpimg`);break;case GPImageReportSender_.ITEM_TYPE.TEXT:w=`${p} - ${n} (${v})`,v=new Blob([n],{type:"text/plain"}),w=new File([v],`${w}.txt`)}v=Object.keys(GPProxy_.AUTH_TYPE_IDS).find(D=>GPProxy_.AUTH_TYPE_IDS[D]===e.auth);var t=this.prx.isTwitchAuth()?
this.twitchIdsCache.get(p.toLowerCase())??null:null;document.dispatchEvent(new CustomEvent(this.eventType,{detail:{noticeColor:this.noticeColor,author:p,authorId:t,sender:m,senderId:l,itemData:e,sourceFile:w,service:v,itemId:a,albumId:b,isImage:x,gameCode:this.prx.getGameCode(),gameConfig:d,keyHash:this.keyHash,...c}}))}}}updateTwitchIdsCache(a){a.forEach((b,c)=>{this.twitchIdsCache.set(b,c)})}}window.GPImageReportSender_=GPImageReportSender_;class GPLocalization_{static LANGUAGE={RU:"ru",EN:"en",ES:"es"};static DEFAULT_LANGUAGE="en";static MISSING_STR="N/A";constructor(a){this.init(a)}getDefaultData(){return{lang:this.getDefaultLanguage(),entries:{}}}getDefaultLanguage(){const a=window.navigator.language.split("-")[0].toLowerCase();return a.toUpperCase()in GPLocalization_.LANGUAGE?a:GPLocalization_.DEFAULT_LANGUAGE}initEntries(a={}){return new Proxy(a,{get:(b,c)=>new Proxy(Object.assign(b[c]??{},{isLoaded:this.isLoaded,lang:this.lang}),
{get:(d,e)=>d[e]??GPLocalization_.MISSING_STR})})}init(a){this.loaded=!!a;const {lang:b,entries:c}=a??this.getDefaultData();this.lang=b;this.entries=this.initEntries(c)}get(a){return this.entries[a]}getLang(){return this.lang}get isLoaded(){return this.loaded}}window.GPLocalization_=GPLocalization_;class GPGlobalBanlist_ extends EventTarget{static MODULE={title:"Global Banlist",alias:"gb"};constructor(a){super();this.prx=a.prx;this.abt=a.abt;this.isSubscribed=!1;this.globalBanlist=new Set;this.globalBanlistIds=new Set;this.twitchUsernamesCache=new Map;this.twitchCachedUsers=new Set;this.addEventListener("global_banlist_updated",b=>{this.clearPlayersByGlobalBanlist()});this.prx.addEventListener("data",({detail:{event:b}})=>{b===GPProxy_.EVENT.NEW_GAME&&this.prx.isAuthorized&&this.requestGlobalBanlist()});
this.prx.addEventListener("users_updated",({})=>{this.clearPlayersByGlobalBanlist()});document.addEventListener("gp:gb.banlist_received",({detail:{ids:b}})=>{this.globalBanlistIds=new Set(b);this.updateGlobalBanlist()});document.addEventListener("gp:tw.ids_usernames",({detail:{usernamesMap:b}})=>{this.updateTwitchUsernamesCache(b);this.updateGlobalBanlist(b)});document.addEventListener("gp:act.subs_status",({detail:{status:b,ps:c}})=>{this.isSubscribed=b;2&c||this.prx.addEventListener("users_updated",
({detail:{users:d}})=>{this.requestIdsUsernames(d)})});this.clearPlayersByGlobalBanlist();this.requestGlobalBanlist()}requestGlobalBanlist(){document.dispatchEvent(new CustomEvent("gp:gb.request_banlist"))}clearPlayersByGlobalBanlist(){this.prx.isHost()&&this.prx.isTwitchAuth()&&this.prx.isGameStage(GPProxy_.GAME_STAGE.LOBBY)&&this.prx.getUsers().forEach(a=>{!this.prx.isYou(a.nick)&&this.globalBanlist.has(this.prx.formatNickname(a.nick))&&this.prx.kickPlayer(a.id)})}updateGlobalBanlist(a){a||this.globalBanlist.clear();
const b=a||this.twitchUsernamesCache;if(b.size){var c=!1;this.globalBanlistIds.forEach(d=>{d=b.get(d);void 0!==d&&(this.globalBanlist.add(d),c=!0)});c&&this.dispatchEvent(new CustomEvent("global_banlist_updated"))}}requestIdsUsernames(a){this.prx.isHost()&&this.prx.isTwitchAuth()&&(a=a.filter(b=>!this.twitchCachedUsers.has(this.prx.formatNickname(b.nick))&&!this.prx.isYou(b.nick)&&!this.prx.isViewer(b)).map(b=>this.prx.formatNickname(b.nick)),a.length&&document.dispatchEvent(new CustomEvent("_request_ids_usernames",
{detail:{users:a}})))}updateTwitchUsernamesCache(a){a.forEach((b,c)=>{this.twitchUsernamesCache.set(c,b);this.twitchCachedUsers.add(b)})}}window.GPGlobalBanlist_=GPGlobalBanlist_;class GPPacketParser_{constructor(){this.socketIOParser=new SocketIOParser_;this.engineIOClient=new EngineIOClient_;return{encodeString:this.socketIOParser.encodeString,add:this.socketIOParser.add,decodeString:this.socketIOParser.decodeString,decodePayload:this.engineIOClient.decodePayload,decode:this.decode.bind(this)}}decode(a,b){if(b){const {type:c,data:d}=this.engineIOClient.decodePayload(a);return"message"===c?this.socketIOParser.add(d).data:null}return this.socketIOParser.add(a).data}}
class SocketIOParser_{constructor(){function a(d){var e=0,f={type:Number(d.charAt(0))};if(null==c.types[f.type])return{type:c.ERROR,data:null};if(c.BINARY_EVENT===f.type||c.BINARY_ACK===f.type){for(var g=e+1;"-"!==d.charAt(++e)&&e!=d.length;);g=d.substring(g,e);if(g!=Number(g)||"-"!==d.charAt(e))throw Error("Illegal attachments");f.attachments=Number(g)}if("/"===d.charAt(e+1)){for(g=e+1;++e;){var h=d.charAt(e);if(","===h)break;if(e===d.length)break}f.nsp=d.substring(g,e)}else f.nsp="/";g=d.charAt(e+
1);if(""!==g&&Number(g)==g){for(g=e+1;++e;){h=d.charAt(e);if(null==h||Number(h)!=h){--e;break}if(e===d.length)break}f.id=Number(d.substring(g,e+1))}"4"===d.charAt(0)&&"5"===d.charAt(1)&&e++;if(d.charAt(++e)){d=d.substr(e);try{var k=JSON.parse(d)}catch(l){k=!1}if(!1===k||f.type!==c.ERROR&&!Array.isArray(k))return{type:c.ERROR,data:null};f.data=k}return f}var b="function"===typeof ArrayBuffer;const c={protocol:4,types:"CONNECT DISCONNECT EVENT ACK ERROR BINARY_EVENT BINARY_ACK".split(" "),CONNECT:0,
DISCONNECT:1,EVENT:2,ACK:3,ERROR:4,BINARY_EVENT:5,BINARY_ACK:6};return{add:function(d){if("string"===typeof d)if(d=a(d),c.BINARY_EVENT===d.type||c.BINARY_ACK===d.type){if(this.reconstructor=new window.BinaryReconstructor(d),0===this.reconstructor.reconPack.attachments)return d}else return d;else{var e;if(e=b)(e=d instanceof ArrayBuffer)||(e="function"===typeof ArrayBuffer.isView?ArrayBuffer.isView(d):d.buffer instanceof ArrayBuffer);if(e||d.base64)if(this.reconstructor){if(d=this.reconstructor.takeBinaryData(d))return this.reconstructor=
null,d}else throw Error("got binary data when not reconstructing a packet");else throw Error("Unknown type: "+d);}},decodeString:a,encodeString:function(d){let e,f=!1;e=""+d.type;if(c.BINARY_EVENT==d.type||c.BINARY_ACK==d.type)e+=d.attachments,e+="-";d.nsp&&"/"!=d.nsp&&(f=!0,e+=d.nsp);null!=d.id&&(f&&(e+=",",f=!1),e+=d.id);null!=d.data&&(f&&(e+=","),e+=JSON.stringify(d.data));return e}}}}
class EngineIOClient_{constructor(){function a(e,f,g){if(void 0===e)return d;if("string"===typeof e){if("b"===e.charAt(0))return g=e.substr(1),e=c[g.charAt(0)],window.base64encoder?(g=window.base64encoder.decode(g.substr(1)),"blob"===f&&Blob&&(g=new Blob([g])),f={type:e,data:g}):f={type:e,data:{base64:!0,data:g.substr(1)}},f;if(g){a:{f=e;try{f=window.utf8.decode(f,{strict:!1})}catch(h){e=!1;break a}e=f}if(!1===e)return d}g=e.charAt(0);return Number(g)==g&&c[g]?1<e.length?{type:c[g],data:e.substring(1)}:
{type:c[g]}:d}g=(new Uint8Array(e))[0];e=e.slice(1);Blob&&"blob"===f&&(e=new Blob([e]));return{type:c[g],data:e}}function b(e,f,g){"function"===typeof f&&(g=f,f=null);for(var h=[];0<e.byteLength;){for(var k=new Uint8Array(e),l=0===k[0],m="",p=1;255!==k[p];p++){if(310<m.length)return g(d,0,1);m+=k[p]}e=e.slice(2+m.length);m=parseInt(m);k=e.slice(0,m);if(l)try{k=String.fromCharCode.apply(null,new Uint8Array(k))}catch(q){for(l=new Uint8Array(k),k="",p=0;p<l.length;p++)k+=String.fromCharCode(l[p])}h.push(k);
e=e.slice(m)}var r=h.length;h.forEach(function(q,n){g(a(q,f,!0),n,r)})}var c=Object.keys({open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6}),d={type:"error",data:"parser error"};return{decodePayload:function(e,f,g){if("string"!==typeof e)return b(e,f,g);"function"===typeof f&&(f=null);if(""===e)return d;g="";for(var h,k,l=0,m=e.length;l<m;l++)if(k=e.charAt(l),":"!==k)g+=k;else{if(""===g||g!=(h=Number(g)))return d;k=e.substr(l+1,h);if(g!=k.length)return d;if(k.length)return e=a(k,f,!1),d.type===
e.type&&d.data===e.data?d:e;l+=h;g=""}if(""!==g)return d}}}}window.GPPacketParser_=GPPacketParser_;class GPProxy_ extends EventTarget{static EVENT={GAME_QUIT:28,CHANGE_GAME_MODE:26,CHANGE_LOBBY_SCREEN:27,CHANGE_GAME_SETTINGS:18,GAME_STARTED:5,DESCRIPTION_INPUT:6,TOOL:7,READY:15,GALLERY_SETTINGS:23,NEW_GAME:20,PLAYER_JOINED:2,PLAYER_LEFT:3,PLAYER_KICKED:14,PLAYER_LEFT_GAME:21,PLAYER_RETURNED:22,TURN_STARTED:11,TURNS_ENDED:24,TIMER_STARTED:25,ALBUM_INFO:12,ALBUM_ITEM:9,ALBUM_NEXT:16,ALBUM_BACK:17,ALBUM_SCORE:35,CHANGE_ANIMATION_SETTINGS:36};static GAME_TIME={FAST:3,NORMAL:2,SLOW:1,REGRESSIVE:5,PROGRESSIVE:8,
DYNAMIC:4,INFINITE:6,HOSTS_DECISION:7,FASTER_FIRST_TURN:9,SLOWER_FIRST_TURN:10};static GAME_ORDER={WRITING_DRAWING:1,DRAWING_WRITING:2,ONLY_DRAWINGS:3,WRITING_ONLY_AT_THE_BEGINNING_AND_THE_END:4,WRITING_ONLY_AT_THE_BEGINNING:5,WRITING_ONLY_AT_THE_END:6,SINGLE_SENTENCE:7,SINGLE_DRAWING:8,SOLO_DRAWING:9,DRAWINGS_WITH_A_BACKGROUND:10,DRAWINGS_WITH_A_BACKGROUND_NO_PREVIEW:11};static INITIAL_STATE={screen:null,user:{owner:!1},users:[],turn:{},turnNum:0,turnMax:0,roundNum:0,bookAuthor:{id:0,nick:""},bookNum:-1,
bookLoaded:!1,bookAutomatic:!0,bookVoice:!1,timeline:[],previous:{user:{id:0,nick:""},type:2,data:""},active:!1,sentence:"",write:"",draw:[],lastDraw:null,background:null,configs:{tab:1,maxUsers:14,mode:1,mod:2,visible:1,speed:2,turns:3,first:1,score:2,animate:2,keep:2,shape:1},animationConfigs:{speed:3,loop:1},animationUpdate:0,resultConfigs:{speed:2,type:1},timeStarted:!1,elapsedBase:0,elapsedTime:0,modList:0};static PAYLOAD_TYPE={PRESETS:1,DATA:2};static GAME_STAGE={LOBBY:1,GAME:2,GALLERY_SETTINGS:5,
ALBUM:3,SCORE:4};static ALBUM_ITEM_TYPE={TEXT:2,IMAGE:1,ANIMATION:5,MULTI_PIECE:10,AI_IMAGE:6};static AUTH_TYPE={DISCORD:"discord",TWITCH:"twitch"};static AUTH_TYPE_IDS={twitch:1,discord:2};static GAME_MODES_PRESETS={1:{mode:1,visible:1,speed:2,turns:3,first:1,score:2,animate:2,keep:2},2:{mode:2,speed:4},3:{mode:3,visible:2,speed:3},4:{mode:4,turns:3},5:{mode:5,first:4},6:{mode:6,speed:3},7:{mode:7,speed:3,turns:1},8:{mode:8,speed:5,first:3},9:{mode:9,first:7,turns:12},10:{mode:10,score:1},11:{mode:11,
first:3,animate:1},12:{mode:12,speed:6,turns:4,first:7,animate:1},13:{mode:13,speed:4,turns:7,first:9,animate:1},14:{mode:14,speed:10,turns:4,first:10,animate:1},15:{mode:15,speed:9,turns:12,first:11},16:{mode:16,first:13,turns:1},17:{mode:17,first:12},18:{mode:18,speed:3,turns:13,first:7,keep:1},19:{mode:19,first:3,animate:1,keep:1},20:{mode:20,speed:7,turns:6,first:9},21:{mode:21,first:3,keep:3},24:{mode:24,speed:1,turns:11,first:3,keep:4}};static SCREEN={LOBBY:"lobby",PHRASE:"phrase",DESCRIPTION:"description",
PAINTER:"painter",ALBUM:"album"};static SCREEN_ID={[this.SCREEN.LOBBY]:1,[this.SCREEN.PHRASE]:3,[this.SCREEN.DESCRIPTION]:4,[this.SCREEN.PAINTER]:5,[this.SCREEN.ALBUM]:7};static SCREEN_NAME={1:this.SCREEN.LOBBY,3:this.SCREEN.PHRASE,4:this.SCREEN.DESCRIPTION,5:this.SCREEN.PAINTER,7:this.SCREEN.ALBUM};static REJOIN_STAGES={LOBBY:["lobby"],GAME:["start","draw","write","memory","reply"],ALBUM:["book"],SCORE:["rank"]};static STAGE={LOBBY:"lobby",GAME:"game",ALBUM:"album",SCORE:"score"};static SEND_QUEUE_DELAY=130;static MODULE={title:"GP Proxy",
alias:"prx",dependencies:["GPPacketParser_"]};constructor(a){super();this.abt=null;this.ws;document.addEventListener("gp:mm.modules_loaded",b=>{this.abt=a.abt;window.closeNotice=a.abt?.closeNotice.bind(a.abt);window.addNotice=a.abt?.addNotice.bind(a.abt)},{once:!0});this.state=GPProxy_.INITIAL_STATE;this.albums=[];this.albumsCount=0;this.isTwitchOAuth=this.isAuthorized=!1;this.twitchOAuthLogin=null;this.gameStage=GPProxy_.GAME_STAGE.LOBBY;this.rejoinFlag=!1;this.rejoinEvent=null;this.isRejoinEventRequested=
!1;GPUtils_.bindMethods([this.stateUpdateHandler,this.wsMessageHandler,this.wsOpenHandler,this.dataEventHandler,this.rejoinHandler,this.sendQueueHandler,this.resetSendQueue,this.setAlbumItem],this);this.parser=new GPPacketParser_;this.localization={};this.wsMsgMiddlewares=new Map;this.sendQueue=[];this.sendInProcess=!1;this.sendQueueTimeLeft=0;this.lastSendTime=Date.now();this.sendQueueTimer;document.addEventListener("_xhr_data",({detail:{encodedPacket:b}})=>{(b=this.parser.decode(b,!0))&&this.setPresets(b[1])});
document.addEventListener("_ws_send_data",({detail:{encodedPacket:b}})=>{b&&3<b.length&&(b=this.parser.decode(b))&&this.wsSendHandler(b)});document.addEventListener("_onmessage_intercept",({detail:{handler:b,e:c}})=>{if(this.wsMsgMiddlewares.size)if("string"!==typeof c.data)b(c);else{var [,d,e]=c.data.match(/4(?:(?:2)|(51-))\[2,(\d+)/)||[];if(void 0!==e&&this.wsMsgMiddlewares.has(+e)){var f=this.wsMsgMiddlewares.get(+e),g=this.parser.decodeString(c.data).data;if(g){var [h,k]=[...f].reduce((l,m)=>
m(l),[g,!1]);k?(f=this.encodePacket(h,!!d),c=this.buildMessageEvent(c,f),b(c)):b(c)}else b(c)}else b(c)}else b(c)});this.addEventListener("data",this.stateUpdateHandler);this.addEventListener("data",this.gameStageUpdateHandler);this.addEventListener("data",this.usersUpdateHandler);this.addEventListener("data",this.albumUpdateHandler);this.addEventListener("data",this.dataEventHandler);this.addEventListener("data",this.sendQueueHandler);this.addEventListener("presets",this.resetSendQueue);this.addEventListener("album_reconnect",
()=>{this.albumsCount=this.getAlbumsCount()});document.addEventListener("_url_changed",this.rejoinHandler,{once:!0});this.setWebSocket(a.ws);this.requestLocalization("draw").then(({data:b,type:c})=>{this.localization[c]=b;this.dispatchEvent(new CustomEvent("localization",{detail:{data:b,type:c}}))}).catch(({error:b,type:c})=>{console.error(b);this.localization[c]={}})}setWebSocket(a){this.ws&&(this.ws.removeEventListener("message",this.wsMessageHandler),this.ws.removeEventListener("open",this.wsOpenHandler));
this.ws=a;this.ws.addEventListener("message",this.wsMessageHandler);this.ws.addEventListener("open",this.wsOpenHandler)}addWSMsgMiddleware(a,b){a.forEach(c=>{const d=this.wsMsgMiddlewares.get(c)||new Set;d.add(b);this.wsMsgMiddlewares.set(c,d)})}removeWSMsgMiddleware(a){this.wsMsgMiddlewares.forEach((b,c)=>{b.delete(a);b.size||this.wsMsgMiddlewares.delete(c)})}encodePacket([a,b,c,d],e){e=e?"51-":2;a=[a,b,c];void 0!==d&&a.push(d);return this.parser.encodeString({type:4,nsp:"/",id:e,data:a})}buildMessageEvent(a,
b){return new MessageEvent("message",{data:b,origin:a.origin,lastEventId:a.lastEventId,source:a.source,ports:a.ports})}setPresets(a){if(a.error)console.warn("Presets Error:",a);else try{this.state=Object.assign(GPProxy_.INITIAL_STATE,this.state,a);this.state.users.find(c=>c.id===a.user.id).you=!0;this.isAuthorized=this.state.user.uid!==this.state.user.authId;this.authTypeId=(this.authType=this.calcAuthType())?GPProxy_.AUTH_TYPE_IDS[this.authType]:0;if(a.users){const c=new CustomEvent("users_updated",
{detail:{users:this.state.users}});this.dispatchEvent(c)}a.timeline?.length&&(this.albums[a.bookNum]={items:[],background:a.background},a.timeline.forEach(this.setAlbumItem));this.dispatchEvent(new CustomEvent("presets",{detail:{state:this.state}}));if(1!==a.screen){var b=GPProxy_.SCREEN_NAME[a.screen];b&&this.dispatchEvent(new CustomEvent(`${b}_reconnect`));this.rejoinFlag=!0}}catch(c){console.warn("Presets Data Error:",{error:c,data:a})}}wsMessageHandler({data:a}){if("string"===typeof a&&(a=this.parser.decodeString(a).data)){const [,
b,c]=a;this.dispatchEvent(new CustomEvent("data",{detail:{event:b,data:c}}))}}wsOpenHandler(a){this.abt?.closeNotice(GPAbout_.NOTICE_TYPE.DISCONNECTION)}wsSendHandler(a){const [,b,c]=a;b!==GPProxy_.EVENT.CHANGE_GAME_SETTINGS&&b!==GPProxy_.EVENT.CHANGE_ANIMATION_SETTINGS&&b!==GPProxy_.EVENT.GAME_QUIT||this.dispatchEvent(new CustomEvent("data",{detail:{event:b,data:c}}))}stateUpdateHandler({detail:{event:a,data:b}}){switch(a){case GPProxy_.EVENT.CHANGE_GAME_MODE:a=GPProxy_.GAME_MODES_PRESETS;b=Object.assign({},
a[1],a[b]);this.state.configs=Object.assign({},this.state.configs,b);break;case GPProxy_.EVENT.CHANGE_LOBBY_SCREEN:b=GPProxy_.GAME_MODES_PRESETS[1];this.state.configs=Object.assign({},this.state.configs,b);break;case GPProxy_.EVENT.CHANGE_GAME_SETTINGS:this.state.configs=Object.assign({},this.state.configs,b);break;case GPProxy_.EVENT.GAME_STARTED:this.state=Object.assign({},this.state,{countDown:!0,previous:null,turnNum:0,roundNum:this.state.roundNum+1,bookNum:0,turnMax:b,timeline:[],background:null});
break;case GPProxy_.EVENT.TURN_STARTED:this.state=Object.assign({},this.state,{draw:[],lastDraw:null},b);[3,4,9].includes(this.state.screen)?this.state.write=b.write||"":this.state.draw=b.draw||[];break;case GPProxy_.EVENT.TURNS_ENDED:this.state=Object.assign({},this.state,{screen:7,bookNum:-1});break;case GPProxy_.EVENT.GALLERY_SETTINGS:this.state=Object.assign({},this.state,{background:null},b);break;case GPProxy_.EVENT.ALBUM_INFO:this.state=Object.assign({},this.state,{timeline:[]},b);break;case GPProxy_.EVENT.ALBUM_ITEM:this.state=
Object.assign({},this.state,{timeline:[...(b.load||!b.type?this.state.timeline:this.state.timeline.slice(0,this.state.timeline.length-1)),b]});break;case GPProxy_.EVENT.NEW_GAME:this.state=Object.assign({},this.state,{screen:1,roundNum:0});break;case GPProxy_.EVENT.ALBUM_SCORE:this.state=Object.assign({},this.state,{screen:8});break;case GPProxy_.EVENT.CHANGE_ANIMATION_SETTINGS:this.state=Object.assign({},this.state,{animationConfigs:Object.assign({},this.state.animationConfigs,b)})}}gameStageUpdateHandler({detail:{event:a}}){switch(a){case GPProxy_.EVENT.NEW_GAME:this.gameStage=
GPProxy_.GAME_STAGE.LOBBY;break;case GPProxy_.EVENT.GAME_STARTED:this.gameStage=GPProxy_.GAME_STAGE.GAME;break;case GPProxy_.EVENT.TURNS_ENDED:this.gameStage=GPProxy_.GAME_STAGE.GALLERY_SETTINGS;break;case GPProxy_.EVENT.GALLERY_SETTINGS:this.gameStage=GPProxy_.GAME_STAGE.ALBUM;break;case GPProxy_.EVENT.ALBUM_SCORE:this.gameStage=GPProxy_.GAME_STAGE.SCORE}}dataEventHandler({detail:{event:a,data:b}}){let c=!0,d;switch(a){case GPProxy_.EVENT.PLAYER_JOINED:d="player_joined";break;case GPProxy_.EVENT.TURN_STARTED:d=
"turn_started";break;case GPProxy_.EVENT.TURNS_ENDED:d="turns_ended";break;case GPProxy_.EVENT.GALLERY_SETTINGS:d="gallery_started";break;default:c=!1}c&&(a=new CustomEvent(d,{detail:{...b}}),this.dispatchEvent(a))}sendQueueHandler({detail:{event:a}}){a!==GPProxy_.EVENT.TURN_STARTED&&a!==GPProxy_.EVENT.TURNS_ENDED||this.resetSendQueue()}rejoinHandler({detail:{path:a}}){if(this.rejoinFlag){var b=a.slice(1),c=Object.keys(GPProxy_.REJOIN_STAGES).find(d=>GPProxy_.REJOIN_STAGES[d].find(e=>e===b));this.gameStage=
GPProxy_.GAME_STAGE[c];this.rejoinEvent=new CustomEvent("rejoin",{detail:{stage:c?.toLowerCase(),path:a}});this.isRejoinEventRequested&&this.dispatchEvent(this.rejoinEvent)}}requestRejoinEvent(){this.rejoinEvent?this.dispatchEvent(this.rejoinEvent):this.isRejoinEventRequested=!0}usersUpdateHandler({detail:{event:a,data:b}}){let c=!0,d=!1;switch(a){case GPProxy_.EVENT.NEW_GAME:this.state.users=this.state.users.filter(k=>!k.away).map(k=>{k.viewer=void 0;k.ready=!1;return k});break;case GPProxy_.EVENT.ALBUM_SCORE:this.state.users=
this.state.users.map(k=>{k.viewer=void 0;return k});break;case GPProxy_.EVENT.TURN_STARTED:this.state.user.ready=!1;this.state.users=this.state.users.map(k=>{k.ready=!1;return k});break;case GPProxy_.EVENT.PLAYER_JOINED:this.state.users.push(b);break;case GPProxy_.EVENT.PLAYER_LEFT:var {userLeft:e,newOwner:f}=b;this.state.users=this.state.users.filter(k=>k.id!==e);f&&(d=this.state.user.id===f,this.state.user.owner=d,this.state.users=this.state.users.map(k=>{k.owner=k.id===f;return k}));break;case GPProxy_.EVENT.PLAYER_LEFT_GAME:var {userLeft:e,
newOwner:f}=b;this.state.users=this.state.users.map(k=>{k.away=k.id===e||k.away;return k});f&&(d=this.state.user.id===f,this.state.user.owner=d,this.state.users=this.state.users.map(k=>{k.owner=k.id===f;return k}));break;case GPProxy_.EVENT.PLAYER_RETURNED:this.state.users=this.state.users.map(k=>{k.away=k.away&&k.id!==b;return k});break;case GPProxy_.EVENT.PLAYER_KICKED:this.state.users=this.state.users.filter(k=>k.id!==b);break;case GPProxy_.EVENT.READY:var {user:g,ready:h}=b;this.state.users=this.state.users.map(k=>
{k.ready=k.id===g?h:k.ready;return k});g===this.state.user.id&&(this.state.user.ready=h);break;case GPProxy_.EVENT.GAME_QUIT:this.state.users=[];break;default:c=!1}c&&this.dispatchEvent(new CustomEvent("users_updated",{detail:{users:this.state.users}}));d&&this.dispatchEvent(new Event("owner_status"))}albumUpdateHandler({detail:{event:a,data:b}}){switch(a){case GPProxy_.EVENT.ALBUM_INFO:this.albums[b.bookNum]={items:[],background:b.background,bookAuthor:b.bookAuthor};b.timeline&&b.timeline.forEach(this.setAlbumItem);
break;case GPProxy_.EVENT.ALBUM_ITEM:if(void 0===b.id){this.state.bookNum+1>=this.albumsCount&&this.dispatchEvent(new Event("albums_ended"));break}if(b.type===GPProxy_.ALBUM_ITEM_TYPE.ANIMATION||b.type===GPProxy_.ALBUM_ITEM_TYPE.MULTI_PIECE){this.dispatchEvent(new CustomEvent("album_item_loading",{detail:{id:null}}));break}b.user&&!b.data?this.dispatchEvent(new CustomEvent("album_item_loading",{detail:{id:b.id}})):this.setAlbumItem(b);break;case GPProxy_.EVENT.GALLERY_SETTINGS:this.albumsCount=this.getAlbumsCount()}}getAlbumsCount(){return this.getUsers().filter(a=>
!a.viewer).length}getAlbum(a=this.state.bookNum){return this.albums[a]}getAlbumBackground(a=this.state.bookNum){return this.albums[a]?.background??null}setAlbumItem({user:a,id:b,data:c,type:d,active:e}){if(e&&c&&a&&(d===GPProxy_.ALBUM_ITEM_TYPE.TEXT||d===GPProxy_.ALBUM_ITEM_TYPE.IMAGE)){a=a.nick;e=d===GPProxy_.ALBUM_ITEM_TYPE.IMAGE?this.getItemTitle(b):null;var f=(new Date).toISOString(),g=this.albums[this.state.bookNum].background;0===b&&g&&!c?.length&&(c=g,g=void 0);c={data:c,background:g,type:d,
canvasTypeId:this.state.configs.shape,meta:{author:a,title:e,date:f}};this.isAuthorized&&(c.auth=this.authTypeId);this.albums[this.state.bookNum].items[b]=c;this.dispatchEvent(new CustomEvent("album_item",{detail:{itemId:b,albumId:this.state.bookNum,item:c}}))}}getItemTitle(a){if(!a)return this.l.ITEM_FREE_TITLE;const b=Object.values(this.albums[this.state.bookNum].items),{first:c,animate:d}=this.state.configs;let e;if(1===d)return this.l.ITEM_ANIM_FRAME_TITLE;if(1===c||2===c){for(a=b.length;0<a--;)if(2===
b[a].type){e=b[a].data;break}return e||this.l.ITEM_FREE_TITLE}return 3===c||6===c?this.l.ITEM_REDRAWN_TITLE:4===c||5===c?1<a?this.l.ITEM_REDRAWN_TITLE:b[0].data:7===c?b[0].data:9===c?this.l.ITEM_FREE_TITLE:10===c||11===c?0<a?this.l.ITEM_COMPLEMENTED_TITLE:this.l.ITEM_FREE_TITLE:this.l.ITEM_FREE_TITLE}getAlbumItem(a,b=this.state.bookNum){return this.albums[b]?.items[a]??null}calcAuthType(){return this.isAuthorized?17<=this.state.user.authId.length?GPProxy_.AUTH_TYPE.DISCORD:GPProxy_.AUTH_TYPE.TWITCH:
null}isConnected(){return this.ws?.readyState===WebSocket.OPEN}send(a,b,c=4,d=2,e){c=this.parser.encodeString({type:c,nsp:"/",id:d,data:[GPProxy_.PAYLOAD_TYPE.DATA,a,b]});if(this.sendQueue.length||e){if(a=a===GPProxy_.EVENT.TOOL&&Number.isInteger(b?.v)){const f=b.v;b=this.sendQueue.findLastIndex(g=>g[2]===f);~b?(this.sendQueue.splice(b,1),this.sendQueueTimeLeft-=GPProxy_.SEND_QUEUE_DELAY):this.sendQueue.push([c,a,f])}else this.sendQueue.push([c,a,b.v[1]]),this.sendQueueTimeLeft+=GPProxy_.SEND_QUEUE_DELAY;
this.sendInProcess||this.delayedSend()}else this.ws.send(c),this.lastSendTime=Date.now()}delayedSend(a=GPProxy_.SEND_QUEUE_DELAY){if(this.sendQueue.length){this.sendInProcess=!0;var b=Date.now()-this.lastSendTime;if(b>a||this.sendQueue[0][1]){const [c,d]=this.sendQueue.shift();this.sendQueueTimeLeft-=d?0:GPProxy_.SEND_QUEUE_DELAY;this.ws.send(c);this.lastSendTime=Date.now();this.dispatchEvent(new CustomEvent("send_queue_updated",{detail:{size:this.sendQueue.length,timeLeft:this.sendQueueTimeLeft}}));
0<this.sendQueue.length&&(this.sendQueueTimer=setTimeout(()=>{this.delayedSend()},d?0:a));this.sendInProcess=!1}else this.sendQueueTimer=setTimeout(()=>{this.delayedSend()},a-b)}else this.sendInProcess=!1,this.sendQueueTimeLeft=0,this.dispatchEvent(new CustomEvent("send_queue_updated",{detail:{size:this.sendQueue.length,timeLeft:this.sendQueueTimeLeft}}))}resetSendQueue(){clearTimeout(this.sendQueueTimer);this.sendQueue=[];this.sendInProcess=!1;this.sendQueueTimeLeft=0}getSendQueueSize(){return this.sendQueue.length}kickPlayer(a){this.send(GPProxy_.EVENT.PLAYER_KICKED,
a)}tool(a,b,c){this.send(GPProxy_.EVENT.TOOL,{t:this.state.turnNum,d:a,v:b},void 0,void 0,c)}undo(a,b){this.tool(2,a,b)}redo(a,b){this.tool(1,a,b)}ready(){this.send(GPProxy_.EVENT.READY,!this.state.user.ready)}getState(){return this.state}getScreen(){return GPProxy_.SCREEN_NAME[this.state.screen]??null}isRejoined(){return this.rejoinFlag}getUser(){return this.state.user}getNickname(){return this.state.user.nick}getUsername(){return this.formatNickname(this.getNickname())}formatNickname(a){return this.isDiscordAuth()?
a:a.toLowerCase()}getUsers(){return this.state.users.slice()}requestAuthId(){document.dispatchEvent(new CustomEvent("gp:prx.auth_id",{detail:{authId:this.state.user.authId,authTypeId:this.authTypeId,isAuthorized:this.isAuthorized}}))}getAuthType(){return this.authType}isTwitchAuth(){return this.authType===GPProxy_.AUTH_TYPE.TWITCH}isDiscordAuth(){return this.authType===GPProxy_.AUTH_TYPE.DISCORD}setTwitchOAuth(a){this.isTwitchOAuth=!0;this.twitchOAuthLogin=a}getTwitchOAuthLogin(){return this.twitchOAuthLogin}isReady(){return!!this.state.user.ready}isHost(){return!!this.state.user.owner}isViewer(a){return!!a.viewer}isYou(a){return void 0===
a?!1:this.state.user["number"===typeof a?"id":"nick"]===a}isAnimateMode(){return 1===this.state.configs.animate}isMultiPieceMode(){return 4===this.state.configs.keep}isScreen(...a){return a.some(b=>b===this.state.screen)}isGameStage(a){return this.gameStage===a}isGameStages(...a){return a.some(b=>b===this.gameStage)}isGameTime(a){return this.state.configs.speed===a}isGameOrder(a){return this.state.configs.first===a}isAlbumAutoShow(){return this.state.bookAutomatic}isSoloGame(){return this.state.screen===
GPProxy_.SCREEN_ID.PAINTER&&1===this.state.users.filter(a=>!a.viewer).length}getGameConfig(){return Object.assign({},this.state.configs)}getCurrentAlbumId(){return this.state.bookNum}getCurrentTurnId(){return this.state.turnNum}getAlbumAuthor(){return this.state.bookAuthor.nick}getGameCode(){return this.state.user.access}getPrevImageData(){return this.state.previous.data}getPrevData(){return this.state.previous}getCanvasTypeId(){return this.state.configs.shape}getLocalization(a){return this.localization[a]||
{}}requestLocalization(a){return new Promise((b,c)=>{if(window.__NEXT_DATA__){const d=window.__NEXT_DATA__ instanceof Element?JSON.parse(window.__NEXT_DATA__.textContent):window.__NEXT_DATA__;fetch(`${location.origin}/_next/data/${d.buildId}/${d.locale}/${a}.json`).then(e=>e.json()).then(e=>{(e=e.pageProps?.texts?.page)?b({data:e,type:a}):c({error:"localization data not found",type:a})}).catch(e=>{c({error:e,type:a})})}else c({error:"__NEXT_DATA__ is undefined",type:a})})}}window.GPProxy_=GPProxy_;class GPFloatManager_{static CONTAINMENT_MODE="viewport";static VISIBLE_THRESHOLD=-2;static AUTO_ANCHOR=!0;constructor(){this.highestZ=10022;this.activeElement=this.lastPromotedElement=null;this.startY=this.startX=0;this.initialRect=null;this.initialAnchors={x:"left",y:"top"};this.handlePointerMove=this.handlePointerMove.bind(this);this.handlePointerUp=this.handlePointerUp.bind(this)}promote(a){this.lastPromotedElement===a?this.activeElement=a:(this.highestZ++,a.style.zIndex=this.highestZ,this.lastPromotedElement=
this.activeElement=a)}grab(a,b){this.promote(a);this.initialRect=a.getBoundingClientRect();this.startX=b.clientX;this.startY=b.clientY;let c;if(a.computedStyleMap){var d=a.computedStyleMap();c="auto"!==d.get("bottom")?.toString();var e="auto"!==d.get("right")?.toString()}else d=a.style.position,a.style.position="static",e=window.getComputedStyle(a),c="auto"!==e.bottom,e="auto"!==e.right,a.style.position=d;this.initialAnchors={x:e?"right":"left",y:c?"bottom":"top"};Object.assign(a.style,{position:"fixed",
left:`${this.initialRect.left}px`,top:`${this.initialRect.top}px`,right:"auto",bottom:"auto",margin:"0",transform:"translate3d(0, 0, 0)",willChange:"transform"});a.setPointerCapture(b.pointerId);a.addEventListener("pointermove",this.handlePointerMove);a.addEventListener("pointerup",this.handlePointerUp)}handlePointerMove(a){if(this.activeElement&&this.initialRect){var b=a.clientX-this.startX;a=a.clientY-this.startY;if("viewport"===GPFloatManager_.CONTAINMENT_MODE){const c=window.innerWidth,d=window.innerHeight,
{width:e,height:f,left:g,top:h}=this.initialRect,k=GPFloatManager_.VISIBLE_THRESHOLD;b=Math.max(-g-k,Math.min(b,c-g-e+k));a=Math.max(-h-k,Math.min(a,d-h-f+k))}this.activeElement.style.transform=`translate3d(${b}px, ${a}px, 0)`}}handlePointerUp(a){if(this.activeElement){var b=this.activeElement,c=b.getBoundingClientRect(),d=window.innerWidth,e=window.innerHeight;b.style.transform="";b.style.willChange="auto";b.removeAttribute("data-anchor");var f=this.initialAnchors.x,g=this.initialAnchors.y;GPFloatManager_.AUTO_ANCHOR&&
(g=c.top+c.height/2,f=c.left+c.width/2>d/2?"right":"left",g=g>e/2?"bottom":"top");"right"===f?(b.style.left="auto",b.style.right=`${d-c.right}px`):(b.style.left=`${c.left}px`,b.style.right="auto");"bottom"===g?(b.style.top="auto",b.style.bottom=`${e-c.bottom}px`):(b.style.top=`${c.top}px`,b.style.bottom="auto");b.releasePointerCapture(a.pointerId);b.removeEventListener("pointermove",this.handlePointerMove);b.removeEventListener("pointerup",this.handlePointerUp);this.initialRect=this.activeElement=
null}}}window.GPFloatManager_=GPFloatManager_;class GPModalManager_{static modals=new Map;static floatManager=new GPFloatManager_;static createModal(a,{title:b,icon:c,hoverIcon:d,content:e,buttons:f}){const g=document.createElement("div");g.className="gp-modal_";g.dataset.name=a;g.addEventListener("pointerdown",k=>{this.floatManager.promote(g)});if(b){g.addEventListener("pointerdown",l=>{l.target===g&&this.floatManager.grab(g,l)});const k=document.createElement("div");k.className="title_";g.appendChild(k);var h=document.createElement("div");
h.className="label_";h.textContent=b??"";k.appendChild(h);c&&(b=document.createElement("div"),b.className="icon-wrapper_",k.appendChild(b),h=document.createElement("div"),h.className="ribbon_",b.appendChild(h),h=document.createElement("div"),h.className="icon_",h.dataset.icon=c,b.appendChild(h),d&&(k.classList.add("is-hoverable_"),h.dataset.hoverIcon=d))}c=document.createElement("div");c.className="content_";c.appendChild(e);g.appendChild(c);if(f){const k=document.createElement("div");k.className=
"buttons_";f.forEach(([l,m])=>{const p=document.createElement("div");p.className="btn_ gp-ui-btn_";p.textContent=l;p.addEventListener("click",m);k.appendChild(p)});g.appendChild(k)}e=document.createElement("div");e.className="gp-ui-close-btn_";e.addEventListener("click",k=>{g.remove()});g.appendChild(e);this.modals.set(a,g);return g}static addModal(a){a.addEventListener("pointerdown",b=>{this.floatManager.promote(a)})}static showModal(a,b=null){if(a=this.modals.get(a))document.body.appendChild(a),
b?this.setPosition(a,b):this.resetPosition(a),this.floatManager.promote(a)}static closeModal(a){(a=this.modals.get(a))&&a.remove()}static setPosition(a,b){a.style.setProperty("inset","auto");Object.entries(b).forEach(([c,d])=>{a.style.setProperty(c,"number"===typeof d?`${d}px`:d)})}static resetPosition(a){a.style.removeProperty("inset")}static promote(a){this.floatManager.promote(a)}}window.GPModalManager_=GPModalManager_;class GPModulesManager_ extends EventTarget{static FORCE_RELOAD=!0;static DEFAULT_PERMISSIONS=3685;static STATE={ANALYTICS:"analytics",KEY:"key",MISMATCH:"mismatch",AUTH:"auth",SUBSCRIBE:"subscribe",SUBSCRIPTION:"subscription",TIME_LEFT:"time-left",EXPIRED:"expired",GIFT:"gift"};static TWITCH_APP_CLIENT_ID="lxn2nh0bxpwhqnmo840o0pf9bzotgu";static TWITCH_APP_REDIRECT_URI="https://gpmod.github.io/twitch-token-auth?WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWW";static TWITCH_AUTH_URL=`https://id.twitch.tv/oauth2/authorize?client_id=${this.TWITCH_APP_CLIENT_ID}&redirect_uri=${encodeURIComponent(this.TWITCH_APP_REDIRECT_URI)}&response_type=token&scope=`;static LANGUAGES={ru:"\u0420\u0443\u0441\u0441\u043a\u0438\u0439",
en:"English",es:"Espa\u00f1ol"};static RELOAD_BTN_L10N={ru:"\u041f\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044c",en:"Reload page",es:"Recarga la pesta\u00f1a"};static DEFAULT_SETTINGS={disabledList:[],twitchAuth:null,allowAnalytics:!1,lastAuthSuccess:null};static MODULE={title:"Modules Manager",alias:"mm",settings:{storage:"gp_mm",defaultSettings:this.DEFAULT_SETTINGS}};constructor(a,b){super();this.loc=new GPLocalization_(b);this.l=this.loc.get(this.constructor.name);this.lang=
this.loc.getLang();this.settingsManager=new GPSettingsManager_(this,this.loc.get("GPSettingsManager_"));this.s=this.settingsManager.setSettings(this);this.disabledList=new Set(this.s.disabledList);this.modules=[];this.lm=[];this.hiddenSettings=new Set;this.initialState={};this.rootThis;this.publicKey;this.pasteKey=null;GPUtils_.bindMethods([this.onMListClick,this.renderModulesList,this.renderError,this.toggleSettingsVisibility,this.reloadBtnClickHandler],this);this.addEventListener("modules_loaded",
({detail:{decryptedData:c,authTypeId:d,isAuthorized:e,isSubscribed:f,kd:g,kt:h}})=>{this.settingsManager.initImporterExporter(this.root.abt.getVersion(),this.root.prx.getNickname());this.root.prx.requestRejoinEvent();document.dispatchEvent(new Event("gp:mm.modules_loaded"));document.dispatchEvent(new CustomEvent("gp:mm.analytics_report",{detail:{mv:this.root.abt.getVersion(),kh:this.root.act.getKeyHash(),ke:c.e??null,kg:Number(c.g??!1),km:Number(c.m??!1),kd:Number(g),kt:Number(h),at:d,af:Number(e),
ss:Number(f)}}))});document.addEventListener("gp:prx.auth_id",async({detail:{authId:c,authTypeId:d,isAuthorized:e}})=>{function f(v){this.lm=this.lm.filter(x=>1<<x.id&v?(x.disabled||x.initialized||this.initModuleInstance(x,this.root,this.loc.get(x.name)),x.locked=!1):x.locked=!0);this.renderModulesList()}async function g(v,x){x=(new TextEncoder).encode(x);var w=await crypto.subtle.digest("SHA-256",x);x=window.atob(v).slice(0,12);x={name:"AES-GCM",iv:new Uint8Array(Array.from(x).map(t=>t.charCodeAt(0)))};
w=await crypto.subtle.importKey("raw",w,x,!1,["decrypt"]);v=window.atob(v).slice(12);v=new Uint8Array(Array.from(v).map(t=>t.charCodeAt(0)));try{const t=await crypto.subtle.decrypt(x,w,v);return(new TextDecoder).decode(t)}catch(t){throw new GPDecryptError_;}}function h(v){document.dispatchEvent(new CustomEvent("gp:act.auth_perms",{detail:{ps:v}}))}async function k(v){v=await g(v,l());return fetch("https://id.twitch.tv/oauth2/validate",{headers:{Authorization:`OAuth ${v}`},credentials:"omit",cache:"no-cache"}).then(x=>
{if(x.ok)return x.json();throw Error();}).then(x=>[x.user_id,x.login]).catch(()=>[])}function l(){function v(y,F){const K=x();return v=function(Q,V){Q-=195;let z=K[Q];void 0===v.IvNImK&&(v.biwoho=function(J){let I="",H="";for(let C=0,N,P,R=0;P=J.charAt(R++);~P&&(N=C%4?64*N+P:P,C++%4)?I+=String.fromCharCode(255&N>>(-2*C&6)):0)P="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(P);for(let C=0,N=I.length;C<N;C++)H+="%"+("00"+I.charCodeAt(C).toString(16)).slice(-2);return decodeURIComponent(H)},
y=arguments,v.IvNImK=!0);const G=Q+K[0],E=y[G];return E?z=E:(z=v.biwoho(z),y[G]=z),z},v(y,F)}function x(){const y="mZmYvMvlr1vW yxrVyG ndq1mJu4offSB0n4Aa mJqZnZKYvwvXC0TJ yJnoAMni uNbIv1zhyJnkDa vMHAmLu9 yuDgEvPi zgHKrZL5 EeLAv2XUyuHrpq yKDgDvOZ mJmZmtvWze92EgO EdjAv1jqy0HsCa uKDgmfPw BwfW mJm0BNnKqvHr zfHoBgnR yvCXmwjb nZyYmZG4ohvMwM96ra rM5AvZuWuKDgma zgHJBvzeyJi1AG sw50Ba nM9RwxbMEq mJCZody2mhjjweLLrq y21wEMiY y0D4Agrh wvHrpq mZu3m1nVA1f5Bq zeDSDfPw wvHAAgfx wKDwmMfx y2HHCKnVzgvbDa mZy4mZCXu1LtDvvr yM1gmMfx".split(" ");
x=function(){return y};return x()}(function(y,F){const K=v;for(y=y();;)try{if(parseInt(K(219))/1+parseInt(K(202))/2*(-parseInt(K(214))/3)+-parseInt(K(221))/4*(-parseInt(K(198))/5)+parseInt(K(209))/6*(parseInt(K(223))/7)+-parseInt(K(205))/8+-parseInt(K(224))/9+parseInt(K(210))/10===F)break;else y.push(y.shift())}catch(Q){y.push(y.shift())}})(x,545929);const w=v,t=[w(220)+w(195),w(203)+(w(206)+"YQ=="),"","",w(212)+"Zvcm0=",w(228)+(w(207)+"dXJyZW5jeQ=="),"c2NyZWVu",w(216)+"xXaWR0aA==","YXZhaW"+w(196),
w(197)+w(227),"",w(225)+"U=",w(217)+"NlTWVtb3J5",w(200)+(w(226)+w(213)),w(211)+(w(199)+"b25z"),w(215)+"pvbmU=",w(204)+"=="][w(201)](window[w(222)]),D=JSON.stringify([window[t[0]][t[1]]?.[t[4]],window[t[0]][t[5]],window[t[6]][t[7]],window[t[6]][t[8]],window[t[0]][t[9]],window[t[0]][t[4]],window[t[0]][t[11]],window[t[0]][t[12]],(new (window[w(208)]?.[t[13]]))[t[14]]()[t[15]]]);let B=-559038803,A=1103547925;for(let y=0,F;y<D.length;y++)F=D[w(218)](y),B=Math[t[16]](B^F,2654435761),A=Math[t[16]](A^F,1597334677);
return B=Math[t[16]](B^B>>>16,2246822507)^Math[t[16]](A^A>>>13,3266489909),A=Math[t[16]](A^A>>>16,2246822507)^Math[t[16]](B^B>>>13,3266489909),String(4294967296*(2097151&A)+(B>>>0))}this.s.allowAnalytics||(this.setEditionState(GPModulesManager_.STATE.ANALYTICS),await this.waitForAnalyticsConsent());let m=!1,p=!1,r=!1,q={};if(this.lm.length){var n=GPModulesManager_.DEFAULT_PERMISSIONS,u=null;try{if(!a||!this.publicKey)throw u=[GPModulesManager_.STATE.KEY],new GPAuthError_;if(!d)if(this.s.twitchAuth){d=
1;const [w,t]=await k(this.s.twitchAuth);if(c=w)this.root.prx.setTwitchOAuth(t);else throw this.s.twitchAuth=null,this.root.abt?.showTwitchOAuthTokenNotice({onButtonClick:()=>{this.requestTwitchToken()}}),new GPAuthError_;}else throw new GPAuthError_;const v=1===d?"t":"d";q=JSON.parse(await g(a,this.publicKey));let x;try{x=JSON.parse(await g(q[v],c))}catch{throw u=[GPModulesManager_.STATE.MISMATCH],new GPDecryptError_;}q.e&&this.setEditionTitle(q.e,q.m);q.g&&(u=[GPModulesManager_.STATE.GIFT]);if(x.ed){p=
!0;if(x.ed<Date.now())throw r=!0,u=[GPModulesManager_.STATE.EXPIRED],2&x.p&&(n|=16),new GPAuthError_;u=[GPModulesManager_.STATE.TIME_LEFT,x.ed-Date.now()]}else q.g||(u=[GPModulesManager_.STATE.SUBSCRIPTION]);u&&this.setEditionState(...u);f.call(this,n|x.p);h.call(this,n|x.p);this.renderModulesList();m=!0}catch(v){v instanceof GPAuthError_||v instanceof GPDecryptError_||console.error(v),u||(e?u??=[GPModulesManager_.STATE.SUBSCRIBE]:this.publicKey&&(u??=[GPModulesManager_.STATE.AUTH])),u&&this.setEditionState(...u),
f.call(this,n),h.call(this,n)}this.dispatchEvent(new CustomEvent("modules_loaded",{detail:{decryptedData:q,authTypeId:d,isAuthorized:e,isSubscribed:m,kd:p,kt:r}}));this.handleSubExpiration(u)}else this.dispatchEvent(new CustomEvent("modules_loaded",{detail:{decryptedData:q,authTypeId:d,isAuthorized:e,isSubscribed:m,kd:p,kt:r}}))});document.addEventListener("gp:act.auth_key_changed",c=>{this.container.classList.add("reload-required_")});document.addEventListener("gp:act.auth_key",({detail:{publicKey:c}})=>
{this.publicKey=c});document.addEventListener("gp:act.init",({detail:{pasteKey:c}})=>{this.pasteKey=c});document.addEventListener("gp.abt.analytics_consent_granted",c=>{this.s.allowAnalytics=!0},{once:!0});window.addEventListener("message",c=>{"https://gpmod.github.io"!==c.origin&&"https://localhost"!==c.origin||"gp-twitch-auth"!==c.data?.type||(this.twitchAuthWindow.postMessage({type:"close"},c.origin),this.twitchAuthWindow=null,this.s.twitchAuth=c.data.token,this.reloadPage())});this.firstRunInit();
this.render()}getElement(){return this.container}getSettingsManager(){return this.settingsManager}render(){this.container?.remove();this.container=document.createElement("div");this.container.className="gp-mm_";this.container.dataset.lang=this.lang;this.container.style.setProperty("--icon-analytics-label",`'${this.l.ICON_ANALYTICS}'`);this.container.style.setProperty("--icon-key-label",`'${this.l.ICON_KEY}'`);this.container.style.setProperty("--icon-mismatch-label",`'${this.l.ICON_MISMATCH}'`);this.container.style.setProperty("--icon-auth-label",
`'${this.l.ICON_AUTH}'`);this.container.style.setProperty("--icon-sign-in-label",`'${this.l.ICON_SIGN_IN}'`);this.container.style.setProperty("--icon-subscribe-label",`'${this.l.ICON_SUBSCRIBE}'`);this.container.style.setProperty("--icon-subscription-label",`'${this.l.ICON_SUBSCRIPTION}'`);this.container.style.setProperty("--icon-expired-label",`'${this.l.ICON_EXPIRED}'`);this.container.style.setProperty("--icon-gift-label",`'${this.l.ICON_GIFT}'`);this.edition=document.createElement("div");this.edition.className=
"edition_ hidden";this.edition.addEventListener("click",g=>{switch(this.container.dataset.state){case GPModulesManager_.STATE.SUBSCRIBE:case GPModulesManager_.STATE.EXPIRED:g=document.createElement("a");g.href="https://boosty.to/gpmod";g.target="_blank";g.click();break;case GPModulesManager_.STATE.AUTH:this.requestTwitchToken();break;case GPModulesManager_.STATE.KEY:this.container.classList.contains("key-input-opened_")||this.keyBtn.click()}});this.container.appendChild(this.edition);this.editionTitle=
document.createElement("div");this.editionTitle.className="edition-title_";this.edition.appendChild(this.editionTitle);this.setEditionTitle("base");var a=document.createElement("div");a.className="ribbon_";this.edition.appendChild(a);this.modulesList=document.createElement("div");this.modulesList.className="modules-list_";this.modulesList.addEventListener("pointerup",this.onMListClick);this.container.appendChild(this.modulesList);this.reloadBtn=document.createElement("div");this.reloadBtn.className=
"gp-ui-btn_ reload-btn_";this.reloadBtn.classList.add("disabled_");this.reloadBtn.textContent=this.l.RELOAD_BTN;this.reloadBtn.addEventListener("click",this.reloadBtnClickHandler);this.container.appendChild(this.reloadBtn);a=document.createElement("div");a.className="footer_";this.container.appendChild(a);var b=document.createElement("div");b.className="buttons_";a.appendChild(b);const c=document.createElement("div");c.className="show-btn_ gp-module-btn_ btn_";c.title=this.l.MODULE_BTN_TTL;c.addEventListener("pointerup",
g=>{g=this.container.classList.contains("shown_");this.container.classList.toggle("shown_",!g);g&&(this.settingsManager.close(),this.settingsManager.closeImporter());c.classList.toggle("pressed_",!g)});b.appendChild(c);this.settingsBtn=document.createElement("div");this.settingsBtn.className="settings-btn_ btn_";this.settingsBtn.title=this.l.SETTINGS_BTN_TTL;this.settingsBtn.addEventListener("pointerup",g=>{this.settingsManager.toggle(void 0,void 0,g.ctrlKey||1===g.button)});b.appendChild(this.settingsBtn);
this.keyBtn=document.createElement("div");this.keyBtn.className="key-btn_ btn_";this.keyBtn.title=this.l.KEY_BTN_TTL;this.keyBtn.addEventListener("click",g=>{g=!this.container.classList.contains("key-input-opened_");this.container.classList.toggle("key-input-opened_",g);g&&this.keyInput.focus();this.settingsManager.close()});this.keyBtn.addEventListener("pointerdown",g=>{this.keyInput.preventHiding=!0});b.appendChild(this.keyBtn);this.keyInput=document.createElement("input");this.keyInput.className=
"key-input_ gp-ui-input_ secure-input_";this.keyInput.placeholder=this.l.KEY_INPUT_PH;this.keyInput.spellcheck=!1;this.keyInput.autocomplete="off";this.keyInput.preventHiding=!1;this.keyInput.addEventListener("input",g=>{if(this.pasteKey){g=g.target.value.trim();var h=this.pasteKey(g);this.container.classList.toggle("key-input-opened_",!h);this.keyInput.classList.toggle("invalid_",g&&!h)}});this.keyInput.addEventListener("keydown",g=>{switch(g.key){case "Escape":g.target.blur()}});this.keyInput.addEventListener("focus",
g=>{g.target.value="";g.target.preventHiding=!1});this.keyInput.addEventListener("blur",g=>{g.target.value="";g.target.classList.remove("invalid_");g.target.preventHiding?g.target.preventHiding=!1:this.container.classList.remove("key-input-opened_")});GPUtils_.setInputFocusBlurHandler(this.keyInput);this.container.appendChild(this.keyInput);this.langBtn=document.createElement("div");this.langBtn.className="lang-btn_ btn_";this.langBtn.title=this.l.LANGUAGE_BTN_TTL;this.langBtn.dataset.lang=this.lang;
this.langBtn.addEventListener("pointerdown",g=>{0===g.button&&(this.langBtn.classList.add("shown_"),this.settingsManager.close(),this.langBtn.classList.contains("shown_")&&document.addEventListener("click",h=>{document.addEventListener("pointerdown",k=>{this.langBtn.classList.remove("shown_")},{once:!0,capture:!0})},{once:!0}))});b.appendChild(this.langBtn);const d=document.createElement("div");d.className="lang-list_";d.addEventListener("click",g=>{this.langBtn.classList.remove("shown_")});d.addEventListener("pointerup",
g=>{if(g.target.classList.contains("btn_")){var h=g.target.dataset.lang,k=h!==this.lang;this.langBtn.dataset.lang=h;k&&(this.setLanguage(h),Array.from(d.children).forEach(l=>{l.classList.toggle("selected_",l===g.target)}),this.langBtn.classList.remove("shown_"))}});Object.entries(GPModulesManager_.LANGUAGES).forEach(([g,h])=>{const k=document.createElement("div");k.className="btn_";k.title=h;k.dataset.lang=g;d.appendChild(k);g===this.lang&&k.classList.add("selected_")});this.langBtn.appendChild(d);
const e=document.createElement("div");e.className="dots-btn_ btn_";e.addEventListener("pointerdown",g=>{0===g.button&&(e.classList.add("shown_"),this.settingsManager.close(),e.classList.contains("shown_")&&document.addEventListener("click",h=>{document.addEventListener("pointerdown",k=>{e.classList.remove("shown_")},{once:!0,capture:!0})},{once:!0}))});b.appendChild(e);b=document.createElement("div");b.className="dots-menu_";b.addEventListener("click",g=>{e.classList.remove("shown_")});b.addEventListener("pointerup",
g=>{g.target.classList.contains("btn_")&&e.classList.remove("shown_")});e.appendChild(b);var f=document.createElement("div");f.className="export-btn_ btn_";f.title=this.l.EXPORT_SETTIGNS_TTL;f.addEventListener("pointerup",g=>{this.settingsManager.exportSettings()});b.appendChild(f);f=document.createElement("div");f.className="import-btn_ btn_";f.title=this.l.IMPORT_SETTIGNS_TTL;f.addEventListener("pointerup",g=>{this.settingsManager.importSettings()});b.appendChild(f);b=document.createElement("div");
b.className="title_";b.textContent=this.l.WIN_TITLE;a.appendChild(b);document.body.appendChild(this.container)}setEditionTitle(a,b=!1){this.editionTitle.textContent=`${a} ed.`;this.edition.classList.toggle("demo_",!!b);this.edition.classList.remove("hidden")}setEditionState(a,b){this.container.dataset.state=a;this.edition.title="";switch(a){case GPModulesManager_.STATE.TIME_LEFT:this.edition.dataset.timeLeft=this.formatTimeLeft(b);break;case GPModulesManager_.STATE.EXPIRED:this.edition.title=this.l.BOOSTY_ICON_TTL;
break;case GPModulesManager_.STATE.KEY:this.edition.title=this.l.KEY_BTN_TTL}}formatTimeLeft(a){const b=this.l.SUB_DAYS_LEFT.split("|");a=Math.trunc(a/864E5);switch(this.l.lang){case GPLocalization_.LANGUAGE.RU:const d=a%100;var c=d%10;let e;if(10<=d&&20>d)e=2;else if(1===c)e=0;else if(1<c&&5>c)e=1;else if(!c||4<c)e=2;c=[b[2],b[3],b[4]];return`${e?b[1]:b[0]} ${1>d?b[5]:`${a} ${c[e]}`}`;case GPLocalization_.LANGUAGE.ES:return 1>a?b[4]:`${1<a?b[1]:b[0]} ${a} ${1===a?b[2]:b[3]}`;default:return 1>a?b[3]:
`${a} ${1===a?b[1]:b[2]} ${b[0]}`}}onMListClick(a){2===a.button?a.preventDefault():a.target.matches(":not(.no-settings_) > :is(.name_, .settings_)")&&this.settingsManager.toggle(!0,a.target.dataset.module,a.ctrlKey||1===a.button)}compareToInitialState(){const a=[...this.modulesList.querySelectorAll(".gp-ui-cb_")].some(b=>b.checked!==this.initialState[b.name]);this.reloadBtn.classList.toggle("alert_",a);this.reloadBtn.classList.toggle("disabled_",!a)}reloadBtnClickHandler(a){this.reloadPage(GPModulesManager_.FORCE_RELOAD)}reloadPage(a=
!0){a&&(window.onbeforeunload=null);if(1<this.root.prx.getUsers().length){a=location.pathname.indexOf("/",1);a=location.pathname.slice(1,~a?a:void 0);a=2===a.length?a:"en";const b=this.root.prx.getUser().access;location.replace(`${location.origin}/${a}/?c=${b}`)}else location.reload()}setModules(a,b,c){this.modules=a;this.rootThis=b;this.root=c;this.initDisabledList();this.initHiddenSettings();const d=this.initModule(this.modules.find(e=>"GPProxy_"===e.name),b,c);d.addEventListener("presets",async()=>
{try{this.loc.isLoaded||await this.waitForLocalization().then(e=>{this.loc.init(e);this.l=this.loc.get(this.constructor.name);this.render();this.settingsManager.l=this.loc.get(this.settingsManager.constructor.name);this.settingsManager.close()}),this.initModules(this.modules,b,c),this.renderModulesList(),d.requestAuthId()}catch(e){console.error(e),e instanceof GPModuleError_&&this.renderError(e)}},{once:!0})}waitForLocalization(){return new Promise(a=>{const b=setTimeout(()=>{a(null)},5E3);document.addEventListener("gp:l10n",
({detail:{l10n:c}})=>{clearTimeout(b);a(c)},{once:!0});document.dispatchEvent(new Event("gp:get_l10n"))})}async initModules(a,b,c){a.forEach(d=>{this.initModule(d,b,c)})}initModule(a,b,c){if(!a.initialized){b=window[a.name];this.initialState[a.name]=this.disabledList.has(a.name)&&!a.required?!1:!0;var d=a.name in window;d&&(a.title=b.MODULE.title,a.description=b.MODULE.description);a.loaded=d;if(a.loaded){if(a.required)return this.initModuleInstance(a,c,this.loc.get(a.name));a.locked=!0;this.lm.push(a)}else if(!d){if(a.required)throw new GPModuleError_(`\u041e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u044b\u0439 \u043c\u043e\u0434\u0443\u043b\u044c "${a.name}" \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d`);
console.error(`\u041c\u043e\u0434\u0443\u043b\u044c "${a.name}" \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d`)}}}initModuleInstance(a,b,c){const d=window[a.name];d.prototype.l=c;d.MODULE?.useCSS&&window.content?.classList.add(`gpm-${d.MODULE.alias}_`);b=b[d.MODULE.alias]=new d(b);d.toggleSettingsVisibility=this.toggleSettingsVisibility(a);a.initialized=!0;return b}toggleSettingsVisibility(a){return b=>{a.hiddenSettings===b&&(a.hiddenSettings=!b,a.hidden||a.hiddenSettings?this.hiddenSettings.add(a.name):
this.hiddenSettings.delete(a.name),this.renderModulesList(),this.settingsManager.updateSettingsList())}}initDisabledList(){let a=!1;this.modules.forEach(b=>{b.disabled?(this.disabledList.add(b.name),a=!0):this.disabledList.has(b.name)&&(b.disabled=!0)});a&&(this.s.disabledList=Array.from(this.disabledList))}initHiddenSettings(){this.hiddenSettings.clear();this.modules.forEach(a=>{(a.hidden||a.hiddenSettings)&&this.hiddenSettings.add(a.name)})}renderModulesList(){const a=document.createDocumentFragment(),
b=new Intl.Collator("us",{sensitivity:"base"});this.modules.sort((c,d)=>{const [e,f]=[!c.locked,!d.locked];return c.dev||d.dev?c.dev&&d.dev?b.compare(c.title,d.title):c.dev&&!d.dev?-1:1:e&&f||!e&&!f?b.compare(c.title,d.title):e&&!f?-1:1});this.modules.forEach((c,d)=>{if(!c.hidden){var e=this.settingsManager.hasSettings(c.name),f=document.createElement("div");f.className="module_";f.classList.toggle("dev_",!!c.dev);f.classList.toggle("locked_",!!c.locked);f.classList.toggle("not-loaded_",!c.loaded);
f.classList.toggle("no-settings_",!!c.hiddenSettings||!e);e=GPUtils_.buildTooltip(c.description??this.loc.get(c.name).DESCRIPTION);f.appendChild(e);e=document.createElement("div");e.className="name_";e.title=c.loaded?"":"\u041c\u043e\u0434\u0443\u043b\u044c \u043d\u0435 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043d";e.dataset.module=c.name;e.textContent=c.title;f.appendChild(e);e=document.createElement("div");e.className="settings_";e.dataset.module=c.name;e.textContent="\ue92d";f.appendChild(e);
var g=this.initialState[c.name];e=document.createElement("div");e.className="checkbox_";var h=document.createElement("input");h.className="gp-ui-cb_";h.id=`module-${d}_`;h.type="checkbox";h.checked=g;h.toggleAttribute("checked",!!g);h.toggleAttribute("disabled",!!c.required);h.addEventListener("change",k=>{c.required||(k.target.checked&&this.disabledList.has(c.name)?(c.disabled=!1,this.disabledList.delete(c.name)):(c.disabled=!0,this.disabledList.add(c.name)),this.s.disabledList=Array.from(this.disabledList),
this.compareToInitialState())});e.appendChild(h);g=document.createElement("label");g.className="gp-ui-cb-label_";g.setAttribute("for",`module-${d}_`);e.appendChild(g);f.appendChild(e);a.appendChild(f)}});this.settingsBtn.classList.toggle("hidden",!this.settingsManager.hasModulesSettings());this.modulesList.innerHTML="";this.modulesList.appendChild(a)}renderError(a){const b=document.createElement("div");b.className="error_";b.innerHTML=`<div class="error-msg_">${a.message}</div>`;this.modulesList.before(b);
this.modulesList.remove()}handleSubExpiration(a){a&&(a[0]===GPModulesManager_.STATE.SUBSCRIPTION||a[0]===GPModulesManager_.STATE.TIME_LEFT||a[0]===GPModulesManager_.STATE.GIFT?this.s.lastAuthSuccess=!0:a[0]===GPModulesManager_.STATE.EXPIRED&&(!0===this.s.lastAuthSuccess&&this.root.abt?.showSubExpiredNotice(),this.s.lastAuthSuccess=!1))}firstRunInit(){let a=JSON.parse(localStorage.getItem("gp_first-run"));!1!==a&&(a=!a,localStorage.setItem("gp_first-run",JSON.stringify(a)));this.firstRun=a}requestTwitchToken(){this.twitchAuthWindow?.close();
this.twitchAuthWindow=window.open(GPModulesManager_.TWITCH_AUTH_URL)}waitForAnalyticsConsent(){return new Promise(a=>{document.addEventListener("gp.abt.analytics_consent_granted",b=>{a()},{once:!0});this.root.abt?.showAnalyticsNotice()})}setLanguage(a){this.lang=a;var b=this.lang!==this.loc.getLang();this.reloadBtn.classList.toggle("alert_",b);this.reloadBtn.classList.toggle("disabled_",!b);if(b=GPModulesManager_.RELOAD_BTN_L10N[a])this.reloadBtn.textContent=b;localStorage.setItem("gp_localization",
JSON.stringify({lang:a}))}areHiddenSettings(a){return this.hiddenSettings.has(a)}isFirstRun(){return this.firstRun}}window.GPModulesManager_=GPModulesManager_;class GPModuleError_ extends Error{constructor(a){super(a)}}class GPAuthError_ extends Error{constructor(a){super(a)}}class GPDecryptError_ extends Error{constructor(a){super(a)}};class GPSettingsImporterExporter_ extends EventTarget{static CATEGORIES={"internal settings":["gp_latest-version","gp_first-run","gp_localization","avatar","gp_about"],key:["gp_activation"],background:["gp_background","gp_background_db"],modules:{"anti-cheat":["gp_anti-cheat"],"art broadcaster":["gp_art-broadcaster"],avatars:["gp_avatars"],"global banlist":["gp_global-banlist"],moderation:["ul_banlist","gp_userlist","gp_users_db"],painter:["gp_painter","gp_painter_bindings","gp_custom-palettes","gp_painter_custom-palette"],
reference:["gp_reference"],"timelapse player":["gp_timelapse-player","gp-timelapse-player-speed"],timer:["gp_timer"],"modules manager":["gp_mm"]}};static UNSPECIFIED_CATEGORY="internal settings";static IGNORED_STORAGES=["gp_auth-filename","gp_update"];static STATIC_STORAGES=["avatar","ul_banlist"];static STATIC_DATABASES=["gp_background_db","gp_users_db"];static REPLACEMENTS=[["gp_update","gp_latest-version"]];constructor(a){super();this.l=a;this.importData=this.settingsMap=this.categoryMap=this.sortingMap=
this.importer=null}init(a,b,c){this.mm=a;this.appVersion=b;this.username=c}exportSettings(){const a=Object.keys(localStorage).filter(b=>(b.startsWith("gp_")&&!GPSettingsImporterExporter_.IGNORED_STORAGES.includes(b)||GPSettingsImporterExporter_.STATIC_STORAGES.includes(b))&&this.filterStorage(b)).map(b=>this.cleanStorage(b));window.indexedDB.databases().then(b=>{b=b.filter(c=>GPSettingsImporterExporter_.STATIC_DATABASES.includes(c.name)).map(c=>{const d=window.indexedDB.open(c.name,c.version);return new Promise(e=>
{d.onsuccess=f=>{const g=f.target.result;f=this.filterDBStores(g).map(h=>new Promise(k=>{const l=g.transaction(h,"readonly").objectStore(h);l.getAll().onsuccess=m=>{k({name:l.name,keyPath:l.keyPath,autoIncrement:l.autoIncrement,indexes:[...l.indexNames].map(p=>{const {name:r,keyPath:q,unique:n,multiEntry:u}=l.index(p);return{name:r,keyPath:q,unique:n,multiEntry:u}}),entries:m.target.result})}}));Promise.all(f).then(h=>e({name:g.name,version:g.version,stores:h}))}})});Promise.all(b).then(async c=>
{var d=await this.serializeSettings(a,c);c=`gpmod settings (${this.username}).gpset`;d=URL.createObjectURL(d);const e=document.createElement("a");e.href=d;e.download=c;e.click();URL.revokeObjectURL(d)})})}filterStorage(a){switch(a){case "gp_mm":return a=JSON.parse(localStorage.getItem(a)||null),!!a&&!(1===Object.keys(a).length&&a.disabledList&&!a.disabledList.length);case "gp_auth-filename":return!!JSON.parse(localStorage.getItem(a)||null);case "ul_banlist":return!!JSON.parse(localStorage.getItem(a)||
null)?.length;default:return!0}}cleanStorage(a){switch(a){case "gp_localization":const b=JSON.parse(localStorage.getItem("gp_localization")).lang;return[a,JSON.stringify({lang:b})];default:return[a,localStorage.getItem(a)]}}filterDBStores(a){const b=Array.from(a.objectStoreNames);switch(a.name){case "gp_background_db":if(1<b.length&&b.indexOf("backgrounds_v3"))return a=b.indexOf("backgrounds"),~a&&b.splice(a,1),b;default:return b}}serializeSettings(a,b){return new Promise(c=>{const d=[];b=b.filter(e=>
e.stores.every(f=>{f.entries.forEach(g=>{g.blob&&d.push(this.convertBlobToBase64(g.blob,g))});return f.entries.length}));Promise.all(d).then(async e=>{e.forEach(([f,g])=>{g.blob=f});e={storages:a,databases:b,meta:{username:this.username,version:this.appVersion,timestamp:Date.now()}};e=await GPUtils_.compressData(e);c(e)})})}convertBlobToBase64(a,b){return new Promise(c=>{const d=new FileReader;d.readAsDataURL(a);d.onloadend=()=>{c([d.result,b])}})}importSettings(){const a=document.createElement("input");
a.type="file";a.accept=".gpset";a.addEventListener("change",async b=>{this.closeImporter();if(b=b.target.files?.[0]){const {storages:c,databases:d,meta:e}=await this.deserializeSettings(b);this.openImporter(c,d,e)}});a.click()}deserializeSettings(a){return new Promise(async b=>{const {storages:c,databases:d,meta:e}=await GPUtils_.decompressFile(a),f=new Map(GPSettingsImporterExporter_.REPLACEMENTS);c.forEach(h=>{const k=f.get(h[0]);k&&(h[0]=k)});const g=[];d.forEach(h=>{h.stores.forEach(k=>{k.entries.forEach(l=>
{l.blob&&g.push(this.convertBase64ToBlob(l.blob,l))})})});Promise.all(g).then(h=>{h.forEach(([k,l])=>{l.blob=k});b({storages:c,databases:d,meta:e})})})}async applySettings({storages:a,databases:b}){a&&a.forEach(([c,d])=>{"gp_about"===c&&(d=JSON.parse(d),d.lastNotifiedVersion=JSON.parse(localStorage.getItem("gp_about"))?.lastNotifiedVersion??null,d=JSON.stringify(d));localStorage.setItem(c,d)});b&&(a=b.map(c=>new Promise((d,e)=>{const f=window.indexedDB.open(c.name,c.version),g=c.stores;f.onupgradeneeded=
h=>{const k=h.target.result;g.map(l=>{const m=k.createObjectStore(l.name,{keyPath:l.keyPath,autoIncrement:l.autoIncrement});l.indexes.forEach(p=>{const {name:r,keyPath:q,...n}=p;m.createIndex(r,q,n)})})};f.onsuccess=h=>{const k=h.target.result;h=g.map(l=>new Promise(m=>{const p=k.transaction(l.name,"readwrite");p.oncomplete=m;const r=p.objectStore(l.name);r.clear().onsuccess=()=>{l.entries.forEach((q,n)=>{r.add(q,l.keyPath?void 0:n)})}}));Promise.all(h).then(d)};f.onerror=e})),await Promise.allSettled(a));
this.mm.reloadPage()}convertBase64ToBlob(a,b){return fetch(a).then(c=>c.blob()).then(c=>[c,b])}convertBlobToJSON(a){return new Promise(b=>{const c=new FileReader;c.readAsText(a);c.onloadend=()=>{b(JSON.parse(c.result))}})}initImporter(){this.sortingMap=new Map;this.categoryMap=this.buildCategoryMap(GPSettingsImporterExporter_.CATEGORIES);this.categories=document.createElement("form");this.categories.className="gp-importer-categories_";this.categories.addEventListener("contextmenu",a=>{a.preventDefault()});
this.importer=GPModalManager_.createModal("settings-importer",{title:this.l.IMPORTER_TITLE,icon:"\u2699\ufe0f",hoverTitle:"",hoverIcon:"\ud83d\udccb",content:this.categories,buttons:[[this.l.IMPORTER_IMPORT_BTN,this.handleImportButtonClick.bind(this)]]})}openImporter(a,b,c){this.importData={storages:a,databases:b,meta:c};this.importer||this.initImporter();this.settingsMap=this.getImportedSettingsMap(a,b);this.renderImporterSettings(this.settingsMap,c);a=this.mm.getElement().getBoundingClientRect();
GPModalManager_.showModal("settings-importer",{bottom:35,left:a.x+a.width+24})}closeImporter(){GPModalManager_.closeModal("settings-importer")}handleImportButtonClick(){const {storages:a,databases:b}=this.importData;var c=this.parseCategories();c=this.filterImporterSettings(a,b,this.settingsMap,c);this.settingsMap=this.importData=null;this.applySettings(c)}parseCategories(){return new Set([...this.categories.elements].filter(a=>a.checked).map(a=>a.name))}filterImporterSettings(a,b,c,d){const e=new Set([...c].filter(([f])=>
d.has(f)).map(([,f])=>f).flat());return[a.filter(f=>e.has(f[0])),b.filter(f=>e.has(f.name))]}getImportedSettingsMap(a,b){a=a.map(d=>d[0]);b=b.map(d=>d.name);const c=new Map;[a,b].forEach(d=>{d.forEach(e=>{const f=this.categoryMap.get(e)??GPSettingsImporterExporter_.UNSPECIFIED_CATEGORY,g=c.get(f);g?g.push(e):c.set(f,[e])})});return c}renderImporterSettings(a,b){b=`${b.username} (${(new Date(b.timestamp)).toLocaleDateString()})`;this.importer.style.setProperty("--hover-title",`'${b}'`);this.categories.innerHTML=
"";const c=document.createDocumentFragment();Array.from(a.keys()).sort((d,e)=>this.sortingMap.get(d)-this.sortingMap.get(e)).forEach((d,e)=>{const f=!(d in GPSettingsImporterExporter_.CATEGORIES),g="internal settings"===d;var h=f?d:this.l[`IMPORTER_${d.toUpperCase().replace(/\s/g,"_")}`];const k=document.createElement("div");k.className="category_";k.classList.toggle("disabled_",g);k.classList.toggle("module_",f);k.dataset.name=d;const l=document.createElement("div");l.className="name_";l.textContent=
h;l.addEventListener("click",p=>{g||(p.ctrlKey?this.single\u0421ontrolClickHandler(p,m):m.click())});l.addEventListener("auxclick",p=>{g||2===p.button&&this.single\u0421ontrolClickHandler(p,m)});k.appendChild(l);e=`gp-imp-cat-${e}_`;h=document.createElement("div");h.className="checkbox_";k.appendChild(h);const m=document.createElement("input");m.type="checkbox";m.id=e;m.className="gp-ui-cb_";m.name=d;m.checked=!0;h.appendChild(m);g&&(m.disabled=!0);d=document.createElement("label");d.className="gp-ui-cb-label_";
d.htmlFor=e;d.addEventListener("click",p=>{p.ctrlKey&&this.single\u0421ontrolClickHandler(p,p.target.control)});d.addEventListener("auxclick",p=>{2===p.button&&this.single\u0421ontrolClickHandler(p,p.target.control)});h.appendChild(d);f?c.appendChild(k):this.categories.appendChild(k)});c.childElementCount&&(a=document.createElement("div"),a.className="modules-label_",a.textContent=this.l.IMPORTER_MODULES,this.categories.appendChild(a),this.categories.appendChild(c))}"single\u0421ontrolClickHandler"(a,
b){a.preventDefault();const c=Array.from(this.categories.elements).every(d=>d!==b?d.disabled||!d.checked:d.checked);Array.from(this.categories.elements).forEach(d=>{d.disabled||(d.checked=d===b?c?!d.checked:!0:!1)})}buildCategoryMap(a,b=new Map,c=0){Object.entries(a).forEach(([d,e])=>{Array.isArray(e)?e.forEach(f=>{b.set(f,d);this.sortingMap.set(d,c++)}):b=new Map([...b,...this.buildCategoryMap(e,b,c)])});return b}}window.GPSettingsImporterExporter_=GPSettingsImporterExporter_;class GPSettingsManager_ extends EventTarget{static POINTER_SLIDER_PREVIEW_CHANGE_SENSITIVITY=Math.round(window.screen.height/1080*15);constructor(a,b){super();this.mm=a;this.l=b;this.views=new Set;this.viewsData=new Map;this.isRendered=!1;this.currentLabels=new Map;this.ie=new GPSettingsImporterExporter_(b);this.close=this.close.bind(this);this.addEventListener("update",({detail:{module:c,storage:d,settings:e,changedSettings:f}})=>{c.dispatchEvent(new CustomEvent("settings_updated",{detail:{settings:f}}));
this.saveSettings(d,Object.assign({},e,f))})}setSettings(a,b){const {name:c,MODULE:{title:d,settings:{storage:e,defaultSettings:f,ui:g={}}}}=a.constructor;b&&a.addEventListener("settings_updated",b.bind(a));b=Object.assign({},f,JSON.parse(localStorage.getItem(e))||{});a.settings=b;const h=[...Object.values(g)].some(l=>!l.hidden),k=this.copy(b);this.viewsData.set(c,{title:d,module:a,storage:e,settings:b,defaultSettings:f,initialSettings:k,ui:g,hasVisibleSettings:h});return this.buildSettingsAPI(c,
b,g,e,a)}hasSettings(a){return this.viewsData.has(a)&&this.hasVisibleSettings(a)}hasModulesSettings(){return!!this.viewsData.size}buildSettingsAPI(a,b,c,d,e){const f=this;return new Proxy(b,{set(g,h,k){k={[h]:k};Object.assign(g,k);h=!(!c[h]||!0===c[h].hidden);f.dispatchEvent(new CustomEvent("update",{detail:{module:e,storage:d,settings:g,changedSettings:k}}));h&&f.updateViews(a);return!0},get(g,h){return g[h]}})}render(a,b=!1){this.container=document.createElement("div");this.container.className=
"gp-settings-manager_";this.container.classList.toggle("load-btn-shown_",b);b=document.createElement("div");b.className="close-btn_ gp-ui-close-btn_";b.addEventListener("click",this.close);this.container.appendChild(b);b=document.createElement("div");b.className="header_";this.container.appendChild(b);this.modulesMenu=document.createElement("select");this.modulesMenu.className="modules-menu_";this.modulesMenu.addEventListener("change",d=>{this.selectModule(d.target.value)});this.renderSettingsList(a);
b.appendChild(this.modulesMenu);if(this.modulesMenu.value){a=document.createElement("div");a.className="modules-menu-buttons_";b.appendChild(a);this.labelsBtn=document.createElement("div");this.labelsBtn.className="labels-btn_ btn_";this.labelsBtn.title=this.l.CATEGORY_LIST_TTL;this.labelsBtn.addEventListener("pointerdown",d=>{this.container.classList.toggle("labels_");this.container.classList.contains("labels_")&&(this.labelList.value="",document.addEventListener("pointerdown",e=>{e.target.parentElement!==
this.labelList&&e.target!==this.labelsBtn&&this.container.classList.remove("labels_")},{once:!0,capture:!0}))});a.appendChild(this.labelsBtn);this.labelList=document.createElement("select");this.labelList.className="label-list_";this.labelList.addEventListener("change",d=>{this.selectLabel(d.target.value);this.container.classList.remove("labels_");this.labelList.value=""});b.appendChild(this.labelList);var c=document.createElement("div");c.className="search-btn_ btn_";c.title=this.l.SEARCH_TTL;c.addEventListener("pointerdown",
d=>{this.container.classList.toggle("search_");this.container.classList.contains("search_")?setTimeout(()=>{this.searchField.focus()},1):this.searchField.value&&(this.searchField.value="",this.filter(null))});a.appendChild(c);this.searchField=document.createElement("input");this.searchField.className="search-field_ gp-ui-input_";this.searchField.type="search";this.searchField.placeholder=this.l.SEARCH_INPUT_PH;this.searchField.setAttribute("spellcheck","false");this.searchField.setAttribute("autocomplete",
"off");this.searchField.toggleAttribute("incremental",!0);this.searchField.addEventListener("search",d=>{this.filter(d.target.value)});this.searchField.addEventListener("keydown",d=>{switch(d.key){case "Escape":d.target.classList.add("hidden");case "Enter":d.target.blur()}});GPUtils_.setInputFocusBlurHandler(this.searchField);b.appendChild(this.searchField);document.body.appendChild(this.container);this.renderSettings(this.modulesMenu.value);this.isRendered=!0;GPModalManager_.addModal(this.container)}}renderSettingsList(a){this.modulesMenu.innerHTML=
"";const b=new Intl.Collator("us",{sensitivity:"base"});Array.from(this.viewsData).filter(([c])=>!this.isHiddenModule(c)&&this.hasVisibleSettings(c)).sort(([,c],[,d])=>b.compare(c.title,d.title)).forEach(([c,d])=>{const e=document.createElement("option");e.value=c;e.textContent=d.title;this.modulesMenu.appendChild(e)});a&&(this.modulesMenu.value=a)}shouldModuleBeRendered(a){return this.viewsData.has(a)&&!this.isHiddenModule(a)}selectModule(a){this.updateView(this.view,a);this.updateHeader(a)}renderSettings(a){this.view=
this.insertView(a,this.container);this.updateHeader(a)}updateHeader(a){this.labelsBtn.classList.toggle("empty_",!this.view.labels.size);this.updateLabelList(this.view.labels);this.searchField.value="";this.container.classList.remove("search_");this.modulesMenu.value=a}updateViews(a,b=null){this.views.forEach(c=>{c.moduleName===a&&c!==b&&c.offsetParent&&this.updateView(c)})}insertView(a,b){if(this.shouldModuleBeRendered(a))return this.renderView(a,b)}renderView(a,b){const {view:c,controls:d}=this.buildView(a);
b.appendChild(c);this.handleControlsScrollbar(d);this.handleControlsScrollHints(d);return c}buildView(a,b=null){const {module:c,storage:d,settings:e,ui:f}=this.viewsData.get(a);b?b.innerHTML="":(b=document.createElement("div"),b.className="gp-settings_",b.dataset.viewIndex=this.views.size,b.scrollPos=0,b.addEventListener("animationend",r=>{"gp-set-highlight_"===r.animationName&&r.target.classList.remove("highlight_")}),(new ResizeObserver(r=>{r[0].contentRect.height&&this.updateScrollPos(b)})).observe(b),
this.views.add(b));b.moduleName=a;b.labels=new Map;const g=document.createElement("div");g.className="controls_ gp-ui-scrollbar_";g.view=b;g.addEventListener("scroll",r=>{b.scrollPos=r.target.scrollTop;this.handleControlsScrollHints(r.target)});b.appendChild(g);b.controls=g;var h=document.createElement("div");h.className="buttons_";b.appendChild(h);const k=document.createElement("div");k.className="load-btn_ btn_ gp-ui-btn_";k.textContent="\ud83e\udc45";k.title=this.l.LOAD_JSON_TTL;k.addEventListener("click",
()=>{b.classList.toggle("json-data_");l.focus()});k.addEventListener("animationend",r=>{r.target.classList.remove("failure_");r.target.classList.remove("success_")});h.appendChild(k);const l=document.createElement("input");l.className="json-data-input_ gp-ui-input_";l.placeholder=this.l.JSON_INPUT_PH;l.spellcheck=!1;l.autocomplete="off";l.addEventListener("keydown",r=>{"Escape"===r.key&&(b.classList.remove("json-data_"),r.target.blur())});l.addEventListener("input",r=>{this.jsonDataInputHandler(a,
r.target,k)});GPUtils_.setInputFocusBlurHandler(l);h.appendChild(l);var m=document.createElement("div");m.className="restore-btn_ btn_ gp-ui-btn_";m.textContent=this.l.RESTORE_BTN;m.title=this.l.RESTORE_BTN_TTL;m.addEventListener("click",()=>{this.restore(a)});h.appendChild(m);m=document.createElement("div");m.className="default-btn_ btn_ gp-ui-btn_";m.textContent=this.l.RESET_BTN;m.title=this.l.RESET_BTN_TTL;m.addEventListener("click",()=>{this.reset(a)});h.appendChild(m);h=document.createDocumentFragment();
for(let r in f)if(m=f[r]??{},this.isLabel(r)){var p=document.createElement("div");p.className="label_";p.textContent=m.text;h.appendChild(p);b.labels.set(m.text,p)}else if(this.isSeparator(r))p=document.createElement("div"),p.className="separator_",p.classList.toggle(`${m.size}_`,!!m.size),h.appendChild(p);else if(m.type&&!m.hidden)switch(m.type){case "component":p=document.createElement("div");p.className="component_";p.dataset.name=r;p.appendChild(m.getElement());h.appendChild(p);this.setControlStateAndDependents(f,
r,e,p);break;case "buttons":const q=document.createElement("div");q.className="buttons_";q.dataset.name=r;m.getButtons().forEach(u=>{u.classList.add("btn_");q.appendChild(u)});h.appendChild(q);this.setControlStateAndDependents(f,r,e,q);break;default:p=document.createElement("div");p.className="setting_";p.dataset.name=r;const n=GPUtils_.buildTooltip(m.description);p.appendChild(n);m=this.buildName(r,m.description);p.appendChild(m);m=this.buildControl(f,r,e[r],c,d,e,g);p.appendChild(m);h.appendChild(p);
this.setControlStateAndDependents(f,r,e,p)}g.appendChild(h);return{view:b,controls:g}}updateView(a,b=null){const {controls:c}=this.buildView(b??a.moduleName,a);this.handleControlsScrollbar(c);this.handleControlsScrollHints(c);this.updateScrollPos(a,b?0:a.scrollPos)}updateScrollPos(a,b){a.controls.scrollTop=b??a.scrollPos}handleControlsScrollbar(a){a.scrollHeight>a.clientHeight&&(a.parentElement.clientHeight-41>a.scrollHeight?a.style.paddingBottom=`${a.scrollHeight-a.clientHeight}px`:a.classList.add("scrollbar_"))}handleControlsScrollHints(a){a.parentElement.classList.toggle("scroll-hint-top_",
0<a.scrollTop);a.parentElement.classList.toggle("scroll-hint-bottom_",a.offsetHeight+a.scrollTop<a.scrollHeight)}isLabel(a){return/^_\d+/.test(a)}isSeparator(a){return/^_+$/.test(a)}buildName(a,b){const c=document.createElement("div");c.className="name_";c.title=b||"";c.textContent=this.formatName(a);return c}formatName(a){const b=[];let c=/([A-Z]{2,}(?=[A-Z][a-z]|[0-9]|$))|([A-Z][a-z]+)|([a-z]+)|([0-9]+)/g,d;for(;null!==(d=c.exec(a));)b.push(d[0]);return b.join(" ")}buildControl(a,b,c,d,e,f,g){const {type:h,
args:k,formatter:l,l10n:m,inputTrigger:p,beforeActivation:r}=a[b],q=document.createElement("div");q.className="control_";let n;switch(h){case "switch":n=document.createElement("div");n.className="gp-ui-switch_";var u=`ctrl-${g.view.dataset.viewIndex}-${b}_`;const v=document.createElement("input");v.id=u;v.type="checkbox";v.name=b;v.checked=c;if(r){let z=!1;v.addEventListener("click",async G=>{G.preventDefault();if(!z){if(v.checked&&(z=!0,G=await r(),z=!1,!G))return;requestAnimationFrame(()=>{v.checked=
!v.checked;v.dispatchEvent(new Event("change",{bubbles:!0}))})}})}n.appendChild(v);const x=document.createElement("label");x.setAttribute("for",u);n.appendChild(x);q.appendChild(n);break;case "slider":const {min:w,max:t,step:D,reverse:B}=k;n=document.createElement("input");n.className="gp-ui-slider_";n.type="range";n.min=w;n.max=t;n.step=D;n.value=c;n.name=b;B&&(n.style.direction="rtl");n.addEventListener("input",z=>{A.textContent=l?l(Number.parseFloat(z.target.value)):z.target.value});const A=document.createElement("div");
A.className="gp-ui-slider-preview_";A.textContent=l?l(c):c;A.addEventListener("pointerdown",z=>{let G=z.clientY;const E=I=>{var H=I.clientY-G;const C=0>H;Math.abs(H)>=GPSettingsManager_.POINTER_SLIDER_PREVIEW_CHANGE_SENSITIVITY&&(H=n.valueAsNumber,H+=(B?!C:C)?D:-D,H=Math.max(Math.min(H,t),w),H=Math.round(1E3*H)/1E3,n.value=H,A.textContent=l?l(H):H,n.dispatchEvent(new Event("change",{bubbles:!0})),G=I.clientY)},J=I=>{const H=0>I.deltaY;let C=n.valueAsNumber;C+=(B?!H:H)?D:-D;C=Math.max(Math.min(C,t),
w);C=Math.round(1E3*C)/1E3;n.value=C;A.textContent=l?l(C):C;n.dispatchEvent(new Event("change",{bubbles:!0}));I.preventDefault();I.stopPropagation();I.stopImmediatePropagation()};z.currentTarget.setPointerCapture(z.pointerId);z.currentTarget.addEventListener("pointermove",E);z.currentTarget.addEventListener("pointerup",I=>{I.currentTarget.removeEventListener("pointermove",E);document.removeEventListener("wheel",J,{passive:!1});n.focus()},{once:!0});document.addEventListener("wheel",J,{passive:!1})});
q.appendChild(n);q.appendChild(A);break;case "list-numbers":({items:u}=k);n=document.createElement("form");n.className="gp-ui-list-n_";n.value=c;n.name=b;u.forEach(({min:z,max:G,step:E,reverse:J},I)=>{const H=document.createElement("input");H.type="range";H.value=c[I];H.name=b;n.appendChild(H);const C=document.createElement("div");C.className="gp-ui-slider-preview_";C.textContent=l?l(c[I]):c[I];C.addEventListener("animationend",N=>{"list-n-item-highlight_"!==N.animationName&&"list-n-item-fadeout_"!==
N.animationName||C.classList.remove("up_","down_")});C.addEventListener("pointerdown",N=>{if(0===N.button){this.resetPreviewAnimation(C);C.classList.add("active_");var P=N.clientY,R=N.clientY,S=M=>{R+=M.movementY;var L=R-P;const O=0>L;Math.abs(L)>=GPSettingsManager_.POINTER_SLIDER_PREVIEW_CHANGE_SENSITIVITY&&(L=c[I],M=E*(M.shiftKey?10:M.ctrlKey?100:1),L+=(J?!O:O)?M:-M,L=Math.max(Math.min(L,G),z),L=Math.round(1E3*L)/1E3,H.value=L,c[I]=L,C.textContent=l?l(L):L,this.updatePreviewAnimation(C,O),H.dispatchEvent(new Event("change",
{bubbles:!0})),P=R)},W=M=>{0===M.button&&(C.removeEventListener("pointermove",S),document.removeEventListener("wheel",T,{passive:!1}),document.removeEventListener("pointerlockchange",U),document.exitPointerLock(),C.classList.remove("active_"))},T=M=>{const L=0>M.deltaY;let O=c[I],X=E*(M.shiftKey?10:M.ctrlKey?100:1);O+=(J?!L:L)?X:-X;O=Math.max(Math.min(O,G),z);O=Math.round(1E3*O)/1E3;H.value=O;c[I]=O;C.textContent=l?l(O):O;this.updatePreviewAnimation(C,L);H.dispatchEvent(new Event("change",{bubbles:!0}));
M.preventDefault()},U=M=>{document.pointerLockElement||(C.removeEventListener("pointermove",S),C.removeEventListener("pointerup",W,{once:!0}),document.removeEventListener("wheel",T,{passive:!1}),document.removeEventListener("pointerlockchange",U),C.classList.remove("active_"))};C.setPointerCapture(N.pointerId);C.addEventListener("pointermove",S);C.addEventListener("pointerup",W,{once:!0});document.addEventListener("wheel",T,{passive:!1});document.addEventListener("pointerlockchange",U);C.requestPointerLock()}});
n.appendChild(C)});q.appendChild(n);break;case "input":u=k?.secure;n=document.createElement("input");n.className="gp-ui-input_";n.classList.toggle("secure-input_",!!u);n.spellcheck=!1;n.autocomplete="off";n.value=c;n.name=b;n.addEventListener("keydown",z=>{switch(z.key){case "Escape":z.target.value=z.target.dataset.initialValue;case "Enter":z.target.blur()}});n.addEventListener("focus",z=>{z.target.dataset.initialValue=z.target.value});n.addEventListener("blur",z=>{delete z.target.dataset});GPUtils_.setInputFocusBlurHandler(n);
q.appendChild(n);break;case "dropdown":n=document.createElement("select");n.className="gp-ui-dropdown_";n.autocomplete="off";n.name=b;const {items:y,itemsProxySetting:F}=k;(F&&f[F]||(y?.length?y:[c])).forEach((z,G)=>{const E=document.createElement("option");E.value=z;E.textContent=l?l(z,G):z;n.appendChild(E)});n.value=c;q.appendChild(n);break;case "list-multiple":case "list-multiple-dynamic":u="list-multiple"===h?k.items:c;n=document.createElement("form");n.className="gp-ui-list-m_";n.name=b;u.forEach((z,
G)=>{const E=`ctrl-${g.view.dataset.viewIndex}-${b}-${G}_`,J=document.createElement("input");J.id=E;J.type="checkbox";J.value=z;J.name=b;J.checked=c.includes(z);n.appendChild(J);z=m&&d.l?d.l[m[G]]:l?l(z,G):z;G=document.createElement("label");G.textContent=z;G.title=z;G.setAttribute("for",E);n.appendChild(G)});q.appendChild(n);break;case "list-icons":const {icons:K}=k;n=document.createElement("form");n.className="gp-ui-list-i_";n.name=b;const Q=[];Object.keys(K).forEach((z,G)=>{G=`ctrl-${g.view.dataset.viewIndex}-${b}-${G}_`;
const E=document.createElement("input");E.id=G;E.type="checkbox";E.name=b;E.value=z;E.checked=c===z;E.addEventListener("click",I=>{Q.forEach(H=>{H.checked=H===E})});n.appendChild(E);Q.push(E);const J=document.createElement("label");J.className="gp-ui-list-i-icon_";J.title=z.split("-").map(I=>I[0].toUpperCase()+I.slice(1)).join(" ");J.style.backgroundImage=`url("${K[z]}")`;J.setAttribute("for",G);n.appendChild(J)});q.appendChild(n);break;case "color":n=document.createElement("input");n.className="gp-ui-color_";
n.type="color";n.value=c;n.name=b;q.appendChild(n);break;case "colors":const {proportions:V}=k;n=document.createElement("form");n.className="gp-ui-colors_";n.value=c;n.name=b;c.forEach((z,G)=>{const E=document.createElement("input");E.type="color";E.value=z;E.name=b;E.style.flex=V[G]??1;E.addEventListener("change",J=>{c[G]=J.target.value;E.dispatchEvent(new Event("change",{bubbles:!0}))});n.appendChild(E)});q.appendChild(n)}u=["change","input"];for(let v=0;v<(p?2:1);v++)n.addEventListener(u[v],x=>
{x={[x.target.name]:this.parseValue(x.target,h)};this.dispatchEvent(new CustomEvent("update",{detail:{module:d,storage:e,settings:Object.assign(f,x),changedSettings:x}}));0===v&&this.updateViews(g.view.moduleName,g.view)});n.addEventListener("change",v=>{a[b].dependents&&a[b].dependents.forEach(x=>{this.updateControlState(x,a,f,g)})});return q}resetPreviewAnimation(a){a.classList.remove("up_","down_");a.offsetLeft}updatePreviewAnimation(a,b){b=b?"up_":"down_";a.classList.remove("up_","down_");a.offsetLeft;
a.classList.add(b)}updateControlState(a,b,c,d){b[a].requires&&(b=this.calcControlState(b[a],c),d.querySelector(`:scope > [data-name="${a}"]`)?.classList.toggle("disabled_",!b))}calcControlState(a,b){return Object.entries(a.requires).every(([c,d])=>b[c]===d)}parseValue(a,b){switch(a.type){case "range":return"list-numbers"===b?a.form.value:Number.parseFloat(a.value);case "checkbox":return a.form?"list-icons"===b?a.value:[...a.form].filter(c=>c.checked).map(c=>c.value):a.checked;case "color":return"colors"===
b?a.form.value:a.value;default:return a.value}}jsonDataInputHandler(a,b,c){c.classList.remove("failure_");c.classList.remove("success_");try{let d=JSON.parse(b.value);const {settings:e,module:f,storage:g}=this.viewsData.get(a);d=this.filterSettings(d,e);if(Object.keys(d).length){const h=this.copy(d);Object.assign(e,h);this.updateViews(a);this.dispatchEvent(new CustomEvent("update",{detail:{module:f,storage:g,settings:e,changedSettings:h}}));c.classList.add("success_")}else c.classList.add("failure_")}catch(d){c.classList.add("failure_")}b.value=
""}filterSettings(a,b){for(let c in a)c in b||delete a[c];return a}setControlStateAndDependents(a,b,c,d){if(a[b].requires){let e=!1;Object.entries(a[b].requires).forEach(([f,g])=>{c[f]!==g&&(e=!0);f in c&&(a[f].dependents?a[f].dependents.add(b):a[f].dependents=new Set([b]))});d.classList.toggle("disabled_",e)}}selectLabel(a){if(a=this.view.labels.get(a))a.classList.add("highlight_"),a.scrollIntoView({behavior:"smooth"})}updateLabelList(a){this.labelList.innerHTML="";const b=document.createDocumentFragment();
b.appendChild(document.createElement("option"));a.forEach((c,d)=>{c=document.createElement("option");c.value=d;c.textContent=d;b.appendChild(c)});this.labelList.appendChild(b);this.labelList.size=a.size+1;this.labelList.style.height=`${26*a.size}px`;this.container.classList.remove("labels_")}filter(a){a=a?.replace(/\s/g,"").toLowerCase();Array.from(this.view.firstElementChild.children).forEach(b=>{if(a){const c=b.dataset.name?.replace(/\s/g,"").toLowerCase();c&&~c.indexOf(a)?b.style.display="":b.style.display=
"none"}else b.style.display=""});this.handleControlsScrollbar(this.view.controls)}initImporterExporter(a,b){this.ie.init(this.mm,a,b)}exportSettings(){this.ie.exportSettings()}importSettings(){this.ie.importSettings()}closeImporter(){this.ie.closeImporter()}reset(a){const {settings:b,defaultSettings:c,module:d,storage:e}=this.viewsData.get(a),f=this.copy(c);Object.assign(b,f);for(let g in b)g in f||delete b[g];this.updateViews(a);this.dispatchEvent(new CustomEvent("update",{detail:{module:d,storage:e,
settings:b,changedSettings:f}}))}restore(a){const {settings:b,initialSettings:c,module:d,storage:e}=this.viewsData.get(a),f=this.copy(c);Object.assign(b,f);this.updateViews(a);this.dispatchEvent(new CustomEvent("update",{detail:{module:d,storage:e,settings:b,changedSettings:f}}))}copy(a){return window.structuredClone(a)}toggle(a,b,c=!1){if(this.isRendered){const d=!this.container.classList.toggle("hidden",void 0===a?void 0:!a);this.container.classList.toggle("load-btn-shown_",c);this.view.classList.remove("json-data_");
a&&b&&this.selectModule(b);d?GPModalManager_.promote(this.container):GPModalManager_.closeModal("native-avatars")}else!1!==a&&(this.render(b,c),GPModalManager_.promote(this.container))}close(){this.isOpened()&&this.toggle(!1);GPModalManager_.closeModal("native-avatars")}isOpened(){return!this.container?.classList.contains("hidden")}isHiddenModule(a){return this.mm.areHiddenSettings(a)}hasVisibleSettings(a){return this.viewsData.get(a).hasVisibleSettings}updateSettingsList(){this.isRendered&&this.renderSettingsList()}saveSettings(a,
b){localStorage.setItem(a,JSON.stringify(b))}}window.GPSettingsManager_=GPSettingsManager_;class GPAcoDecoder_{static COLOR_MODE={RGB:0,HSB:1,LAB:7,GRAYSCALE:8};static COLOR_MODES_SIGNS={[this.COLOR_MODE.RGB]:[0,0,0,0],[this.COLOR_MODE.HSB]:[0,0,0,0],[this.COLOR_MODE.LAB]:[0,-1,-1,0],[this.COLOR_MODE.GRAYSCALE]:[0,0,0,0]};static decode(a){try{return this.parseACO(a)}catch(b){return null}}static parseACO(a){a=new DataView(a);const b=a.getUint16(2),c=a.getUint16(4),d=[];for(let e=0;e<b;e++){const [f,g,h]=this.readData(a,6+10*e,c);let k;switch(c){case this.COLOR_MODE.RGB:k={r:Math.trunc(f/
256),g:Math.trunc(g/256),b:Math.trunc(h/256),a:1};break;case this.COLOR_MODE.HSB:k={h:Math.trunc(f/182.04),s:Math.trunc(g/655.35),b:Math.trunc(h/655.35)};break;case this.COLOR_MODE.LAB:k={l:Math.round(f/100),a:Math.round(g/100),b:Math.round(h/100)};break;case this.COLOR_MODE.GRAYSCALE:k={r:Math.trunc(f/39.0625),g:Math.trunc(f/39.0625),b:Math.trunc(f/39.0625),a:1}}k&&d.push(k)}return d.length?this.convertToHex(d,c):null}static readData(a,b,c){const d=[];for(let f=0;4>f;f++){var e=b+2*f;e=~this.COLOR_MODES_SIGNS[c][f]?
a.getUint16(e):a.getInt16(e);d.push(e)}return d}static convertToHex(a,b){switch(b){case this.COLOR_MODE.RGB:case this.COLOR_MODE.GRAYSCALE:return a.map(c=>this.rgbToHex(c));case this.COLOR_MODE.LAB:return a.map(c=>this.labToHex(c));case this.COLOR_MODE.HSB:return a.map(c=>this.hsvToHex(c))}}static componentToHex(a){return Math.floor(a).toString(16).padStart(2,"0")}static rgbToHex({r:a,g:b,b:c}){return`${this.componentToHex(a)}${this.componentToHex(b)}${this.componentToHex(c)}`}static hsvToHex({h:a,
s:b,v:c}){a=this.hsvToRgb(a/360,b/100,c/100);return this.rgbToHex(a)}static hsvToRgb(a,b,c){let d,e,f;const g=Math.floor(6*a),h=6*a-g;a=c*(1-b);const k=c*(1-h*b);b=c*(1-(1-h)*b);switch(g%6){case 0:d=c;e=b;f=a;break;case 1:d=k;e=c;f=a;break;case 2:d=a;e=c;f=b;break;case 3:d=a;e=k;f=c;break;case 4:d=b;e=a;f=c;break;case 5:d=c,e=a,f=k}return{r:Math.round(255*d),g:Math.round(255*e),b:Math.round(255*f)}}static labToHex({l:a,a:b,b:c}){a=this.labToRgb([a,b,c]);return this.rgbToHex(a)}static labToRgb(a){var b=
(a[0]+16)/116;let c=a[1]/500+b,d=b-a[2]/200,e;c=.95047*(.008856<c*c*c?c*c*c:(c-16/116)/7.787);b=.008856<b*b*b?b*b*b:(b-16/116)/7.787;d=1.08883*(.008856<d*d*d?d*d*d:(d-16/116)/7.787);a=3.2406*c+-1.5372*b+-.4986*d;e=-.9689*c+1.8758*b+.0415*d;b=.0557*c+-.204*b+1.057*d;a=.0031308<a?1.055*Math.pow(a,1/2.4)-.055:12.92*a;e=.0031308<e?1.055*Math.pow(e,1/2.4)-.055:12.92*e;b=.0031308<b?1.055*Math.pow(b,1/2.4)-.055:12.92*b;return{r:255*Math.max(0,Math.min(1,a)),g:255*Math.max(0,Math.min(1,e)),b:255*Math.max(0,
Math.min(1,b))}}};class GPColorPanel_ extends EventTarget{static MAX_WIDTH=144;static SELECTORS={SCREEN:".screen",STEP:".draw > .step",PANEL:".colors",MARKS:".marks",MARK_COLOR:".marks .color",COLOR_LIST:".colorslist",COLOR:".colors :is(.colorslist, .marks) .color",INPUT_COLOR:'input[type="color"]'};static SET={DEFAULT:"default",CUSTOM_PALETTE:"custom_palette",COLOR_PICKER:"color_picker",COLOR_WHEEL:"color_wheel"};static CONTROL={PALETTE:"palette",CUSTOM_PALETTE:"custom-palette",COLOR_PICKER:"color-picker","FULL_SIZE_\u0421OLOR_PICKER":"full-size-color-picker",
COLOR_WHEEL:"color-wheel"};static SET_CONTROLS={[this.SET.DEFAULT]:[this.CONTROL.PALETTE,this.CONTROL.COLOR_PICKER],[this.SET.CUSTOM_PALETTE]:[this.CONTROL.CUSTOM_PALETTE,this.CONTROL.COLOR_PICKER],[this.SET.COLOR_PICKER]:[this.CONTROL.FULL_SIZE_\u0421OLOR_PICKER],[this.SET.COLOR_WHEEL]:[this.CONTROL.COLOR_PICKER,this.CONTROL.COLOR_WHEEL]};constructor(a,b,c){super();this.prx=b;this.l=c;this.style=document.documentElement.style;this.painter=a;this.s=a.getSettings();this.controls=new Set;this.colorInput;
this.palette;this.colorWheel;this.colorPicker;this.fullSizeColorPicker;this.updateTopOffsetTimer;GPUtils_.bindMethods([this.colorsContainerClickHandler,this.colorsContainerDownHandler,this.colorPickerColorChangeHandler,this.colorPickerColor2ChangeHandler,this.colorInputInputHandler,this.colorInputChangeHandler,this.color2InputChangeHandler,this.switchColors,this.wheelHandler],this);this.painter.addEventListener("color",({detail:{color:d}})=>{this.resetPaletteColor();this.colorWheel?.setColor(d);this.colorPicker?.setColor(d);
this.fullSizeColorPicker?.setColor(d);this.colorInput.value=d});this.painter.addEventListener("color2",({detail:{color:d}})=>{this.color2Input.value=d});this.init()}init(){const a=GPColorPanel_.SELECTORS;this.screen=document.querySelector(a.SCREEN);this.step=this.screen.querySelector(a.STEP);this.panel=this.screen.querySelector(a.PANEL);this.marks=this.panel.querySelector(a.MARKS);this.colorList=this.panel.querySelector(a.COLOR_LIST);this.colorsContainer=this.colorList.parentElement;this.panel.addEventListener("wheel",
this.wheelHandler);const b=this.colorsContainer.querySelector(a.MARK_COLOR);this.screen.classList.toggle("color-marks_",b);this.colorsContainer.addEventListener("click",this.colorsContainerClickHandler,!0);this.colorsContainer.addEventListener("pointerdown",this.colorsContainerDownHandler);this.colorsContainer.addEventListener("contextmenu",this.suppressContextMenu);this.colorsContainer.querySelectorAll(a.COLOR).forEach(c=>{const [,d,e,f]=c.style.cssText.match(/\((\d+),\s(\d+),\s(\d+)\)/).map(g=>
+g);c.dataset.color=GPColorUtils_.rgbToHex(d,e,f)});this.nativeColorInput=this.panel.querySelector(a.INPUT_COLOR);this.updateNativePalette(this.s.stretchNativePalette);this.setControlsSet(this.s.colorPanelControlsSet);this.initColorInputs();this.enable();this.updateTopOffset();this.resetPaletteColor()}terminate(){this.panel.removeEventListener("wheel",this.wheelHandler);this.colorsContainer.removeEventListener("click",this.colorsContainerClickHandler,!0);this.colorsContainer.removeEventListener("pointerdown",
this.colorsContainerDownHandler);this.colorsContainer.removeEventListener("contextmenu",this.suppressContextMenu);this.colorInput.removeEventListener("input",this.colorInputInputHandler);this.colorInput.removeEventListener("change",this.colorInputChangeHandler);this.colorInput.removeEventListener("pointerdown",this.switchColors);this.colorInput.removeEventListener("contextmenu",this.suppressContextMenu);this.color2Input.removeEventListener("change",this.color2InputChangeHandler);this.color2Input.removeEventListener("pointerdown",
this.switchColors);this.color2Input.removeEventListener("contextmenu",this.suppressContextMenu);this.colorInput.remove();this.color2Input.remove();this.resetControls()}updateTopOffset(){clearTimeout(this.updateTopOffsetTimer);this.updateTopOffsetTimer=setTimeout(()=>{const a=this.panel.getBoundingClientRect().height/this.painter.getScale();this.panel.style.setProperty("--gp-colors-panel-offset",`${Math.round(Math.min(Math.max(2*(112-(698-a)/2),0),698-a))}px`);this.step.style.setProperty("--gp-step-offset",
420<a?`-${Math.min((a-424)/2,15)}px`:"0")},1)}updateNativePalette(a){this.screen.classList.toggle("gp-prevent-palette-stretching_",!a);this.updateTopOffset()}colorsContainerDownHandler(a){if((0===a.button||2===a.button)&&a.target.classList.contains("color")){var b=a.target.dataset.color;2!==a.button?(this.colorsContainer.querySelectorAll(".sel").forEach(c=>{c.classList.remove("sel")}),a.target.classList.add("sel"),this.palette?.resetPaletteColor(),this.colorPicker?.setColor(b),this.colorInput.value=
b,this.dispatchEvent(new CustomEvent("color",{detail:{color:b}}))):(this.color2Input.value=b,this.dispatchEvent(new CustomEvent("color2",{detail:{color:b}})));a.stopPropagation()}}colorsContainerClickHandler(a){a.target.classList.contains("color")&&a.stopPropagation()}setControlsSet(a){this.resetControls();this.currentControlsSet=a in GPColorPanel_.SET_CONTROLS?a:GPColorPanel_.SET.DEFAULT;a=GPColorPanel_.SET_CONTROLS[this.currentControlsSet];this.panel.classList.add(...a.map(b=>`ctrl-${b}_`));a.forEach(b=>
{switch(b){case GPColorPanel_.CONTROL.PALETTE:0===GPExtendedPalette_.PALETTES[this.s.extendedPaletteName]?.length&&this.painter.setPaletteName(GPExtendedPalette_.PALETTE.DEFAULT);this.s.extendedPalettePanel&&this.initExtendedPalette();break;case GPColorPanel_.CONTROL.CUSTOM_PALETTE:this.initExtendedPalette(GPExtendedPalette_.PALETTE.CUSTOM);break;case GPColorPanel_.CONTROL.COLOR_PICKER:this.s.colorPickerPanel&&this.initColorPicker();break;case GPColorPanel_.CONTROL.FULL_SIZE_\u0421OLOR_PICKER:this.initFullSize\u0421olorPicker();
break;case GPColorPanel_.CONTROL.COLOR_WHEEL:this.initColorWheel()}});this.updateCustomToolsState();this.controls=new Set(a)}changeControlsSet(a){const b=Object.values(GPColorPanel_.SET),c=b.findIndex(d=>d===this.s.colorPanelControlsSet);if(~c){const d=b.length;a=b[0>a?(c+d-1)%d:(c+1)%d]}else a=GPColorPanel_.SET.DEFAULT;this.setControlsSet(a);this.dispatchEvent(new CustomEvent("controls_set_changed",{detail:{name:a}}))}wheelHandler(a){this.changeControlsSet(a.deltaY);a.preventDefault()}initExtendedPalette(a){this.palette&&
this.palette.terminate();this.palette=new GPExtendedPalette_(this.l,a??this.s.extendedPaletteName,()=>this.prx.getNickname(),()=>this.painter.getColor().slice(1));this.palette.addEventListener("palette",({detail:{name:b}})=>{this.painter.setPaletteName(b)});this.palette.addEventListener("color",({detail:{color:b}})=>{this.marks&&this.resetMarksColor();this.colorWheel?.setColor(b);this.fullSizeColorPicker?.setColor(b);this.colorPicker?.setColor(b);this.colorInput.value=b;this.dispatchEvent(new CustomEvent("color",
{detail:{color:b}}))});this.palette.addEventListener("color2",({detail:{color:b}})=>{this.color2Input.value=b;this.dispatchEvent(new CustomEvent("color2",{detail:{color:b}}))});this.painter.isDisabled&&this.palette.disable();this.colorList.after(this.palette.getElement());this.screen.classList.add("gp-extended-palette-panel_")}initColorPicker(){this.colorPicker&&this.colorPicker.remove();this.colorPicker=new GPColorPicker_(GPColorPanel_.MAX_WIDTH,125);this.colorPicker.setColor(this.painter.getColor());
this.colorPicker.toggle(!this.painter.isDisabled);this.colorPicker.addEventListener("color",this.colorPickerColorChangeHandler);this.colorPicker.addEventListener("color2",this.colorPickerColor2ChangeHandler);this.nativeColorInput.before(this.colorPicker.getElement());this.screen.classList.add("gp-color-picker-panel_")}"initFullSize\u0421olorPicker"(){this.fullSizeColorPicker&&this.fullSizeColorPicker.remove();this.fullSizeColorPicker=new GPColorPicker_(GPColorPanel_.MAX_WIDTH,288);this.fullSizeColorPicker.setColor(this.painter.getColor());
this.fullSizeColorPicker.toggle(!this.painter.isDisabled);this.fullSizeColorPicker.addEventListener("color",this.colorPickerColorChangeHandler);this.fullSizeColorPicker.addEventListener("color2",this.colorPickerColor2ChangeHandler);this.colorList.after(this.fullSizeColorPicker.getElement());this.screen.classList.add("gp-color-picker-panel_")}colorPickerColorChangeHandler({detail:{color:a}}){this.resetPaletteColor();this.colorWheel?.setColor(a);this.colorInput.value=a;this.dispatchEvent(new CustomEvent("color",
{detail:{color:a}}))}colorPickerColor2ChangeHandler({detail:{color:a}}){this.color2Input.value=a;this.dispatchEvent(new CustomEvent("color2",{detail:{color:a}}))}initColorWheel(){this.colorWheel&&this.colorWheel.remove();this.colorWheel=new GPColorWheel_(this.painter.getColor(),this.s.colorWheelMode,GPColorPanel_.MAX_WIDTH,this.l);this.colorWheel.addEventListener("color",({detail:{color:a}})=>{this.resetPaletteColor();this.fullSizeColorPicker?.setColor(a);this.colorPicker?.setColor(a);this.colorInput.value=
a;this.dispatchEvent(new CustomEvent("color",{detail:{color:a}}))});this.colorWheel.addEventListener("mode",({detail:{mode:a}})=>{this.dispatchEvent(new CustomEvent("color_wheel_mode_changed",{detail:{mode:a}}))});this.colorList.after(this.colorWheel.getElement())}resetControls(){this.controls.forEach(a=>{this.panel.classList.remove(`ctrl-${a}_`)});this.controls.clear();this.palette&&(this.palette.terminate(),this.palette=null,this.screen.classList.remove("gp-extended-palette-panel_"));this.colorWheel&&
(this.colorWheel.remove(),this.colorWheel=null);this.fullSizeColorPicker&&(this.fullSizeColorPicker.remove(),this.fullSizeColorPicker=null,this.screen.classList.remove("gp-color-picker-panel_"));this.colorPicker&&(this.colorPicker.remove(),this.colorPicker=null,this.screen.classList.remove("gp-color-picker-panel_"));this.screen.classList.remove("gp-custom-tools_")}initColorInputs(){this.colorInput=document.createElement("input");this.colorInput.type="color";this.colorInput.className="gp-painter-color_";
this.colorInput.classList.add("gp-ui-color_");this.colorInput.value=this.painter.getColor();this.colorInput.addEventListener("input",this.colorInputInputHandler);this.colorInput.addEventListener("change",this.colorInputChangeHandler);this.colorInput.addEventListener("pointerdown",this.switchColors);this.colorInput.addEventListener("contextmenu",this.suppressContextMenu);this.nativeColorInput.after(this.colorInput);this.color2Input=document.createElement("input");this.color2Input.type="color";this.color2Input.className=
"gp-painter-color2_";this.color2Input.classList.add("gp-ui-color_");this.color2Input.value=this.painter.getColor2();this.color2Input.addEventListener("change",this.color2InputChangeHandler);this.color2Input.addEventListener("pointerdown",this.switchColors);this.color2Input.addEventListener("contextmenu",this.suppressContextMenu);this.colorInput.after(this.color2Input);this.nativeColorInput.classList.add("hidden")}colorInputInputHandler(a){this.dispatchEvent(new CustomEvent("color",{detail:{color:a.target.value}}))}colorInputChangeHandler(a){this.resetPaletteColor();
this.colorPicker?.setColor(a.target.value);this.dispatchEvent(new CustomEvent("color",{detail:{color:a.target.value}}))}color2InputChangeHandler(a){this.dispatchEvent(new CustomEvent("color2",{detail:{color:a.target.value}}))}switchColors(a){2===a.button&&this.painter.switchColors()}suppressContextMenu(a){a.preventDefault()}toggle(a){a?this.enable():this.disable()}enable(){this.panel.classList.remove("disabled");this.colorInput.removeAttribute("disabled");this.color2Input.removeAttribute("disabled");
this.colorInput.value=this.painter.getColor();this.color2Input.value=this.painter.getColor2();this.palette?.enable();this.colorWheel?.enable();this.colorPicker?.enable();this.fullSizeColorPicker?.enable()}disable(){this.panel.classList.add("disabled");this.colorInput.setAttribute("disabled","");this.color2Input.setAttribute("disabled","");this.colorInput.value=this.s.panelsBackgroundColor;this.color2Input.value=this.s.panelsBackgroundColor;this.palette?.disable();this.colorWheel?.disable();this.colorPicker?.disable();
this.fullSizeColorPicker?.disable()}updateExtendedPalette(a){this.controls.has(GPColorPanel_.CONTROL.PALETTE)&&(a?this.initExtendedPalette():this.palette&&(this.palette.terminate(),this.palette=null,this.screen.classList.remove("gp-extended-palette-panel_")),this.resetPaletteColor(),this.updateCustomToolsState())}resetPaletteColor(){this.palette?this.palette.resetPaletteColor():this.resetNativePaletteColor();this.marks&&this.resetMarksColor()}resetNativePaletteColor(){this.colorList.querySelector(".sel")?.classList.remove("sel")}resetMarksColor(){this.marks.querySelector(".sel")?.classList.remove("sel")}updateColorPickerPanel(a){this.controls.has(GPColorPanel_.CONTROL.COLOR_PICKER)&&
(a?this.initColorPicker():this.colorPicker&&(this.colorPicker.remove(),this.colorPicker=null,this.screen.classList.remove("gp-color-picker-panel_")),this.updateCustomToolsState())}updateCustomToolsState(){this.screen.classList.toggle("gp-custom-tools_",!!(this.palette||this.colorPicker||this.fullSizeColorPicker||this.colorWheel));this.updateTopOffset()}updatePanelsBackground(a){this.painter.isDisabled&&(this.colorInput.value=a,this.color2Input.value=a)}}window.GPColorPanel_=GPColorPanel_;class GPColorPicker_ extends EventTarget{static TOP="top";static BOTTOM="bottom";static LEFT="left";static RIGHT="right";static HORIZONTAL="horizontal";static VERTICAL="vertical";static DEFAULT_WIDTH=250;static DEFAULT_HEIGHT=250;static DEFAULT_HUE_POSITION=this.BOTTOM;static HUE_MIN_SIDE_SIZE=30;static HUE_MARGIN=15;constructor(a=GPColorPicker_.DEFAULT_WIDTH,b=GPColorPicker_.DEFAULT_HEIGHT,c=GPColorPicker_.DEFAULT_HUE_POSITION){super();this.style=document.documentElement.style;this.style.setProperty("--cp-hue-margin",
`${GPColorPicker_.HUE_MARGIN}px`);this.container;this.hsv=[0,0,0];this.width=a;this.height=b;this.palettePointerY=this.palettePointerX=0;this.huePosition=c;this.huePosDir=c===GPColorPicker_.TOP||c===GPColorPicker_.BOTTOM?GPColorPicker_.HORIZONTAL:GPColorPicker_.VERTICAL;this.hueBarSize=(this.huePosDir===GPColorPicker_.HORIZONTAL?this.width:this.height)-2*GPColorPicker_.HUE_MARGIN;this.huePosDir===GPColorPicker_.HORIZONTAL?(this.hueWidth=this.width,this.hueHeight=GPColorPicker_.HUE_MIN_SIDE_SIZE,this.paletteWidth=
this.width,this.paletteHeight=this.height-this.hueHeight):(this.hueWidth=GPColorPicker_.HUE_MIN_SIDE_SIZE,this.hueHeight=this.height,this.paletteWidth=this.width-this.hueWidth,this.paletteHeight=this.height);GPUtils_.bindMethods([this.paletteDownHandler,this.paletteMoveHandler,this.hueSliderDownHandler,this.hueSliderMoveHandler],this);this.render()}getElement(){return this.container}hide(){this.container.classList.add("hidden");this.isHidden=!0}show(a,b){let c=0,d=0;switch(this.huePosition){case GPColorPicker_.LEFT:c=
this.hueWidth;break;case GPColorPicker_.TOP:d=this.hueHeight}a=a-this.palettePointerX-c;b=b-this.palettePointerY-d;a=a+this.width>document.documentElement.clientWidth?Math.max(document.documentElement.clientWidth-this.width,0):Math.max(a,0);b=b+this.height>document.documentElement.clientHeight?Math.max(document.documentElement.clientHeight-this.height,0):Math.max(b,0);this.container.style.left=`${a}px`;this.container.style.top=`${b}px`;this.container.classList.remove("hidden");this.isHidden=!1}remove(){this.container.remove()}toggle(a){this.container.toggleAttribute("disabled",
void 0===a?a:!a)}enable(){this.toggle(!0)}disable(){this.toggle(!1)}render(){this.container=document.createElement("div");this.container.className=`gp-color-picker_ ${this.huePosition}_`;this.container.innerHTML='<div class="palette"><div class="hue"><div class="lightness"><div class="darkness"></div><div class="pointer-wrapper"><div class="pointer"></div></div></div></div></div><div class="hue"><div class="slider-wrapper"><div class="slider"><div class="handle-wrapper"><div class="handle"></div></div></div></div></div>';
this.container.style.width=`${this.width}px`;this.container.style.height=`${this.height}px`;this.container.addEventListener("contextmenu",b=>{b.preventDefault()});this.palette=this.container.querySelector(".palette");this.palette.addEventListener("pointerdown",this.paletteDownHandler);this.paletteHue=this.container.querySelector(".gp-color-picker_ > .palette .hue");this.pointerWrapper=this.container.querySelector(".gp-color-picker_ > .palette .pointer-wrapper");const a=this.container.querySelector(".gp-color-picker_ > .hue");
a.style.width=`${this.hueWidth}px`;a.style.height=`${this.hueHeight}px`;this.hueSlider=this.container.querySelector(".gp-color-picker_ > .hue .slider");this.hueSlider.addEventListener("pointerdown",this.hueSliderDownHandler);this.hueHandleWrapper=this.container.querySelector(".gp-color-picker_ > .hue .handle-wrapper")}paletteDownHandler(a){if(0===a.button||2===a.button){if(2===a.button)var b=this.hsv;this.palette.setPointerCapture(a.pointerId);this.palette.addEventListener("pointermove",this.paletteMoveHandler);
this.palette.addEventListener("pointerup",c=>{this.palette.removeEventListener("pointermove",this.paletteMoveHandler);b&&this.setHSVColor(...b)},{once:!0});this.paletteMoveHandler(a)}}paletteMoveHandler(a){if(!this.isHidden){var [b,c]=this.getCoords(a);b=Math.max(0,Math.min(this.paletteWidth,b));c=Math.max(0,Math.min(this.paletteHeight,c));this.palettePointerX=b;this.palettePointerY=c;this.updatePalettePointer(b,c);this.hsv=this.getPaletteColor(b,c);this.dispatchEvent(new CustomEvent(a.buttons&2?
"color2":"color",{detail:{color:GPColorUtils_.hsvToHex(...this.hsv)}}))}}hueSliderDownHandler(a){0===a.button&&(this.hueSlider.setPointerCapture(a.pointerId),this.hueSlider.addEventListener("pointermove",this.hueSliderMoveHandler),this.hueSlider.addEventListener("pointerup",b=>{this.hueSlider.removeEventListener("pointermove",this.hueSliderMoveHandler)},{once:!0}),this.hueSliderMoveHandler(a))}hueSliderMoveHandler(a){if(!this.isHidden){var [b,c]=this.getCoords(a),d=(a=this.huePosDir===GPColorPicker_.HORIZONTAL)?
b:c;this.updateHueSlider(d,a);this.hsv[0]=Math.round(Math.max(0,Math.min(100,d/(this.hueBarSize/100))))/100;this.updatePaletteHue(this.hsv[0]);this.dispatchEvent(new CustomEvent("color",{detail:{color:GPColorUtils_.hsvToHex(...this.hsv)}}))}}updatePalettePointer(a,b){a=Math.max(0,Math.min(100,a/(this.paletteWidth/100)));this.pointerWrapper.style.top=`${Math.max(0,Math.min(100,b/(this.paletteHeight/100)))}%`;this.pointerWrapper.style.left=`${a}%`}updatePaletteHue(a){const [b,c,d]=GPColorUtils_.hsvToRgb(a,
1,1);this.paletteHue.style.backgroundColor=`rgb(${b}, ${c}, ${d})`}updateHueSlider(a,b=this.huePosDir===GPColorPicker_.HORIZONTAL){a=Math.max(0,Math.min(100,a/(this.hueBarSize/100)));b?this.hueHandleWrapper.style.left=`${a}%`:this.hueHandleWrapper.style.top=`${a}%`}getPaletteColor(a,b){return Number.isNaN(a)||Number.isNaN(b)?this.hsv:[this.hsv[0],Math.max(0,Math.min(100,Math.round(a/(this.paletteWidth/100))))/100,Math.max(0,Math.min(100,Math.round((this.paletteHeight-b)/(this.paletteHeight/100))))/
100]}getCoords(a){const b=a.target.getBoundingClientRect(),[c,d]=a.touches?[a.touches[0].clientX,a.touches[0].clientY]:[a.clientX,a.clientY],[e,f]=[c-b.left,d-b.top];return[a.target.clientWidth/b.width*e,a.target.clientHeight/b.height*f]}getColor(){return GPColorUtils_.hsvToHex(...this.hsv)}setColor(a){const [b,c,d]=GPColorUtils_.hexToHsv(a);this.setHSVColor(b,c,d)}setHSVColor(a,b,c){this.hsv=[a,b,c];const d=this.hueBarSize*a;b*=this.paletteWidth;c=this.paletteHeight-this.paletteHeight*c;this.palettePointerX=
Math.max(0,Math.min(this.paletteWidth,b));this.palettePointerY=Math.max(0,Math.min(this.paletteHeight,c));this.updateHueSlider(d);this.updatePaletteHue(a);this.updatePalettePointer(b,c)}}window.GPColorPicker_=GPColorPicker_;class GPColorUtils_{static hsvToRgb(a,b,c){let d,e,f;const g=Math.floor(6*a),h=6*a-g;a=c*(1-b);const k=c*(1-h*b);b=c*(1-(1-h)*b);switch(g%6){case 0:d=c;e=b;f=a;break;case 1:d=k;e=c;f=a;break;case 2:d=a;e=c;f=b;break;case 3:d=a;e=k;f=c;break;case 4:d=b;e=a;f=c;break;case 5:d=c,e=a,f=k}return[Math.round(255*d),Math.round(255*e),Math.round(255*f)]}static rgbToHex(a,b,c){return"#"+(16777216+(a<<16)+(b<<8)+c).toString(16).slice(1)}static hsvToHex(a,b,c){a=this.hsvToRgb(a,b,c);return this.rgbToHex(...a)}static hexToRgb(a){a=
a.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(b,c,d,e)=>c+c+d+d+e+e);return(a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a))?[parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)]:null}static rgbToHsv(a,b,c){a/=255;b/=255;c/=255;const d=Math.max(a,b,c),e=Math.min(a,b,c);let f;const g=d-e;if(d==e)f=0;else{switch(d){case a:f=(b-c)/g+(b<c?6:0);break;case b:f=(c-a)/g+2;break;case c:f=(a-b)/g+4}f/=6}return[f,0==d?0:g/d,d]}static hexToHsv(a){a=this.hexToRgb(a);return this.rgbToHsv(...a).map(b=>Math.floor(1E3*
b)/1E3)}static rgbToHsl(a,b,c){a/=255;b/=255;c/=255;const d=Math.max(a,b,c);var e=Math.min(a,b,c);let f,g=(d+e)/2;if(d==e)f=e=0;else{const h=d-e;e=.5<g?h/(2-d-e):h/(d+e);switch(d){case a:f=(b-c)/h+(b<c?6:0);break;case b:f=(c-a)/h+2;break;case c:f=(a-b)/h+4}f/=6}return[f,e,g]}static hexToHsl(a){a=this.hexToRgb(a);return this.rgbToHsl(...a)}}window.GPColorUtils_=GPColorUtils_;class GPColorWheel_ extends EventTarget{static SIZE=300;static DEFAULT_COLOR="#000000";static DEFAULT_BRIGHTNESS=1;static MOUSE_WHEEL_ENABLED=!1;static SECOND_BUTTON_ENABLED=!0;static MODE={SINGLE:"single",COMPLEMENTARY:"complementary",SPLIT_COMPLEMENTARY:"split_complementary",ANALOGOUS:"analogous",TRIADIC:"triadic",TETRADIC:"tetradic"};static DEFAULT_MODE=this.MODE.COMPLEMENTARY;static MODE_MENU_TYPE={TEXT:"text",ICON:"icon"};static DEFAULT_MODE_MENU_TYPE=this.MODE_MENU_TYPE.ICON;static MODE_ICON_PATTERN='<svg class="icon_" viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg"><defs><style>.cw-ic_{r:32px;fill:#000;cx:200px;cy:68px;transform-origin:200px 200px}</style></defs><circle cx="200" cy="200" r="200" fill="currentColor"/>{markers}</svg>';static MARKERS={[this.MODE.SINGLE]:[0],
[this.MODE.COMPLEMENTARY]:[0,6],[this.MODE.SPLIT_COMPLEMENTARY]:[0,5,7],[this.MODE.ANALOGOUS]:[0,1,11],[this.MODE.TRIADIC]:[0,4,8],[this.MODE.TETRADIC]:[0,3,6,9]};static HUE_STEP=.0833;constructor(a=GPColorWheel_.DEFAULT_MODE,b=GPColorWheel_.DEFAULT_COLOR,c=GPColorWheel_.SIZE,d){super();this.l=d;this.size=c;this.brightness=GPColorWheel_.DEFAULT_BRIGHTNESS;this.mode=b;this.currentModeIndex=Object.values(GPColorWheel_.MODE).indexOf(this.mode);this.render();this.setColor(a)}getElement(){return this.container}render(){this.container=
document.createElement("div");this.container.className="gp-color-wheel_";this.container.dataset.menuType=GPColorWheel_.DEFAULT_MODE_MENU_TYPE;this.container.style.setProperty("--color-wheel-size",`${this.size}px`);this.modesMenu=document.createElement("div");this.modesMenu.className="modes-menu_ folded_";const a=e=>{this.hideModesMenu()};this.modesMenu.addEventListener("pointerdown",e=>{if(0===e.button){var f=this.modesMenu.classList.contains("folded_"),g=e.target.parentElement===this.modesMenu;g&&
document.removeEventListener("pointerup",a,{once:!0});document.addEventListener("pointerup",h=>{h.target.parentElement!==this.modesMenu||h.target.classList.contains("selected_")&&f?f&&!g&&document.addEventListener("pointerup",a,{once:!0}):(this.hideModesMenu(),this.selectMode(h.target.dataset.mode),document.removeEventListener("pointerup",a,{once:!0}))},{once:!0});this.showModesMenu()}});this.container.appendChild(this.modesMenu);const b=this.l.COLOR_WHEEL_MODES.split("|");Object.values(GPColorWheel_.MODE).forEach((e,
f)=>{const g=document.createElement("div");g.className="item_";g.classList.toggle("selected_",e===this.mode);g.dataset.mode=e;e=this.buildModeIcon(e);g.appendChild(e);e=document.createElement("div");e.className="title_";e.textContent=b[f];g.appendChild(e);this.modesMenu.appendChild(g)});const c=document.createElement("div");c.className="wheel_";c.addEventListener("pointerdown",e=>{0===e.button&&e.target===e.currentTarget&&(c.classList.add("pressed_"),document.addEventListener("pointerup",f=>{c.classList.remove("pressed_")},
{once:!0}))});c.addEventListener("pointerdown",e=>{0===e.button&&e.target===e.currentTarget&&this.selectColorHandler(e,null,null,this.getScale())});GPColorWheel_.SECOND_BUTTON_ENABLED&&c.addEventListener("contextmenu",e=>{this.changeMode(1);e.preventDefault()});GPColorWheel_.MOUSE_WHEEL_ENABLED&&c.addEventListener("wheel",e=>{this.changeMode(e.deltaY);e.preventDefault()});this.container.appendChild(c);this.canvas=document.createElement("canvas");this.canvas.className="canvas_";this.canvas.width=300;
this.canvas.height=300;c.appendChild(this.canvas);const d=this.canvas.getContext("2d");this.drawWheel(d);this.markers=document.createElement("div");this.markers.className="markers_";this.markers.addEventListener("pointerdown",e=>{if(0===e.button){var {width:f,height:g}=e.target.getBoundingClientRect();this.hsv=e.target.hsv;var h=this.getScale();this.selectColorHandler(e,e.offsetX*h-f/2,e.offsetY*h-g/2,h)}});c.appendChild(this.markers);this.brightnessInput=document.createElement("input");this.brightnessInput.className=
"brightness_";this.brightnessInput.type="range";this.brightnessInput.min=0;this.brightnessInput.max=1;this.brightnessInput.step=.01;this.brightnessInput.value=this.brightness;this.brightnessInput.addEventListener("input",e=>{this.hsv[2]=Number.parseFloat(e.target.value);this.updateBrightness();this.renderMarkers();this.dispatchEvent(new CustomEvent("color",{detail:{color:GPColorUtils_.hsvToHex(...this.hsv)}}))});this.container.appendChild(this.brightnessInput)}showModesMenu(){this.modesMenu.classList.remove("folded_")}hideModesMenu(){this.modesMenu.classList.add("folded_")}buildModeIcon(a){a=
GPColorWheel_.MARKERS[a].map(b=>`<circle class="cw-ic_" transform="rotate(${30*b+180})"/>`);a=GPColorWheel_.MODE_ICON_PATTERN.replace("{markers}",a);return(new DOMParser).parseFromString(a,"image/svg+xml").documentElement}selectMode(a){a!==this.mode&&(this.mode=a,this.currentModeIndex=Object.values(GPColorWheel_.MODE).indexOf(a),this.updateModesMenu(),this.renderMarkers(),this.dispatchEvent(new CustomEvent("mode",{detail:{mode:this.mode}})))}updateModesMenu(){this.hideModesMenu();Array.from(this.modesMenu.children).forEach(a=>
{a.classList.toggle("selected_",a.dataset.mode===this.mode)})}changeMode(a){const b=Object.values(GPColorWheel_.MODE);this.currentModeIndex=0<a?(this.currentModeIndex+1)%b.length:(this.currentModeIndex-1+b.length)%b.length;this.mode=b[this.currentModeIndex];this.updateModesMenu();this.renderMarkers();this.dispatchEvent(new CustomEvent("mode",{detail:{mode:this.mode}}))}updateBrightness(){this.brightness=this.hsv[2];this.brightnessInput.value=this.hsv[2];this.canvas.style.opacity=1*this.hsv[2]}drawWheel(a){a.clearRect(0,
0,a.canvas.width,a.canvas.height);const b=a.canvas.width/2;a.translate(b,b);a.lineWidth=3;let c=b,d=0;this.plot(a,c,d,0);const e=45/Math.floor(b/Math.sqrt(2));let f=1.25-b;for(;c>d;){++d;0>f?f+=2*d+3:(f+=2*(d-c)+5,--c);const g=d*e;this.plot(a,c,d,g);this.plot(a,d,c,90-g)}a.translate(-b,-b)}plot(a,b,c,d){const e=[b,-c,-b,c];b=[c,b,-c,-b];for(c=0;4>c;++c){const f=a.createLinearGradient(0,0,e[c],b[c]);f.addColorStop(0,"white");f.addColorStop(1,`rgb(${GPColorUtils_.hsvToRgb((-(d+90*c)%360+360)%360/360,
1,1).join(",")})`);a.strokeStyle=f;a.beginPath();a.moveTo(0,0);a.lineTo(e[c],b[c]);a.stroke()}}selectColorHandler(a,b,c,d){const e=f=>{this.selectColor(f,a.target.index,b,c,d)};a.currentTarget.setPointerCapture(a.pointerId);a.currentTarget.addEventListener("pointermove",e);a.currentTarget.addEventListener("pointerup",f=>{f.currentTarget.removeEventListener("pointermove",e)},{once:!0});this.selectColor(a,a.target.index,b,c,d)}selectColor(a,b,c,d,e){const [f,g]=this.getCoords(a,c,d,e);a=this.size/2;
this.hsv=[1-(this.getAngle(a,a,f,g)+180)%360/360,Math.min(this.getDistance(a,a,f,g)/a,1),Number.parseFloat(this.brightness)];this.updateMarkers(b);this.dispatchEvent(new CustomEvent("color",{detail:{color:GPColorUtils_.hsvToHex(...this.hsv)}}))}renderMarkers(){this.markers.innerHTML="";GPColorWheel_.MARKERS[this.mode].forEach((a,b)=>{a=this.renderMarker([1+(this.hsv[0]-GPColorWheel_.HUE_STEP*a)%1,this.hsv[1],this.hsv[2]],b);this.markers.appendChild(a)})}renderMarker(a,b){const [c,d]=this.getColorCoords(a),
e=document.createElement("div");e.className="marker_";e.classList.toggle("main_",0===b);e.style.top=`${d}px`;e.style.left=`${c}px`;e.style.backgroundColor=`rgb(${GPColorUtils_.hsvToRgb(...a).join(",")})`;e.index=b;e.hsv=a;return e}updateMarkers(a=0){Array.from(this.markers.children).forEach(b=>{const c=[1+(this.hsv[0]-GPColorWheel_.HUE_STEP*(GPColorWheel_.MARKERS[this.mode][b.index]-GPColorWheel_.MARKERS[this.mode][a]))%1,this.hsv[1],this.hsv[2]],[d,e]=this.getColorCoords(c);b.style.top=`${e}px`;
b.style.left=`${d}px`;b.style.backgroundColor=`rgb(${GPColorUtils_.hsvToRgb(...c).join(",")})`})}getColorCoords(a){var b=this.size/2;const c=a[1]*b,d=Math.PI/180*(360*a[0]+90);a=b+c*Math.sin(d);b+=c*Math.cos(d);1E-10>Math.abs(a)&&(a=0);1E-10>Math.abs(b)&&(b=0);return[a,b]}getCoords(a,b=0,c=0,d=1){const e=a.currentTarget.getBoundingClientRect();return[(a.clientX-e.left-b)/d,(a.clientY-e.top-c)/d]}getDistance(a,b,c,d){a=c-a;b=d-b;return Math.sqrt(a*a+b*b)}getAngle(a,b,c,d){return 180/Math.PI*Math.atan2(d-
b,c-a)+180}setColor(a){this.hsv=GPColorUtils_.hexToHsv(a);this.updateBrightness();this.renderMarkers()}getScale(){return this.container.getBoundingClientRect().width/this.container.offsetWidth}enable(){this.container.removeAttribute("disabled")}disable(){this.container.setAttribute("disabled","")}remove(){this.container.remove()}}window.GPColorWheel_=GPColorWheel_;class GPDrawInterface_ extends EventTarget{static MOBILE_MAX_WIDTH=640;static TOOLS_IDS_CLASSES={1:"pen",2:"ers",3:"lin",4:"reb",5:"ellb",6:"rec",7:"ell",8:"fil",10:"note"};static TOOLS={pen:{id:1,tumbler:!0},ers:{id:2,tumbler:!0},reb:{id:4,tumbler:!0},ellb:{id:5,tumbler:!0},rec:{id:6,tumbler:!0},ell:{id:7,tumbler:!0},lin:{id:3,tumbler:!0},fil:{id:8,tumbler:!0},dropper:{id:"",tumbler:!0,disabled:!0},note:{id:10,tumbler:!0},hide:{id:""},undo:{id:""},redo:{id:""}};static FILTER_TOOL_CLASSES=["jsx",
"tool","sel"];static THICKNESSES=[2,6,10,14,18];static THICKNESS_MARK_SIZE=7;static SELECTORS={CORE:".core",SCREEN:".screen",HEADER:".header",TOOLS:".tools",TOOL:".tools .tool",SELECTED_TOOL:".tool.sel",OPTIONS:".options",OPACITY:".bxopacity input",THICKNESS:".thickness",SAVE_BTN:"button.download"};static SYMMETRY_ICONS={VERTICAL:'<svg width="26" height="26"><path d="M13.018 2.34v21.251h0" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.28163504"/></svg>',HORIZONTAL:'<svg width="26" height="26"><path d="M23.643 12.966H2.393h0" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.28163504"/></svg>',
QUADRANT:'<svg width="26" height="26"><g stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.452"><path d="M23.643 12.966H2.393M13.018 2.34v21.251" stroke-width="2.28163504"/></g></svg>',RADIAL:'<svg width="26" height="26" fill="none"><circle cx="13" cy="13" r="10.387" stroke="currentColor" stroke-width="2.8"/></svg>',MANDALA:'<svg width="26" height="26" fill="none"><circle cx="13" cy="13" r="10.387" stroke="currentColor" stroke-width="2.8"/><g fill="currentColor" stroke-width="1.313"><path d="M13.04 13.623c-.658 0-1.203-.317-1.203-.698V3.257c0-.382.545-.698 1.203-.698s1.202.316 1.202.698v9.668c0 .381-.545.698-1.202.698z"/><path d="M22.628 18.581c-.334.566-.884.875-1.212.681l-8.326-4.915c-.329-.194-.324-.824.01-1.39s.884-.875 1.213-.68l8.325 4.914c.329.194.324.824-.01 1.39z"/><path d="M3.4 18.603c.334.566.884.874 1.212.68l8.326-4.914c.328-.194.324-.825-.01-1.39-.335-.567-.884-.875-1.213-.682L3.39 17.212c-.328.194-.323.825.01 1.39z"/></g></svg>'};static READY_BUTTON_ICON_SVG={READY:'<path fill="#201255" d="M14.75 2.9c5.93 0 10.74 4.81 10.74 10.76 0 .55-.05 1.08-.12 1.6v1.12c0 5.94-4.81 10.76-10.74 10.76S3.9 22.32 3.9 16.38v-1.96c0-.17-.01-.34-.01-.52 0-1.74.42-3.39 1.16-4.86 1.72-3.63 5.42-6.14 9.7-6.14"></path><path fill="#087f6e" fill-rule="evenodd" d="M25.45 16.38c0 5.94-4.88 10.72-10.81 10.72S3.9 22.28 3.9 16.34v-1.91c.22-5.74 4.94-7.86 10.73-7.86s10.54 2.06 10.81 7.76v2.04z" clip-rule="evenodd"></path><path fill="#00ffbc" d="M14.67 24.63c5.96 0 10.79-4.81 10.79-10.76S20.63 3.12 14.67 3.12 3.89 7.93 3.89 13.87s4.83 10.76 10.79 10.76z"></path><path fill="#cfffde" fill-rule="evenodd" d="M14.66 5.36c5.38 0 9.94 4.11 10.78 9.23.05-.37.07-.59.05-1.03-.1-5.94-4.85-10.68-10.83-10.68S3.88 7.62 3.88 13.56c0 .59 0 .54.02.87.83-5.11 5.38-9.07 10.76-9.07" clip-rule="evenodd"></path><path fill="#201255" d="M14.75 2.9c5.93 0 10.74 4.81 10.74 10.76 0 .55-.05 1.08-.12 1.6v1.12c0 5.94-4.81 10.76-10.74 10.76S3.9 22.32 3.9 16.38v-1.96c0-.17-.01-.34-.01-.52 0-1.74.42-3.39 1.16-4.86 1.72-3.63 5.42-6.14 9.7-6.14"></path><path fill="#087f6e" fill-rule="evenodd" d="M25.45 16.38c0 5.94-4.88 10.72-10.81 10.72S3.9 22.28 3.9 16.34v-1.91c.22-5.74 4.94-7.86 10.73-7.86s10.54 2.06 10.81 7.76v2.04z" clip-rule="evenodd"></path><path fill="#00ffbc" d="M14.67 24.98c5.96 0 10.79-4.81 10.79-10.76S20.63 3.47 14.67 3.47 3.89 8.28 3.89 14.22s4.83 10.76 10.79 10.76z"></path><path fill="#cfffde" fill-rule="evenodd" d="M14.66 5.36c5.38 0 9.94 4.11 10.78 9.23.05-.37.07-.59.05-1.03-.1-5.94-4.85-10.68-10.83-10.68S3.88 7.62 3.88 13.56c0 .59 0 .54.02.87.83-5.11 5.38-9.07 10.76-9.07" clip-rule="evenodd"></path><path fill="#201255" d="M14.66 2.88c2.46 0 4.7.8 6.51 2.15.02.01.03.02.05.04.11.09.23.17.34.27.06.05.12.1.18.16l.19.16c.11.1.21.2.31.3.01.01.03.02.04.04 1.92 1.89 3.13 4.5 3.2 7.39v.17c0 .37 0 .59-.03.86v1.96c0 4.25-2.5 7.91-6.1 9.65-1.43.7-3.03 1.1-4.73 1.1-5.93 0-10.73-4.82-10.73-10.76v-1.95c-.01-.33-.02-.27-.02-.87 0-5.94 4.8-10.68 10.78-10.68M14.66 1c-3.39 0-6.57 1.3-8.95 3.66A12.45 12.45 0 0 0 2 13.56c0 .47 0 .57.01.76v2.05C2.01 23.33 7.66 29 14.62 29c1.94 0 3.81-.43 5.55-1.29 4.34-2.09 7.15-6.54 7.15-11.33v-1.82c.04-.33.05-.63.04-1.06v-.17c-.08-3.28-1.42-6.36-3.76-8.67l-.05-.05a12 12 0 0 0-.53-.49l-.05-.04-.05-.05c-.05-.05-.11-.1-.17-.14-.13-.1-.26-.21-.4-.31-.02-.02-.04-.03-.07-.05-2.2-1.65-4.84-2.52-7.62-2.52h-.01z"></path><path fill="#fff" fill-rule="evenodd" d="M15.44 19.01c-.42 0-.85-.1-1.24-.27a2.95 2.95 0 0 1-.99-.76l-3.84-4.55c-.5-.61-.73-1.35-.66-2.09.07-.75.43-1.43 1.02-1.93.54-.44 1.2-.67 1.87-.67.42 0 .85.1 1.24.27.38.18.72.44.99.76l2.02 2.39 6.64-5.26c.51-.4 1.16-.63 1.82-.63a2.9 2.9 0 0 1 2.21 1.02l.02.03.02.03c.49.6.7 1.35.62 2.11-.07.73-.45 1.42-1.06 1.91l-8.86 7.02c-.5.4-1.15.63-1.82.63z" clip-rule="evenodd"></path><path fill="#201255" d="M24.31 7.2c.52 0 1.01.21 1.38.58l.15.15c.32.4.47.9.42 1.41-.05.5-.31.96-.72 1.28l-8.86 7.02c-.34.27-.79.43-1.24.43a1.99 1.99 0 0 1-1.51-.7l-3.85-4.55c-.33-.4-.49-.9-.45-1.4.05-.5.3-.97.69-1.3a1.99 1.99 0 0 1 2.11-.26c.26.12.49.3.67.51l2.61 3.09 7.35-5.82c.35-.27.79-.43 1.24-.43m.02-1.88h-.01c-.87 0-1.72.3-2.4.83l-5.92 4.69-1.44-1.71c-.35-.42-.8-.77-1.31-1-.51-.24-1.07-.36-1.63-.36a3.9 3.9 0 0 0-2.45.87h-.02l-.02.02c-.77.65-1.25 1.56-1.34 2.56-.1.99.21 1.97.86 2.76v.03l3.85 4.55a3.84 3.84 0 0 0 2.94 1.36c.88 0 1.74-.3 2.41-.85l8.84-7.01c.81-.65 1.31-1.55 1.42-2.55s-.18-1.99-.82-2.79l-.05-.06-.05-.05q-.09-.105-.18-.18c-.72-.72-1.7-1.12-2.7-1.13z"></path>',
EDIT:'<path fill="#211256" d="M24.22 3.21c-2.733-2.232-6.478-3.234-8.47-.784L4.753 15.936s-.087.076-.13.12h.021l-.087.13a1.6 1.6 0 0 0-.327.686l-1.186 9.145a2.24 2.24 0 0 0 .784 2.188 2.23 2.23 0 0 0 2.188.37l8.829-3.016q.408-.146.686-.49l11.17-13.727c1.991-2.45.25-5.9-2.483-8.133"></path><path fill="#cfffde" d="m14.16 23.85-5.64 1.927c-.707-2.319-2.383-2.7-3.233-2.743l.74-5.737c.795-.893 3.256-.12 5.51 1.709l.043.032c2.166 1.786 3.277 3.832 2.558 4.769l.033.021h-.011z"></path><path fill="#00ffbc" d="M15.945 21.651c-.479-1.306-1.567-2.721-3.19-4.05l-.043-.032c-1.502-1.22-3.32-2.188-4.942-2.439l5.878-7.218h.011c.751-.838 3.016-.217 5.15 1.427 2.318 1.785 3.69 4.05 2.982 5.138l-5.846 7.185z"></path><path fill="#087f6e" d="M23.544 12.31c-.566-1.6-1.97-3.222-3.593-4.463-1.404-1.078-3.048-1.894-4.528-2.112l1.742-2.145c1.35-1.654 4.256-.283 5.89 1.045 1.632 1.329 3.56 3.898 2.22 5.553z"></path><path fill="#cfffde" d="M24.154 4.059c-2.733-2.232-6.478-3.234-8.47-.784L5.624 15.642c.175.022.35.043.523.076.643.13 1.307.36 1.895.697L17.883 4.7c1.23-1.818 4.54-.457 7.272 1.774.893.73 1.677 1.59 2.265 2.493-.316-1.752-1.6-3.56-3.266-4.91"></path><path fill="#211256" d="M26.701 11.342c1.992-2.45.25-5.9-2.482-8.133-2.732-2.231-6.477-3.233-8.47-.783L4.755 15.936s-.087.076-.13.12h.021l-.087.13a1.6 1.6 0 0 0-.326.686l-1.187 9.145a2.26 2.26 0 0 0 .784 2.188 2.23 2.23 0 0 0 2.188.37l8.829-3.016q.408-.146.686-.49zM17.176 3.59c1.35-1.654 4.256-.283 5.89 1.046 1.632 1.328 3.56 3.897 2.22 5.552l-1.73 2.122c-.567-1.6-1.971-3.222-3.594-4.463-1.404-1.078-3.048-1.894-4.528-2.112zM14.17 23.84h-.011l-5.64 1.937c-.707-2.319-2.383-2.7-3.232-2.743l.74-5.737c.795-.893 3.255-.12 5.508 1.709.011 0 .022.021.044.032 2.166 1.786 3.277 3.832 2.558 4.769l.033.021zm-1.403-6.24s-.033-.021-.044-.032c-1.502-1.22-3.32-2.188-4.942-2.439l5.878-7.218h.011c.751-.838 3.016-.217 5.15 1.427 2.318 1.785 3.668 4.071 2.96 5.16h-.01l-5.825 7.163c-.479-1.306-1.567-2.722-3.19-4.05z"></path>'};static SETTINGS_TAB={SETTINGS:"settings",
SHORTCUTS:"shortcuts"};static DEFAULT_SETTINGS_TAB=this.SETTINGS_TAB.SETTINGS;constructor(a,b,c){super();this.prx=b;this.l=c;this.style=document.documentElement.style;this.painter=a;this.initialSettings=a.getSettingsCopy();this.s=a.getSettings();this.shortcutsScrollPos=this.settingsScrollPos=0;this.toolsContainer;this.colorPanel;this.optionsContainer;this.thicknessesContainer;this.readyBtn;this.readyLabel;this.saveBtn;this.readyWarning;this.isInit=!1;this.tools={};this.thicknesses={};this.currentThickness=
this.currentTool=null;this.settingsTabsData=[[GPDrawInterface_.SETTINGS_TAB.SETTINGS,this.l.SETTINGS_BTN],[GPDrawInterface_.SETTINGS_TAB.SHORTCUTS,this.l.BINDINGS_BTN]];this.currentSettingsTab=GPDrawInterface_.DEFAULT_SETTINGS_TAB;GPUtils_.bindMethods([this.toolsContainerClickHandler,this.opacityChangeHandler,this.thicknessesContainerClickHandler,this.readyBtnClickHandler,this.onClickSaveBtn,this.onClickSettingsBtn,this.onClickSettingsTab,this.onClickShortcutsTab,this.resizeHandler],this);this.painter.addEventListener("mirror",
({detail:{state:d}})=>{this.toolsStates.classList.toggle("mirror_",d)});this.painter.addEventListener("vertical_mirror",({detail:{state:d}})=>{this.toolsStates.classList.toggle("vertical-mirror_",d)});this.painter.addEventListener("grayscale",({detail:{state:d}})=>{this.toolsStates.classList.toggle("grayscale_",d)});this.painter.addEventListener("zoom",({detail:{scale:d}})=>{this.toolsStates.classList.remove("zoom-in_","zoom-out_");1!==d&&(1<d?this.toolsStates.classList.add("zoom-in_"):this.toolsStates.classList.add("zoom-out_"))});
this.painter.addEventListener("rotation",({detail:{rotation:d}})=>{this.toolsStates.classList.toggle("rotation_",0!==d)});this.updatePanelsBackground(this.initialSettings.panelsBackgroundColor,this.initialSettings.panelsBackgroundOpacity);this.updatePanelsElements(this.initialSettings.panelsElementsColor,this.initialSettings.panelsElementsOpacity);this.updateControlsBackgroundBlurLevel(this.initialSettings.controlsBackgroundBlurLevel)}init(){var a=GPDrawInterface_.SELECTORS;this.core=document.querySelector(a.CORE);
this.core.classList.add("background_");this.screen=document.querySelector(a.SCREEN);this.screen.classList.add("gp-painter-rendered_");this.toolsContainer=document.querySelector(a.TOOLS);this.toolsContainer.addEventListener("click",this.toolsContainerClickHandler);this.toolsContainer.addEventListener("mouseout",this.stopPropagation);this.toolsContainer.querySelectorAll(a.TOOL).forEach(c=>{for(let d in GPDrawInterface_.TOOLS)if(c.classList.contains(d)){c.dataset.toolid=GPDrawInterface_.TOOLS[d].id;
this.tools[d]=c;break}});this.currentTool=this.tools[GPDrawInterface_.TOOLS_IDS_CLASSES[this.painter.tool]];this.colorPanel=new GPColorPanel_(this.painter,this.prx,this.l);this.colorPanel.addEventListener("color",({detail:{color:c}})=>{this.dispatchEvent(new CustomEvent("color",{detail:{color:c}}))});this.colorPanel.addEventListener("color2",({detail:{color:c}})=>{this.dispatchEvent(new CustomEvent("color2",{detail:{color:c}}))});this.colorPanel.addEventListener("controls_set_changed",({detail:{name:c}})=>
{this.painter.setColorPanelControlsSet(c)});this.colorPanel.addEventListener("color_wheel_mode_changed",({detail:{mode:c}})=>{this.painter.setColorWheelMode(c)});this.optionsContainer=document.querySelector(a.OPTIONS);this.nativeOpacity=this.optionsContainer.querySelector(a.OPACITY);this.nativeOpacity.addEventListener("change",this.opacityChangeHandler);this.opacity=this.initOpacityPanel(this.s.minOpacity,this.painter.opacity,this.optionsContainer.querySelector(a.OPACITY));this.opacityContainer=this.nativeOpacity.parentElement;
this.opacityContainer.addEventListener("mouseout",this.stopPropagation);const b=this.optionsContainer.querySelectorAll(a.THICKNESS);b.forEach((c,d)=>{d=GPDrawInterface_.THICKNESSES[d];c.dataset.value=d;this.thicknesses[d]=c;c.classList.remove("sel");this.painter.thickness===d&&(c.classList.add("sel"),this.currentThickness=c)});this.thicknessesContainer=b[0].parentElement;this.thicknessesContainer.addEventListener("click",this.thicknessesContainerClickHandler);this.thicknessesContainer.addEventListener("mouseout",
this.stopPropagation);this.thicknessMark=document.createElement("div");this.thicknessMark.className="mark_";this.thicknessMark.style.setProperty("--mark-size",`${GPDrawInterface_.THICKNESS_MARK_SIZE}px`);this.thicknessesContainer.appendChild(this.thicknessMark);this.thicknessMarkPositions=this.calcThicknessMarkPositions(this.thicknessesContainer,b[0]);this.updateThicknessMark(this.painter.thickness);this.readyBtn=document.querySelector(".content-button button");this.readyBtn.addEventListener("click",
this.readyBtnClickHandler,!0);this.readySvg=this.readyBtn.querySelector("svg");this.readyLabel=this.readyBtn.querySelector("strong");this.readyBtn.hasAttribute("disabled")&&this.readyBtn.removeAttribute("disabled");this.painter.addEventListener("stroke",c=>{this.readyBtn.hasAttribute("disabled")&&this.readyBtn.removeAttribute("disabled")},{once:!0});this.painter.addEventListener("stroke_redo",c=>{this.readyBtn.hasAttribute("disabled")&&this.readyBtn.removeAttribute("disabled")},{once:!0});this.updateReadyBtn();
this.saveBtn=document.querySelector(a.SAVE_BTN);this.saveBtn.addEventListener("click",this.onClickSaveBtn,!0);a=document.querySelector(a.HEADER);this.painter.reference&&(this.referenceBtn=a.appendChild(this.painter.reference.getPainterButton()));this.painter.timer&&this.painter.prx.isGameTime(GPProxy_.GAME_TIME.HOSTS_DECISION)&&this.painter.prx.isHost()&&a.appendChild(this.painter.timer.getElement());this.symmetryModes=document.createElement("form");this.symmetryModes.className="gp-painter-symmetry-modes_";
this.symmetryModes.addEventListener("change",c=>{this.setSymmetryMode(+c.target.dataset.modeId)});this.symmetryModes.addEventListener("wheel",c=>{if("LABEL"===c.target.tagName){var d=+c.target.control.dataset.modeId;if(d!==this.painter.getSymmetryMode())c.target.click();else{switch(d){case GPPainter_.SYMMETRY_MODES.RADIAL:this.painter.changeSymmetryRadialGuidesCount(c.deltaY);break;case GPPainter_.SYMMETRY_MODES.MANDALA:this.painter.changeSymmetryMandalaGuidesCount(c.deltaY)}this.updateSymmetryGuidesCount(d)}}});
this.symmetryGuidesCount=document.createElement("div");this.symmetryGuidesCount.className="guides-count_ btn_";this.symmetryGuidesCount.addEventListener("wheel",c=>{c.currentTarget.dataset.count=this.painter.getSymmetryMode()===GPPainter_.SYMMETRY_MODES.RADIAL?this.painter.changeSymmetryRadialGuidesCount(c.deltaY):this.painter.changeSymmetryMandalaGuidesCount(c.deltaY)});this.symmetryGuidesCount.addEventListener("pointerdown",c=>{let d=c.clientY;const e=f=>{const g=f.clientY-d;Math.abs(g)>=GPPainter_.SYMMETRY_GUIDES_COUNT_SENSITIVITY&&
(f.currentTarget.dataset.count=this.painter.getSymmetryMode()===GPPainter_.SYMMETRY_MODES.RADIAL?this.painter.changeSymmetryRadialGuidesCount(g):this.painter.changeSymmetryMandalaGuidesCount(g),d=f.clientY)};this.symmetryGuidesCount.setPointerCapture(c.pointerId);this.symmetryGuidesCount.addEventListener("pointermove",e);this.symmetryGuidesCount.addEventListener("pointerup",f=>{this.symmetryGuidesCount.removeEventListener("pointermove",e)},{once:!0})});this.painter.getSymmetryModes().forEach(c=>{var d=
GPPainter_.SYMMETRY_MODES[c];const e=`sm-mode-${d}_`,f=document.createElement("input");f.type="radio";f.name="sm-group_";f.id=e;f.checked=d===this.painter.getSymmetryMode();f.dataset.modeId=d;this.symmetryModes.appendChild(f);d=document.createElement("label");d.className=`${c.toLowerCase()}_ btn_`;d.setAttribute("for",e);d.innerHTML=GPDrawInterface_.SYMMETRY_ICONS[c];this.symmetryModes.appendChild(d)});this.symmetryModes.appendChild(this.symmetryGuidesCount);this.toolsContainer.firstElementChild.before(this.symmetryModes);
this.updateSymmetryPanel(this.painter.isSymmetryEnabled);this.updateSymmetryGuidesCount(this.painter.getSymmetryMode());this.actionQueueSize=document.createElement("div");this.actionQueueSize.className="action-queue-size_";a.appendChild(this.actionQueueSize);this.toolsStates=document.createElement("div");this.toolsStates.className="tools-states_";[["mirror",this.painter.getMirrorState()],["vertical-mirror",this.painter.getVerticalMirrorState()],["grayscale",this.painter.getGrayscaleState()],["zoom-in",
1<this.painter.getZoomScale()],["zoom-out",1>this.painter.getZoomScale()],["rotation",0!==this.painter.getRotation()]].forEach(([c,d])=>{const e=`${c}_`,f=document.createElement("div");f.className=`${e} state_`;f.title=this.l.TOOLS_STATES[c];this.toolsStates.classList.toggle(e,d);this.toolsStates.appendChild(f)});a.appendChild(this.toolsStates);this.settingsBtn=document.createElement("button");this.settingsBtn.className="gp-painter-settings-btn_";this.settingsBtn.addEventListener("click",this.onClickSettingsBtn);
a.appendChild(this.settingsBtn);if(!this.settingsPane){this.settingsPane=document.createElement("div");this.settingsPane.className="settings_";this.settingsPane.classList.add("hidden");this.settingsPane.addEventListener("pointerdown",this.stopPropagation);this.settingsPane.addEventListener("pointerup",this.stopPropagation);this.settingsPane.addEventListener("pointermove",this.stopPropagation);this.settingsPane.addEventListener("mousedown",this.stopPropagation);this.settingsPane.addEventListener("mouseup",
this.stopPropagation);this.settingsPane.addEventListener("mousemove",this.stopPropagation);this.settingsPane.addEventListener("wheel",this.stopPropagation);this.painter.container.appendChild(this.settingsPane);const c=document.createElement("form");c.className="tabs_";c.addEventListener("change",d=>{switch(d.target.value){case GPDrawInterface_.SETTINGS_TAB.SETTINGS:this.renderSettings();break;case GPDrawInterface_.SETTINGS_TAB.SHORTCUTS:this.renderShortcuts()}});this.settingsPane.appendChild(c);this.settingsTabsData.forEach(([d,
e])=>{const f=`gp-${d}-tab_`,g=document.createElement("input");g.name="tabs_";g.type="radio";g.id=f;g.value=d;c.appendChild(g);const h=document.createElement("label");h.className=`${d}-btn_ tab_ gp-ui-btn_`;h.setAttribute("for",f);h.textContent=e;c.appendChild(h);d===this.currentSettingsTab&&(g.checked=!0)});this.settingsContent=document.createElement("div");this.settingsContent.className="content_";this.settingsPane.appendChild(this.settingsContent);this.shortcutsManager=this.painter.getShortcutsManager()}this.toggleFixedScreenSize(this.s.fixedScreenSize);
this.toggleHeaderBackground(this.s.hideHeaderBackground);this.updateHeaderColor(this.s.headerColor);this.updateHeaderPhraseColor(this.s.headerInstructionsColor);this.setAutoHideHeaderState(this.s.autoHideHeaderElements);this.setAutoHideHeaderDelay(this.s.autoHideHeaderDelay);this.toggleInteractionHints(this.s.interactionHints);this.updateInteractionHintsDelay(this.s.interactionHintsDelay);this.enableInterface();window.addEventListener("resize",this.resizeHandler);this.lastViewportWidth=window.innerWidth;
this.isInit=!0}terminate(){this.isInit&&(this.tools={},this.thicknesses={},this.currentThickness=this.currentTool=null,this.opacity.remove(),this.opacity.removeEventListener("change",this.opacityChangeHandler),this.opacity=null,this.settingsBtn.remove(),this.settingsBtn=null,this.toolsContainer.removeEventListener("click",this.toolsContainerClickHandler),this.toolsContainer.removeEventListener("mouseout",this.stopPropagation),this.toolsContainer=null,this.nativeOpacity.removeEventListener("change",
this.opacityChangeHandler),this.nativeOpacity=null,this.opacityContainer.removeEventListener("mouseout",this.stopPropagation),this.opacityContainer=null,this.thicknessesContainer.removeEventListener("click",this.thicknessesContainerClickHandler),this.thicknessesContainer.removeEventListener("mouseout",this.stopPropagation),this.thicknessesContainer=null,this.thicknessMark.remove(),this.thicknessMark=null,this.readyBtn.removeEventListener("click",this.readyBtnClickHandler,!0),this.readyBtn=null,this.symmetryModes.remove(),
this.symmetryModes=null,this.actionQueueSize.remove(),this.actionQueueSize=null,this.toolsStates.remove(),this.toolsStates=null,this.saveBtn.removeEventListener("click",this.onClickSaveBtn,!0),this.saveBtn=null,this.painter.reference&&(this.referenceBtn.remove(),this.referenceBtn=null),this.core&&this.core.classList.remove("background_"),this.readyWarning&&(this.readyWarning.remove(),this.referenceBtn=null),this.colorPanel.terminate(),this.colorPanel=null,this.screen.classList.remove("gp-painter-rendered_"))}resizeHandler(a){a=
window.innerWidth;if(this.lastViewportWidth<=GPDrawInterface_.MOBILE_MAX_WIDTH&&a>GPDrawInterface_.MOBILE_MAX_WIDTH||this.lastViewportWidth>GPDrawInterface_.MOBILE_MAX_WIDTH&&a<=GPDrawInterface_.MOBILE_MAX_WIDTH)this.terminate(),this.init();this.lastViewportWidth=a}initOpacityPanel(a,b,c){const d=document.createElement("input");d.className="gp-opacity-slider_";d.type="range";d.min=a;d.max=1;d.step="0.01";d.value=b;d.addEventListener("change",this.opacityChangeHandler);c.after(d);return d}updateNativePalette(a){this.colorPanel.updateNativePalette(a)}updateExtendedPalette(a){this.colorPanel.updateExtendedPalette(a)}toggleInterface(a){a?
this.enableInterface():this.disableInterface()}enableInterface(){this.painter.enable();this.toolsContainer.classList.remove("disabled");this.optionsContainer.classList.remove("disabled");this.opacity.removeAttribute("disabled");this.updatePanelsBackground(this.s.panelsBackgroundColor,this.s.panelsBackgroundOpacity);this.colorPanel.enable()}disableInterface(){this.painter.disable();this.toolsContainer.classList.add("disabled");this.optionsContainer.classList.add("disabled");this.opacity.setAttribute("disabled",
"");this.updatePanelsBackground(this.s.panelsBackgroundColor,Math.max(this.s.panelsBackgroundOpacity-10,0));this.colorPanel.disable()}toggleFixedScreenSize(a){this.screen.classList.toggle("fixed-size_",!!a);this.painter.resizeWindowHandler()}toggleHeaderBackground(a){this.screen.classList.toggle("header-hidden_",!!a)}roundPixelOffset(){this.style.setProperty("--gp-pixel-offset-top","0px");this.style.setProperty("--gp-pixel-offset-left","0px");const {top:a,left:b}=window.getComputedStyle(this.screen),
c=parseFloat(a)%1,d=parseFloat(b)%1;this.style.setProperty("--gp-pixel-offset-top",`${c}px`);this.style.setProperty("--gp-pixel-offset-left",`${d}px`)}stopPropagation(a){a.stopPropagation()}toolsContainerClickHandler(a){if(a.target.classList.contains("tool")){a.stopImmediatePropagation();var b=a.target,c=this.filterToolClasses([...a.target.classList]),d=c[0];a=GPDrawInterface_.TOOLS[d];if(!a.disabled){if(a.id)this.painter.setTool(a.id);else switch(d){case "hide":c="hideon"===c[1];b.classList.toggle("hideon",
!c);this.painter.toggleLastDraw(c);break;case "undo":this.painter.undo();break;case "redo":this.painter.redo()}a.tumbler&&(this.currentTool.classList.remove("sel"),b.classList.add("sel"),this.currentTool=b)}}}filterToolClasses(a){return a.filter(b=>!GPDrawInterface_.FILTER_TOOL_CLASSES.some(c=>b.startsWith(c)))}opacityChangeHandler(a){a.stopImmediatePropagation();this.painter.setOpacity(a.target.value)}thicknessesContainerClickHandler(a){a.stopPropagation();a.target.classList.contains("thickness")&&
(a=+a.target.dataset.value,this.painter.setThickness(a),this.updateThickness(a))}readyBtnClickHandler(a){a.stopPropagation();this.painter.prx.isGameTime(GPProxy_.GAME_TIME.HOSTS_DECISION)&&this.painter.prx.isHost()&&this.s.readyConfirmation&&!this.painter.isReadyWarningShown?this.showReadyWarning():(this.painter.timer&&this.painter.prx.isGameTime(GPProxy_.GAME_TIME.HOSTS_DECISION)&&this.painter.prx.isHost()&&this.painter.timer.reset(),a=!this.painter.prx.isReady(),this.updateReadyBtn(a),this.toggleInterface(!a),
this.painter.prx.ready())}showReadyWarning(){this.readyWarning=document.createElement("div");this.readyWarning.className="ready-warning_";var a=document.createElement("div");a.className="window_";this.readyWarning.appendChild(a);var b=document.createElement("div");b.className="label_";b.textContent=this.l.READY_CONFIRMATION;a.appendChild(b);b=document.createElement("div");b.className="buttons_";a.appendChild(b);a=document.createElement("div");a.className="ok-btn_ btn_";a.textContent=this.l.READY_CONFIRMATION_OK_BTN;
a.addEventListener("click",c=>{this.readyWarning.remove();this.painter.isReadyWarningShown=!0;this.readyBtn.click()});b.appendChild(a);a=document.createElement("div");a.className="cancel-btn_ btn_";a.textContent=this.l.READY_CONFIRMATION_CANCEL_BTN;a.addEventListener("click",c=>{this.readyWarning.remove()});b.appendChild(a);this.screen.appendChild(this.readyWarning)}onClickSaveBtn(a){a.stopPropagation();this.painter.saveImage()}onClickSettingsBtn(a){this.painter.resetZoom();a=this.settingsPane.classList.toggle("hidden");
this.screen.classList.toggle("gp-settings-shown_");if(!a)switch(this.currentSettingsTab){case GPDrawInterface_.SETTINGS_TAB.SETTINGS:this.renderSettings();break;case GPDrawInterface_.SETTINGS_TAB.SHORTCUTS:this.renderShortcuts()}}setSymmetryMode(a){this.painter.setSymmetryMode(a);this.updateSymmetryGuidesCount(a)}updateSymmetryGuidesCount(a){switch(a){case GPPainter_.SYMMETRY_MODES.RADIAL:this.symmetryGuidesCount.dataset.count=this.s.symmetryRadialGuidesCount;break;case GPPainter_.SYMMETRY_MODES.MANDALA:this.symmetryGuidesCount.dataset.count=
this.s.symmetryMandalaGuidesCount}}hideSettings(){this.settingsPane.classList.add("hidden")}onClickSettingsTab(a){this.renderSettings()}renderSettings(){this.settingsContent.innerHTML="";this.settingsView?(this.settingsContent.appendChild(this.settingsView),this.painter.updateSettingsView(this.settingsView)):this.settingsView=this.painter.insertSettingsView(this.settingsContent);this.currentSettingsTab=GPDrawInterface_.SETTINGS_TAB.SETTINGS}onClickShortcutsTab(a){this.renderShortcuts()}renderShortcuts(){this.settingsContent.innerHTML=
"";this.shortcutsManager.insertView(this.settingsContent);this.currentSettingsTab=GPDrawInterface_.SETTINGS_TAB.SHORTCUTS}toggleReference(){this.referenceBtn?.click()}updateToolbar(a){this.currentTool.classList.remove("sel");this.currentTool=this.tools[GPDrawInterface_.TOOLS_IDS_CLASSES[a]];this.currentTool.classList.add("sel")}updateOpacity(a){this.opacity.value=a}updateThickness(a){const b=this.thicknesses[a];this.currentThickness&&(this.currentThickness.classList.remove("sel"),this.currentThickness=
null);b&&(b.classList.add("sel"),this.currentThickness=b);this.updateThicknessMark(a)}updateThicknessMark(a){if(this.painter.thickness in this.thicknesses)this.thicknessMark.classList.add("hidden",this.painter.thickness in this.thicknesses);else{var b=GPDrawInterface_.THICKNESSES.findLastIndex(c=>a>=c);this.thicknessMark.style.left=`${this.thicknessMarkPositions[b+1]}px`;this.thicknessMark.dataset.edge=~b?b===GPDrawInterface_.THICKNESSES.length-1?"end":"":"start";this.thicknessMark.classList.remove("hidden")}}calcThicknessMarkPositions(a,
b){const c=GPDrawInterface_.THICKNESSES,d=Number.parseInt(getComputedStyle(a).width),e=(a.clientWidth-d)/2,f=b.offsetWidth,g=(d-c.length*f)/(c.length-1);return[0,...c.slice(0,-1).map((h,k)=>e+(k+1)*f+k*g+g/2),d+2*e]}updateReadyBtn(a){a??this.painter.prx.isReady()?(this.readySvg.innerHTML=GPDrawInterface_.READY_BUTTON_ICON_SVG.EDIT,this.readyLabel.textContent=this.painter.localization.edit):(this.readySvg.innerHTML=GPDrawInterface_.READY_BUTTON_ICON_SVG.READY,this.readyLabel.textContent=this.painter.localization.ready)}updateColorPickerPanel(a){this.colorPanel.updateColorPickerPanel(a)}updatePanelsBackground(a,
b){const c=parseInt(a.substr(1,2),16),d=parseInt(a.substr(3,2),16),e=parseInt(a.substr(5,2),16);this.style.setProperty("--gp-panels-bg-color",`rgb(${c} ${d} ${e} / ${b}%)`);const [f,g,h]=GPColorUtils_.rgbToHsv(c,d,e),[k,l,m]=GPColorUtils_.hsvToRgb(Math.max(f-.04246122552758713,0),Math.max(g-.012523565849717255,0),Math.max(h-.05882352941176472,0));this.style.setProperty("--gp-panels-elems2-color",`rgb(${k}, ${l}, ${m})`);this.colorPanel?.updatePanelsBackground(a)}updatePanelsElements(a,b){const c=
parseInt(a.substr(1,2),16),d=parseInt(a.substr(3,2),16);a=parseInt(a.substr(5,2),16);this.style.setProperty("--gp-panels-elems-rgb",`${c} ${d} ${a}`);this.style.setProperty("--gp-panels-elems-rgb-opacity",`${b}%`)}updateControlsBackgroundBlurLevel(a){this.style.setProperty("--gp-panels-controls-backdrop-filter",a?`blur(${a}px)`:"unset")}updateHeaderColor(a){this.screen.classList.toggle("gp-colored-header_",a!==GPPainter_.DEFAULT_HEADER_COLOR);let [b,c,d]=GPColorUtils_.hexToHsl(a);b=Math.round(36E3*
b)/100;c=Math.round(1E4*c)/100;d=Math.round(1E4*d)/100;var e=(b- -5.36+92.59)%360;const f=this.calcHeaderFilterValue(66.86,78.64,c),g=this.calcHeaderFilterValue(34.31,20.2,d);var h=(b-5.72+103.67)%360,k=this.calcHeaderFilterValue(66.86,72.41,c);const l=this.calcHeaderFilterValue(34.31,60.2,d);e=`hue-rotate(${e}deg) saturate(${f}) brightness(${g})`;h=`hue-rotate(${h}deg) saturate(${k}) brightness(${l})`;k=this.screen.querySelector(":scope .draw").style;k.setProperty("--gp-text-stroke",`hsl(${b-4.27}deg 100% ${Math.max(d-
21.37,0)}%)`);k.setProperty("--gp-book-border-color",`hsl(${b-10.16}deg ${Math.max(c+24.18,0)}% ${Math.max(d-20,0)}%)`);k.setProperty("--gp-book-bg-color",`hsl(${b-7.03}deg ${Math.max(c-4.05,0)}% ${Math.max(d-14.12,0)}%)`);k.setProperty("--gp-book-rings-filter",h);k.setProperty("--gp-header-color",a);k.setProperty("--gp-header-bs-color",`hsl(${b-5.9}deg ${Math.max(c-3.28,0)}% ${Math.max(d+14.9,0)}%)`);k.setProperty("--gp-header-border-bottom-color",`hsl(${b-6.19}deg ${Math.max(c+10.43,0)}% ${Math.max(d-
25.29,0)}% / 50%)`);k.setProperty("--gp-header-logo-bg-filter",e);k.setProperty("--gp-core-bs-color",`hsl(${b-6.66}deg ${Math.max(c-4.95,0)}% ${Math.max(d-26.28,0)}%)`)}calcHeaderFilterValue(a,b,c){return Math.round(Math.min(Math.max(c-(a-b),0),100)/b*100)/100}toggleInteractionHints(a){this.screen.classList.toggle("gp-hints_",!!a)}updateInteractionHintsDelay(a){this.style.setProperty("--gp-hints-delay",`${a}s`)}updateHeaderPhraseColor(a){this.style.setProperty("--gp-header-phrase-color",a)}updateActionQueueSize(a,
b){this.actionQueueSize.textContent=a?this.formatActionQueueTimeleft(b):""}formatActionQueueTimeleft(a){return`${String(Math.floor(a/6E4)).padStart(2,"0")}:${String(Math.floor(a/1E3)%60).padStart(2,"0")}`}setAutoHideHeaderState(a){this.screen.classList.toggle("gp-auto-hide-header_",a)}setAutoHideHeaderDelay(a){this.style.setProperty("--gp-header-auto-hide-delay",`${a}s`)}updateSymmetryPanel(a){this.screen.classList.toggle("gp-symmetry-panel_",a)}}window.GPDrawInterface_=GPDrawInterface_;class GPExtendedPalette_ extends EventTarget{static CUSTOM_COLOR_SET_STORAGE="gp_custom-palettes";static DEFAULT_COLOR_SET="3A0505 590D0D 993333 ED1C24 E54C4C FF9999 FF0000 000000 251005 59270D 995633 FF5800 E5814C FFBC99 FFFF00 FFFFFF 2D1F06 593E0D 997533 FFA500 E5AF4C FFDB99 00FF00 FFFFFF 2D2D06 59590D 999933 FFF200 E4E54C FFFF99 00FFFF 0C0C0C 192D06 32590D 659933 7EFF00 97E54C CBFF99 0000FF 191919 062D0C 0D5919 339943 21E43F 4CE564 99FFA9 FF00FF 262626 062D25 0D5948 339982 00FFC7 4CE5C3 99FFE9 2A2C30 333333 061F2D 0D3E59 337599 00A5FF 4CAFE5 99DBFF 464B55 4C4C4C 06132D 0D2759 335699 0058FF 4C81E5 99BCFF 798BA8 666666 06062D 0D0D59 333399 0000FF 6060F0 9999FF A7B0C8 7F7F7F 13062D 260D59 543399 5200FF 7E4CE5 BA99FF C8CFE4 999999 1F062D 3E0D59 753399 A500FF AF4CE5 DB99FF 36322D B3B3B3 2D0626 590D4B 993387 EC008C E54CCA FF99ED 56493D CCCCCC 2D0614 590D29 993358 FF005D E54C84 FF99BE 6B5745 D9D9D9 F3BD9E FFCCAF FFDCC8 E5C9C3 F7E1DB FBE7E2 B58F7B E6E6E6 B27C5E CC9475 DCA98C ECC8B6 FFDFCF FEE6DB C0A292 F3F3F3".split(" ");static CUSTOM_PALETTES=JSON.parse(localStorage.getItem(this.CUSTOM_COLOR_SET_STORAGE))??
{};static PALETTE={DEFAULT:"default",CUSTOM:"custom"};static PALETTES=Object.assign({[this.PALETTE.DEFAULT]:this.DEFAULT_COLOR_SET,[this.PALETTE.CUSTOM]:[]},this.CUSTOM_PALETTES);static MAX_PALETTE_SIZE=128;static TYPE_PALETTE="application/vnd.gpmod.palette";static TYPE_PALETTE_COLOR_ID="application/vnd.gpmod.color-id";static PALETTE_FILE_EXT="gppal";static PS_COLOR_SWATCH_EXT="aco";static PALETTE_KEY_STATES={Shift:"add",Control:"delete",Alt:"move"};static buildDragPaletteImage(){const a=new Image;
a.src='data:image/svg+xml,%3Csvg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M12.78.28C6.567 1.492 1.561 6.486.336 12.68c-2.313 11.688 8.231 20.4 16.175 19.169 2.575-.4 3.838-3.413 2.656-5.732-1.444-2.837.62-6.15 3.807-6.15h4.981c2.238 0 4.05-1.85 4.056-4.081C31.98 6.036 23.017-1.714 12.78.28zM6.011 19.968c-1.106 0-2-.894-2-2 0-1.107.894-2 2-2 1.106 0 2 .893 2 2 0 1.106-.894 2-2 2zm2-8c-1.106 0-2-.894-2-2 0-1.107.894-2 2-2 1.106 0 2 .893 2 2 0 1.106-.894 2-2 2zm8-4c-1.106 0-2-.894-2-2 0-1.107.894-2 2-2s2 .893 2 2c0 1.106-.893 2-2 2zm8 4c-1.106 0-2-.894-2-2 0-1.107.894-2 2-2 1.107 0 2 .893 2 2 0 1.106-.893 2-2 2z" fill="%2343de99" stroke-width=".063"/%3E%3C/svg%3E';
return a}static DRAG_PALETTE_IMAGE=this.buildDragPaletteImage();static PALETTE_BACKGROUND_ICON='<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 512 512"><path d="M204.3 5C104.9 24.4 24.8 104.3 5.2 203.4c-37 187 131.7 326.4 258.8 306.7 41.2-6.4 61.4-54.6 42.5-91.7-23.1-45.4 9.9-98.4 60.9-98.4h79.7c35.8 0 64.8-29.6 64.9-65.3C511.5 97.1 368.1-26.9 204.3 5zM96 320c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm32-128c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm128-64c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm128 64c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32z"/></svg>';static PALETTE_WHEEL_SWITCH=!1;constructor(a,
b,c,d){super();this.l=a;this.paletteName=b;this.getNickname=c;this.getCurrentColor=d;this.state=!1;GPUtils_.bindMethods([this.paletteKeyHandler,this.resetKeys,this.onPaletteDragStart,this.onPaletteDragOver,this.onPaletteDragEnter,this.onPaletteDragLeave,this.onPaletteDrop],this);this.init()}getElement(){return this.palette}getState(){return this.state}init(){document.addEventListener("keydown",this.paletteKeyHandler,!0);document.addEventListener("keyup",this.paletteKeyHandler,!0);window.addEventListener("blur",
this.resetKeys);window.addEventListener("focus",this.resetKeys);this.paletteKeys=new Set;this.paletteFileInput=document.createElement("input");this.paletteFileInput.type="file";this.paletteFileInput.accept=`.${GPExtendedPalette_.PALETTE_FILE_EXT}`;this.paletteFileInput.addEventListener("change",a=>{this.handlePaletteFile(a.target.files)});this.palette=document.createElement("div");this.palette.className="gp-palette-set_";this.palette.classList.toggle("custom_",this.isCustomPalette);this.palette.dataset.id=
-1;this.paletteBackground=document.createElement("div");this.paletteBackground.className="background_";this.paletteBackground.title=this.l.PALETTE_FILE_DROP_AREA_TTL;this.paletteBackground.innerHTML=GPExtendedPalette_.PALETTE_BACKGROUND_ICON;this.palette.appendChild(this.paletteBackground);this.paletteColors=document.createElement("div");this.paletteColors.className="colors_";this.palette.appendChild(this.paletteColors);this.isCustomPalette&&(this.palette.draggable=!0,this.palette.addEventListener("dragstart",
this.onPaletteDragStart),this.palette.addEventListener("dragover",this.onPaletteDragOver),this.palette.addEventListener("dragenter",this.onPaletteDragEnter),this.palette.addEventListener("dragleave",this.onPaletteDragLeave),this.palette.addEventListener("drop",this.onPaletteDrop));this.palette.addEventListener("auxclick",a=>{this.isCustomPalette&&1===a.button&&(a.ctrlKey?0<this.colorSet.length&&this.downloadPalette():this.paletteFileInput.click(),a.preventDefault())});this.palette.addEventListener("pointerdown",
a=>{if(0===a.button||2===a.button)if(this.isCustomPalette){const b=a.target.classList.contains("color_"),c=this.colorSet,d=b?this.getColorIndex(a.target):-1;a.shiftKey?(b?(c.splice(d,0,this.getCurrentColor()),c.length=Math.min(c.length,GPExtendedPalette_.MAX_PALETTE_SIZE)):c.length<GPExtendedPalette_.MAX_PALETTE_SIZE&&c.push(this.getCurrentColor()),this.renderPaletteColorSet(),this.saveCustomPalette()):a.ctrlKey?(b?c.splice(d,1):c.length&&c.pop(),this.renderPaletteColorSet(),this.saveCustomPalette()):
a.altKey?b&&this.renderPaletteColorSet():b&&this.selectPaletteColor(a.target,a.button)}else this.selectPaletteColor(a.target,a.button)});this.palette.addEventListener("click",a=>{this.isCustomPalette&&0===this.colorSet.length&&void 0===this.palette.dataset.state&&this.paletteFileInput.click()});this.palette.addEventListener("contextmenu",a=>{a.preventDefault()});GPExtendedPalette_.PALETTE_WHEEL_SWITCH&&this.palette.addEventListener("wheel",a=>{this.changePalette(a.deltaY);a.preventDefault()});this.setPalette(this.paletteName)}terminate(){this.palette.remove();
this.paletteKeys.clear();document.removeEventListener("keydown",this.paletteKeyHandler,!0);document.removeEventListener("keyup",this.paletteKeyHandler,!0);window.removeEventListener("blur",this.resetKeys);window.removeEventListener("focus",this.resetKeys)}changePalette(a){const b=Object.keys(GPExtendedPalette_.PALETTES),c=b.findIndex(d=>d===this.paletteName);if(~c){const d=b.length;a=b[0>a?(c+d-1)%d:(c+1)%d]}else a=GPExtendedPalette_.PALETTE.DEFAULT;this.setPalette(a);this.dispatchEvent(new CustomEvent("palette",
{detail:{name:a}}))}setPalette(a){this.palette?(this.paletteKeys.clear(),this.paletteName=a,this.colorSet=GPExtendedPalette_.PALETTES[this.paletteName],this.isCustomPalette=this.paletteName!==GPExtendedPalette_.PALETTE.DEFAULT,this.paletteDropTarget=null,this.palette.classList.toggle("custom_",this.isCustomPalette),this.renderPaletteColorSet(),this.isCustomPalette?(this.palette.draggable=!0,this.palette.addEventListener("dragstart",this.onPaletteDragStart),this.palette.addEventListener("dragover",
this.onPaletteDragOver),this.palette.addEventListener("dragenter",this.onPaletteDragEnter),this.palette.addEventListener("dragleave",this.onPaletteDragLeave),this.palette.addEventListener("drop",this.onPaletteDrop)):(this.palette.draggable=!1,this.palette.removeEventListener("dragstart",this.onPaletteDragStart),this.palette.removeEventListener("dragover",this.onPaletteDragOver),this.palette.removeEventListener("dragenter",this.onPaletteDragEnter),this.palette.removeEventListener("dragleave",this.onPaletteDragLeave),
this.palette.removeEventListener("drop",this.onPaletteDrop))):this.init()}renderPaletteColorSet(){const a=this.colorSet;a.length=Math.min(a.length,GPExtendedPalette_.MAX_PALETTE_SIZE);const [b,c,d]=this.calculateColorSize(a.length);this.palette.classList.toggle("max-size_",c);this.palette.classList.toggle("empty_",!a.length);this.palette.style.setProperty("--gp-color-size",`${b}px`);this.palette.style.setProperty("--gp-palette-columns-count",`${d}`);this.paletteColors.innerHTML="";a.forEach((e,f)=>
{const g=document.createElement("div");g.className="color_";g.dataset.color=`#${e}`;g.style.backgroundColor=`#${e}`;this.isCustomPalette&&(g.draggable=!0,g.dataset.id=f);this.paletteColors.appendChild(g)})}saveCustomPalette(){const {default:a,...b}=GPExtendedPalette_.PALETTES;localStorage.setItem(GPExtendedPalette_.CUSTOM_COLOR_SET_STORAGE,JSON.stringify(b))}calculateColorSize(a){const b=[3,4,5,6,8];var c=b.map((f,g)=>Math.floor(292/(148/b[g]))*f).findIndex(f=>a<=f),d=~c?c:b.length-1;c=Math.floor((148-
3*(b[d]-1))/b[d]);const e=b[d]===b.at(-1);d=~d?b[d]:b.at(-1);return[c,e,d]}getColorIndex(a){return[].indexOf.call(this.palette.children,a)}selectPaletteColor(a,b){const c=a.dataset.color;2!==b?(this.resetPaletteColor(),a.classList.add("selected_"),a="color"):a="color2";this.dispatchEvent(new CustomEvent(a,{detail:{color:c}}))}resetPaletteColor(){if(this.palette){var a=this.palette.querySelector(".color_.selected_");a&&a.classList.remove("selected_")}}paletteKeyHandler(a){if(this.palette&&!a.repeat){var b=
GPExtendedPalette_.PALETTE_KEY_STATES;a.key in b&&(a.getModifierState(a.key)?this.paletteKeys.add(a.key):this.paletteKeys.delete(a.key),(a=Object.keys(b).find(c=>this.paletteKeys.has(c)))?this.palette.dataset.state=b[a]:delete this.palette.dataset.state)}}resetKeys(a){this.palette&&(this.paletteKeys.clear(),delete this.palette.dataset.state)}serializePalette(a){return a.join("\n")}downloadPalette(){const {url:a,filename:b}=this.buildSerializedPalette(),c=document.createElement("a");c.href=a;c.download=
b;c.click();URL.revokeObjectURL(this.paletteURL)}buildSerializedPalette(){const a=`gp-palette by ${this.getNickname()} (${this.getPaletteHash()}).${GPExtendedPalette_.PALETTE_FILE_EXT}`,b=new Blob([this.serializePalette(this.colorSet)]);URL.revokeObjectURL(this.paletteURL);this.paletteURL=URL.createObjectURL(b);return{url:this.paletteURL,filename:a}}getPaletteHash(){let a=0;this.colorSet.forEach(b=>{for(let c=0;c<b.length;c++){const d=b.charCodeAt(c);a=(a<<5)-a+d;a|=0}});return(a+2147483648).toString(36)}onPaletteDragStart(a){if(a.shiftKey||
a.ctrlKey||a.altKey||!this.colorSet.length)a.altKey&&a.target!==a.currentTarget?(a.dataTransfer.setData(GPExtendedPalette_.TYPE_PALETTE_COLOR_ID,a.target.dataset.id),a.dataTransfer.effectAllowed="move"):a.preventDefault();else{const {url:b,filename:c}=this.buildSerializedPalette();a.dataTransfer.setData("DownloadURL",`${GPExtendedPalette_.TYPE_PALETTE}:${c}:${b}`);a.dataTransfer.setDragImage(GPExtendedPalette_.DRAG_PALETTE_IMAGE,0,0)}}onPaletteDragOver(a){a.preventDefault();a.dataTransfer.dropEffect=
"move"}onPaletteDragEnter(a){switch(a.dataTransfer.types[0]){case GPExtendedPalette_.TYPE_PALETTE_COLOR_ID:~a.target.dataset.id&&a.target.classList.add("drag-over_");break;case "Files":this.paletteDropTarget=a.target,a.currentTarget.classList.add("drag-over_")}}onPaletteDragLeave(a){a.target.matches(".color_")?a.target.classList.remove("drag-over_"):a.target===this.paletteDropTarget&&(a.preventDefault(),a.currentTarget.classList.remove("drag-over_"))}onPaletteDrop(a){switch(a.dataTransfer.types[0]){case GPExtendedPalette_.TYPE_PALETTE_COLOR_ID:const b=
a.dataTransfer.getData(GPExtendedPalette_.TYPE_PALETTE_COLOR_ID);if(b===a.target.dataset.id)break;this.moveColor(b,a.target.dataset.id);this.saveCustomPalette();break;case "Files":this.handlePaletteFile(a.dataTransfer.files)}a.target.classList.remove("drag-over_");a.currentTarget.classList.remove("drag-over_");a.preventDefault()}handlePaletteFile(a){if(a=Array.from(a).find(this.isPaletteFile)){const b=new FileReader;this.isPSColorSwatchFile(a)?(b.addEventListener("loadend",c=>{try{const d=GPAcoDecoder_.decode(b.result);
this.loadPaletteColors(d)}catch(d){console.error(d)}}),b.readAsArrayBuffer(a)):(b.addEventListener("loadend",c=>{try{const d=this.parsePaletteFile(b.result);this.loadPaletteColors(d)}catch(d){console.error(d)}}),b.readAsText(a))}}loadPaletteColors(a){a&&(this.colorSet.length=0,this.colorSet.push(...a),this.renderPaletteColorSet(),this.saveCustomPalette())}parsePaletteFile(a){const b=[];a=a.split(/\s+/);for(let c=0;c<a.length;c++){const d=(a[c].match(/^#?([0-9A-Fa-f]{6})$/)||[])[1];if(d&&(b.push(d),
b.length===GPExtendedPalette_.MAX_PALETTE_SIZE))break}return b}isPaletteFile(a){const b=a.name.toLowerCase();return[GPExtendedPalette_.PALETTE_FILE_EXT,GPExtendedPalette_.PS_COLOR_SWATCH_EXT].some(c=>b.endsWith(`.${c}`))}isPSColorSwatchFile(a){return a.name.toLowerCase().endsWith(`.${GPExtendedPalette_.PS_COLOR_SWATCH_EXT}`)}moveColor(a,b){this.colorSet.splice(~b?b:this.colorSet.length,0,this.colorSet.splice(a,1)[0]);this.renderPaletteColorSet()}enable(){this.palette.removeAttribute("disabled")}disable(){this.palette.setAttribute("disabled",
"")}remove(){this.palette.remove()}get size(){return GPExtendedPalette_.PALETTES[this.paletteName].length}}window.GPExtendedPalette_=GPExtendedPalette_;class GPPainter_ extends EventTarget{static POINTER_RESOLUTION_RATIO_X=window.screen.width/1920;static POINTER_RESOLUTION_RATIO_Y=window.screen.height/1080;static SEARCH_DRAW_CONTAINER_INTERVAL=200;static TOOL={BRUSH:1,ERASER:2,LINE:3,RECTANGLE:4,CIRCLE:5,RECTANGLE_FILLED:6,CIRCLE_FILLED:7,FILL:8,NOTE:10,DELIMITER:11};static TOOLS_IN_TIME=[this.TOOL.BRUSH,this.TOOL.ERASER,this.TOOL.NOTE];static CANVAS_DENSITY=2;static BACKGROUND_COLOR="#ffffff";static DEFAULT_TOOL=this.TOOL.BRUSH;static FIRST_STROKE_ID=1;static POINTER_COLOR="#000000";static POINTER_OPACITY=1;static POINTER_OUTLINE_COLOR="#FFFFFF";static POINTER_OUTLINE_OPACITY=1;static POINTER_CROSSHAIR_MIN_THICKNESS=5;static POINTER_CROSSHAIR_LINE_LENGTH=6;static POINTER_DOT_THICKNESS=2;static TOOLS_THICKNESSES={[this.TOOL.RECTANGLE_FILLED]:2,
[this.TOOL.CIRCLE_FILLED]:2,[this.TOOL.FILL]:2};static DISABLED_MODE_OPTIONS={visible:[2]};static COLOR_PICKER_WIDTH=250;static COLOR_PICKER_HEIGHT=250;static COLOR_PICKER_HUE_POSITION=GPColorPicker_.RIGHT;static DEFAULT_HEADER_COLOR="#481d92";static SYMMETRY_MODES={VERTICAL:0,HORIZONTAL:1,QUADRANT:2,RADIAL:3,MANDALA:4};static UNSUBSCRIBED_SYMMETRY_MODES=["VERTICAL","HORIZONTAL"];static DEFAULT_SYMMETRY_MODE=this.SYMMETRY_MODES.VERTICAL;static SYMMETRY_GUIDES_COUNT_SENSITIVITY=Math.round(5*GPPainter_.POINTER_RESOLUTION_RATIO_Y);static MIN_SYMMETRY_RADIAL_GUIDES=2;static MAX_SYMMETRY_RADIAL_GUIDES=32;static MIN_SYMMETRY_MANDALA_GUIDES=3;static MAX_SYMMETRY_MANDALA_GUIDES=16;static SYMMETRY_GUIDES_ROTATION_MODE={DRAGGING:"dragging",
SNAPPING:"snapping"};static M_STROKE_OFFSET=67;static M_STROKE_RANGE=100;static AXIS={HORIZONTAL:"horizontal",VERTICAL:"vertical"};static DIRECTION={DOWN_RIGHT:"down / right",UP_LEFT:"up / left"};static DEFAULT_SETTINGS={defaultColor:["#000000",GPPainter_.BACKGROUND_COLOR],defaultThickness:6,defaultOpacity:1,minThickness:1,maxThickness:300,thicknessAxis:this.AXIS.HORIZONTAL,upThicknessDirection:this.DIRECTION.DOWN_RIGHT,doubleEraserThickness:!0,disableDoubleEraserThicknessOnShortcut:!0,thicknessStep:1,
customThickness:[2,6,10,14,18],minOpacity:.02,opacitySensitivity:1,opacityAxis:this.AXIS.HORIZONTAL,upOpacityDirection:this.DIRECTION.DOWN_RIGHT,opacityStep:.1,customOpacity:[.2,.4,.6,.8,1],brightnessSensitivity:1,brightnessAxis:this.AXIS.VERTICAL,upBrightnessDirection:this.DIRECTION.UP_LEFT,brightnessStep:1,minZoom:1,maxZoom:30,zoomSensitivity:.5,zoomAxis:this.AXIS.VERTICAL,zoomInDirection:this.DIRECTION.UP_LEFT,maxZoomToPoint:3,zoomStep:.5,pointerOpacity:1,pointerOutlineOpacity:1,colorPickerHuePosition:GPColorPicker_.RIGHT,
colorPickerWidth:250,colorPickerHeight:250,colorWheelMode:GPColorWheel_.MODE.COMPLEMENTARY,fixedScreenSize:!1,readyConfirmation:!1,stretchNativePalette:!0,extendedPalettePanel:!0,extendedPaletteName:"default",colorPanelControlsSet:"default",colorPickerPanel:!0,panelsBackgroundColor:"#5e1933",panelsBackgroundOpacity:60,panelsElementsColor:"#ff8eaf",panelsElementsOpacity:60,controlsBackgroundBlurLevel:0,interactionHints:!0,interactionHintsDelay:1,hideHeaderBackground:!1,autoHideHeaderElements:!1,autoHideHeaderDelay:.3,
headerColor:"#481d92",headerInstructionsColor:"#43de99",lineSmoothingLevel:0,eraserLineSmoothing:!1,symmetryGuidesColor:"#4affff",symmetryGuidesOpacity:1,symmetryGuidesWidth:1,symmetryRadialGuidesCount:8,symmetryMandalaGuidesCount:4,symmetryMode:this.SYMMETRY_MODES.VERTICAL,symmetryGuidesRotationMode:this.SYMMETRY_GUIDES_ROTATION_MODE.DRAGGING,centeringCircleTool:!1};static SETTINGS_UI={_1:{text:"Default Settings"},defaultColor:{type:"colors",args:{proportions:[3,1]},description:"\u041e\u0441\u043d\u043e\u0432\u043d\u043e\u0439 \u0438 \u0434\u043e\u043f\u043e\u043b\u043d\u0438\u0442\u0435\u043b\u044c\u043d\u044b\u0439 \u0446\u0432\u0435\u0442\u0430 \u043a\u0438\u0441\u0442\u0438 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e (\u0443\u0441\u0442\u0430\u043d\u0430\u0432\u043b\u0438\u0432\u0430\u044e\u0442\u0441\u044f \u0432 \u043d\u0430\u0447\u0430\u043b\u0435 \u043a\u0430\u0436\u0434\u043e\u0433\u043e \u0440\u0430\u0443\u043d\u0434\u0430)"},
defaultThickness:{type:"slider",args:{min:1,max:600,step:1},description:"\u0422\u043e\u043b\u0449\u0438\u043d\u0430 \u043a\u0438\u0441\u0442\u0438 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e (\u0443\u0441\u0442\u0430\u043d\u0430\u0432\u043b\u0438\u0432\u0430\u0435\u0442\u0441\u044f \u0432 \u043d\u0430\u0447\u0430\u043b\u0435 \u043a\u0430\u0436\u0434\u043e\u0433\u043e \u0440\u0430\u0443\u043d\u0434\u0430)"},defaultOpacity:{type:"slider",args:{min:.01,max:1,step:.01},description:"\u041d\u0430\u0441\u044b\u0449\u0435\u043d\u043d\u043e\u0441\u0442\u044c \u043a\u0438\u0441\u0442\u0438 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e (\u0443\u0441\u0442\u0430\u043d\u0430\u0432\u043b\u0438\u0432\u0430\u0435\u0442\u0441\u044f \u0432 \u043d\u0430\u0447\u0430\u043b\u0435 \u043a\u0430\u0436\u0434\u043e\u0433\u043e \u0440\u0430\u0443\u043d\u0434\u0430)"},
_2:{text:"Thickness"},minThickness:{type:"slider",args:{min:1,max:600,step:1},description:"\u041c\u0438\u043d\u0438\u043c\u0430\u043b\u044c\u043d\u0430\u044f \u0442\u043e\u043b\u0449\u0438\u043d\u0430 \u043a\u0438\u0441\u0442\u0438, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u0430\u044f \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},maxThickness:{type:"slider",args:{min:1,max:600,step:1},description:"\u041c\u0430\u043a\u0441\u0438\u043c\u0430\u043b\u044c\u043d\u0430\u044f \u0442\u043e\u043b\u0449\u0438\u043d\u0430 \u043a\u0438\u0441\u0442\u0438, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u0430\u044f \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},
thicknessAxis:{type:"dropdown",args:{items:[this.AXIS.HORIZONTAL,this.AXIS.VERTICAL]},description:"\u041f\u043b\u043e\u0441\u043a\u043e\u0441\u0442\u044c \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u043e\u0432\u043a\u0438 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c \u0442\u043e\u043b\u0449\u0438\u043d\u044b \u043a\u0438\u0441\u0442\u0438"},upThicknessDirection:{type:"dropdown",args:{items:[this.DIRECTION.DOWN_RIGHT,this.DIRECTION.UP_LEFT]},description:"\u041d\u0430\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u043f\u043e\u0432\u044b\u0448\u0435\u043d\u0438\u044f \u0442\u043e\u043b\u0449\u0438\u043d\u044b \u043a\u0438\u0441\u0442\u0438, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u043e\u0439 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},
doubleEraserThickness:{type:"switch",description:"\u0423\u0434\u0432\u0430\u0438\u0432\u0430\u0442\u044c \u0442\u043e\u043b\u0449\u0438\u043d\u0443 \u043a\u0438\u0441\u0442\u0438 \u0434\u043b\u044f \u0438\u043d\u0441\u0442\u0440\u0443\u043c\u0435\u043d\u0442\u0430 \u041b\u0430\u0441\u0442\u0438\u043a"},disableDoubleEraserThicknessOnShortcut:{type:"switch",description:'\u041e\u0442\u043a\u043b\u044e\u0447\u0438\u0442\u044c \u0443\u0434\u0432\u0430\u0438\u0432\u0430\u043d\u0438\u0435 \u0442\u043e\u043b\u0449\u0438\u043d\u044b \u043a\u0438\u0441\u0442\u0438 \u043f\u0440\u0438 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u0438 \u0444\u0443\u043d\u043a\u0446\u0438\u0438 "\u041b\u0430\u0441\u0442\u0438\u043a (\u043f\u043e \u0437\u0430\u0436\u0430\u0442\u0438\u044e)"'},
thicknessStep:{type:"slider",args:{min:1,max:10,step:1},description:"\u0428\u0430\u0433 \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044f \u0442\u043e\u043b\u0449\u0438\u043d\u044b \u043a\u0438\u0441\u0442\u0438 \u043f\u0440\u0438 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u0438 \u043a\u043e\u043c\u0431\u0438\u043d\u0430\u0446\u0438\u0439 \u043a\u043b\u0430\u0432\u0438\u0448"},customThickness:{type:"list-numbers",args:{items:[{min:1,max:600,step:1},{min:1,max:600,
step:1},{min:1,max:600,step:1},{min:1,max:600,step:1},{min:1,max:600,step:1}]},description:"\u041f\u0440\u043e\u0438\u0437\u0432\u043e\u043b\u044c\u043d\u044b\u0435 \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u044f \u0442\u043e\u043b\u0449\u0438\u043d\u044b \u043a\u0438\u0441\u0442\u0438 \u0434\u043b\u044f \u0431\u044b\u0441\u0442\u0440\u043e\u0433\u043e \u0432\u044b\u0431\u043e\u0440\u0430 \u0441 \u043f\u043e\u043c\u043e\u0449\u044c\u044e \u043a\u043e\u043c\u0431\u0438\u043d\u0430\u0446\u0438\u0439 \u043a\u043b\u0430\u0432\u0438\u0448"},
_3:{text:"Opacity"},minOpacity:{type:"slider",args:{min:.01,max:1,step:.01},description:"\u041c\u0438\u043d\u0438\u043c\u0430\u043b\u044c\u043d\u0430\u044f \u043d\u0430\u0441\u044b\u0449\u0435\u043d\u043d\u043e\u0441\u0442\u044c \u043a\u0438\u0441\u0442\u0438, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u0430\u044f \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},opacitySensitivity:{type:"slider",args:{min:.1,max:3,step:.1},description:"\u0427\u0443\u0432\u0441\u0442\u0432\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u044c \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044f \u043d\u0430\u0441\u044b\u0449\u0435\u043d\u043d\u043e\u0441\u0442\u0438 \u043a\u0438\u0441\u0442\u0438, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u043e\u0439 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},
opacityAxis:{type:"dropdown",args:{items:[this.AXIS.HORIZONTAL,this.AXIS.VERTICAL]},description:"\u041f\u043b\u043e\u0441\u043a\u043e\u0441\u0442\u044c \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u043e\u0432\u043a\u0438 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c \u043d\u0430\u0441\u044b\u0449\u0435\u043d\u043d\u043e\u0441\u0442\u0438 \u043a\u0438\u0441\u0442\u0438"},upOpacityDirection:{type:"dropdown",args:{items:[this.DIRECTION.DOWN_RIGHT,this.DIRECTION.UP_LEFT]},description:"\u041d\u0430\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u043f\u043e\u0432\u044b\u0448\u0435\u043d\u0438\u044f \u043d\u0430\u0441\u044b\u0449\u0435\u043d\u043d\u043e\u0441\u0442\u0438 \u043a\u0438\u0441\u0442\u0438, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u043e\u0439 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},
opacityStep:{type:"slider",args:{min:.01,max:10,step:.01},description:"\u0428\u0430\u0433 \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044f \u043d\u0430\u0441\u044b\u0449\u0435\u043d\u043d\u043e\u0441\u0442\u0438 \u043a\u0438\u0441\u0442\u0438 \u043f\u0440\u0438 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u0438 \u043a\u043e\u043c\u0431\u0438\u043d\u0430\u0446\u0438\u0439 \u043a\u043b\u0430\u0432\u0438\u0448"},customOpacity:{type:"list-numbers",args:{items:[{min:.01,
max:1,step:.01},{min:.01,max:1,step:.01},{min:.01,max:1,step:.01},{min:.01,max:1,step:.01},{min:.01,max:1,step:.01}]},description:"\u041f\u0440\u043e\u0438\u0437\u0432\u043e\u043b\u044c\u043d\u044b\u0435 \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u044f \u043d\u0430\u0441\u044b\u0449\u0435\u043d\u043d\u043e\u0441\u0442\u0438 \u043a\u0438\u0441\u0442\u0438 \u0434\u043b\u044f \u0431\u044b\u0441\u0442\u0440\u043e\u0433\u043e \u0432\u044b\u0431\u043e\u0440\u0430 \u0441 \u043f\u043e\u043c\u043e\u0449\u044c\u044e \u043a\u043e\u043c\u0431\u0438\u043d\u0430\u0446\u0438\u0439 \u043a\u043b\u0430\u0432\u0438\u0448"},
_4:{text:"Brightness"},brightnessSensitivity:{type:"slider",args:{min:.1,max:3,step:.1},description:"\u0427\u0443\u0432\u0441\u0442\u0432\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u044c \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044f \u044f\u0440\u043a\u043e\u0441\u0442\u0438 \u0446\u0432\u0435\u0442\u0430 \u043a\u0438\u0441\u0442\u0438, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u043e\u0439 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},brightnessAxis:{type:"dropdown",
args:{items:[this.AXIS.HORIZONTAL,this.AXIS.VERTICAL]},description:"\u041f\u043b\u043e\u0441\u043a\u043e\u0441\u0442\u044c \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u043e\u0432\u043a\u0438 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c \u044f\u0440\u043a\u043e\u0441\u0442\u0438 \u0446\u0432\u0435\u0442\u0430 \u043a\u0438\u0441\u0442\u0438"},upBrightnessDirection:{type:"dropdown",args:{items:[this.DIRECTION.DOWN_RIGHT,this.DIRECTION.UP_LEFT]},description:"\u041d\u0430\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u043f\u043e\u0432\u044b\u0448\u0435\u043d\u0438\u044f \u044f\u0440\u043a\u043e\u0441\u0442\u0438 \u0446\u0432\u0435\u0442\u0430 \u043a\u0438\u0441\u0442\u0438, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u043e\u0439 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},
brightnessStep:{type:"slider",args:{min:1,max:10,step:1},description:"\u0428\u0430\u0433 \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044f \u044f\u0440\u043a\u043e\u0441\u0442\u0438 \u0446\u0432\u0435\u0442\u0430 \u043a\u0438\u0441\u0442\u0438 \u043f\u0440\u0438 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u0438 \u043a\u043e\u043c\u0431\u0438\u043d\u0430\u0446\u0438\u0439 \u043a\u043b\u0430\u0432\u0438\u0448"},_5:{text:"Zoom"},minZoom:{type:"slider",args:{min:.1,max:1,
step:.1},description:"\u041c\u0438\u043d\u0438\u043c\u0430\u043b\u044c\u043d\u044b\u0439 \u0443\u0440\u043e\u0432\u0435\u043d\u044c \u043c\u0430\u0441\u0448\u0442\u0430\u0431\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f \u0445\u043e\u043b\u0441\u0442\u0430, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u043e\u0433\u043e \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},maxZoom:{type:"slider",args:{min:2,max:60,step:1},description:"\u041c\u0430\u043a\u0441\u0438\u043c\u0430\u043b\u044c\u043d\u044b\u0439 \u0443\u0440\u043e\u0432\u0435\u043d\u044c \u043c\u0430\u0441\u0448\u0442\u0430\u0431\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f \u0445\u043e\u043b\u0441\u0442\u0430, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u043e\u0433\u043e \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},
zoomSensitivity:{type:"slider",args:{min:.1,max:2,step:.1},description:"\u0427\u0443\u0432\u0441\u0442\u0432\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u044c \u043c\u0430\u0441\u0448\u0442\u0430\u0431\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f \u0445\u043e\u043b\u0441\u0442\u0430, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u043e\u0433\u043e \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},zoomAxis:{type:"dropdown",args:{items:[this.AXIS.HORIZONTAL,this.AXIS.VERTICAL]},
description:"\u041f\u043b\u043e\u0441\u043a\u043e\u0441\u0442\u044c \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u043e\u0432\u043a\u0438 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c \u043c\u0430\u0441\u0448\u0442\u0430\u0431\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f \u0445\u043e\u043b\u0441\u0442\u0430"},zoomInDirection:{type:"dropdown",args:{items:[this.DIRECTION.DOWN_RIGHT,this.DIRECTION.UP_LEFT]},description:"\u041d\u0430\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u043c\u0430\u0441\u0448\u0442\u0430\u0431\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f \u0445\u043e\u043b\u0441\u0442\u0430, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u043e\u0433\u043e \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},
maxZoomToPoint:{type:"slider",args:{min:2,max:60,step:1},description:"\u041c\u0430\u043a\u0441\u0438\u043c\u0430\u043b\u044c\u043d\u043e\u0435 \u043c\u0430\u0441\u0448\u0442\u0430\u0431\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f \u0445\u043e\u043b\u0441\u0442\u0430 \u0432 \u0432\u044b\u0431\u0440\u0430\u043d\u043d\u0443\u044e \u0442\u043e\u0447\u043a\u0443"},zoomStep:{type:"slider",args:{min:.1,max:2,step:.1},description:"\u041a\u043e\u044d\u0444\u0444\u0438\u0446\u0438\u0435\u043d\u0442 \u043c\u0430\u0441\u0448\u0442\u0430\u0431\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f \u0445\u043e\u043b\u0441\u0442\u0430 \u043f\u0440\u0438 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u0438 \u043a\u043e\u043b\u0435\u0441\u0430 \u043c\u044b\u0448\u0438 \u0438 \u043a\u043e\u043c\u0431\u0438\u043d\u0430\u0446\u0438\u0439 \u043a\u043b\u0430\u0432\u0438\u0448"},
_6:{text:"Pointer"},pointerOpacity:{type:"slider",args:{min:0,max:1,step:.1},description:"\u041f\u0440\u043e\u0437\u0440\u0430\u0447\u043d\u043e\u0441\u044c \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u044f"},pointerOutlineOpacity:{type:"slider",args:{min:0,max:1,step:.1},description:"\u041f\u0440\u043e\u0437\u0440\u0430\u0447\u043d\u043e\u0441\u044c \u043a\u043e\u043d\u0442\u0443\u0440\u0430 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u044f"},_7:{text:"Color Picker"},colorPickerHuePosition:{type:"dropdown",
args:{items:[GPColorPicker_.TOP,GPColorPicker_.BOTTOM,GPColorPicker_.RIGHT,GPColorPicker_.LEFT]},description:"\u0420\u0430\u0441\u043f\u043e\u043b\u043e\u0436\u0435\u043d\u0438\u0435 \u043f\u043e\u043b\u0437\u0443\u043d\u043a\u0430 \u043e\u0442\u0442\u0435\u043d\u043a\u0430 \u0434\u043b\u044f \u043f\u0430\u043b\u0438\u0442\u0440\u044b \u0446\u0432\u0435\u0442\u043e\u0432 (\u043f\u043e\u0434 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c)"},colorPickerWidth:{type:"slider",args:{min:100,
max:350,step:1},description:"\u0428\u0438\u0440\u0438\u043d\u0430 \u043f\u0430\u043b\u0438\u0442\u0440\u044b \u0446\u0432\u0435\u0442\u043e\u0432 (\u043f\u043e\u0434 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c)"},colorPickerHeight:{type:"slider",args:{min:100,max:350,step:1},description:"\u0412\u044b\u0441\u043e\u0442\u0430 \u043f\u0430\u043b\u0438\u0442\u0440\u044b \u0446\u0432\u0435\u0442\u043e\u0432 (\u043f\u043e\u0434 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c)"},
_8:{text:"Interface"},fixedScreenSize:{type:"switch",description:"\u0424\u0438\u043a\u0441\u0438\u0440\u043e\u0432\u0430\u043d\u043d\u044b\u0439 \u0440\u0430\u0437\u043c\u0435\u0440 \u0438\u043d\u0442\u0435\u0440\u0444\u0435\u0439\u0441\u0430 \u0440\u0435\u0434\u0430\u043a\u0442\u043e\u0440\u0430 (\u0438\u0433\u043d\u043e\u0440\u0438\u0440\u0443\u0435\u0442 \u0440\u0430\u0437\u043c\u0435\u0440 \u043e\u043a\u043d\u0430 \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0430)"},readyConfirmation:{type:"switch",
description:'\u041f\u043e\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043d\u0438\u0435 \u0437\u0430\u0432\u0435\u0440\u0448\u0435\u043d\u0438\u044f \u0445\u043e\u0434\u0430, \u0435\u0441\u043b\u0438 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440 "\u0412\u0420\u0415\u041c\u042f" \u0443\u0441\u0442\u0430\u043d\u043e\u0432\u043b\u0435\u043d, \u043a\u0430\u043a "\u0420\u0415\u0428\u0415\u041d\u0418\u0415 \u0412\u0415\u0414\u0423\u0429\u0415\u0413\u041e" (\u043f\u0440\u0438 \u0443\u0441\u043b\u043e\u0432\u0438\u0438, \u0447\u0442\u043e \u0412\u044b \u044f\u0432\u043b\u044f\u0435\u0442\u0435\u0441\u044c \u0432\u043b\u0430\u0434\u0435\u043b\u044c\u0446\u0435\u043c \u043a\u043e\u043c\u043d\u0430\u0442\u044b)'},
stretchNativePalette:{type:"switch",description:"\u0420\u0430\u0441\u0442\u044f\u0433\u0438\u0432\u0430\u0442\u044c \u0440\u043e\u0434\u043d\u0443\u044e \u043f\u0430\u043d\u0435\u043b\u044c \u043f\u0430\u043b\u0438\u0442\u0440\u044b \u043f\u043e \u0448\u0438\u0440\u0438\u043d\u0435"},extendedPalettePanel:{type:"switch",description:"\u0420\u0430\u0441\u0448\u0438\u0440\u0435\u043d\u043d\u0430\u044f \u043f\u0430\u043d\u0435\u043b\u044c \u043f\u0430\u043b\u0438\u0442\u0440\u044b (\u0437\u0430\u043c\u0435\u043d\u044f\u0435\u0442 \u043e\u0441\u043d\u043e\u0432\u043d\u0443\u044e)"},
colorPickerPanel:{type:"switch",description:"\u041f\u0430\u043d\u0435\u043b\u044c \u0432\u044b\u0431\u043e\u0440\u0430 \u0446\u0432\u0435\u0442\u0430"},panelsBackgroundColor:{type:"color",inputTrigger:!0,description:"\u0426\u0432\u0435\u0442 \u0444\u043e\u043d\u0430 \u043f\u0430\u043d\u0435\u043b\u0435\u0439 \u0438\u043d\u0442\u0435\u0440\u0444\u0435\u0439\u0441\u0430"},panelsBackgroundOpacity:{type:"slider",args:{min:0,max:100,step:1},inputTrigger:!0,description:"\u041f\u0440\u043e\u0437\u0440\u0430\u0447\u043d\u043e\u0441\u0442\u044c \u0444\u043e\u043d\u0430 \u043f\u0430\u043d\u0435\u043b\u0435\u0439 \u0438\u043d\u0442\u0435\u0440\u0444\u0435\u0439\u0441\u0430"},
panelsElementsColor:{type:"color",inputTrigger:!0,description:"\u0426\u0432\u0435\u0442 \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u043e\u0432 \u043f\u0430\u043d\u0435\u043b\u0435\u0439 \u0438\u043d\u0442\u0435\u0440\u0444\u0435\u0439\u0441\u0430"},panelsElementsOpacity:{type:"slider",args:{min:0,max:100,step:1},inputTrigger:!0,description:"\u041f\u0440\u043e\u0437\u0440\u0430\u0447\u043d\u043e\u0441\u0442\u044c \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u043e\u0432 \u043f\u0430\u043d\u0435\u043b\u0435\u0439 \u0438\u043d\u0442\u0435\u0440\u0444\u0435\u0439\u0441\u0430"},
controlsBackgroundBlurLevel:{type:"slider",args:{min:0,max:20,step:.1},inputTrigger:!0,description:"\u0423\u0440\u043e\u0432\u0435\u043d\u044c \u0440\u0430\u0437\u043c\u044b\u0442\u0438\u044f \u0444\u043e\u043d\u0430 \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u043e\u0432 \u0443\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u044f"},interactionHints:{type:"switch",description:"\u0412\u0438\u0437\u0443\u0430\u043b\u044c\u043d\u044b\u0435 \u043f\u043e\u0434\u0441\u043a\u0430\u0437\u043a\u0438\n\u041e\u0442\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0435 \u0432\u0438\u0437\u0443\u0430\u043b\u044c\u043d\u044b\u0445 \u043f\u043e\u0434\u0441\u043a\u0430\u0437\u043e\u043a \u043f\u0440\u0438 \u043d\u0430\u0432\u0435\u0434\u0435\u043d\u0438\u0438 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u044f \u043d\u0430 \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u044b \u0438\u043d\u0442\u0435\u0440\u0444\u0435\u0439\u0441\u0430\n\u041a \u043f\u0440\u0438\u043c\u0435\u0440\u0443: \u043f\u043e\u0434\u0441\u043a\u0430\u0437\u043a\u0430 \u043f\u0440\u0438 \u043d\u0430\u0432\u0435\u0434\u0435\u043d\u0438\u0438 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u044f \u043d\u0430 \u043f\u0430\u043d\u0435\u043b\u044c \u0446\u0432\u0435\u0442\u043e\u0432 \u043e \u043f\u0435\u0440\u0435\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u0438 \u043f\u0440\u0435\u0441\u0435\u0442\u043e\u0432 \u0441 \u043f\u043e\u043c\u043e\u0449\u044c\u044e \u043a\u043e\u043b\u0435\u0441\u0430 \u043c\u044b\u0448\u0438"},
interactionHintsDelay:{type:"slider",args:{min:0,max:2,step:.05},description:"\u0417\u0430\u0434\u0435\u0440\u0436\u043a\u0430 \u0432 \u0441\u0435\u043a\u0443\u043d\u0434\u0430\u0445 \u043f\u0435\u0440\u0435\u0434 \u043f\u043e\u044f\u0432\u043b\u0435\u043d\u0438\u0435\u043c \u0432\u0438\u0437\u0443\u0430\u043b\u044c\u043d\u044b\u0445 \u043f\u043e\u0434\u0441\u043a\u0430\u0437\u043e\u043a \u043f\u043e\u0441\u043b\u0435 \u043d\u0430\u0432\u0435\u0434\u0435\u043d\u0438\u044f \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u044f"},
_9:{text:"Header"},hideHeaderBackground:{type:"switch",description:"\u0421\u043a\u0440\u044b\u0432\u0430\u0442\u044c \u0444\u043e\u043d \u0437\u0430\u0433\u043e\u043b\u043e\u0432\u043a\u0430 \u0438 \u0440\u0430\u043c\u043a\u0438 \u0440\u0435\u0434\u0430\u043a\u0442\u043e\u0440\u0430"},autoHideHeaderElements:{type:"switch",description:"\u0410\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438 \u0441\u043a\u0440\u044b\u0432\u0430\u0442\u044c \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u044b \u0437\u0430\u0433\u043e\u043b\u043e\u0432\u043a\u0430 \u0440\u0435\u0434\u0430\u043a\u0442\u043e\u0440\u0430 (\u043a\u0440\u043e\u043c\u0435 \u043b\u043e\u0433\u043e \u0438 \u0437\u0430\u043f\u0443\u0449\u0435\u043d\u043d\u043e\u0433\u043e \u0442\u0430\u0439\u043c\u0435\u0440\u0430) \u0438 \u043f\u043e\u043a\u0430\u0437\u044b\u0432\u0430\u0442\u044c \u043f\u0440\u0438 \u043d\u0430\u0432\u0435\u0434\u0435\u043d\u0438\u0438 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u044f"},
autoHideHeaderDelay:{type:"slider",args:{min:0,max:1,step:.1},description:"\u0417\u0430\u0434\u0435\u0440\u0436\u043a\u0430 \u043f\u0435\u0440\u0435\u0434 \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438\u043c \u0441\u043a\u0440\u044b\u0442\u0438\u0435\u043c/\u043f\u043e\u043a\u0430\u0437\u043e\u043c \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u043e\u0432 \u0437\u0430\u0433\u043e\u043b\u043e\u0432\u043a\u0430"},headerColor:{type:"color",inputTrigger:!0,description:"\u0426\u0432\u0435\u0442 \u0437\u0430\u0433\u043e\u043b\u043e\u0432\u043a\u0430 \u0440\u0435\u0434\u0430\u043a\u0442\u043e\u0440\u0430 \u0438 \u0441\u0432\u044f\u0437\u0430\u043d\u043d\u044b\u0445 \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u043e\u0432"},
headerInstructionsColor:{type:"color",inputTrigger:!0,description:"\u0426\u0432\u0435\u0442 \u0438\u043d\u0441\u0442\u0440\u0443\u043a\u0446\u0438\u0439 \u0432 \u0437\u0430\u0433\u043e\u043b\u043e\u0432\u043a\u0435 \u0440\u0435\u0434\u0430\u043a\u0442\u043e\u0440\u0430"},_10:{text:"Line Smoothing"},lineSmoothingLevel:{type:"slider",args:{min:0,max:8,step:1},description:"\u0423\u0440\u043e\u0432\u0435\u043d\u044c \u0441\u0433\u043b\u0430\u0436\u0438\u0432\u0430\u043d\u0438\u044f \u043b\u0438\u043d\u0438\u0439 \u0434\u043b\u044f \u0438\u043d\u0441\u0442\u0440\u0443\u043c\u0435\u043d\u0442\u043e\u0432 \u041a\u0438\u0441\u0442\u044c, \u041b\u0430\u0441\u0442\u0438\u043a \u0438 \u0417\u0430\u043c\u0435\u0442\u043a\u0430"},
eraserLineSmoothing:{type:"switch",description:"\u041f\u0440\u0438\u043c\u0435\u043d\u044f\u0442\u044c \u0441\u0433\u043b\u0430\u0436\u0438\u0432\u0430\u043d\u0438\u0435 \u043b\u0438\u043d\u0438\u0439 \u0434\u043b\u044f \u0438\u043d\u0441\u0442\u0440\u0443\u043c\u0435\u043d\u0442\u0430 \u041b\u0430\u0441\u0442\u0438\u043a"},_11:{text:"Symmetry Guides"},symmetryGuidesColor:{type:"color",inputTrigger:!0,description:"\u0426\u0432\u0435\u0442 \u043d\u0430\u043f\u0440\u0430\u0432\u043b\u044f\u044e\u0449\u0438\u0445 \u0441\u0438\u043c\u043c\u0435\u0442\u0440\u0438\u0438"},
symmetryGuidesOpacity:{type:"slider",args:{min:0,max:1,step:.01},inputTrigger:!0,description:"\u041d\u0430\u0441\u044b\u0449\u0435\u043d\u043d\u043e\u0441\u0442\u044c \u043d\u0430\u043f\u0440\u0430\u0432\u043b\u044f\u044e\u0449\u0438\u0445 \u0441\u0438\u043c\u043c\u0435\u0442\u0440\u0438\u0438"},symmetryGuidesWidth:{type:"slider",args:{min:1,max:8,step:.5},inputTrigger:!0,description:"\u0428\u0438\u0440\u0438\u043d\u0430 \u043d\u0430\u043f\u0440\u0430\u0432\u043b\u044f\u044e\u0449\u0438\u0445 \u0441\u0438\u043c\u043c\u0435\u0442\u0440\u0438\u0438"},
symmetryGuidesRotationMode:{type:"dropdown",args:{items:[this.SYMMETRY_GUIDES_ROTATION_MODE.DRAGGING,this.SYMMETRY_GUIDES_ROTATION_MODE.SNAPPING]},description:"\u0420\u0435\u0436\u0438\u043c \u0432\u0440\u0430\u0449\u0435\u043d\u0438\u044f \u043d\u0430\u043f\u0440\u0430\u0432\u043b\u044f\u044e\u0449\u0438\u0445 \u0441\u0438\u043c\u043c\u0435\u0442\u0440\u0438\u0438: Dragging - \u043f\u0435\u0440\u0435\u0442\u0430\u0441\u043a\u0438\u0432\u0430\u043d\u0438\u0435 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c, Snapping - \u043f\u0440\u0438\u0432\u044f\u0437\u043a\u0430 \u043a \u043f\u043e\u0437\u0438\u0446\u0438\u0438 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u044f"},
_12:{text:"Tools"},centeringCircleTool:{type:"switch",description:"\u0426\u0435\u043d\u0442\u0440\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0438\u043d\u0441\u0442\u0440\u0443\u043c\u0435\u043d\u0442\u044b \u041a\u0440\u0443\u0433 \u0438 \u0417\u0430\u043f\u043e\u043b\u043d\u0435\u043d\u043d\u044b\u0439 \u043a\u0440\u0443\u0433 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e"}};static MODULE={title:"Painter",alias:"pa",dependencies:["GPDrawInterface_","GPColorUtils_","GPColorPicker_"],
settings:{storage:"gp_painter",defaultSettings:this.DEFAULT_SETTINGS,ui:this.SETTINGS_UI},useCSS:!0};constructor(a){super();this.prx=a.prx;this.sm=a.sm;this.timer=a.tmr;this.reference=a.ref;this.ac=a.ac;this.abt=a.abt;this.s=a.sm.setSettings(this,this.updateSettings);this.tools={dropper:{activator:{pointer:{0:{pointerMove:this.dropperPointerMove}},keyDown:this.dropperKeyDown,end:this.dropperEnd}},thickness:{activator:{pointer:{0:{pointerMove:this.thicknessPointerMove,pointerUp:this.thicknessPointerUp}},
keyDown:this.thicknessKeyDown,rightButton:this.thicknessRightButton,middleButton:this.thicknessMiddleButton}},opacity:{activator:{pointer:{0:{pointerMove:this.opacityMove}},keyDown:this.opacityKeyDown,rightButton:this.opacityRightButton,middleButton:this.opacityMiddleButton}},brightness:{activator:{pointer:{0:{pointerMove:this.brightnessMove}},keyDown:this.brightnessKeyDown,rightButton:this.brightnessRightButton,middleButton:this.brightnessMiddleButton}},zoom:{activator:{pointer:{0:{pointerUp:this.zoomPointerUp,
pointerMove:this.zoomMove}},keyDown:this.zoomKeyDown,rightButton:this.zoomRightButton,middleButton:this.zoomMiddleButton}},zoomToPoint:{handler:this.zoomToPoint},zoomIn:{handler:this.zoomIn,repeat:!0},zoomOut:{handler:this.zoomOut,repeat:!0},zoomReset:{handler:this.resetZoom},mirror:{handler:this.mirror},verticalMirror:{handler:this.verticalMirror},colorPicker:{handler:this.showColorPicker},switchColors:{handler:this.switchColors,whileDrawing:!0},eraser:{handler:this.eraser},grayscale:{handler:this.grayscale,
whileDrawing:!0},hand:{activator:{pointer:{0:{pointerMove:this.handPointerMove},2:{pointerDown:this.rotateKeyDown,pointerMove:this.rotatePointerMove,pointerUp:this.rotateEnd}},keyDown:this.handKeyDown,middleButton:this.handMiddleButton,end:this.handEnd}},rotate:{activator:{pointer:{0:{pointerMove:this.rotatePointerMove}},keyDown:this.rotateKeyDown,rightButton:this.rotateRightButton,middleButton:this.rotateMiddleButton,end:this.rotateEnd}},clear:{handler:this.clear},symmetry:{activator:{pointer:{0:{pointerDown:this.symmetryPointerDown,
pointerMove:this.symmetryPointerMove,pointerUp:this.symmetryPointerUp,hide:!0},2:{pointerDown:this.symmetryPointerDown,pointerMove:this.symmetryPointerMove,pointerUp:this.symmetryPointerUp}},keyDown:this.symmetryKeyDown,keyUp:this.symmetryKeyUp,middleButton:this.symmetryMiddleButton}},reference:{handler:this.toggleReference},toolCentering:{handler:this.toolCentering},grid:{handler:this.toggleGrid,whileDrawing:!0},undo:{handler:this.undo,repeat:!0},redo:{handler:this.redo,repeat:!0},save:{handler:this.save},
decreaseThickness:{handler:this.decreaseThickness,repeat:!0},increaseThickness:{handler:this.increaseThickness,repeat:!0},customThickness1:{handler:this.setCustomThickness,args:[0]},customThickness2:{handler:this.setCustomThickness,args:[1]},customThickness3:{handler:this.setCustomThickness,args:[2]},customThickness4:{handler:this.setCustomThickness,args:[3]},customThickness5:{handler:this.setCustomThickness,args:[4]},thicknessPanelSlot1:{handler:this.setBrushThickness,args:[2]},thicknessPanelSlot2:{handler:this.setBrushThickness,
args:[6]},thicknessPanelSlot3:{handler:this.setBrushThickness,args:[10]},thicknessPanelSlot4:{handler:this.setBrushThickness,args:[14]},thicknessPanelSlot5:{handler:this.setBrushThickness,args:[18]},decreaseOpacity:{handler:this.decreaseOpacity,repeat:!0},increaseOpacity:{handler:this.increaseOpacity,repeat:!0},customOpacity1:{handler:this.setCustomOpacity,args:[0]},customOpacity2:{handler:this.setCustomOpacity,args:[1]},customOpacity3:{handler:this.setCustomOpacity,args:[2]},customOpacity4:{handler:this.setCustomOpacity,
args:[3]},customOpacity5:{handler:this.setCustomOpacity,args:[4]},decreaseBrightness:{handler:this.decreaseBrightness,repeat:!0},increaseBrightness:{handler:this.increaseBrightness,repeat:!0},brushTool:{handler:this.brushTool},eraserTool:{handler:this.eraserTool},rectangleTool:{handler:this.rectangleTool},rectangleFilledTool:{handler:this.rectangleFilledTool},circleTool:{handler:this.circleTool},circleFilledTool:{handler:this.circleFilledTool},fillTool:{handler:this.fillTool},noteTool:{handler:this.noteTool}};
this.shortcutsManager=new GPShortcutsManager_(this,this.l);this.shortcutsManager.addEventListener("shortcuts_updated",({detail:{shortcuts:c}})=>{this.shortcutsHandler.updateShortcuts(c)});this.shortcutsHandler=new GPShortcutsHandler_(this.shortcutsManager.getShortcuts(),this.tools);this.shortcutsHandler.addEventListener("trigger",({detail:{shortcut:c,event:d}})=>{d.repeat&&!this.tools[c].repeat||this.isDrawing&&!this.tools[c].activator&&!this.tools[c].whileDrawing||this.tools[c].handler.apply(this,
[d,...(this.tools[c].args??[])])});this.addEventListener("enable",c=>{this.shortcutsHandler.enable()});this.addEventListener("disable",c=>{this.shortcutsHandler.disable()});this.shortcutsManager.addEventListener("keys_locked",c=>{this.shortcutsHandler.lockKeys()});this.shortcutsManager.addEventListener("keys_unlocked",c=>{this.shortcutsHandler.unlockKeys()});this.iface=new GPDrawInterface_(this,this.prx,this.l);this.iface.addEventListener("color",({detail:{color:c}})=>{this.color=c;this.colorPicker.setColor(c)});
this.iface.addEventListener("color2",({detail:{color:c}})=>{this.color2=c});this.canvasTypeId=GPUtils_.CANVAS_ID.DEFAULT;this.density=GPPainter_.CANVAS_DENSITY;this.style=document.documentElement.style;this.style.setProperty("--gp-painter-background-color",`${GPPainter_.BACKGROUND_COLOR}`);this.color=this.s.defaultColor[0];this.color2=this.s.defaultColor[1];this.thickness=Math.max(this.s.minThickness,Math.min(this.s.maxThickness,this.s.defaultThickness));a=Math.max(this.s.minOpacity,this.s.defaultOpacity);
this.opacity=1===a?a:String(a);this.tool=GPPainter_.DEFAULT_TOOL;this.isNote=!1;this.searchTimer=null;this.strokeId=GPPainter_.FIRST_STROKE_ID;this.strokeOptions=[];this.strokeCoords=[];this.history=[];this.undos=[];this.lastDrawData=this.backgroundData=null;this.gridType=0;this.lastDelimiterIndex=-1;this.isSigned=!1;this.mStrokeId=null;this.mStrokeOrigin=this.getRandomInt(GPPainter_.M_STROKE_RANGE);this.isSubscribed=!1;this.lastClientY=this.lastClientX=0;this.isDrawing=this.isToolCentering=this.isEraser=
this.isGrayscale=this.isVerticalMirror=this.isMirror=!1;this.centering\u0421oords=[];this.isSymmetryGuidesMoved=this.isSymmetryGuidesMoving=this.isSymmetryGuidesAdjustable=this.isSymmetryKeyPressed=this.isSymmetryEnabled=!1;this.symmetryStrokesOptions=[];this.symmetryCoords=[];this.symmetryStrokesGroups={};this.symmetryGuideAngle=this.getSymmetryModeGuidesAngle(this.s.symmetryMode);this.radiansPerSymmetryRadialGuide=2*Math.PI/this.s.symmetryRadialGuidesCount;this.radiansPerSymmetryMandalaGuide=2*
Math.PI/this.s.symmetryMandalaGuidesCount;this.isDisabled=!1;this.isTerminated=!0;this.localization=this.prx.getLocalization("draw");this.isReadyWarningShown=!1;this.lineSmoothingCounter=1;this.background;this.backgroundCtx;this.lastDraw;this.lastDrawCtx;this.canvas;this.canvasCtx;this.stroke;this.strokeCtx;this.pointer;this.pointerCtx;this.colorPicker;this.colorPickerWidth=GPPainter_.COLOR_PICKER_WIDTH;this.colorPickerHeight=GPPainter_.COLOR_PICKER_HEIGHT;this.colorPickerHuePos=GPPainter_.COLOR_PICKER_HUE_POSITION;
GPUtils_.bindMethods([this.inject,this.searchDrawContainer,this.getFillData,this.saveImage,this.clearPointer,this.middleButtonDown,this.rightButtonDown,this.strokeDown,this.strokeUp,this.strokeMove,this.strokeProcess,this.updatePointer,this.updateGlobalCoords,this.resetKeys,this.mouseZoom,this.changeSymmetryRadialGuidesCount,this.changeSymmetryMandalaGuidesCount,this.resizeWindowHandler,this.windowsInkCheck,this.initPointerTool],this);this.toolActivators=new Map;this.addEventListener("color",({detail:{color:c}})=>
{this.color=c});this.addEventListener("color2",({detail:{color:c}})=>{this.color2=c});this.addEventListener("stroke",({detail:{data:c,symmetryStrokesData:d=[]}})=>{this.drawFunction(this.canvasCtx,[c,...d]);this.strokeOptions=[];this.strokeCoords=[];this.symmetryCoords=[];d.length&&(this.symmetryStrokesGroups[c[1]]=c[1],d.map(e=>{this.symmetryStrokesGroups[e[1]]=c[1]}));this.clearStroke();this.history.push(c,...d);this.undos.length&&(this.undos=[]);this.shouldBeSigned()&&this.sign()});this.addEventListener("stroke_started",
({detail:{data:c,symmetryStrokesData:d=[]}})=>{const e=!!d.length,f=c[0];this.prx.getSendQueueSize()&&this.isToolInTime(f)||(this.prx.tool(1,c,e),d.forEach(g=>{this.prx.tool(1,g,e)}))});this.addEventListener("stroke_process",({detail:{data:c,symmetryStrokesData:d=[]}})=>{const e=!!d.length;this.prx.tool(3,c,e);d.forEach(f=>{this.prx.tool(3,f,e)})});this.addEventListener("stroke_ended",({detail:{data:c,symmetryStrokesData:d=[]}})=>{const e=!!d.length,f=e||this.prx.getSendQueueSize()&&this.isToolInTime(c[0])?
1:3;this.prx.tool(f,c,e);d.forEach(g=>{this.prx.tool(f,g,e)})});this.addEventListener("stroke_undo",({detail:{data:c,symmetryStrokesData:d=[]}})=>{this.prx.undo(c[1],!1);d.forEach(e=>{this.prx.undo(e[1],!1)})});this.addEventListener("stroke_redo",({detail:{data:c,symmetryStrokesData:d=[]}})=>{const e=!!d.length;this.prx.redo(c,e);d.forEach(f=>{this.prx.redo(f,e)})});this.prx.addEventListener("localization",({detail:{data:c,type:d}})=>{"draw"===d&&(this.localization=c)});this.prx.addEventListener("turn_started",
()=>{this.terminate();this.resetTurnSettings();this.setTimer()});this.prx.addEventListener("turns_ended",c=>{this.terminate();this.stopTimer()});this.prx.addEventListener("send_queue_updated",({detail:{size:c,timeLeft:d}})=>{this.iface.updateActionQueueSize(c,d)});document.addEventListener("_url_changed",({detail:{path:c}})=>{"/draw"===c&&this.injectHandler()});this.prx.addEventListener("rejoin",({detail:{stage:c}})=>{c===GPProxy_.STAGE.GAME&&setTimeout(()=>{this.container||this.injectHandler()},
1)});document.addEventListener("gp:act.subs_status",({detail:{status:c}})=>{this.isSubscribed=c});Document.prototype.addEventListener=new Proxy(Element.prototype.addEventListener,{apply(c,d,e){if("keydown"!==e[0]||!1!==e[2])return c.apply(d,e)}});const b=this;Element.prototype.addEventListener=new Proxy(Element.prototype.addEventListener,{apply(c,d,e){if(!(d.classList?.contains("drawingContainer")&&["mousedown","pointerdown","contextmenu","touchstart"].includes(e[0])&&b.isPermittedMode()))return c.apply(d,
e)}});this.timer?.addEventListener("finish",c=>{this.timer.settings.readyAfterTimeExpires&&this.prx.isGameTime(GPProxy_.GAME_TIME.HOSTS_DECISION)&&this.prx.isHost()&&this.iface.readyBtn.click()});this.reference?.addEventListener("state_changed",c=>{this.resizeWindowHandler()})}render(a){this.canvasTypeId=a;const [b,c]=GPUtils_.getCanvasDimensionsById(a);this.originalWidth=b;this.originalHeight=c;this.width=this.originalWidth*this.density;this.height=this.originalHeight*this.density;this.symmetryGuideX=
Math.round(this.originalWidth/2);this.symmetryGuideY=Math.round(this.originalHeight/2);this.symmetryGuidesRadius=Math.ceil(Math.sqrt(this.originalWidth*this.originalWidth+this.originalHeight*this.originalHeight))*this.density;this.style.setProperty("--gp-painter-width",`${this.originalWidth}px`);this.style.setProperty("--gp-painter-heigth",`${this.originalHeight}px`);this.container?.remove();this.container=document.createElement("div");this.container.className="gp-painter_";null===this.abt?.getWindowsInkWarningState()&&
this.container.addEventListener("pointerdown",this.windowsInkCheck,{once:!0});this.container.addEventListener("contextmenu",this.preventDefault);this.container.addEventListener("pointerdown",this.middleButtonDown);this.container.addEventListener("pointerdown",this.strokeDown);this.container.addEventListener("pointerdown",this.rightButtonDown);this.container.addEventListener("pointermove",this.updatePointer);this.container.addEventListener("pointerenter",this.updatePointer);this.container.addEventListener("pointerleave",
this.clearPointer);this.container.addEventListener("wheel",this.mouseZoom);this.container.addEventListener("pointerdown",this.stopPropagation);this.container.addEventListener("pointermove",this.stopPropagation);this.container.addEventListener("mousedown",this.suppressEvents);this.container.addEventListener("mousemove",this.suppressEvents);this.container.addEventListener("mouseup",this.suppressEvents);this.container.addEventListener("mousecancel",this.suppressEvents);this.container.addEventListener("touchstart",
this.suppressEvents,!0);this.container.addEventListener("touchend",this.suppressEvents,!0);this.container.addEventListener("touchcancel",this.suppressEvents,!0);this.container.addEventListener("wheel",this.stopPropagation);a=document.createElement("div");a.className="rotator_";this.container.appendChild(a);this.drawingArea=document.createElement("div");this.drawingArea.className="drawing-area_";a.appendChild(this.drawingArea);this.background=document.createElement("canvas");this.background.className=
"background_";this.background.classList.add("hidden");this.background.width=this.width;this.background.height=this.height;this.backgroundCtx=this.background.getContext("2d");this.backgroundCtx.fillStyle=GPPainter_.BACKGROUND_COLOR;this.backgroundCtx.fillRect(0,0,this.width,this.height);this.drawingArea.appendChild(this.background);this.lastDraw=document.createElement("canvas");this.lastDraw.className="last-draw_";this.lastDraw.classList.add("hidden");this.lastDraw.width=this.width;this.lastDraw.height=
this.height;this.lastDrawCtx=this.lastDraw.getContext("2d");this.drawingArea.appendChild(this.lastDraw);this.canvas=document.createElement("canvas");this.canvas.className="canvas_";this.canvas.width=this.width;this.canvas.height=this.height;this.canvasCtx=this.canvas.getContext("2d");this.drawingArea.appendChild(this.canvas);this.stroke=document.createElement("canvas");this.stroke.className="stroke_";this.stroke.width=this.width;this.stroke.height=this.height;this.drawingArea.appendChild(this.stroke);
this.strokeCtx=this.stroke.getContext("2d");this.strokeCtx.lineJoin="round";this.strokeCtx.lineCap="round";this.strokeCtx.strokeStyle=this.s.defaultColor[0];this.strokeCtx.lineWidth=this.s.defaultThickness;this.strokeCtx.globalAlpha=this.s.defaultOpacity;this.grid=document.createElement("canvas");this.grid.className="grid_";this.grid.width=this.width;this.grid.height=this.height;this.gridCtx=this.grid.getContext("2d");this.gridCtx.fillStyle="#dacbef";this.pointer=document.createElement("canvas");
this.pointer.className="pointer_";this.pointer.width=this.width;this.pointer.height=this.height;a.after(this.pointer);this.pointerCtx=this.pointer.getContext("2d");this.pointerCtx.lineWidth=this.density;this.symmetryGuides=document.createElement("canvas");this.symmetryGuides.className="symmetry-guides_ hidden";this.symmetryGuides.width=this.width;this.symmetryGuides.height=this.height;this.symmetryGuidesCtx=this.symmetryGuides.getContext("2d");this.symmetryGuidesCtx.strokeStyle=this.s.symmetryGuidesColor;
this.symmetryGuidesCtx.globalAlpha=this.s.symmetryGuidesOpacity;this.symmetryGuidesCtx.lineWidth=this.s.symmetryGuidesWidth*this.density;this.drawSymmetryGuides();this.drawingArea.appendChild(this.symmetryGuides);this.zoomer=new GPZoomer_({viewport:this.container,rotator:a,content:this.drawingArea},{scale:this.getScale(),minScale:this.s.minZoom,maxScale:this.s.maxZoom,zoomStep:this.s.zoomStep});this.zoomer.addEventListener("scale",({detail:{scale:d}})=>{this.dispatchEvent(new CustomEvent("zoom",{detail:{scale:d}}))});
this.zoomer.addEventListener("rotation",({detail:{rotation:d}})=>{this.dispatchEvent(new CustomEvent("rotation",{detail:{rotation:d}}))});this.zoomIndicator=document.createElement("div");this.zoomIndicator.className="zoom-scale_ hidden";this.pointer.after(this.zoomIndicator);this.zoomer.addEventListener("scale",({detail:{scale:d}})=>{this.zoomIndicator.classList.toggle("hidden",1===d);this.zoomIndicator.textContent="x"+Math.round(10*d)/10});this.initColorPicker({width:this.s.colorPickerWidth,height:this.s.colorPickerHeight,
huePos:this.s.colorPickerHuePosition});this.initPointerTools()}terminate(){!this.isTerminated&&this.container&&(clearTimeout(this.strokeTimer),clearTimeout(this.searchTimer),document.removeEventListener("pointermove",this.updateGlobalCoords,!0),this.shortcutsHandler.stop(),window.removeEventListener("blur",this.resetKeys),window.removeEventListener("focus",this.resetKeys),window.removeEventListener("resize",this.resizeWindowHandler),this.clearPointer(),this.clearStroke(),this.clearCanvas(),this.clearBackground(),
this.background.classList.add("hidden"),this.lastDraw.classList.add("hidden"),this.colorPicker.hide(),this.iface.terminate(),this.reference?.terminate(),this.container.remove(),this.isTerminated=!0)}resetTurnSettings(){if(this.container){this.color=this.s.defaultColor[0];this.color2=this.s.defaultColor[1];this.thickness=Math.max(this.s.minThickness,Math.min(this.s.maxThickness,this.s.defaultThickness));var a=Math.max(this.s.minOpacity,this.s.defaultOpacity);this.opacity=1===a?a:String(a);this.tool=
GPPainter_.DEFAULT_TOOL;this.isSymmetryGuidesMoved=this.isSymmetryGuidesMoving=this.isSymmetryGuidesAdjustable=this.isSymmetryKeyPressed=this.isSymmetryEnabled=!1;this.symmetryStrokesOptions=[];this.symmetryCoords=[];this.symmetryStrokesGroups={};!this.isSubscribed&&!this.prx.isSoloGame()&&1<this.s.symmetryMode&&(this.s.symmetryMode=GPPainter_.DEFAULT_SYMMETRY_MODE,this.drawSymmetryGuides());this.symmetryGuides.classList.add("hidden");this.symmetryGuides.classList.remove("adjustable_");this.symmetryGuides.classList.remove("no-cursor_");
this.isGrayscale=this.isVerticalMirror=this.isMirror=!1;this.clearGrid();this.resetMirror();this.resetZoom();this.iface.hideSettings();this.reference?.reset();this.isSigned=!1;this.mStrokeOrigin=this.getRandomInt(GPPainter_.M_STROKE_RANGE)}}init(){const a=this.prx.getState(),b=this.prx.getCurrentTurnId();this.searchTimer=null;this.strokeOptions=[];this.strokeCoords=[];this.history=a.draw||[];this.backgroundData=this.ac?.isSuspicious(`tbg_${b}`)?[]:a.background;this.lastDrawData=this.ac?.isSuspicious(`t_${b}`)?
[]:a.lastDraw;this.lastDelimiterIndex=this.history.findLastIndex(c=>11===c[0]);this.strokeId=this.calculateStrokeID();this.undos=[];this.clearActiveTools();this.isDisabled=this.isDrawing=this.isToolCentering=this.isEraser=!1;this.dispatchEvent(new Event("enable"));this.isReadyWarningShown=this.isNote=!1;document.addEventListener("pointermove",this.updateGlobalCoords,!0);this.shortcutsHandler.start();window.addEventListener("blur",this.resetKeys);window.addEventListener("focus",this.resetKeys);window.addEventListener("resize",
this.resizeWindowHandler);this.redrawBackground();this.redrawLastDraw();this.redrawCanvas();this.background.classList.toggle("hidden",!this.backgroundData);this.lastDraw.classList.toggle("hidden",!this.lastDrawData);this.zoomer.setContainerScale(this.getScale());this.iface.init();this.reference?.init();this.prx.isReady()&&this.iface.disableInterface();this.isTerminated=!1}injectHandler(){this.enabled=this.isPermittedMode();this.terminate();this.inject()}inject(){if(this.enabled){var a=this.prx.getCanvasTypeId();
this.container&&this.canvasTypeId===a||this.render(a);this.searchDrawContainer().then(b=>{b.appendChild(this.container);this.init()})}}searchDrawContainer(){return new Promise(a=>{this.searchTimer=setTimeout(()=>{const b=document.querySelector(".drawingContainer");b?(clearTimeout(this.searchTimer),a(b)):this.searchDrawContainer()},GPPainter_.SEARCH_DRAW_CONTAINER_INTERVAL)})}isPermittedMode(){const {configs:a}=this.prx.getState();for(let b in GPPainter_.DISABLED_MODE_OPTIONS)if(GPPainter_.DISABLED_MODE_OPTIONS[b].some(c=>
c===a[b]))return!1;return!0}initColorPicker({width:a,height:b,huePos:c}={}){this.colorPickerWidth=a??this.colorPickerWidth;this.colorPickerHeight=b??this.colorPickerHeight;this.colorPickerHuePos=c??this.colorPickerHuePos;this.colorPicker?.getElement()&&this.colorPicker.getElement().remove();this.colorPicker=new GPColorPicker_(this.colorPickerWidth,this.colorPickerHeight,this.colorPickerHuePos);this.colorPicker.setColor(this.color);this.colorPicker.hide();this.colorPicker.addEventListener("color",
({detail:{color:d}})=>{this.dispatchEvent(new CustomEvent("color",{detail:{color:d}}))});this.colorPicker.addEventListener("color2",({detail:{color:d}})=>{this.dispatchEvent(new CustomEvent("color2",{detail:{color:d}}))});document.body.appendChild(this.colorPicker.getElement())}calculateStrokeID(){const a=[...this.history,...this.undos].reduceRight((b,c)=>c[1]>b?c[1]:b,GPPainter_.FIRST_STROKE_ID-1);return Math.max(a+1,GPPainter_.FIRST_STROKE_ID)}middleButtonDown(a){1!==a.button||this.hasActiveTools()||
(this.runPointerTool("hand",a,0),a.stopPropagation(),a.stopImmediatePropagation())}rightButtonDown(a){2===a.button&&document.addEventListener("contextmenu",this.preventDefault,{once:!0})}strokeDown(a){this.prx.isConnected()||this.abt?.showDisconnectionNotice();this.isDrawing&&this.strokeUp(a);if(!this.hasActiveTools()){var b=2===a.button?this.color2:this.color,c=this.getCanvasCoords(a);this.strokeOptions=this.getStrokeOptions(this.tool,b);this.strokeCoords=[c];this.isCenteringActivated=this.shouldCenteringBeActivated(this.tool);
this.centering\u0421oords=[c.slice()];this.isSymmetryEnabled&&this.convertToSymmetryCoords(c).forEach((d,e)=>{const f=this.strokeOptions.slice();f[1]=this.strokeId++;this.symmetryStrokesOptions[e]=f;this.symmetryCoords[e]=[d];this.centering\u0421oords[e+1]=d.slice()});this.lineSmoothingCounter=1;this.tool===GPPainter_.TOOL.FILL?(this.updateStrokeCoords(this.strokeCoords,this.getUnscaledCanvasCoords(a),void 0,b),a=this.buildStrokeData(this.strokeOptions,this.strokeCoords),this.dispatchEvent(new CustomEvent("stroke_started",
{detail:{data:a}})),this.dispatchEvent(new CustomEvent("stroke",{detail:{data:a}}))):(a.currentTarget.setPointerCapture(a.pointerId),a.currentTarget.addEventListener("pointermove",this.strokeMove),a.currentTarget.addEventListener("pointerup",this.strokeUp,{once:!0}),a=[...this.strokeOptions,...this.strokeCoords],b=this.buildSymmetryStrokesData(!0),this.drawFunction(this.strokeCtx,[a,...b],this.density,!1),clearTimeout(this.strokeTimer),!this.isSymmetryEnabled&&this.isToolInTime(this.tool)&&(this.strokeTimer=
setTimeout(this.strokeProcess,1E3),this.dispatchEvent(new CustomEvent("stroke_started",{detail:{data:a,symmetryStrokesData:b}}))),this.isDrawing=!0)}}buildSymmetryStrokesData(a=!1){const b=[];this.isSymmetryEnabled&&this.symmetryCoords.forEach((c,d)=>{b.push(this.buildStrokeData(this.symmetryStrokesOptions[d],c,a))});return b}rotatePoint(a,b,c,d,e){var f=Math.PI/180*e;e=Math.cos(f);f=Math.sin(f);return[e*(c-a)+f*(d-b)+a,e*(d-b)-f*(c-a)+b]}convertToSymmetryCoords([a,b],c=this.s.symmetryMode){const d=
this.isMirror?this.originalWidth-this.symmetryGuideX:this.symmetryGuideX,e=this.isVerticalMirror?this.originalHeight-this.symmetryGuideY:this.symmetryGuideY,f=[];switch(c){case GPPainter_.SYMMETRY_MODES.VERTICAL:const [l,m]=this.calcSymmetryPoint(a,b,d,e,this.symmetryGuideAngle);f.push([l,m]);break;case GPPainter_.SYMMETRY_MODES.HORIZONTAL:const [p,r]=this.calcSymmetryPoint(a,b,d,e,this.symmetryGuideAngle);f.push([p,r]);break;case GPPainter_.SYMMETRY_MODES.QUADRANT:c=this.symmetryGuideAngle;var g=
a-d,h=b-e,k=g*Math.cos(-c)-h*Math.sin(-c);h=-(g*Math.sin(-c)+h*Math.cos(-c));g=k*Math.cos(c)-h*Math.sin(c)+d;c=k*Math.sin(c)+h*Math.cos(c)+e;f.push([g,c],[2*d-a,2*e-b],[2*d-g,2*e-c]);break;case GPPainter_.SYMMETRY_MODES.RADIAL:c=this.s.symmetryRadialGuidesCount;a-=d;k=b-e;b=Math.sqrt(a*a+k*k);a=Math.atan2(k,a);k=2*Math.PI/c;for(g=1;g<c;g++)h=a+g*k,f.push([Math.round(d+b*Math.cos(h)),Math.round(e+b*Math.sin(h))]);break;case GPPainter_.SYMMETRY_MODES.MANDALA:c=this.s.symmetryMandalaGuidesCount;a-=d;
k=b-e;b=Math.sqrt(a*a+k*k);a=Math.atan2(k,a);k=2*Math.PI/c;g=a-this.symmetryGuideAngle;for(h=0;h<c;h++){const q=a+h*k,n=q-2*g;f.push([Math.round(d+b*Math.cos(q)),Math.round(e+b*Math.sin(q))],[Math.round(d+b*Math.cos(n)),Math.round(e+b*Math.sin(n))])}f.splice(0,1)}return f}strokeMove(a){a=this.getCanvasCoords(a);this.updateStrokeCoords(this.strokeCoords,a);this.isSymmetryEnabled&&(a=this.convertToSymmetryCoords(a),this.updateSymmetryStrokeCoords(a));a=this.buildSymmetryStrokesData(!0);this.clearStroke();
this.drawFunction(this.strokeCtx,[[...this.strokeOptions,...this.strokeCoords],...a],this.density,!1);this.lineSmoothingCounter++}strokeUp(a){clearTimeout(this.strokeTimer);this.s.lineSmoothingLevel&&this.lineSmoothingCounter%(this.s.lineSmoothingLevel+1)&&this.strokeCoords.push(this.getCanvasCoords(a));const b=this.buildStrokeData(this.strokeOptions,this.strokeCoords),c=this.buildSymmetryStrokesData(),d=this.isToolInTime(this.tool)?"stroke_ended":"stroke_started";this.dispatchEvent(new CustomEvent(d,
{detail:{data:b,symmetryStrokesData:c}}));this.dispatchEvent(new CustomEvent("stroke",{detail:{data:b,symmetryStrokesData:c}}));this.isDrawing=!1;a.currentTarget.removeEventListener("pointermove",this.strokeMove);this.strokeMove.cancel?.()}strokeProcess(){let a;this.isSymmetryEnabled&&(a=[],this.symmetryCoords.forEach((b,c)=>{a.push(this.buildStrokeData(this.symmetryStrokesOptions[c],b))}));this.dispatchEvent(new CustomEvent("stroke_process",{detail:{data:[...this.strokeOptions,...this.strokeCoords],
symmetryStrokesData:a}}));!this.isSymmetryEnabled&&this.isToolInTime(this.tool)&&(clearTimeout(this.strokeTimer),this.strokeTimer=setTimeout(this.strokeProcess,1E3))}updateSymmetryStrokeCoords(a){a.forEach((b,c)=>{this.updateStrokeCoords(this.symmetryCoords[c],b,c+1)})}updateStrokeCoords(a,b,c=0,d=this.color){switch(this.tool){case GPPainter_.TOOL.BRUSH:case GPPainter_.TOOL.ERASER:case GPPainter_.TOOL.NOTE:this.s.lineSmoothingLevel&&(this.tool!==GPPainter_.TOOL.ERASER||this.s.eraserLineSmoothing)&&
this.lineSmoothingCounter%(this.s.lineSmoothingLevel+1)||a.push(b);break;case GPPainter_.TOOL.LINE:case GPPainter_.TOOL.RECTANGLE:case GPPainter_.TOOL.CIRCLE:case GPPainter_.TOOL.RECTANGLE_FILLED:case GPPainter_.TOOL.CIRCLE_FILLED:d=[a[0],b];a.splice(0,a.length);a.push(...d);if(this.isCenteringActivated){const [e,f]=this.centering\u0421oords[c];a[0][0]=e-(b[0]-e);a[0][1]=f-(b[1]-f)}break;case GPPainter_.TOOL.FILL:a.splice(0,a.length),a.push(...this.getFillData(b[0],b[1],d))}}getStrokeOptions(a=this.tool,
b=this.color,c=this.thickness){switch(a){case GPPainter_.TOOL.BRUSH:case GPPainter_.TOOL.LINE:case GPPainter_.TOOL.RECTANGLE:case GPPainter_.TOOL.CIRCLE:case GPPainter_.TOOL.RECTANGLE_FILLED:case GPPainter_.TOOL.CIRCLE_FILLED:return[a,this.strokeId++,[b,c,this.opacity]];case GPPainter_.TOOL.ERASER:return[a,this.strokeId++,!this.s.doubleEraserThickness||this.isEraser&&this.s.disableDoubleEraserThicknessOnShortcut?c:2*c];case GPPainter_.TOOL.FILL:return[a,this.strokeId++,[b,this.opacity]];case GPPainter_.TOOL.NOTE:return[a,
this.strokeId++,null]}}buildStrokeData(a,b,c=!1){return[...a,...(c||!this.isMirror&&!this.isVerticalMirror||a[0]===GPPainter_.TOOL.FILL?b:this.mirrorStrokeCoords(b,this.isMirror,this.isVerticalMirror))]}lockPointer(){this.pointerLock=!0}unlockPointer(){this.pointerLock=!1}updatePointer(a){this.pointerLock||this.renderPointer(...this.getPointerCoords(a))}getPointerCoords(a){const b=this.getScale(),c=this.pointer.getBoundingClientRect();let d;a?(d=a.clientX,a=a.clientY):(d=this.lastClientX,a=this.lastClientY);
return[(d-c.left)*this.density/b,(a-c.top)*this.density/b]}renderPointer(a,b,c,d=this.thickness,e,f){this.clearPointer();d="zoom"===this.activator?1:!e&&GPPainter_.TOOLS_THICKNESSES[this.tool]||d;this.tool!==GPPainter_.TOOL.ERASER||!this.s.doubleEraserThickness||this.isEraser&&this.s.disableDoubleEraserThicknessOnShortcut||(d*=2);d*=this.zoomer.getScale();c="thickness"===this.activeTool||"opacity"!==this.activator&&"brightness"!==this.activator?c:this.opacity;e=this.pointerCtx;var g=Math.min(Math.max(this.zoomer.getScale(),
1),2);e.lineWidth=g;e.beginPath();e.arc(a,b,d/2*this.density,0,2*Math.PI);c&&(e.fillStyle=`rgba(${GPColorUtils_.hexToRgb(this.color).join(",")},${c}`,e.fill());e.strokeStyle=GPPainter_.POINTER_COLOR;e.stroke();e.beginPath();e.arc(a,b,(d/2+g/2)*this.density,0,2*Math.PI);e.strokeStyle=GPPainter_.POINTER_OUTLINE_COLOR;e.globalAlpha=this.s.pointerOutlineOpacity;e.stroke();e.globalAlpha=this.s.pointerOpacity;d<GPPainter_.POINTER_CROSSHAIR_MIN_THICKNESS&&(d=3*d*this.density,g=GPPainter_.POINTER_CROSSHAIR_LINE_LENGTH*
this.density,e.strokeStyle=GPPainter_.POINTER_OUTLINE_COLOR,e.globalAlpha=this.s.pointerOutlineOpacity,e.beginPath(),e.moveTo(a,b-d),e.lineTo(a,b-d-g),e.moveTo(a+d,b),e.lineTo(a+d+g,b),e.moveTo(a,b+d),e.lineTo(a,b+d+g),e.moveTo(a-d,b),e.lineTo(a-d-g,b),e.stroke(),e.globalAlpha=this.s.pointerOpacity);if(f){const [h,k]=f;e.beginPath();e.arc(h,k,GPPainter_.POINTER_DOT_THICKNESS/2*this.density,0,2*Math.PI);c&&(e.fillStyle=`rgba(${GPColorUtils_.hexToRgb(this.color).join(",")},${c}`,e.fill());e.strokeStyle=
GPPainter_.POINTER_COLOR;e.stroke();e.beginPath();e.arc(h,k,(GPPainter_.POINTER_DOT_THICKNESS/2+1)*this.density,0,2*Math.PI);e.strokeStyle=GPPainter_.POINTER_OUTLINE_COLOR;e.globalAlpha=this.s.pointerOutlineOpacity;e.stroke();e.globalAlpha=this.s.pointerOpacity}}setTool(a){this.tool=a;a=a===GPPainter_.TOOL.NOTE;const b=a!==this.isNote;this.isNote=a;b&&(this.redrawBackground(),this.redrawLastDraw(),this.redrawCanvas())}getColor(){return this.color}getColor2(){return this.color2}setColor(a){this.colorPicker.setColor(a);
this.dispatchEvent(new CustomEvent("color",{detail:{color:a}}))}setColor2(a){this.dispatchEvent(new CustomEvent("color2",{detail:{color:a}}))}setOpacity(a){this.opacity=String(a);this.iface.updateOpacity(a)}setThickness(a){this.thickness=a}toggleLastDraw(a){this.lastDraw.classList.toggle("hidden",!a)}clearBackground(){this.backgroundCtx.fillStyle=GPPainter_.BACKGROUND_COLOR;this.backgroundCtx.fillRect(0,0,this.background.width,this.background.height)}clearLastDraw(){this.lastDrawCtx.clearRect(0,0,
this.lastDraw.width,this.lastDraw.height)}clearCanvas(){this.canvasCtx.clearRect(0,0,this.canvas.width,this.canvas.height)}clearStroke(){this.strokeCtx.clearRect(0,0,this.stroke.width,this.stroke.height)}clearPointer(){this.pointerCtx.clearRect(0,0,this.pointer.width,this.pointer.height)}clearGrid(){this.grid.remove();this.gridType=0}redrawBackground(){this.clearBackground();this.backgroundData?.length&&this.drawFunction(this.backgroundCtx,this.backgroundData,this.density,!1,this.isNote)}redrawLastDraw(){this.clearLastDraw();
this.lastDrawData?.length&&this.drawFunction(this.lastDrawCtx,this.lastDrawData,this.density,!0,this.isNote)}redrawCanvas(){this.clearCanvas();this.history.length&&this.drawFunction(this.canvasCtx,this.history,this.density,!0,this.isNote)}redrawGrid(){this.toggleGrid()}getCanvasCoords(a){return this.zoomer.getCoords(a)}getUnscaledCanvasCoords(a){const [b,c]=this.getCanvasCoords(a);return[b*this.density,c*this.density]}updateGlobalCoords(a){this.lastClientX=a.clientX;this.lastClientY=a.clientY}resetKeys(){this.container&&
(this.container.classList.remove("dropper_","hand_","rotate_","s-rotate_","s-adjustable_","no-pointer_"),this.clearActiveTools(),this.isToolCentering=this.isEraser=!1)}initPointerTools(){for(let a in this.tools)this.tools[a].activator&&(this.tools[a].handler=this.initPointerTool(a,this.tools[a].activator))}initPointerTool(a,b){for(const m in b){const p=b[m];"object"!==typeof p?b[m]=p.bind(this):GPUtils_.bindDeep(p,this)}var c=!1,d=!1,e=null;const f=m=>{this.activator&&this.pointerTools.get(this.activator).keyUp();
this.activeTool||this.isDrawing||b.keyDown?.();document.addEventListener("keyup",g);this.container.addEventListener("pointerdown",k);c=!0;e=m.code;this.activator=a},g=m=>{m.code===e&&(this.activator===a&&(this.activator=null),d||(b.end?.(),this.updatePointer(),document.removeEventListener("keyup",g)),b.keyUp?.(),this.container.removeEventListener("pointerdown",k),c=!1)};let h=m=>{};const k=(m,p=!1)=>{if(!this.isDrawing&&this.activator===a&&m.buttons&7){if(!p){if(1===m.button&&b.middleButton){b.middleButton(m);
return}if(2===m.button&&b.rightButton){b.rightButton(m);return}}var r=p?0:m.button;b.pointer?.[r]?.hide&&this.container.classList.add("no-pointer_");b.pointer?.[r]?.pointerDown?.(m);b.pointer?.[r]?.pointerMove&&(h=b.pointer[r].pointerMove(m));this.container.setPointerCapture(m.pointerId);this.container.addEventListener("pointermove",h);this.container.addEventListener("pointerup",q=>{l(q,p)},{once:!0});h(m);this.lockPointer();this.activeTool=a;d=!0}},l=(m,p=!1)=>{this.container.removeEventListener("pointermove",
h);h.cancel?.();p=p?0:m.button;b.pointer?.[p]?.hide&&this.container.classList.remove("no-pointer_");b.pointer?.[p]?.pointerUp?.(m);this.updatePointer(m);this.unlockPointer();d=!1;c||b.end?.();this.activeTool=null};this.toolActivators.set(a,m=>{f.bind(this)(m);k(m,!0);g(m)});this.tools[a].stop=m=>{!this.activeTool!==a&&(l(m),g(m))};this.pointerTools||(this.pointerTools=new Map);this.pointerTools.set(a,{keyUp:()=>{const m=new Event("keyup");m.code=e;g(m)},keyDown:()=>{const m=new Event("keydown");m.code=
e;g(m)},pointerUp:()=>{const m=new Event("pointerup");m.clientX=this.lastClientX;m.clientY=this.lastClientY;l(m)}});return f}runPointerTool(a,b,c){this.toolActivators.get(a)?.(b,c)}hasActiveTools(){return!!this.activator}clearActiveTools(){this.activator&&(this.pointerTools.get(this.activator).keyUp(),this.activator=null);this.activeTool&&(this.pointerTools.get(this.activator).pointerUp(),this.activeTool=null)}dropperKeyDown(a){this.container.classList.add("dropper_")}dropperPointerMove(a){return b=>
{let [c,d]=this.getUnscaledCanvasCoords(b);c=this.isMirror?this.width-c:c;d=this.isVerticalMirror?this.height-d:d;const e=this.getPixelColor(c,d);b.buttons&2?this.setColor2(e):this.setColor(e)}}dropperEnd(a){this.container.classList.remove("dropper_")}getPixelColor(a,b){var c=document.createElement("canvas");c.width=1;c.height=1;c=c.getContext("2d");c.fillStyle=GPPainter_.BACKGROUND_COLOR;c.fillRect(0,0,1,1);this.backgroundData?.length&&c.drawImage(this.background,a,b,1,1,0,0,1,1);this.lastDrawData?.length&&
c.drawImage(this.lastDraw,a,b,1,1,0,0,1,1);c.drawImage(this.canvas,a,b,1,1,0,0,1,1);const [d,e,f,g]=c.getImageData(0,0,1,1).data;return g?`${GPColorUtils_.rgbToHex(d,e,f)}`:GPPainter_.BACKGROUND_COLOR}thicknessKeyDown(a){this.renderPointer(...this.getPointerCoords(),void 0,void 0,!0)}thicknessPointerMove(a){const [b,c]=this.getPointerCoords(a),d=this.s.upThicknessDirection===GPPainter_.DIRECTION.DOWN_RIGHT?1:-1;let e=a.clientX,f=a.clientY;return g=>{const h=Math.round(Math.max(Math.min(this.thickness+
(this.s.thicknessAxis===GPPainter_.AXIS.HORIZONTAL?g.clientX-e:g.clientY-f)*d,this.s.maxThickness),this.s.minThickness));e=g.clientX;f=g.clientY;h&&(this.thickness=h,this.iface.updateThickness(h),this.renderPointer(b,c,void 0,void 0,!0))}}thicknessPointerUp(a){this.dispatchEvent(new CustomEvent("thickness",{detail:{thickness:this.thickness}}))}thicknessRightButton(a){this.thicknessMiddleButton(a)}thicknessMiddleButton(a){this.thickness=this.s.defaultThickness;this.iface.updateThickness(this.thickness);
this.renderPointer(...this.getPointerCoords(),void 0,void 0,!0)}opacityKeyDown(a){this.renderPointer(...this.getPointerCoords(),this.opacity,void 0,!0)}opacityMove(a){const [b,c]=this.getPointerCoords(a),d=this.s.opacityAxis===GPPainter_.AXIS.HORIZONTAL,e=`client${d?"X":"Y"}`,f=this.s.upOpacityDirection===GPPainter_.DIRECTION.UP_LEFT?-1:1,g=this.s.opacitySensitivity*(d?GPPainter_.POINTER_RESOLUTION_RATIO_X:GPPainter_.POINTER_RESOLUTION_RATIO_Y),h=100*this.opacity/g;let k=a[e]*f;return l=>{l=l[e]*
f;const m=(l+h-k)*g;0>m?k=l+h:100<m&&(k=l+h-100/g);this.setOpacity(Math.max(this.s.minOpacity,Math.min(1,Math.round(m)/100)));this.renderPointer(b,c,this.opacity,void 0,!0)}}opacityRightButton(a){this.opacityMiddleButton(a)}opacityMiddleButton(a){this.setOpacity(this.s.defaultOpacity);this.renderPointer(...this.getPointerCoords(),this.opacity,void 0,!0)}brightnessKeyDown(a){this.renderPointer(...this.getPointerCoords(),this.opacity,void 0,!0)}brightnessMove(a){const [b,c]=this.getPointerCoords(a),
[d,e,f]=GPColorUtils_.hexToHsv(this.color),g=this.s.brightnessAxis===GPPainter_.AXIS.HORIZONTAL,h=`client${g?"X":"Y"}`,k=this.s.upBrightnessDirection===GPPainter_.DIRECTION.UP_LEFT?-1:1,l=this.s.brightnessSensitivity*(g?GPPainter_.POINTER_RESOLUTION_RATIO_X:GPPainter_.POINTER_RESOLUTION_RATIO_Y),m=100*f/l;let p=a[h]*k;return r=>{r=r[h]*k;const q=(r+m-p)*l;0>q?p=r+m:100<q&&(p=r+m-100/l);this.setBrightness(d,e,Math.max(.01,Math.min(1,Math.round(q)/100)));this.renderPointer(b,c,this.opacity,void 0,!0)}}brightnessRightButton(a){this.brightnessMiddleButton(a)}brightnessMiddleButton(a){const [b,
c]=GPColorUtils_.hexToHsv(this.color);this.setBrightness(b,c,1);this.renderPointer(...this.getPointerCoords(),this.opacity,void 0,!0)}handKeyDown(a){this.container.classList.add("hand_")}handPointerMove(a){let b=a.clientX,c=a.clientY;return d=>{const e=d.clientX-b,f=d.clientY-c;b=d.clientX;c=d.clientY;this.zoomer.pan(e,f)}}handRightButton(a){this.runPointerTool("rotate",a)}handMiddleButton(a){this.resetZoom(!0)}handEnd(a){this.container.classList.remove("hand_")}rotateKeyDown(a){this.container.classList.add("rotate_")}rotatePointerMove(a){const b=
this.container.getBoundingClientRect(),c=b.left+b.width/2,d=b.top+b.height/2;let e=180*Math.atan2(a.clientY-d,a.clientX-c)/Math.PI;return f=>{f=180*Math.atan2(f.clientY-d,f.clientX-c)/Math.PI;this.zoomer.rotate(f-e,!1);e=f}}rotateRightButton(a){this.rotateMiddleButton(a)}rotateMiddleButton(a){this.resetZoomRotation(!0)}rotateEnd(a){this.container.classList.remove("rotate_")}zoomKeyDown(a){this.renderPointer(...this.getPointerCoords(a))}zoomPointerUp(a){1>=this.zoomer.getScale()&&this.resetZoom(!0)}zoomMove(a){const [b,
c]=this.getPointerCoords(a),d=this.s.zoomInDirection===GPPainter_.DIRECTION.UP_LEFT?1:-1,e=a.clientX,f=a.clientY;let g=a.clientX,h=a.clientY;return k=>{const l=(this.s.zoomAxis===GPPainter_.AXIS.HORIZONTAL?k.clientX-g:k.clientY-h)*d;2<Math.abs(l)&&(this.zoomer.zoom(-Math.sign(l)*this.s.zoomSensitivity,e,f,!1),g=k.clientX,h=k.clientY,this.renderPointer(b,c))}}zoomRightButton(a){this.resetZoom(!0)}zoomMiddleButton(a){this.resetZoom(!0)}mouseZoom(a){this.zoomer.zoom(Math.sign(-a.deltaY)*this.s.zoomStep,
a.clientX,a.clientY,!0);1>=this.zoomer.getScale()&&this.resetZoom(!0);this.updatePointer(a);a.preventDefault()}resetZoom(a){this.zoomer.reset(a);this.zoomIndicator.classList.add("hidden");this.updatePointer()}resetZoomScale(a){this.zoomer.resetScale(a);this.updatePointer()}resetZoomRotation(a){this.zoomer.resetRotation(a)}resizeWindowHandler(a){this.zoomer.setContainerScale(this.getScale());this.iface.roundPixelOffset()}getScale(){return this.s.fixedScreenSize||this.reference?.isEnabled()?1:this.getContainerScale()}getContainerScale(){let a=
(window.innerWidth-180)/1150;766*a>window.innerHeight&&(a=window.innerHeight/766);return a}suppressEvents(a){a.preventDefault();a.stopPropagation();a.stopImmediatePropagation()}stopPropagation(a){a.stopPropagation()}preventDefault(a){a.preventDefault()}mirrorStrokeCoords(a,b,c){if(a.length)return Array.isArray(a[0])?a.map(([d,e])=>[b?this.width/this.density-d:d,c?this.height/this.density-e:e]):a.map(d=>d%2?c?this.height/this.density-d:d:b?this.width/this.density-d:d)}resetMirror(){this.container.classList.remove("mirror_",
"vertical-mirror_")}isToolInTime(a){return GPPainter_.TOOLS_IN_TIME.includes(a)}getShortcutsManager(){return this.shortcutsManager}getMirrorState(){return this.isMirror}getVerticalMirrorState(){return this.isVerticalMirror}getGrayscaleState(){return this.isGrayscale}getZoomScale(){return this.zoomer.getScale()}getRotation(){return this.zoomer.getRotation()}saveImage(){const a=document.createElement("canvas");a.width=this.originalWidth;a.height=this.originalHeight;var b=a.getContext("2d");b.drawImage(this.background,
0,0,a.width,a.height);b.drawImage(this.canvas,0,0,a.width,a.height);var c=this.prx.getState();b=c.user.nick;c="string"===typeof c.previous?.data?c.previous.data:"\u043f\u0440\u043e\u0438\u0437\u0432\u043e\u043b\u044c\u043d\u0430\u044f \u0442\u0435\u043c\u0430";const d=(new Date).toLocaleDateString("ru-RU");b=`${b} - ${c} (${d}).png`;c=document.createElement("a");c.href=a.toDataURL();c.download=b;c.click()}clear(){if(!this.isDrawing){var a=this.getStrokeOptions(GPPainter_.TOOL.ERASER,void 0,Math.trunc(Math.hypot(this.originalWidth,
this.originalHeight)));a=this.buildStrokeData(a,[[this.originalWidth/2,this.originalHeight/2]]);this.dispatchEvent(new CustomEvent("stroke_started",{detail:{data:a}}));this.dispatchEvent(new CustomEvent("stroke_ended",{detail:{data:a}}));this.dispatchEvent(new CustomEvent("stroke",{detail:{data:a}}))}}getTools(){return this.tools}brushTool(){this.setTool(GPPainter_.TOOL.BRUSH);this.iface.updateToolbar(this.tool);this.updatePointer()}eraserTool(){this.setTool(GPPainter_.TOOL.ERASER);this.iface.updateToolbar(this.tool);
this.updatePointer()}rectangleTool(){this.setTool(GPPainter_.TOOL.RECTANGLE);this.iface.updateToolbar(this.tool);this.updatePointer()}rectangleFilledTool(){this.prx.isAnimateMode()||(this.setTool(GPPainter_.TOOL.RECTANGLE_FILLED),this.iface.updateToolbar(this.tool),this.updatePointer())}circleTool(){this.setTool(GPPainter_.TOOL.CIRCLE);this.iface.updateToolbar(this.tool);this.updatePointer()}circleFilledTool(){this.prx.isAnimateMode()||(this.setTool(GPPainter_.TOOL.CIRCLE_FILLED),this.iface.updateToolbar(this.tool),
this.updatePointer())}fillTool(){this.prx.isAnimateMode()||(this.setTool(GPPainter_.TOOL.FILL),this.iface.updateToolbar(this.tool),this.updatePointer())}noteTool(){this.prx.isAnimateMode()&&(this.setTool(GPPainter_.TOOL.NOTE),this.iface.updateToolbar(this.tool),this.updatePointer())}undo(){if(!this.isDrawing){var a=!0,b=[];do{if(!this.history.length||11===this.history.at(-1)[0])return;var c=this.history.pop();this.undos.push(c);if(a){var d=c;a=!1}else b.push(c)}while(void 0!==this.symmetryStrokesGroups[c[1]]&&
this.symmetryStrokesGroups[c[1]]===this.symmetryStrokesGroups[this.history.at(-1)?.[1]]);!this.history.length&&this.isSigned&&this.unsign();this.clearCanvas();this.drawFunction(this.canvasCtx,this.history,this.density,!0,this.isNote);this.dispatchEvent(new CustomEvent("stroke_undo",{detail:{data:d,symmetryStrokesData:b}}))}}redo(){if(!this.isDrawing){var a=!0,b=[];do{if(!this.undos.length)return;var c=this.undos.pop();this.history.push(c);this.drawFunction(this.canvasCtx,[c],this.density,!0,this.isNote);
if(a){var d=c;a=!1}else b.push(c)}while(void 0!==this.symmetryStrokesGroups[c[1]]&&this.symmetryStrokesGroups[c[1]]===this.symmetryStrokesGroups[this.undos.at(-1)?.[1]]);this.shouldBeSigned()&&this.sign();this.dispatchEvent(new CustomEvent("stroke_redo",{detail:{data:d,symmetryStrokesData:b}}))}}switchColors(){const [a,b]=[this.color2,this.color];this.colorPicker.setColor(a);this.dispatchEvent(new CustomEvent("color",{detail:{color:a}}));this.dispatchEvent(new CustomEvent("color2",{detail:{color:b}}))}mirror(){this.isMirror=
!this.isMirror;this.container.classList.toggle("mirror_",this.isMirror);this.dispatchEvent(new CustomEvent("mirror",{detail:{state:this.isMirror}}))}verticalMirror(){this.isVerticalMirror=!this.isVerticalMirror;this.container.classList.toggle("vertical-mirror_",this.isVerticalMirror);this.dispatchEvent(new CustomEvent("vertical_mirror",{detail:{state:this.isVerticalMirror}}))}grayscale(){this.isGrayscale=!this.isGrayscale;this.container.classList.toggle("grayscale_",this.isGrayscale);this.dispatchEvent(new CustomEvent("grayscale",
{detail:{state:this.isGrayscale}}))}eraser(a){if(!this.isEraser){this.isEraser=!0;var b=this.tool;this.setTool(GPPainter_.TOOL.ERASER);this.iface.updateToolbar(this.tool);var c=d=>{d.code===a.code&&(this.isEraser=!1,this.setTool(b),this.iface.updateToolbar(this.tool),document.removeEventListener("keyup",c))};document.addEventListener("keyup",c)}}toolCentering(a){if(!this.isToolCentering){this.isToolCentering=!0;var b=c=>{c.code===a.code&&(this.isToolCentering=!1,document.removeEventListener("keyup",
b))};document.addEventListener("keyup",b)}}shouldCenteringBeActivated(a){return a===GPPainter_.TOOL.LINE||a===GPPainter_.TOOL.RECTANGLE||a===GPPainter_.TOOL.RECTANGLE_FILLED?this.isToolCentering:a===GPPainter_.TOOL.CIRCLE||a===GPPainter_.TOOL.CIRCLE_FILLED?this.s.centeringCircleTool?!this.isToolCentering:this.isToolCentering:!1}symmetryKeyDown(a){this.isSymmetryKeyPressed=!0;this.enableSymmetryAdjustment();this.isSymmetryEnabled?document.addEventListener("keyup",b=>{this.isSymmetryGuidesMoved||this.disableSymmetry()},
{once:!0}):this.enableSymmetry()}symmetryKeyUp(a){this.isSymmetryGuidesMoving||(this.disableSymmetryEditing(),this.isSymmetryGuidesMoved=!1);this.isSymmetryKeyPressed=!1}symmetryPointerDown(a){this.isSymmetryGuidesAdjustable&&(this.isSymmetryGuidesMoved=this.isSymmetryGuidesMoving=!0,2===a.button&&this.container.classList.add("s-rotate_"),this.symmetryGuides.classList.add("no-cursor_"))}symmetryPointerMove(a){const b=a.button,c=this.getScale(),d=this.symmetryGuideAngle;let e;if(2===b){const [f,g]=
this.getMirroredCoords(a);e=this.getPointAngle(this.symmetryGuideX,this.symmetryGuideY,f,g)}return f=>{const [g,h]=this.getMirroredCoords(f,c);0===b?this.updateSymmetryGuides(Math.max(0,Math.min(this.originalWidth,g)),Math.max(0,Math.min(this.originalHeight,h)),this.symmetryGuideAngle):2===b&&(f=this.getPointAngle(this.symmetryGuideX,this.symmetryGuideY,g,h),this.updateSymmetryGuides(this.symmetryGuideX,this.symmetryGuideY,this.s.symmetryGuidesRotationMode===GPPainter_.SYMMETRY_GUIDES_ROTATION_MODE.DRAGGING?
d+(f-e):f))}}symmetryPointerUp(a){this.isSymmetryGuidesMoving=!1;this.isSymmetryKeyPressed||(this.disableSymmetryEditing(),this.isSymmetryGuidesMoved=!1);2===a.button&&this.container.classList.remove("s-rotate_");this.symmetryGuides.classList.remove("no-cursor_")}symmetryMiddleButton(a){this.resetSymmetryGuides()}enableSymmetry(){this.isSymmetryEnabled=!0;this.iface.updateSymmetryPanel(!0);this.symmetryGuides.classList.remove("hidden")}disableSymmetry(){this.isSymmetryEnabled=!1;this.iface.updateSymmetryPanel(!1);
this.symmetryGuides.classList.add("hidden")}enableSymmetryAdjustment(){this.isSymmetryGuidesAdjustable=!0;this.symmetryGuides.classList.add("adjustable_");this.container.classList.add("s-adjustable_");this.drawSymmetryGuides();this.clearPointer()}disableSymmetryEditing(){this.isSymmetryGuidesAdjustable=!1;this.symmetryGuides.classList.remove("adjustable_");this.container.classList.remove("s-adjustable_");this.drawSymmetryGuides();this.updatePointer()}getMirroredCoords(a){let [b,c]=this.getCanvasCoords(a);
this.isMirror&&(b=this.originalWidth-b);this.isVerticalMirror&&(c=this.originalHeight-c);return[b,c]}calcSymmetryPoint(a,b,c,d,e){e=Math.tan(e);c=d-e*c;d=1+e*e;return[(a+e*(b-c))/d*2-a,(e*a+e*e*b+c)/d*2-b]}updateSymmetryGuides(a,b,c){this.symmetryGuideX=a;this.symmetryGuideY=b;this.symmetryGuideAngle=c;this.drawSymmetryGuides(a,b,c)}resetSymmetryGuides(){this.updateSymmetryGuides(Math.round(this.originalWidth/2),Math.round(this.originalHeight/2),this.getSymmetryModeGuidesAngle(this.s.symmetryMode));
this.isSymmetryGuidesMoved=!0}getSymmetryModeGuidesAngle(a){switch(a){case GPPainter_.SYMMETRY_MODES.VERTICAL:return Math.PI/2;case GPPainter_.SYMMETRY_MODES.RADIAL:case GPPainter_.SYMMETRY_MODES.MANDALA:return-Math.PI/2;default:return 0}}drawSymmetryGuides(a=this.symmetryGuideX,b=this.symmetryGuideY,c=this.symmetryGuideAngle){const d=this.symmetryGuidesCtx;a*=this.density;b*=this.density;d.clearRect(0,0,d.canvas.width,d.canvas.height);d.beginPath();switch(this.s.symmetryMode){case GPPainter_.SYMMETRY_MODES.VERTICAL:this.isSymmetryGuidesAdjustable&&
this.drawSymmetryGuideReticleRing(d,a,b,7);this.drawSymmetryGuide(d,a,b,c);break;case GPPainter_.SYMMETRY_MODES.HORIZONTAL:this.isSymmetryGuidesAdjustable&&this.drawSymmetryGuideReticleRing(d,a,b,7);this.drawSymmetryGuide(d,a,b,c);break;case GPPainter_.SYMMETRY_MODES.QUADRANT:this.drawSymmetryGuide(d,a,b,c);this.drawSymmetryGuide(d,a,b,c+Math.PI/2);break;case GPPainter_.SYMMETRY_MODES.RADIAL:var e=this.s.symmetryRadialGuidesCount,f=this.symmetryGuideX*this.density,g=this.symmetryGuideY*this.density,
h=2*Math.PI/e;this.isSymmetryGuidesAdjustable&&2===e?this.drawSymmetryGuideReticleRing(d,a,b,7):d.arc(a,b,50*this.density,0,2*Math.PI);for(a=0;a<e;a++){var k=a*h+c;b=f+Math.cos(k)*this.symmetryGuidesRadius;k=g+Math.sin(k)*this.symmetryGuidesRadius;d.moveTo(f,g);d.lineTo(b,k)}break;case GPPainter_.SYMMETRY_MODES.MANDALA:for(e=this.s.symmetryMandalaGuidesCount,f=this.symmetryGuideX*this.density,g=this.symmetryGuideY*this.density,h=2*Math.PI/e,this.isSymmetryGuidesAdjustable&&2===e&&this.drawSymmetryGuideReticleRing(d,
a,b,7),a=0;a<e;a++)k=a*h+c,b=f+Math.cos(k)*this.symmetryGuidesRadius,k=g+Math.sin(k)*this.symmetryGuidesRadius,d.moveTo(f,g),d.lineTo(b,k)}d.stroke()}drawSymmetryGuide(a,b,c,d){if(1E-10>Math.abs(Math.cos(d)))a.moveTo(b,0),a.lineTo(b,a.canvas.height);else{d=Math.tan(d);b=c-d*b;c=a.canvas.width;const e=d*c+b;a.moveTo(0,0*d+b);a.lineTo(c,e)}}drawSymmetryGuideReticleLine(a,b,c,d,e){e/=2;d+=Math.PI/2;const f=b+e*Math.cos(d),g=c+e*Math.sin(d);a.moveTo(b-e*Math.cos(d),c-e*Math.sin(d));a.lineTo(f,g)}drawSymmetryGuideReticleRing(a,
b,c,d){a.arc(b,c,d*this.density,0,2*Math.PI)}setSymmetryGuidesColor(a){this.symmetryGuidesCtx.strokeStyle=a;this.drawSymmetryGuides()}setSymmetryGuidesOpacity(a){this.symmetryGuidesCtx.globalAlpha=a;this.drawSymmetryGuides()}setSymmetryGuidesWidth(a){this.symmetryGuidesCtx.lineWidth=a*this.density;this.drawSymmetryGuides()}setSymmetryMode(a){const b=this.s.symmetryMode;this.s.symmetryMode=a;switch(a){case GPPainter_.SYMMETRY_MODES.RADIAL:b!==GPPainter_.SYMMETRY_MODES.MANDALA&&(this.symmetryGuideX=
Math.round(this.originalWidth/2),this.symmetryGuideY=Math.round(this.originalHeight/2));break;case GPPainter_.SYMMETRY_MODES.MANDALA:b!==GPPainter_.SYMMETRY_MODES.RADIAL&&(this.symmetryGuideX=Math.round(this.originalWidth/2),this.symmetryGuideY=Math.round(this.originalHeight/2));break;default:this.symmetryGuideX=Math.round(this.originalWidth/2),this.symmetryGuideY=Math.round(this.originalHeight/2)}this.symmetryGuideAngle=this.getSymmetryModeGuidesAngle(a);this.drawSymmetryGuides()}getSymmetryMode(){return this.s.symmetryMode}getSymmetryModes(){const a=
Object.keys(GPPainter_.SYMMETRY_MODES);return this.isSubscribed||this.prx.isSoloGame()?a:GPPainter_.UNSUBSCRIBED_SYMMETRY_MODES}changeSymmetryRadialGuidesCount(a){this.s.symmetryRadialGuidesCount=Math.min(GPPainter_.MAX_SYMMETRY_RADIAL_GUIDES,Math.max(GPPainter_.MIN_SYMMETRY_RADIAL_GUIDES,this.s.symmetryRadialGuidesCount+(0<a?-1:1)));this.radiansPerSymmetryRadialGuide=2*Math.PI/this.s.symmetryRadialGuidesCount;this.drawSymmetryGuides();return this.s.symmetryRadialGuidesCount}changeSymmetryMandalaGuidesCount(a){this.s.symmetryMandalaGuidesCount=
Math.min(GPPainter_.MAX_SYMMETRY_MANDALA_GUIDES,Math.max(GPPainter_.MIN_SYMMETRY_MANDALA_GUIDES,this.s.symmetryMandalaGuidesCount+(0<a?-1:1)));this.radiansPerSymmetryMandalaGuide=2*Math.PI/this.s.symmetryMandalaGuidesCount;this.drawSymmetryGuides();return this.s.symmetryMandalaGuidesCount}showColorPicker(a){const b=this.drawingArea.getBoundingClientRect(),c=b.left+(this.lastClientX-b.left),d=b.top+(this.lastClientY-b.top);if(c>=b.left&&c<=b.right&&d>=b.top&&d<=b.bottom){this.colorPicker.show(c,d);
const e=f=>{f.code===a.code&&(this.colorPicker.hide(),document.removeEventListener("keyup",e))};document.addEventListener("keyup",e);this.clearPointer()}}zoomToPoint(a){1!==this.zoomer.getScale()?this.resetZoom(!0):(this.zoomer.getScale()!==this.s.maxZoomToPoint?this.zoomer.zoomToPoint(this.s.maxZoomToPoint,this.lastClientX,this.lastClientY,!0):this.zoomer.resetScale(!0),this.updatePointer())}zoomIn(a){this.isPointerInsidePainter()?this.zoomer.zoom(this.s.zoomStep,this.lastClientX,this.lastClientY,
!0):this.zoomer.zoomIn();a.preventDefault()}zoomOut(a){this.isPointerInsidePainter()?this.zoomer.zoom(-this.s.zoomStep,this.lastClientX,this.lastClientY,!0):this.zoomer.zoomOut();1>=this.zoomer.getScale()&&this.resetZoom();a.preventDefault()}isPointerInsidePainter(){const a=this.container.getBoundingClientRect(),b=this.lastClientX,c=this.lastClientY;return b>=a.left&&b<=a.right&&c>=a.top&&c<=a.bottom}toggleReference(){this.iface.toggleReference()}save(){this.saveImage()}toggleGrid(){var a=this.gridType=
(this.gridType+1)%4;const b=this.width;var c=this.height;const d=this.density,e=this.gridCtx;e.clearRect(0,0,b,c);if(0!=a){a=(2==a?48:1==a?24:96)*d;var f=b/2,g=f/a;for(var h=0;h<g;h++){var k=h*a;const l=(0==h%4?.5:.25)*d;e.fillRect(f+k,0,l*d,c);e.fillRect(f-k,0,l*d,c)}c/=2;f=c/a;for(g=0;g<f;g++)h=g*a,k=(0==g%4?.5:.25)*d,e.fillRect(0,c+h,b,k*d),e.fillRect(0,c-h,b,k*d);e.globalAlpha=1;this.grid.isConnected||this.pointer.before(this.grid)}else this.grid.remove()}decreaseOpacity(a){this.setOpacity(Math.max(this.s.minOpacity,
Math.min(1,Math.round(100*(+this.opacity-+this.s.opacityStep))/100)))}increaseOpacity(a){this.setOpacity(Math.max(this.s.minOpacity,Math.min(1,Math.round(100*(+this.opacity+ +this.s.opacityStep))/100)))}setCustomOpacity(a,b){this.setOpacity(this.s.customOpacity[b])}decreaseThickness(a){this.setBrushThickness(a,Math.round(Math.max(Math.min(this.thickness-this.s.thicknessStep,this.s.maxThickness),this.s.minThickness)))}increaseThickness(a){this.setBrushThickness(a,Math.round(Math.max(Math.min(this.thickness+
this.s.thicknessStep,this.s.maxThickness),this.s.minThickness)))}setCustomThickness(a,b){this.setBrushThickness(a,this.s.customThickness[b])}setBrushThickness(a,b){this.thickness=b;this.iface.updateThickness(b);this.updatePointer()}decreaseBrightness(a){const [b,c,d]=GPColorUtils_.hexToHsv(this.color);this.setBrightness(b,c,Math.max(.01,Math.min(1,Math.round(100*d-this.s.brightnessStep)/100)))}increaseBrightness(a){const [b,c,d]=GPColorUtils_.hexToHsv(this.color);this.setBrightness(b,c,Math.max(.01,
Math.min(1,Math.round(100*d+this.s.brightnessStep)/100)))}setBrightness(a,b,c){a=GPColorUtils_.hsvToHex(a,b,c);this.setColor(a)}disable(){this.container.removeEventListener("pointerdown",this.middleButtonDown);this.container.removeEventListener("pointerdown",this.strokeDown);this.container.removeEventListener("pointerdown",this.rightButtonDown);this.resetZoom();this.resetKeys();this.container.classList.add("disabled_");this.isDisabled=!0;this.dispatchEvent(new Event("disable"))}enable(){this.container.addEventListener("pointerdown",
this.middleButtonDown);this.container.addEventListener("pointerdown",this.strokeDown);this.container.addEventListener("pointerdown",this.rightButtonDown);this.container.classList.remove("disabled_");this.isDisabled=!1;this.dispatchEvent(new Event("enable"))}drawFunction(a,b,c=this.density,d=!0,e=!0){GPUtils_.drawFunction(a,b,c,d,e)}getFillData(a,b,c){this.isMirror&&(a=this.width-a);this.isVerticalMirror&&(b=this.height-b);let d;if(this.backgroundData){const e=document.createElement("canvas");e.width=
this.canvas.width;e.height=this.canvas.height;d=e.getContext("2d");d.drawImage(this.background,0,0,e.width,e.height);d.drawImage(this.lastDraw,0,0,e.width,e.height);d.drawImage(this.canvas,0,0,e.width,e.height)}else d=this.canvasCtx;return this.getFillRects(d,a,b,c,this.canvas.width,this.canvas.height).map((e,f)=>4>f%5?Math.round(e/this.density):e)}getFillRects(a,b,c,d,e,f){var g=function(t,D,B){var A=D,y=B;if(m(D,B,t)){for(;m(A+1,y,t);)A++;var F=A;do for(A=D-1,y++;m(A+1,y,t)&&A+1<=F;)A++;while(A==
F);return{x:D,y:B,w:F-D,h:--y-B}}return{w:-1,h:-1}},h=function(t,D,B){var A=D,y=B;if(m(D,B,t)){for(;m(A-1,y,t);)A--;var F=A;do for(A=D+1,y--;m(A-1,y,t)&&A-1>=F;)A--;while(A==F);return{x:F,y:++y,w:D-F,h:B-y}}return{w:-1,h:-1}},k=function(t,D,B){var A=D,y=B;if(m(D,B,t)){for(;m(A,y+1,t);)y++;var F=y;do for(y=B-1,A--;m(A,y+1,t)&&y+1<=F;)y++;while(y==F);return{x:++A,y:B,w:D-A,h:F-B}}return{w:-1,h:-1}},l=function(t,D,B){var A=D,y=B;if(m(D,B,t)){for(;m(A,y-1,t);)y--;var F=y;do for(y=B+1,A++;m(A,y-1,t)&&
y-1>=F;)y--;while(y==F);return{x:D,y:F,w:--A-D,h:B-F}}return{w:-1,h:-1}},m=function(t,D,B){if(r[t][D])return!1;t=4*(t+D*e);t=v.slice(t,t+4);D=Math.abs(B[1]-t[1]);var A=Math.abs(B[2]-t[2]),y=Math.abs(B[3]-t[3]);return 20>Math.abs(B[0]-t[0])&&20>D&&20>A&&20>y||0==t[3]&&255==B[0]&&255==B[1]&&255==B[2]||0==B[3]&&255==t[0]&&255==t[1]&&255==t[2]},p=function(t){for(var D=t[0],B=t[1],A=D+t[2],y=B+t[3];D<A;D++)for(var F=B;F<y;F++)r[D][F]=!0;return t};b=Math.round(b);c=Math.round(c);var r;d=parseInt(d.replace("#",
"0x"));var q=d%256,n=(d=Math.floor(d/256))%256,u=d=Math.floor(d/256);!function(){r=[];for(var t=-1;t<=e;t++)r[t]=[];r[-1]=[];r[e]=[];for(t=-1;t<=f;t++)r[-1][t]=1,r[e][t]=1;for(t=0;t<e;t++)r[t][-1]=1,r[t][f]=1}();var v=a.getImageData(0,0,e,f).data;a=4*(b+c*e);a=[v[a],v[a+1],v[a+2],v[a+3]];d=[];for(var x=0;x<=e;x++)d[x]=[];if(m(b,c,[u,n,q,255]))return[];for(;m(b-1,c,a);)b--;for(;m(b,c-1,a);)c--;var w;q=g(a,b,c);c={x:b,y:c,w:q.w,h:q.h,ref:0,andada:0,stack:0};n=q.w;u=[].concat(p([q.x,q.y,q.w+1,q.h+1]),
[0]);do{b=0;for(2==c.ref&&(b+=c.andada);b<=c.h;)-1!=(w=(q=l(a,c.x+c.w+1,c.y+c.h-b)).h)?(d[w].push({x:q.x,y:q.y,w:q.w,h:q.h,ref:1,andada:c.h+1-b,stack:u.length}),u.push.apply(u,p([q.x,q.y,q.w+1,q.h+1]).concat([c.stack])),w>n&&(n=w),b+=w):b++;b=0;for(1==c.ref&&(b+=c.andada);b<=c.h;)-1!=(w=(q=k(a,c.x-1,c.y+b)).h)?(d[w].push({x:q.x,y:q.y,w:q.w,h:q.h,ref:2,andada:c.h+1-b,stack:u.length}),u.push.apply(u,p([q.x,q.y,q.w+1,q.h+1]).concat([c.stack])),w>n&&(n=w),b+=w):b++;b=0;for(4==c.ref&&(b+=c.andada);b<=
c.w;)-1!=(w=(q=g(a,c.x+b,c.y+c.h+1)).w)?(d[w].push({x:q.x,y:q.y,w:q.w,h:q.h,ref:3,andada:c.w+1-b,stack:u.length}),u.push.apply(u,p([q.x,q.y,q.w+1,q.h+1]).concat([c.stack])),w>n&&(n=w),b+=w):b++;b=0;for(3==c.ref&&(b+=c.andada);b<=c.w;)-1!=(w=(q=h(a,c.x+c.w-b,c.y-1)).w)?(d[w].push({x:q.x,y:q.y,w:q.w,h:q.h,ref:4,andada:c.w+1-b,stack:u.length}),u.push.apply(u,p([q.x,q.y,q.w+1,q.h+1]).concat([c.stack])),w>n&&(n=w),b+=w):b++;for(c=d[n].pop();null==c&&0<n;)c=d[--n].pop()}while(null!=c);return u}setTimer(){this.timer&&
(this.timer.reset(),this.timer.settings.runAfterTurnStart&&this.prx.isGameTime(GPProxy_.GAME_TIME.HOSTS_DECISION)&&this.prx.isHost()&&this.timer.start())}stopTimer(){this.timer&&this.timer.reset()}sign(){const a=this.buildMStroke();this.prx.tool(1,a,!0);this.mStrokeId=a[1];this.isSigned=!0}unsign(){null!==this.mStrokeId&&(this.prx.undo(this.mStrokeId,!0),this.mStrokeId=null,this.isSigned=!1)}buildMStroke(){var a=this.prx.getGameCode();const b=this.prx.getUsername(),c=Date.now().toString();a=this.stringToCoords(`\x00${a}@${b}@${c}\x00`);
return[1,this.strokeId++,[this.color,6,`${this.opacity}`],...a]}stringToCoords(a){const b=a.split("").map(c=>c.codePointAt(0));a.length%2&&b.push(0);a=[];for(let c=0;c<b.length;c+=2)a.push([b[c]+this.originalWidth+GPPainter_.M_STROKE_OFFSET,b[c+1]+this.originalHeight+GPPainter_.M_STROKE_OFFSET]);return a}shouldBeSigned(){return!this.isSigned&&this.prx.isAuthorized&&this.history.length-(this.lastDelimiterIndex+1)>this.mStrokeOrigin}windowsInkCheck(a){0===a.button&&"pen"===a.pointerType&&this.abt.setWindowsInkWarningState(!0)}getRandomInt(a){return Math.floor(Math.random()*
(a+1))}setColorPanelControlsSet(a){this.s.colorPanelControlsSet=a}setPaletteName(a){this.s.extendedPaletteName=a}setColorWheelMode(a){this.s.colorWheelMode=a}insertSettingsView(a){return this.sm.insertView(this.constructor.name,a)}updateSettingsView(a){this.sm.updateView(a)}getSettings(){return this.s}getSettingsCopy(){return Object.assign({},this.s)}getDefaultSettings(){return Object.assign({},GPPainter_.DEFAULT_SETTINGS)}updateSettings({detail:{settings:a}}){this.container&&("minZoom"in a&&this.zoomer.setMinScale(a.minZoom),
"maxZoom"in a&&this.zoomer.setMaxScale(a.maxZoom),"fixedScreenSize"in a&&this.iface.toggleFixedScreenSize(a.fixedScreenSize),"stretchNativePalette"in a&&this.iface.updateNativePalette(a.stretchNativePalette),"extendedPalettePanel"in a&&this.iface.updateExtendedPalette(a.extendedPalettePanel),"colorPickerPanel"in a&&this.iface.updateColorPickerPanel(a.colorPickerPanel),"colorPickerHuePosition"in a&&this.initColorPicker({huePos:a.colorPickerHuePosition}),"colorPickerWidth"in a&&this.initColorPicker({width:a.colorPickerWidth}),
"colorPickerHeight"in a&&this.initColorPicker({height:a.colorPickerHeight}),"hideHeaderBackground"in a&&this.iface.toggleHeaderBackground(a.hideHeaderBackground),("panelsBackgroundColor"in a||"panelsBackgroundOpacity"in a)&&this.iface.updatePanelsBackground(this.s.panelsBackgroundColor,this.isDisabled?Math.max(this.s.panelsBackgroundOpacity-10,0):this.s.panelsBackgroundOpacity),("panelsElementsColor"in a||"panelsElementsOpacity"in a)&&this.iface.updatePanelsElements(this.s.panelsElementsColor,this.isDisabled?
Math.max(this.s.panelsElementsOpacity-30,0):this.s.panelsElementsOpacity),"controlsBackgroundBlurLevel"in a&&this.iface.updateControlsBackgroundBlurLevel(a.controlsBackgroundBlurLevel),"interactionHints"in a&&this.iface.toggleInteractionHints(a.interactionHints),"interactionHintsDelay"in a&&this.iface.updateInteractionHintsDelay(a.interactionHintsDelay),"headerColor"in a&&this.iface.updateHeaderColor(a.headerColor),"headerInstructionsColor"in a&&this.iface.updateHeaderPhraseColor(a.headerInstructionsColor),
"autoHideHeaderElements"in a&&this.iface.setAutoHideHeaderState(a.autoHideHeaderElements),"autoHideHeaderDelay"in a&&this.iface.setAutoHideHeaderDelay(a.autoHideHeaderDelay),"symmetryGuidesColor"in a&&this.setSymmetryGuidesColor(a.symmetryGuidesColor),"symmetryGuidesOpacity"in a&&this.setSymmetryGuidesOpacity(a.symmetryGuidesOpacity),"symmetryGuidesWidth"in a&&this.setSymmetryGuidesWidth(a.symmetryGuidesWidth))}parseUISettings(a){const b={};for(let c in a)b[c]=a[c].value;return b}getPointAngle(a,
b,c,d){return Math.atan2(d-b,c-a)}}window.GPPainter_=GPPainter_;class GPShortcutsHandler_ extends EventTarget{static MODIFIER_KEYS=new Set("ControlLeft ControlRight ShiftLeft ShiftRight AltLeft AltRight ContextMenu".split(" "));static MODIFIER_KEYS_ORDER=[...this.MODIFIER_KEYS].reduce((a,b,c)=>(a[b]=c,a),{});static NATIVE_SHORTCUTS_KEYS=new Set("KeyB KeyE KeyF KeyG KeyX KeyZ Digit1 Digit2 Digit3 Digit4 Digit5 Minus Equal Comma Period".split(" "));constructor(a,b){super();GPUtils_.bindMethods([this.onWindowBlur,this.onWindowFocus,this.onKeyDown,this.onKeyUp],this);
this.tools=b;this.shortcutActivatorsTree=this.shortcutTree=null;this.activatorKeys=new Set;this.pressedKeys=new Set;this.currentShortcut=null;this.keysLocked=this.disabled=!1;this.updateShortcuts(a)}buildShortcutTree(a,b=!1){const c={};b&&this.activatorKeys.clear();for(const d in a){const e=this.isActivator(d);if(!b||e)for(const f of a[d]){let g=c;for(const h of f)g[h]||(g[h]={}),g=g[h];g.name=d;e&&f.length&&this.activatorKeys.add(f.at(-1))}}return c}findShortcut(a,b=!1){b=b?this.shortcutActivatorsTree:
this.shortcutTree;for(const c of a){if(!b[c])return null;b=b[c]}return b.name??null}isActivator(a){return!!this.tools[a]?.activator}isModifierKey(a){return GPShortcutsHandler_.MODIFIER_KEYS.has(a)}isNativeShortcut(a){return GPShortcutsHandler_.NATIVE_SHORTCUTS_KEYS.has(a)}areKeysDisabled(){return this.disabled||this.keysLocked||"INPUT"===document.activeElement.tagName&&("text"===document.activeElement.type||"search"===document.activeElement.type)||"TEXTAREA"===document.activeElement.tagName}handleDefaultBehavior(a){"Space"!==
a.code&&"Enter"!==a.code||"BUTTON"!==document.activeElement.tagName||a.preventDefault()}handleKeyDown(a){if(!this.areKeysDisabled())if(this.handleDefaultBehavior(a),this.pressedKeys.add(a.code),a.repeat)this.currentShortcut&&(this.dispatchShortcut(this.currentShortcut,a),a.preventDefault(),a.stopPropagation());else{var b=this.matchShortcut(a.code);b?(this.currentShortcut=b,this.dispatchShortcut(b,a),a.preventDefault()):this.currentShortcut=null;a.stopPropagation()}}handleKeyUp(a){this.pressedKeys.delete(a.code);
this.currentShortcut=null;if(this.pressedKeys.size&&(a=Array.from(this.pressedKeys).at(-1),this.activatorKeys.has(a))){var b=this.matchShortcut(a,!0);b&&this.isActivator(b)&&(this.currentShortcut=b,this.dispatchShortcut(b,{code:a,repeat:!1}))}}dispatchShortcut(a,b){this.dispatchEvent(new CustomEvent("trigger",{detail:{shortcut:a,event:b}}))}matchShortcut(a,b){let c=[],d=[];this.pressedKeys.forEach(f=>{this.isModifierKey(f)?(c.push(f),d=[]):d=[f]});c.sort((f,g)=>GPShortcutsHandler_.MODIFIER_KEYS_ORDER[f]-
GPShortcutsHandler_.MODIFIER_KEYS_ORDER[g]);let e=this.findShortcut(new Set([...c,...d]));e||0!==d.length||(e=this.findShortcut(new Set([a]),b));return e}onWindowBlur(a){this.currentShortcut=null;this.pressedKeys.clear()}onWindowFocus(a){this.onWindowBlur(a)}onKeyDown(a){this.handleKeyDown.call(this,a)}onKeyUp(a){this.handleKeyUp.call(this,a)}onButtonClick(a){"BUTTON"===a.target.tagName&&a.target.blur()}start(){window.addEventListener("blur",this.onWindowBlur);window.addEventListener("focus",this.onWindowFocus);
document.addEventListener("keydown",this.onKeyDown,!0);document.addEventListener("keyup",this.onKeyUp,!0);document.addEventListener("click",this.onButtonClick)}stop(){window.removeEventListener("blur",this.onWindowBlur);window.removeEventListener("focus",this.onWindowFocus);document.removeEventListener("keydown",this.onKeyDown,!0);document.removeEventListener("keyup",this.onKeyUp,!0);document.removeEventListener("click",this.onButtonClick)}enable(){this.disabled=!1}disable(){this.disabled=!0}lockKeys(){this.keysLocked=
!0}unlockKeys(){this.keysLocked=!1}updateShortcuts(a){this.shortcutTree=this.buildShortcutTree(a);this.shortcutActivatorsTree=this.buildShortcutTree(a,!0)}}window.GPShortcutsHandler_=GPShortcutsHandler_;class GPShortcutsManager_ extends EventTarget{static SHORTCUTS_STORAGE="gp_painter_bindings";static RESERVED_KEYS=["F5","F11","F12","MetaLeft","MetaRight"];static MODIFIER_KEYS=new Set("ControlLeft ControlRight ShiftLeft ShiftRight AltLeft AltRight ContextMenu".split(" "));static MODIFIER_KEYS_ORDER=[...this.MODIFIER_KEYS].reduce((a,b,c)=>(a[b]=c,a),{});static KEY_ALIASES={Backquote:"`",Equal:"+",Minus:"-",BracketLeft:"[",BracketRight:"]",Quote:"'",Semicolon:";",Backslash:"\\",Comma:",",Period:".",
Slash:"/",Control:"Ctrl",ArrowUp:"\u2191",ArrowDown:"\u2193",ArrowLeft:"\u2190",ArrowRight:"\u2192",Divide:"/",Multiply:"*",Subtract:"-",Add:"+",Decimal:"."};static DEFAULT_SHORTCUTS={dropper:[["AltLeft"]],thickness:[["ControlLeft"]],opacity:[["ShiftLeft"]],brightness:[["KeyV"]],zoom:[["KeyZ"]],zoomToPoint:[["KeyS"]],zoomIn:[["Equal"],["ControlLeft","Equal"]],zoomOut:[["Minus"],["ControlLeft","Minus"]],zoomReset:[["KeyA"],["ControlLeft","Digit0"]],mirror:[["CapsLock"]],verticalMirror:[["ControlLeft",
"CapsLock"]],colorPicker:[["Tab"]],switchColors:[["KeyX"]],eraser:[["KeyC"]],grayscale:[["KeyW"]],hand:[["Space"]],rotate:[["ControlLeft","Space"]],clear:[["KeyF"]],symmetry:[["KeyT"]],reference:[["KeyP"]],toolCentering:[["KeyR"]],grid:[["KeyG"]],undo:[["ControlLeft","KeyZ"]],redo:[["ControlLeft","KeyY"],["ControlLeft","ShiftLeft","KeyZ"]],save:[["ControlLeft","KeyS"]],decreaseThickness:[["BracketLeft"]],increaseThickness:[["BracketRight"]],customThickness1:[["Digit1"]],customThickness2:[["Digit2"]],
customThickness3:[["Digit3"]],customThickness4:[["Digit4"]],customThickness5:[["Digit5"]],thicknessPanelSlot1:[],thicknessPanelSlot2:[],thicknessPanelSlot3:[],thicknessPanelSlot4:[],thicknessPanelSlot5:[],decreaseOpacity:[["Comma"]],increaseOpacity:[["Period"]],customOpacity1:[],customOpacity2:[],customOpacity3:[],customOpacity4:[],customOpacity5:[],decreaseBrightness:[],increaseBrightness:[],brushTool:[["KeyB"]],eraserTool:[["KeyE"]],rectangleTool:[],rectangleFilledTool:[],circleTool:[],circleFilledTool:[],
fillTool:[],noteTool:[]};constructor(a,b){if(GPShortcutsManager_.instance)return GPShortcutsManager_.instance;super();GPShortcutsManager_.instance=this;this.l=b;this.painter=a;GPUtils_.bindMethods([this.onShortcutSetClick,this.onKeyUp,this.onKeyDown,this.stopShortcut,this.updateShortcutPreview,this.resetShortcuts],this);this.keysLocked=!1;this.pressedKeys=new Set;this.currentShortcutKeys;this.bindingKeys=new Set;this.activeShortcutElem=null;this.shortcutsScrollPos=0;this.isRendered=!1;this.shortcuts=
Object.assign({},window.structuredClone(GPShortcutsManager_.DEFAULT_SHORTCUTS),JSON.parse(localStorage.getItem(GPShortcutsManager_.SHORTCUTS_STORAGE)));this.keysMap=this.buildKeysMap(this.shortcuts);this.addEventListener("shortcuts_updated",({detail:{shortcuts:c}})=>{this.updateShortcutsHandler(c)})}insertView(a){const b=this.getView();a.appendChild(b);this.updateScrollPos();this.handleViewScrollbar()}getView(){return this.container??this.renderShortcuts()}renderShortcuts(a=this.getShortcuts()){if(this.isRendered)this.shortcutsElem.innerHTML=
"";else{this.container=document.createElement("div");this.container.className="shortcuts-settings_";(new ResizeObserver(g=>{g[0].contentRect.height&&this.updateScrollPos()})).observe(this.container);this.shortcutsElem=document.createElement("div");this.shortcutsElem.className="shortcuts_ gp-ui-scrollbar_";this.shortcutsElem.classList.add("unlocalized_",!this.l.isLoaded);this.shortcutsElem.addEventListener("scroll",g=>{this.shortcutsScrollPos=g.target.scrollTop;this.handleViewScrollHints()});this.container.appendChild(this.shortcutsElem);
var b=document.createElement("div");b.className="buttons_";this.container.appendChild(b);var c=document.createElement("div");c.className="reset-btn_ btn_ gp-ui-btn_";c.textContent=this.l.RESET_SETTINGS_BTN;c.title=this.l.RESET_SETTINGS_BTN_TTL;c.addEventListener("click",this.resetShortcuts);b.appendChild(c)}b=!this.l.isLoaded;c=this.painter.getTools();const d=document.createDocumentFragment();for(let g in a){if(!c[g])continue;if(!b&&this.l.TOOLS[g]?.[2]){var e=document.createElement("div");e.className=
"label_";e.textContent=this.l.TOOLS[g][2];d.appendChild(e)}e=GPUtils_.buildTooltip(this.l.TOOLS[g]?.[1]);d.appendChild(e);e=document.createElement("div");e.className="name_";b?e.textContent=this.formatShortcutName(g):(e.title=this.l.TOOLS[g][1],e.textContent=this.l.TOOLS[g][0]);const h=document.createElement("div");h.className="shortcuts-container_";const k=document.createElement("div");k.className="shortcut-list_";h.appendChild(k);var f=document.createElement("div");f.className="conflict-warning_";
k.appendChild(f);a[g].length?a[g].forEach((l,m)=>{l=this.renderShortcut(g,m,l,k);k.appendChild(l)}):(f=this.renderShortcut(g,-1,[],k),f.classList.add("empty_"),k.appendChild(f));f=document.createElement("div");f.className="add-btn_ btn_ gp-ui-btn_";f.addEventListener("click",l=>{l=this.renderShortcut(g,-1,[],k);k.appendChild(l);this.handleViewScrollbar();this.handleViewScrollHints();this.setLatestShortcut(l)});h.appendChild(f);d.appendChild(h);d.appendChild(e)}this.shortcutsElem.appendChild(d);this.updateScrollPos();
this.handleViewScrollbar();this.handleViewScrollHints();this.isRendered=!0;return this.container}updateScrollPos(){this.shortcutsElem.scrollTop=this.shortcutsScrollPos}handleViewScrollbar(){this.shortcutsElem.classList.toggle("scrollbar_",this.shortcutsElem.scrollHeight>this.shortcutsElem.clientHeight)}handleViewScrollHints(){this.container.classList.toggle("scroll-hint-top_",0<this.shortcutsElem.scrollTop);this.container.classList.toggle("scroll-hint-bottom_",this.shortcutsElem.offsetHeight+this.shortcutsElem.scrollTop<
this.shortcutsElem.scrollHeight)}formatShortcutName(a){const b=[];let c=/([A-Z]{2,}(?=[A-Z][a-z]|[0-9]|$))|([A-Z][a-z]+)|([a-z]+)|([0-9]+)/g,d;for(;null!==(d=c.exec(a));)b.push(d[0]);return b.join(" ")}setLatestShortcut(a){a.querySelector(".shortcut_").click()}onClickShortcutsTab(a){this.renderShortcuts(this.getShortcuts())}renderShortcut(a,b,c,d){c=this.formatShortcut(c);const e=document.createElement("div");e.className="shortcut-container_";const f=document.createElement("div");f.className="shortcut_";
f.innerHTML=c;f.dataset.name=a;f.dataset.index=b;f.addEventListener("click",this.onShortcutSetClick);f.addEventListener("contextmenu",g=>{this.activeShortcutElem===f&&(this.cancelBinding(f),g.preventDefault(),g.stopPropagation())});e.appendChild(f);c=document.createElement("div");c.className="buttons_";e.appendChild(c);d=document.createElement("div");d.className="delete-btn_ btn_ gp-ui-btn_";d.addEventListener("click",g=>{this.deleteShortcut(a,b,e);this.handleViewScrollbar();this.handleViewScrollHints()});
c.appendChild(d);d=document.createElement("div");d.className="accept-btn_ btn_ gp-ui-btn_";d.addEventListener("click",g=>{this.isAcceptedShortcut(this.bindingKeys,this.currentShortcutKeys)?this.assignShortcut([...this.bindingKeys],this.activeShortcutElem):this.cancelBinding(this.activeShortcutElem)});c.appendChild(d);return e}deleteShortcut(a,b,c){~b?(c=this.getShortcuts(),c[a].splice(b,1),this.renderShortcuts(c),this.dispatchEvent(new CustomEvent("shortcuts_updated",{detail:{shortcuts:c}}))):c.remove()}onShortcutSetClick(a){this.activeShortcutElem&&
this.cancelBinding(this.activeShortcutElem);this.keysLocked=!0;this.dispatchEvent(new Event("keys_locked"));a.currentTarget.focus();a=a.target;this.currentShortcutKeys=this.getShortcutsKeys(a.dataset.name,+a.dataset.index);this.pressedKeys.clear();this.activeShortcutElem=a;a.parentElement.classList.add("process_");document.addEventListener("keydown",this.onKeyDown,!0);document.addEventListener("keyup",this.onKeyUp,!0);document.addEventListener("pointerdown",this.stopShortcut,!0)}stopShortcut(a){this.activeShortcutElem?
this.activeShortcutElem.parentElement.contains(a.target)||this.cancelBinding(this.activeShortcutElem):document.removeEventListener("pointerdown",this.stopShortcut,!0)}onKeyDown(a){a.preventDefault();a.stopPropagation();if(!a.repeat)switch(a.code){case "Escape":this.cancelBinding(this.activeShortcutElem);break;case "Enter":case "NumpadEnter":this.isAcceptedShortcut(this.bindingKeys,this.currentShortcutKeys)?this.assignShortcut([...this.bindingKeys],this.activeShortcutElem):this.cancelBinding(this.activeShortcutElem);
break;default:this.pressedKeys.add(a.code),this.bindingKeys=this.handlePressedKey(a),this.activeShortcutElem.parentElement.parentElement.classList.add("pressed_"),this.updateShortcutPreview(this.bindingKeys)}}onKeyUp(a){this.pressedKeys.delete(a.code);0===this.pressedKeys.size&&this.activeShortcutElem.parentElement.parentElement.classList.remove("pressed_");a.preventDefault()}handlePressedKey(a){if(0!==this.pressedKeys.size){var b=[],c=[];this.pressedKeys.forEach(d=>{this.isModifierKey(d)?(b.push(d),
c=[]):c=[d]});b.sort((d,e)=>GPShortcutsManager_.MODIFIER_KEYS_ORDER[d]-GPShortcutsManager_.MODIFIER_KEYS_ORDER[e]);return new Set([...b,...c])}}hasOnlyModifiers(a){return[...a].every(b=>this.isModifierKey(b))}isModifierKey(a){return GPShortcutsManager_.MODIFIER_KEYS.has(a)}updateShortcutPreview(a){const b=this.activeShortcutElem;b.classList.remove("is-warning_");const c=b.parentElement.parentElement;c.classList.remove("is-conflict_","is-mods_");if(a.size){b.innerHTML=this.formatShortcut(a);const d=
this.findShortcut(a,b.dataset.name),e=this.findReservedKeys(a);this.hasOnlyModifiers(a)&&c.classList.add("is-mods_");if(d||e)c.classList.add("is-conflict_"),this.updateConflictWarning(c,b.parentElement,d,e);b.classList.toggle("is-warning_",d||e)}else b.innerHTML=this.formatShortcut(this.getShortcutsKeys(b.dataset.name,+b.dataset.index));this.handleViewScrollbar();this.handleViewScrollHints()}updateConflictWarning(a,b,c,d){a=a.querySelector(".conflict-warning_");b.after(a);a.innerHTML=`<div class="icon_"></div><div class="text_">${d?
`<span>${this.l.BINDINGS_RESERVED_KEYS}: </span>${d.map(e=>`<span class="shortcut-name_">${this.formatKey(e)}</span>`).join("")}`:`<span>${this.l.BINDINGS_CONFLICT_WARNING} </span><span class="shortcut-name_">${this.l.TOOLS[c][0]}</span>`}</div>`}isAcceptedShortcut(a,b){return!(0===a.size||this.hasShortcut(a)||this.hasReservedKeys(a))}hasReservedKeys(a){return null!==this.findReservedKeys(a)}findReservedKeys(a){a=Array.from(a).filter(b=>GPShortcutsManager_.RESERVED_KEYS.includes(b));return 0<a.length?
a:null}hasShortcut(a){return null!==this.findShortcut2(a)}findShortcut(a,b){a=this.findShortcut2(a);return a!==b?a:null}isSameShortcut(a,b){return this.compareShortcutKeys(b,a)}compareShortcutKeys(a,b){return a&&b?a.every((c,d)=>c===b[d]):!1}assignShortcut(a,b){b.innerHTML=this.formatShortcut(a);this.updateShortcuts(b.dataset.name,b.dataset.index,a);this.endBinding(b)}cancelBinding(a){a.innerHTML=this.formatShortcut(this.getShortcutsKeys(a.dataset.name,+a.dataset.index));this.endBinding(a)}endBinding(a){this.keysLocked=
!1;this.dispatchEvent(new Event("keys_unlocked"));a.parentElement.parentElement.classList.remove("is-conflict_","is-mods_");a.parentElement.classList.remove("process_");a.classList.remove("is-warning_");document.removeEventListener("keydown",this.onKeyDown,!0);document.removeEventListener("keyup",this.onKeyUp,!0);document.removeEventListener("pointerdown",this.stopShortcut,!0);this.activeShortcutElem=null}resetShortcuts(){const a=this.getDefaultShortcuts();this.renderShortcuts(a);this.dispatchEvent(new CustomEvent("shortcuts_updated",
{detail:{shortcuts:a}}))}updateShortcuts(a,b,c){const d=this.getShortcuts();b=~b?b:d[a].length;d[a][b]=c;this.renderShortcuts(d);this.dispatchEvent(new CustomEvent("shortcuts_updated",{detail:{shortcuts:d}}))}formatShortcut(a){if(!a)return"\u00a0";const b=document.createElement("div");Array.isArray(a)||(a=Array.from(a));for(let c=0;c<a.length;c++)if(b.append(this.formatKey(a[c])),c<a.length-1){const d=document.createElement("span");d.textContent=" + ";b.appendChild(d)}return b.innerHTML}formatKey(a){if(a.startsWith("Key"))return a.slice(3);
if(a.startsWith("Digit"))return a.slice(5);if(a.startsWith("Numpad")){var b=a.slice(6);return`${GPShortcutsManager_.KEY_ALIASES[b]??b} (Numpad)`}if(a in GPShortcutsManager_.KEY_ALIASES)return GPShortcutsManager_.KEY_ALIASES[a];const c=a.endsWith("Left")?"Left":a.endsWith("Right")?"Right":"";return c?(b="Right"===c,a=a.slice(0,-c.length),a in GPShortcutsManager_.KEY_ALIASES&&(a=GPShortcutsManager_.KEY_ALIASES[a]),b?`${a} (Right)`:a):a}buildKeysMap(a){const b=this.painter.getTools(),c={};for(let d in a)b[d]&&
a[d].forEach(e=>{const f=e.length;c[f]=c[f]||[];c[f].push({name:d,keys:e,...b[d]})});return c}updateShortcutsHandler(a){this.shortcuts=a;this.keysMap=this.buildKeysMap(a);this.saveShortcuts(a)}getShortcuts(){return window.structuredClone(this.shortcuts)}getDefaultShortcuts(){return window.structuredClone(GPShortcutsManager_.DEFAULT_SHORTCUTS)}getShortcutsKeys(a,b){return this.shortcuts[a]?.[b]||null}findShortcut2(a){if(!this.keysMap[a.size])return null;let b;return this.keysMap[a.size].some(({name:c,
keys:d})=>{b=c;const e=a.values();return d.every(f=>f===e.next().value)})?b:null}saveShortcuts(a){localStorage.setItem(GPShortcutsManager_.SHORTCUTS_STORAGE,JSON.stringify(a))}areKeysLocked(){return this.keysLocked}}window.GPShortcutsManager_=GPShortcutsManager_;class GPZoomer_ extends EventTarget{static ANIMATION_DURATION=.1;static ANIMATION_EASING="ease-out";static MIN_VISIBLE_PADDING=50;static MIN_SCALE=.5;static MAX_SCALE=3;static ZOOM_TO_POINT_SCALE=2;static ZOOM_STEP=.5;static MOVE_STEP=20;constructor({viewport:a,rotator:b,content:c},d={}){super();this.viewport=a;this.content=c;this.content.addEventListener("transitionend",e=>{e.target===e.currentTarget&&this.dispatchScale()});this.rotator=b;this.rotator.addEventListener("transitionend",e=>{e.target===
e.currentTarget&&this.dispatchRotation()});this.scale=1;this.rotation=this.positionY=this.positionX=0;this.containerScale=1;this.minScale=d.minScale??GPZoomer_.MIN_SCALE;this.maxScale=d.maxScale??GPZoomer_.MAX_SCALE;this.zoomToPointScale=d.zoomToPointScale??GPZoomer_.ZOOM_TO_POINT_SCALE;this.zoomStep=d.zoomStep??GPZoomer_.ZOOM_STEP;this.moveStep=d.moveStep??GPZoomer_.MOVE_STEP;this.updateTransform(!1)}zoom(a,b,c,d=!0){var e=this.viewport.getBoundingClientRect();b=(b-e.left)/this.containerScale;c=
(c-e.top)/this.containerScale;if(this.rotation%360){var f=this.rotation*Math.PI/180;const g=Math.cos(f);f=Math.sin(f);const h=e.width/2/this.containerScale,k=e.height/2/this.containerScale;e=g*(b-h)+f*(c-k)+h;b=-f*(b-h)+g*(c-k)+k}else e=b,b=c;c=this.scale;this.scale=Math.min(this.maxScale,Math.max(this.minScale,this.scale+a));a=this.scale/c;this.positionX=e-(e-this.positionX)*a;this.positionY=b-(b-this.positionY)*a;this.updateTransform(d);d||this.dispatchScale()}zoomToPoint(a,b,c,d=!0){var e=this.viewport.getBoundingClientRect(),
f=(b-e.left)/this.containerScale,g=(c-e.top)/this.containerScale;if(this.rotation%360){c=this.rotation*Math.PI/180;var h=Math.cos(c);const k=Math.sin(c),l=e.width/2/this.containerScale;e=e.height/2/this.containerScale;c=h*(f-l)+k*(g-e)+l;b=-k*(f-l)+h*(g-e)+e;f=l-f;g=e-g;e=f*h+g*k;g=-f*k+g*h}else c=f,b=g,h=e.height/2/this.containerScale,e=e.width/2/this.containerScale-f,g=h-g;h=this.scale;this.scale=Math.min(this.maxScale,Math.max(this.minScale,a));a=this.scale/h;this.positionX=c-(c-this.positionX)*
a;this.positionY=b-(b-this.positionY)*a;this.positionX+=e;this.positionY+=g;this.updateTransform(d);d||this.dispatchScale()}zoomIn(a=!0){const b=this.viewport.getBoundingClientRect();this.zoom(this.zoomStep,b.left+b.width/2,b.top+b.height/2,a)}zoomOut(a=!0){const b=this.viewport.getBoundingClientRect();this.zoom(-this.zoomStep,b.left+b.width/2,b.top+b.height/2,a)}pan(a,b,c=!1){if(this.rotation%360){var d=this.rotation*Math.PI/180;const g=Math.cos(d),h=Math.sin(d);d=(-a*h+b*g)/this.containerScale;
a=this.positionX+(a*g+b*h)/this.containerScale;b=this.positionY+d}else a=this.positionX+a/this.containerScale,b=this.positionY+b/this.containerScale;const [e,f]=this.applyViewportBounds(a,b,this.scale);this.positionX=e;this.positionY=f;this.updateTransform(c)}moveUp(a=!0){this.pan(0,-GPZoomer_.MOVE_STEP,a)}moveDown(a=!0){this.pan(0,GPZoomer_.MOVE_STEP,a)}moveLeft(a=!0){this.pan(-GPZoomer_.MOVE_STEP,0,a)}moveRight(a=!0){this.pan(GPZoomer_.MOVE_STEP,0,a)}rotate(a,b=!0){this.rotation+=a;this.updateTransform(b);
b||this.dispatchRotation()}reset(a=!0){const b=360*Math.round(this.rotation/360),c=1!==this.scale,d=this.rotation!==b;this.scale=1;this.positionY=this.positionX=0;this.rotation=b;this.updateTransform(a);a||(c&&this.dispatchScale(),d&&this.dispatchRotation())}resetScale(a=!0){const b=1!==this.scale;this.scale=1;this.positionY=this.positionX=0;this.updateTransform(a);a||b&&this.dispatchScale()}resetRotation(a=!0){const b=360*Math.round(this.rotation/360),c=this.rotation!==b;this.rotation=b;this.updateTransform(a);
a||c&&this.dispatchRotation()}setContainerScale(a){this.containerScale=a}getScale(){return this.scale}getRotation(){return(this.rotation%360+360)%360}getCoords(a){var b=this.viewport.getBoundingClientRect();if(a.touches){var c=a.touches[0].clientX;a=a.touches[0].clientY}else c=a.clientX,a=a.clientY;c=(c-b.left)/this.containerScale;a=(a-b.top)/this.containerScale;var d=c,e=a;if(this.rotation%360){d=b.width/2/this.containerScale;b=b.height/2/this.containerScale;var f=-this.rotation*Math.PI/180;e=Math.cos(f);
f=Math.sin(f);c-=d;a-=b;d=d+c*e-a*f;e=b+c*f+a*e}return[Math.round((d-this.positionX)/this.scale),Math.round((e-this.positionY)/this.scale)]}getMinScale(){return this.minScale}setMinScale(a){this.minScale=a}getMaxScale(){return this.maxScale}setMaxScale(a){this.maxScale=a}getState(){return{scale:this.scale,positionX:this.positionX,positionY:this.positionY,rotation:this.rotation}}setState({scale:a,positionX:b,positionY:c,rotation:d},e=!1){this.scale=a??this.scale;this.positionX=b??this.positionX;this.positionY=
c??this.positionY;this.rotation=d??this.rotation;this.updateTransform(e)}applyViewportBounds(a,b){var c=GPZoomer_.MIN_VISIBLE_PADDING,d=this.content.offsetWidth===this.viewport.offsetWidth?this.content:this.content.firstElementChild;if(!(this.rotation%360)||0!==c){const e=this.viewport.offsetWidth,f=this.viewport.offsetHeight,g=d.offsetWidth*this.scale,h=d.offsetHeight*this.scale,k=d.offsetLeft*this.scale;d=d.offsetTop*this.scale;const l=e-c-k,m=c-g-k,p=f-c-d;c=c-h-d;a=Math.min(l,Math.max(m,a));b=
Math.min(p,Math.max(c,b));m>l&&(a=(e-g)/2-k);c>p&&(b=(f-h)/2-d);return[a,b]}return[a,b]}applyTransition(a){this.content.style.transition=this.rotator.style.transition=a?`transform ${GPZoomer_.ANIMATION_DURATION}s ${GPZoomer_.ANIMATION_EASING}`:"none"}updateTransform(a=!0){this.applyTransition(a);this.content.style.transformOrigin="0 0";this.content.style.transform=`translate(${this.positionX}px, ${this.positionY}px) scale(${this.scale})`;this.rotator.style.transform=`rotate(${this.rotation}deg)`}dispatchScale(){this.dispatchEvent(new CustomEvent("scale",
{detail:{scale:this.scale}}))}dispatchRotation(){this.dispatchEvent(new CustomEvent("rotation",{detail:{rotation:this.getRotation()}}))}}window.GPZoomer_=GPZoomer_;class GPReference_ extends EventTarget{static CONTAINER_HEIGHT=698;static CONTAINER_MIN_WIDTH=256;static QUERY_INPUT_HEIGHT=56;static BORDER_SIZE=4;static PREVIEW_MAX_HEIGHT=180;static DEFAULT_COLUMNS_COUNT=4;static RESULTS_COLUMN_MIN_WIDTH=125;static ALIGNMENT_ICONS={center:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23dee0ed' viewBox='0 0 13 13'%3E%3Crect width='3' height='6' x='2' y='3.5' rx='1'/%3E%3Crect width='3' height='6' x='8' y='3.5' rx='1'/%3E%3Cpath d='M6 1h1v11H6z'/%3E%3C/svg%3E",
"flex-start":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23dee0ed' viewBox='0 0 13 13'%3E%3Crect width='3' height='6' x='6' y='3.5' rx='1'/%3E%3Crect width='3' height='6' x='2' y='3.5' rx='1'/%3E%3Cpath d='M1 1h1v11H1z'/%3E%3C/svg%3E","flex-end":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23dee0ed' viewBox='0 0 13 13'%3E%3Crect width='3' height='6' transform='scale(-1,1)' rx='1' y='3.5' x='-7'/%3E%3Crect width='3' height='6' transform='scale(-1,1)' rx='1' y='3.5' x='-11'/%3E%3Cpath d='m12 1h-1v11h1z'/%3E%3C/svg%3E",
"space-between":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23dee0ed' viewBox='0 0 13 13'%3E%3Crect width='3' height='6' x='8' y='3.5' rx='1'/%3E%3Crect width='3' height='6' x='2' y='3.5' rx='1'/%3E%3Cpath d='M1 1h1v11H1zM11 1h1v11h-1z'/%3E%3C/svg%3E","space-around":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23dee0ed' viewBox='0 0 13 13'%3E%3Crect width='3' height='6' x='7.25' y='3.5' rx='1'/%3E%3Crect width='3' height='6' x='2.75' y='3.5' rx='1'/%3E%3Cpath d='M1 1h1v11H1zM11 1h1v11h-1z'/%3E%3C/svg%3E",
"space-evenly":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23dee0ed' viewBox='0 0 13 13'%3E%3Crect width='3' height='6' x='7' y='3.5' rx='1'/%3E%3Crect width='3' height='6' x='3' y='3.5' rx='1'/%3E%3Cpath d='M1 1h1v11H1zM11 1h1v11h-1z'/%3E%3C/svg%3E"};static URL_PATTERN=/^https?:\/\/\w/;static IMAGE_TYPES=new Set("image/jpeg image/png image/gif image/webp image/svg+xml image/bmp image/avif".split(" "));static SVG_TYPE="image/svg+xml";static SEARCH_ENGINES={GOOGLE:"google",
PINTEREST:"pinterest",UNSPLASH:"unsplash"};static INTERFACE_ALIGNMENT={CENTER:"center",RIGHT:"flex-start",LEFT:"flex-end",SPACE_BETWEEN:"space-between",SPACE_AROUND:"space-around",SPACE_EVENLY:"space-evenly"};static DEFAULT_SETTINGS={enabled:!1,searchEngine:this.SEARCH_ENGINES.GOOGLE,interfaceAlignment:this.INTERFACE_ALIGNMENT.CENTER,containerMaxWidth:"none",stretchImage:!1,minZoom:1,maxZoom:30,zoomStep:.5,frameStickyEdges:!0,frameStickyEdgesDistance:15,frameSeparateOpacity:!1,frameWidth:284,framePos:{x:0,
y:0},frameAnchor:"tl",googleRequestTimeout:5E3};static SETTINGS_UI={interfaceAlignment:{type:"list-icons",args:{icons:this.ALIGNMENT_ICONS},description:"\u0412\u044b\u0440\u0430\u0432\u043d\u0438\u0432\u0430\u043d\u0438\u0435 \u043e\u043a\u043e\u043d \u043c\u043e\u0434\u0443\u043b\u0435\u0439 Reference \u0438 Painter \u043e\u0442\u043d\u043e\u0441\u0438\u0442\u0435\u043b\u044c\u043d\u043e \u043e\u043a\u043d\u0430 \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0430"},_1:{text:"Image"},minZoom:{type:"slider",
args:{min:.1,max:1,step:.1},description:"\u041c\u0438\u043d\u0438\u043c\u0430\u043b\u044c\u043d\u044b\u0439 \u0443\u0440\u043e\u0432\u0435\u043d\u044c \u043c\u0430\u0441\u0448\u0442\u0430\u0431\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f \u0440\u0435\u0444\u0435\u0440\u0435\u043d\u0441\u0430"},maxZoom:{type:"slider",args:{min:2,max:60,step:1},description:"\u041c\u0430\u043a\u0441\u0438\u043c\u0430\u043b\u044c\u043d\u044b\u0439 \u0443\u0440\u043e\u0432\u0435\u043d\u044c \u043c\u0430\u0441\u0448\u0442\u0430\u0431\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f \u0440\u0435\u0444\u0435\u0440\u0435\u043d\u0441\u0430"},
zoomStep:{type:"slider",args:{min:.1,max:2,step:.1},description:"\u041a\u043e\u044d\u0444\u0444\u0438\u0446\u0438\u0435\u043d\u0442 \u043c\u0430\u0441\u0448\u0442\u0430\u0431\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f \u0440\u0435\u0444\u0435\u0440\u0435\u043d\u0441\u0430 \u043f\u0440\u0438 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u0438 \u043a\u043e\u043b\u0435\u0441\u0430 \u043c\u044b\u0448\u0438"},_2:{text:"Frames"},frameStickyEdges:{type:"switch",description:"\u041f\u0440\u0438\u0442\u044f\u0433\u0438\u0432\u0430\u0442\u044c\u0441\u044f \u043a \u043a\u0440\u0430\u044f\u043c \u0434\u0440\u0443\u0433\u0438\u0445 \u0444\u0440\u0435\u0439\u043c\u043e\u0432 \u043f\u0440\u0438 \u043f\u0435\u0440\u0435\u043c\u0435\u0449\u0435\u043d\u0438\u0438 \u0444\u0440\u0435\u0439\u043c\u0430"},
frameStickyEdgesDistance:{type:"slider",args:{min:5,max:40,step:1},description:"\u0414\u0438\u0441\u0442\u0430\u043d\u0446\u0438\u044f \u043f\u0440\u0438\u0442\u044f\u0433\u0438\u0432\u0430\u043d\u0438\u044f \u043a \u0444\u0440\u0435\u0439\u043c\u0430\u043c"},frameSeparateOpacity:{type:"switch",description:"\u0420\u0430\u0437\u0434\u0435\u043b\u044c\u043d\u044b\u0435 \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438 \u043f\u0440\u043e\u0437\u0440\u0430\u0447\u043d\u043e\u0441\u0442\u0438 \u0434\u043b\u044f \u043a\u0430\u0436\u0434\u043e\u0433\u043e \u0444\u0440\u0435\u0439\u043c\u0430"},
_3:{text:"Google Images"},googleRequestTimeout:{type:"slider",args:{min:0,max:6E4,step:1E3},formatter:this.requestTimeoutFormatter,description:"\u0412\u0440\u0435\u043c\u044f \u0432 \u0441\u0435\u043a\u0443\u043d\u0434\u0430\u0445, \u043f\u043e \u0438\u0441\u0442\u0435\u0447\u0435\u043d\u0438\u0438 \u043a\u043e\u0442\u043e\u0440\u043e\u0433\u043e \u0437\u0430\u043f\u0440\u043e\u0441 \u0431\u0443\u0434\u0435\u0442 \u043f\u0440\u0435\u0440\u0432\u0430\u043d\n\u0418\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044f \u0432 Google Images \u0440\u0430\u0441\u043f\u043e\u043b\u0430\u0433\u0430\u044e\u0442\u0441\u044f \u043d\u0430 \u0441\u0432\u043e\u0438\u0445 \u0441\u043e\u0431\u0441\u0442\u0432\u0435\u043d\u043d\u044b\u0445 \u0441\u0435\u0440\u0432\u0435\u0440\u0430\u0445, \u043a\u043e\u0442\u043e\u0440\u044b\u0435 \u043c\u043e\u0433\u0443\u0442 \u0431\u044b\u0442\u044c \u043d\u0435\u0434\u043e\u0441\u0442\u0443\u043f\u043d\u044b \u0438\u043b\u0438 \u0437\u0430\u0431\u043b\u043e\u043a\u0438\u0440\u043e\u0432\u0430\u043d\u044b (\u0441\u043e \u0441\u0442\u043e\u0440\u043e\u043d\u044b \u043f\u0440\u043e\u0432\u0430\u0439\u0434\u0435\u0440\u0430 \u0438\u043b\u0438 \u0441\u043e \u0441\u0442\u043e\u0440\u043e\u043d\u044b \u0441\u0430\u043c\u043e\u0433\u043e \u0441\u0435\u0440\u0432\u0435\u0440\u0430). \u0412\u0440\u0435\u043c\u044f \u0442\u0430\u0439\u043c\u0430\u0443\u0442\u0430 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u044f\u0435\u0442, \u0447\u0435\u0440\u0435\u0437 \u043a\u0430\u043a\u043e\u0435 \u0432\u0440\u0435\u043c\u044f (\u0432 \u0441\u0435\u043a\u0443\u043d\u0434\u0430\u0445) \u043f\u0440\u0435\u043a\u0440\u0430\u0449\u0430\u0442\u044c \u043f\u043e\u043f\u044b\u0442\u043a\u0438 \u0437\u0430\u043f\u0440\u043e\u0441\u0430 \u0438 \u043e\u0442\u043a\u0440\u044b\u0432\u0430\u0442\u044c \u043f\u0440\u0435\u0432\u044c\u044e \u0432\u043c\u0435\u0441\u0442\u043e \u043d\u0435\u0434\u043e\u0441\u0442\u0443\u043f\u043d\u043e\u0433\u043e \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044f."}};static requestTimeoutFormatter(a){return`${Math.round(a/
1E3)}`}static MODULE={title:"Reference",alias:"ref",settings:{storage:"gp_reference",defaultSettings:this.DEFAULT_SETTINGS,ui:this.SETTINGS_UI},useCSS:!0};constructor(a){super();this.prx=a.prx;this.s=a.sm.setSettings(this,this.updateSettings);this.history=new Map;this.searchData=this.pendingSearch=this.pendingImage=this.lastQuery=null;this.isRefOpened=this.isLastPage=!1;this.scrollPos=0;this.resizeStartX;this.resizeInitialWidth;this.resizeTimer;this.isReRenderNeeded=this.isResizing=!1;this.firstRenderTimer=
null;this.columns=[];this.columnsCount=GPReference_.DEFAULT_COLUMNS_COUNT;this.cropper=this.lastColumnsCount=null;this.isCropping=!1;this.fm=new GPReferenceFrameManager_(document.getElementById("content"),this.s.frameStickyEdges,this.s.frameStickyEdgesDistance,GPReferenceFrameManager_.DEFAULT_STATIC_ANCHOR,this.s.frameSeparateOpacity,GPReferenceFrame_.DEFAULT_OPACITY,this.s.frameWidth,this.s.framePos,this.s.frameAnchor);this.addEventListener("settings_updated",this.emitSettings);this.fm.addEventListener("size",
({detail:{width:b}})=>{this.s.frameWidth=b});this.fm.addEventListener("pos",({detail:{x:b,y:c}})=>{this.s.framePos={x:b,y:c}});this.fm.addEventListener("anchor",({detail:{anchor:b}})=>{this.s.frameAnchor=b});GPUtils_.bindMethods([this.downloadImage,this.onScroll,this.openImage,this.closeImage,this.onImageWheel,this.onImageDown,this.onImageMDown,this.onImageClick,this.onImageMove,this.onImageDblClick,this.resizeDown,this.resizeMove,this.resizeUp,this.resizeDblClick,this.handleResizeWindow,this.onResize],
this);document.addEventListener("gp:ref.progress",({detail:{percentage:b}})=>{this.updateProgress(b)});document.addEventListener("gp:ref.search_results",({detail:{images:b,isLastPage:c,isFirstPage:d,searchEngine:e,query:f}})=>{e===this.pendingSearch&&(this.searchData=d?b:[...this.searchData,...b],this.pendingSearch=null,this.isLastPage=c,this.renderImages({images:b,isFirstPage:d,query:f}),this.hideProgress())});document.addEventListener("gp:ref.search_error",b=>{this.pendingSearch=null;this.hideProgress()});
document.addEventListener("gp:ref.image_complete",({detail:{base64:b,width:c,height:d,url:e,query:f,type:g,isFromHistory:h,inFrame:k,openInBg:l}})=>{if(k)this.base64ToBlob(b).then(m=>{this.openFrame(m,l)});else{if(e!==this.pendingImage)return;h||this.addToHistory(e,c,d,f);this.pendingImage=null;this.showPreview(b,c,d,{query:f,type:g,url:e})}this.hideProgress()});document.addEventListener("gp:ref.image_complete",()=>{this.historyBtn.removeAttribute("hidden")},{once:!0});document.addEventListener("gp:ref.image_error",
({detail:{previewURL:b,width:c,height:d,query:e,isFromHistory:f,inFrame:g,openInBg:h}})=>{b?this.downloadImage(b,c,d,e,null,f,g,h):g||(this.pendingImage=null);this.hideProgress()});this.prx.addEventListener("turn_started",b=>{this.container&&(this.container.classList.remove("no-animation-delay_"),this.isLastPage=this.isRefOpened=!1,this.lastQuery=this.lastColumnsCount=null,this.queryInput.value="",this.scrollPos=0,this.searchData=null,this.results.innerHTML="",delete this.results.dataset.query,this.fm.clear())});
this.prx.addEventListener("turns_ended",b=>{this.fm.clear()});this.createPainterBtn();this.emitSettings()}toggle(a){this.s.enabled=a??!document.getElementById("__next")?.classList.contains("gp-reference-rendered_");this.s.enabled?this.enable():this.disable()}enable(){document.getElementById("__next").classList.add("gp-reference-rendered_");clearTimeout(this.firstRenderTimer);this.firstRenderTimer=setTimeout(()=>{const a=this.columnsCount;this.calculateColumnsCount();this.columnsCount!==a&&this.renderImages({images:this.searchData,
isFirstPage:!0,query:this.results.dataset.query})},400);this.dispatchEvent(new Event("state_changed"))}disable(){document.getElementById("__next").classList.remove("gp-reference-rendered_");clearTimeout(this.firstRenderTimer);this.dispatchEvent(new Event("state_changed"))}init(){this.container||this.render();window.addEventListener("resize",this.handleResizeWindow);this.screen=document.querySelector("#content > .screen");this.screen.before(this.container);this.s.enabled?this.enable():this.disable()}terminate(){this.container&&
(this.pendingSearch=this.pendingImage=null,this.isReRenderNeeded=this.isResizing=!1,this.container.remove(),window.removeEventListener("resize",this.handleResizeWindow),this.disable())}reset(){this.container&&(this.container.classList.remove("image-opened_"),this.zoomer.reset())}render(){this.container=document.createElement("div");this.container.className="gp-reference_";this.style=this.container.style;this.style.setProperty("--gp-ref-max-width",`${this.s.containerMaxWidth}`);this.style.setProperty("--gp-ref-column-flex",
`${Math.floor(100/this.columnsCount)}%`);document.documentElement.style.setProperty("--gp-ref-alignment",`${this.s.interfaceAlignment}`);var a=this.container;a.addEventListener("drop",async e=>{e.preventDefault();let f;e.dataTransfer.items&&"file"===e.dataTransfer.items[0].kind?f=e.dataTransfer.items[0].getAsFile():e.dataTransfer.files.length&&(f=e.dataTransfer.files[0]);if(f&&GPReference_.IMAGE_TYPES.has(f.type)){const g=new FileReader;g.addEventListener("loadend",h=>{this.showPreview(g.result,0,
0,{query:"file",type:f.type})});g.readAsDataURL(f)}},!0);a.addEventListener("dragover",e=>{e.preventDefault();e.dataTransfer.dropEffect="move"},!0);a=document.createElement("div");a.className="wrapper_";this.container.appendChild(a);var b=document.createElement("div");b.className="header_";b.addEventListener("animationend",e=>{"gp-ref-fade-out_"===e.animationName&&this.style.setProperty("--gp-ref-progress","0%")});b.addEventListener("pointerleave",e=>{this.historyList.classList.remove("shown_")});
a.appendChild(b);this.queryInput=document.createElement("input");this.queryInput.className="query_";this.queryInput.setAttribute("spellcheck","false");this.queryInput.setAttribute("autocomplete","off");this.queryInput.addEventListener("keydown",e=>{if("Enter"===e.key){const f=e.target.value.trim();GPReference_.URL_PATTERN.test(f)?this.openImageURL(f):f&&(this.lastQuery=f,this.searchImages(f,!1));e.target.blur()}else"Escape"===e.key&&e.target.blur()});GPUtils_.setInputFocusBlurHandler(this.queryInput);
b.appendChild(this.queryInput);this.historyBtn=document.createElement("div");this.historyBtn.className="history-btn_";this.historyBtn.setAttribute("hidden","");this.historyBtn.addEventListener("pointerdown",e=>{0===e.button&&this.history.size&&(this.historyList.classList.toggle("shown_"),this.historyList.scrollTop=0)});b.appendChild(this.historyBtn);this.historyList=document.createElement("div");this.historyList.className="history-list_";this.historyList.addEventListener("pointerup",e=>{if(e=e.target.closest(".history-item_")){var {url:f,
width:g,height:h,query:k}=e.dataset;this.downloadImage(f,g,h,k,null,!0);this.historyList.classList.remove("shown_")}});b.appendChild(this.historyList);this.searchEnginesMenu=document.createElement("div");this.searchEnginesMenu.className="search-engines-menu_";b.appendChild(this.searchEnginesMenu);this.searchEngines=document.createElement("div");this.searchEngines.className="search-engines_";this.searchEngines.addEventListener("pointerdown",e=>{0===e.button&&(this.searchEngines.classList.contains("shown_")?
e.target===this.searchEngines&&this.searchEngines.classList.remove("shown_"):this.searchEngines.classList.add("shown_"))});this.searchEngines.addEventListener("click",e=>{e.target.matches(".search-engine_.selected_")&&this.searchEngines.classList.remove("shown_")});this.searchEngines.addEventListener("pointerup",e=>{if(e.target.classList.contains("search-engine_")){var f=e.target.dataset.searchEngine;if(f!==this.s.searchEngine){this.s.searchEngine=f;const g=this.queryInput.value.trim();this.searchByEngine(g,
f);Array.from(this.searchEngines.children).forEach(h=>{h.style.order=+(h!==e.target)});this.searchEngines.classList.remove("shown_");this.searchEngines.title=e.target.title}}});Object.values(GPReference_.SEARCH_ENGINES).forEach(e=>{const f=document.createElement("div");f.className=`search-engine_ ${e}_`;f.title=e[0].toUpperCase()+e.slice(1);f.dataset.searchEngine=e;this.searchEngines.appendChild(f)});b=this.searchEngines.querySelector(`[data-search-engine="${this.s.searchEngine}"]`);b.classList.add("selected_");
this.searchEngines.title=b.title;this.searchEnginesMenu.appendChild(this.searchEngines);Array.from(this.searchEngines.children).forEach(e=>{e.style.order=+(e.dataset.searchEngine!==this.s.searchEngine)});this.results=document.createElement("div");this.results.className="results_";this.results.addEventListener("click",this.openImage);this.results.addEventListener("scroll",this.onScroll);this.results.addEventListener("contextmenu",this.blockContextMenu);a.appendChild(this.results);this.imageObserver=
new IntersectionObserver(e=>{e.forEach(f=>{f.isIntersecting&&(f=f.target,f.src=f.dataset.src,this.imageObserver.unobserve(f))})},{root:this.results});this.imageWrapper=document.createElement("div");this.imageWrapper.className="image-wrapper_";this.imageWrapper.addEventListener("wheel",this.onImageWheel);this.imageWrapper.addEventListener("pointerdown",this.onImageDown);this.imageWrapper.addEventListener("mousedown",this.onImageMDown);this.imageWrapper.addEventListener("click",this.onImageClick);this.imageWrapper.addEventListener("dblclick",
this.onImageDblClick);this.imageWrapper.addEventListener("contextmenu",this.blockContextMenu);a.appendChild(this.imageWrapper);b=document.createElement("div");b.className="rotator_";this.imageWrapper.appendChild(b);const c=document.createElement("div");c.className="content_";b.appendChild(c);this.image=document.createElement("img");this.image.className="image_";this.image.addEventListener("load",e=>{this.calculateAnchor()});c.appendChild(this.image);const d=document.createElement("div");d.className=
"close-btn_";d.innerHTML='<svg viewBox="0 0 98 98" stroke-linejoin="round"><path stroke-width="2" stroke="currentColor" fill="currentColor" filter="drop-shadow(2px 2px 0px rgb(32 33 36 / 60%))" d="M78.2 23.3 75 20.1 48.7 46.4 22.5 20.1l-3.3 3.2 26.3 26.3-27.2 27.2 3.2 3.3 27.2-27.3L76 80.1l3.2-3.3L52 49.6l26.2-26.3z"/></svg>';d.addEventListener("click",e=>{this.closeImage()});this.imageWrapper.appendChild(d);this.zoomer=new GPZoomer_({viewport:this.imageWrapper,rotator:b,content:c},{minScale:this.s.minZoom,
maxScale:this.s.maxZoom});b=document.createElement("div");b.className="resizer_ left_";b.dataset.dir="left";b.addEventListener("pointerdown",this.resizeDown);b.addEventListener("pointerup",this.resizeUp);b.addEventListener("dblclick",this.resizeDblClick);a.appendChild(b);b=document.createElement("div");b.className="resizer_ right_";b.dataset.dir="right";b.addEventListener("pointerdown",this.resizeDown);b.addEventListener("pointerup",this.resizeUp);b.addEventListener("dblclick",this.resizeDblClick);
a.appendChild(b)}createPainterBtn(){this.painterBtn=document.createElement("button");this.painterBtn.className="gp-reference-btn_";this.painterBtn.addEventListener("click",()=>{this.container.classList.toggle("no-animation-delay_",!this.s.enabled);this.toggle()})}searchByEngine(a,b){a&&(this.lastQuery=a,this.searchImages(a,!1));(a=this.searchEngines.querySelector(".selected_"))&&a.classList.remove("selected_");this.searchEngines.querySelector(`[data-search-engine=${b}]`).classList.add("selected_")}searchImages(a,
b){a&&(this.pendingImage=null,this.pendingSearch=this.s.searchEngine,this.abortImageRequest(),document.dispatchEvent(new CustomEvent("gp:ref.search",{detail:{searchEngine:this.s.searchEngine,next:!!b,query:a}})),this.container.classList.add("progress_"),this.container.classList.remove("complete_"),this.closeImage())}abortImageRequest(){document.dispatchEvent(new Event("gp:ref.about_image"))}renderImages({images:a,isFirstPage:b,query:c,scrollPos:d}){if(a?.length){var e=Array(this.columnsCount).fill(0),
f=Array(this.columnsCount).fill().map(()=>document.createDocumentFragment());if(b)for(this.results.innerHTML="",this.results.scrollTop=0,this.results.dataset.query=c,this.columns=[],b=0;b<this.columnsCount;b++){const g=document.createElement("div");g.className="column_";g.dataset.index=`${b}`;this.columns[b]=g;this.results.appendChild(g)}else e.map((g,h)=>+this.columns[h].dataset.height);a.forEach(g=>{var h=g.image.width/g.image.height;const k=document.createElement("div");k.className="preview_";
k.style.backgroundColor=g.dominantColor;k.dataset.url=g.image.url;k.dataset.previewURL=g.preview.url;k.dataset.width=g.image.width;k.dataset.height=g.image.height;k.dataset.aspectRatio=h;const l=new Image;l.width=h*GPReference_.PREVIEW_MAX_HEIGHT;l.height=GPReference_.PREVIEW_MAX_HEIGHT;l.referrerPolicy="no-referrer";l.dataset.src=g.preview.url;k.appendChild(l);this.imageObserver.observe(l);h=this.getMinHeightColumnIndex(e);f[h].appendChild(k);e[h]+=g.image.height/g.image.width});this.columns.forEach((g,
h)=>{g.dataset.height=e[h];g.appendChild(f[h])});a=!!this.results.getBoundingClientRect().height;void 0!==d&&setTimeout(()=>{this.results.scrollTop=d},a?0:500);a&&setTimeout(()=>{this.isNextPageNeeded()&&this.searchImages(c,!0)},a?0:500)}}getMinHeightColumnIndex(a){return a.reduce((b,c,d,e)=>c<e[b]?d:b,0)}isNextPageNeeded(){return!this.isLastPage&&!this.pendingSearch&&this.columns.some(a=>{const b=this.results.scrollTop,c=this.results.getBoundingClientRect().height;a=a.getBoundingClientRect().height;
return b+c>=a})}calculateColumnsCount(a){a=a||this.results.getBoundingClientRect().width||this.imageWrapper.getBoundingClientRect().width;this.columnsCount=Math.floor(a/GPReference_.RESULTS_COLUMN_MIN_WIDTH);this.style.setProperty("--gp-ref-column-flex",`${Math.floor(100/this.columnsCount)}%`)}onScroll(){!this.isResizing&&this.isNextPageNeeded()&&this.searchImages(this.lastQuery,!0);this.scrollPos=this.results.scrollTop}updateProgress(a){this.container.classList.toggle("progress_",!~a);this.style.setProperty("--gp-ref-progress",
`${a}%`)}hideProgress(){this.container.classList.remove("progress_");this.container.classList.add("complete_")}downloadImage(a,b,c,d,e,f,g,h){this.pendingImage=a;document.dispatchEvent(new CustomEvent("gp:ref.image",{detail:{searchEngine:this.s.searchEngine,url:a,width:b,height:c,query:d,previewURL:e,isFromHistory:f,inFrame:g,openInBg:h}}));this.container.classList.add("progress_");this.container.classList.remove("complete_")}async showPreview(a,b,c,{query:d,type:e,url:f}){b&&c||([b,c]=await this.getImageDimensions(a));
this.image.metadata={base64:a,query:d,type:e,url:f};this.image.style.setProperty("--gp-ref-img-width","100%");this.image.style.setProperty("--gp-ref-img-height","100%");this.image.src=a;this.container.classList.add("image-opened_");this.imageWidth=b;this.imageHeight=c;(a=this.history.get(f)?.pos)?this.zoomer.setState(a):this.zoomer.reset();this.isRefOpened=!0}async getImageDimensions(a){return new Promise((b,c)=>{const d=new Image;d.onload=()=>{b([d.naturalWidth,d.naturalHeight])};d.onerror=c;d.src=
a})}onImageDown(a){switch(a.button){case 0:a.ctrlKey&&!a.shiftKey?this.saveImage():a.shiftKey?this.cropImage(a):this.moveImage(a);break;case 1:this.zoomer.reset(),this.updateHistoryState()}}onImageMDown(a){2===a.button&&(this.isCropping?(this.isCropping=!1,this.cropper.remove()):document.addEventListener("mouseup",b=>{b.target===this.imageWrapper&&this.closeImage()},{once:!0}))}onImageClick(a){0===a.button&&2===a.buttons&&(this.base64ToBlob(this.image.metadata.base64).then(b=>{this.openFrame(b,a.ctrlKey)}),
document.addEventListener("contextmenu",b=>{b.preventDefault()},{once:!0}))}moveImage(a){const b=this.onImageMove(a);a.target.setPointerCapture(a.pointerId);a.target.addEventListener("pointermove",b);a.target.addEventListener("pointerup",c=>{c.target.removeEventListener("pointermove",b);this.updateHistoryState()},{once:!0});b(a)}cropImage(a){if(a.target===this.imageWrapper&&this.image.metadata.type!==GPReference_.SVG_TYPE){this.cropper=document.createElement("div");this.cropper.className="gp-ref-cropper_";
document.body.appendChild(this.cropper);var b=a.pageX,c=a.pageY,[,d]=this.getContainedImageSize(this.image),e=this.image.getBoundingClientRect(),f=d===e.height?e.height/this.image.naturalHeight:e.width/this.image.naturalWidth,g=Math.round(a.clientX-e.x)/f,h=Math.round(a.clientY-e.y)/f;this.isCropping=!0;var k=(l=>{this.isCropping||this.image.removeEventListener("pointermove",k);const m=Math.min(b,l.pageX),p=Math.min(c,l.pageY),r=Math.max(b,l.pageX);l=Math.max(c,l.pageY);this.cropper.style.left=`${m}px`;
this.cropper.style.top=`${p}px`;this.cropper.style.width=`${r-m}px`;this.cropper.style.height=`${l-p}px`}).bind(this);this.image.setPointerCapture(a.pointerId);this.image.addEventListener("pointermove",k);this.image.addEventListener("pointerup",l=>{this.image.removeEventListener("pointermove",k);this.cropper.remove();this.cropper=null;this.isCropping&&this.getCroppedImage(g,h,Math.round(l.clientX-e.x)/f,Math.round(l.clientY-e.y)/f).then(m=>{m&&this.openFrame(m,l.ctrlKey)});this.isCropping=!1},{once:!0})}}calculateAnchor(){this.getContainedImageSize(this.image);
this.image.style.setProperty("--gp-ref-img-width","unset");this.image.style.setProperty("--gp-ref-img-height","unset")}getContainedImageSize(a){const b=a.naturalWidth/a.naturalHeight;let c=a.height*b,d=a.height;c>a.width&&(c=a.width,d=a.width/b);return[Math.ceil(c),Math.ceil(d)]}getCroppedImage(a,b,c,d){return new Promise(e=>{var f=Math.min(a,c),g=Math.min(b,d);const h=Math.max(a,c);var k=Math.max(b,d);const l=Math.min(f,0),m=Math.min(g,0),p=f-l,r=g-m;f=Math.abs(h-f)-(Math.max(h-this.image.naturalWidth,
0)-l);g=Math.abs(k-g)-(Math.max(k-this.image.naturalHeight,0)-m);f&&g?(k=document.createElement("canvas"),k.width=f,k.height=g,k.getContext("2d").drawImage(this.image,p,r,f,g,0,0,f,g),k.toBlob(e)):e(null)})}onImageMove(a){let b=a.clientX,c=a.clientY;return d=>{const e=d.clientX-b,f=d.clientY-c;b=d.clientX;c=d.clientY;this.zoomer.pan(e,f)}}onImageDblClick(a){this.zoomer.reset();this.updateHistoryState()}onImageWheel(a){a.preventDefault();this.zoomer.zoom(Math.sign(-a.deltaY)*this.s.zoomStep,a.clientX,
a.clientY,!0);1===this.zoomer.getMinScale()&&1>=this.zoomer.getScale()&&this.zoomer.reset();this.updateHistoryState()}openImageURL(a){this.downloadImage(a,0,0,"url",null,null)}openImage(a){if(a.target.classList.contains("preview_")){var {url:b,width:c,height:d,previewURL:e}=a.target.dataset,f=0===a.button&&(a.ctrlKey||2===a.buttons);a=f&&a.ctrlKey;this.downloadImage(b,c,d,this.results.dataset.query,e,null,f,a);f&&!a&&document.addEventListener("contextmenu",g=>{g.preventDefault()},{once:!0})}}closeImage(){this.results.dataset.query&&
(this.isRefOpened=!1,this.zoomer.reset(),this.container.classList.remove("image-opened_"),this.isReRenderNeeded&&(this.calculateColumnsCount(),this.renderImages({images:this.searchData,isFirstPage:!0,query:this.results.dataset.query})))}saveImage(){const {base64:a,query:b,type:c}=this.image.metadata,d=c.split("/")[1].split("+")[0],e=document.createElement("a");e.href=a;e.download=`${b}.${d}`;e.click()}addToHistory(a,b,c,d){this.history.delete(a);this.history.set(a,{width:b,height:c,query:d});this.renderHistory()}updateHistoryState(){const a=
this.history.get(this.image.metadata.url);a&&(a.pos=this.zoomer.getState())}renderHistory(){this.historyList.innerHTML="";const a=document.createDocumentFragment();Array.from(this.history).reverse().forEach(([b,{width:c,height:d,query:e}],f)=>{const g=document.createElement("div");g.className="history-item_";g.dataset.url=b;g.dataset.width=c;g.dataset.height=d;g.dataset.query=e;b=document.createElement("div");b.className="index_";b.textContent=`${this.history.size-f}.`;g.appendChild(b);f=document.createElement("div");
f.className="label_";f.textContent=e;g.appendChild(f);a.appendChild(g)});this.historyList.appendChild(a)}blockContextMenu(a){a.preventDefault()}resizeDown(a){a.target.setPointerCapture(a.pointerId);this.resizeStartX=a.pageX;this.resizeInitialWidth=this.getContainerWidth();this.lastColumnsCount=this.columnsCount;a.target.addEventListener("pointermove",this.resizeMove);this.isResizing=!0}resizeMove(a){const b=a.pageX-this.resizeStartX;this.style.setProperty("--gp-ref-max-width",`${Math.max(this.resizeInitialWidth+
2*("left"===a.target.dataset.dir?-b:b),GPReference_.CONTAINER_MIN_WIDTH)}px`);this.isRefOpened?this.isReRenderNeeded=!0:this.calculateColumnsCount()}resizeUp(a){var b=this.getContainerWidth();if(b!==this.resizeInitialWidth){this.style.setProperty("--gp-ref-max-width","none");const c=this.getContainerWidth();b=b<c?`${b}px`:"none";this.s.containerMaxWidth=b;this.style.setProperty("--gp-ref-max-width",b)}a.target.removeEventListener("pointermove",this.resizeMove);this.isResizing=!1;!this.isRefOpened&&
this.searchData&&this.columnsCount!==this.lastColumnsCount&&this.renderImages({images:this.searchData,isFirstPage:!0,query:this.results.dataset.query})}resizeDblClick(a){a="none"===window.getComputedStyle(this.container).maxWidth?`${GPReference_.CONTAINER_MIN_WIDTH}px`:"none";this.s.containerMaxWidth=a;this.style.setProperty("--gp-ref-max-width",a);this.isRefOpened?this.isReRenderNeeded=!0:(this.calculateColumnsCount(),this.renderImages({images:this.searchData,isFirstPage:!0,query:this.results.dataset.query}))}getContainerWidth(){return this.container.getBoundingClientRect().width-
2*GPReference_.BORDER_SIZE}handleResizeWindow(a){clearTimeout(this.resizeTimer);this.resizeTimer=setTimeout(this.onResize,250)}onResize(){this.s.enabled&&(this.isRefOpened?this.isReRenderNeeded=!0:(this.calculateColumnsCount(),this.renderImages({images:this.searchData,isFirstPage:!0,query:this.results.dataset.query})))}openFrame(a,b){this.fm.create(a,b);b||this.toggle(!1)}base64ToBlob(a){return fetch(a).then(b=>b.blob())}isEnabled(){return this.s.enabled}getPainterButton(){return this.painterBtn}updateSettings({detail:{settings:a}}){"interfaceAlignment"in
a&&document.documentElement.style.setProperty("--gp-ref-alignment",`${a.interfaceAlignment}`);this.container&&("minZoom"in a&&this.zoomer.setMinScale(a.minZoom),"maxZoom"in a&&this.zoomer.setMaxScale(a.maxZoom),"stretchImage"in a&&this.isRefOpened&&(this.calculateAnchor(),this.zoomer.reset(),this.updateHistoryState()),"frameStickyEdges"in a&&this.fm.setStickyEdges(a.frameStickyEdges),"frameStickyEdgesDistance"in a&&this.fm.setStickyEdgesDistance(a.frameStickyEdgesDistance),"frameSeparateOpacity"in
a&&this.fm.setSeparateOpacity(a.frameSeparateOpacity))}emitSettings(){document.dispatchEvent(new CustomEvent("gp:ref.settings",{detail:{settings:window.structuredClone(this.settings)}}))}}window.GPReference_=GPReference_;class GPReferenceFrameManager_ extends EventTarget{static DEFAULT_STICKY_EDGES=!0;static DEFAULT_STICKY_EDGES_DISTANCE=15;static DEFAULT_STATIC_ANCHOR=!0;static DEFAULT_SEPARATE_OPACITY=!1;static BASE_Z_INDEX=100;static Z_INDEX_POOL=100;static MIN_FRAME_DISPLAY_AREA_SIZE=40;constructor(a,b,c,d,e,f,g,h,k){super();this.container=a;this.stickyEdges=b;this.stickyEdgesDistance=c;this.staticAnchor=d;this.separateOpacity=e;this.opacity=f;this.width=g;this.x=h.x;this.y=h.y;this.anchor=k;this.frames=[];this.topFrame=
null;this.lastZIndex=GPReferenceFrameManager_.BASE_Z_INDEX}create(a,b){a=new GPReferenceFrame_(a,b,this);this.add(a)}add(a){this.frames.push(a);this.topFrame=a}delete(a){a=this.frames.indexOf(a);this.frames.splice(a,1);this.frames.length||this.reset()}clear(){this.frames.forEach(a=>{a.remove()});this.reset()}reset(){this.frames=[];this.topFrame=null;this.lastZIndex=GPReferenceFrameManager_.BASE_Z_INDEX}toFront(a){this.topFrame!==a&&(a.setZIndex(this.getNextZIndex()),this.topFrame=a);(this.frames.length>
GPReferenceFrameManager_.Z_INDEX_POOL||this.lastZIndex>GPReferenceFrameManager_.BASE_Z_INDEX+GPReferenceFrameManager_.Z_INDEX_POOL)&&this.optimizeZIndexes()}getNextZIndex(){return this.lastZIndex++}optimizeZIndexes(){this.lastZIndex=GPReferenceFrameManager_.BASE_Z_INDEX;Array.from(this.frames).sort((a,b)=>a.zIndex-b.zIndex).forEach(a=>{a.setZIndex(this.getNextZIndex());this.topFrame=a})}setTopFrame(a){this.topFrame=a}getAlignedCoords(a){const b=GPReferenceFrame_.BORDER_WIDTH;var c=GPReferenceFrame_.DEFAULT_WIDTH;
if(1===this.frames.length)return[b,b];const d=2*b;var e=Math.trunc(document.documentElement.clientWidth/(c+2*b));const f=new Map([[b,[]]]);for(var g=0;g<e;g++)f.set((c+2*b)*g+b,[[-b,-b]]);let h=b;this.frames.forEach(k=>{if(k!==a&&!k.isSeparated&&!k.isChanged){const l=[k.offsetY,k.offsetY+k.height],m=f.get(k.offsetX);m?m.push(l):f.set(k.offsetX,[[b,b],l]);k.offsetX>h&&(h=k.offsetX)}});for(let [k,l]of f)for(l.sort((m,p)=>m[0]-p[0]),c=0;c<l.length;c++)if([,e]=l[c],[g]=c!==l.length-1?l[c+1]:[document.documentElement.clientHeight,
document.documentElement.clientHeight],g-(e+d)>=a.height)return[k,e+d];return[h+GPReferenceFrame_.DEFAULT_WIDTH+d,b]}setOpacity(a){this.frames.forEach(b=>{b.setOpacity(a)})}getFrames(){return this.frames}hasFrames(){return 0<this.frames.length}isSingleFrame(){return 1===this.frames.length}getContainer(){return this.container}setStickyEdges(a){this.stickyEdges=a}setStickyEdgesDistance(a){this.stickyEdgesDistance=a}setSeparateOpacity(a){this.separateOpacity=a}setstaticAnchor(a){this.staticAnchor=a}}
class GPReferenceFrame_{static DEFAULT_WIDTH=284;static MAX_WIDTH=window.screen.width/3;static MIN_WIDTH=180;static WIDTH_STEP=10;static BORDER_WIDTH=2;static DEFAULT_ANCHOR="tl";static DEFAULT_OPACITY=1;static MIN_OPACITY=.1;static OPACITY_STEP=.1;static ANCHOR_PROPS={t:"top",b:"bottom",l:"left",r:"right"};static ANCHOR={TOP:"t",BOTTOM:"b",LEFT:"l",RIGHT:"r"};constructor(a,b=!1,c){this.fm=c;this.opacity=this.fm.opacity??GPReferenceFrame_.DEFAULT_OPACITY;this.isChanged=!1;this.openedInBg=b;this.isSeparated=
!this.fm.hasFrames()&&!this.openedInBg;GPUtils_.bindMethods([this.suppressEvent,this.opacityPreviewHandler,this.wheelHandler,this.toFront,this.moveHandler,this.resizeHandler,this.closeHandler],this);this.render();this.load(a);this.fm.setTopFrame(this)}render(){this.frame=document.createElement("div");this.frame.className="frame_ gp-ref-frame_";this.frame.classList.toggle("static-anchor_",this.fm.staticAnchor);this.frame.style.zIndex=this.fm.getNextZIndex();this.frame.style.setProperty("--gp-ref-frame-opacity",
`${this.opacity}`);this.frame.addEventListener("wheel",this.wheelHandler);this.frame.addEventListener("pointerdown",this.toFront);this.frame.addEventListener("pointerdown",this.moveHandler);this.frame.addEventListener("pointerdown",this.resizeHandler);this.frame.addEventListener("pointerdown",this.closeHandler);this.frame.addEventListener("mousedown",b=>{b.stopPropagation()});const a=document.createElement("div");a.className="wrapper_";this.frame.appendChild(a);this.image=document.createElement("img");
this.image.className="image_";a.appendChild(this.image);this.fm.getContainer().appendChild(this.frame)}wheelHandler(a){a.ctrlKey?this.changeOpacity(a):this.changeSize(a);a.preventDefault()}changeOpacity(a){a=Math.max(Math.min(this.opacity+(0<a.deltaY?-GPReferenceFrame_.OPACITY_STEP:GPReferenceFrame_.OPACITY_STEP),1),GPReferenceFrame_.MIN_OPACITY);this.setOpacity(a);this.fm.separateOpacity?this.setOpacity(a):this.fm.setOpacity(a);this.frame.classList.add("opacity-preview_");this.frame.addEventListener("pointerleave",
this.opacityPreviewHandler,{once:!0})}opacityPreviewHandler(a){this.frame.classList.remove("opacity-preview_")}setOpacity(a){this.opacity=a;this.frame.style.setProperty("--gp-ref-frame-opacity",`${a}`)}changeSize(a){a=0<a.deltaY?Math.max(this.width-GPReferenceFrame_.WIDTH_STEP,this.minWidth):Math.min(this.width+GPReferenceFrame_.WIDTH_STEP,GPReferenceFrame_.MAX_WIDTH);this.setSize(a);this.toFront();this.isChanged||this.handleChange();this.fm.isSingleFrame()&&(this.fm.width=a,this.dispatchSize(a))}toFront(){this.fm.toFront(this)}moveHandler(a){if(0===
a.button){var b=this.frame.dataset.anchor,c=this.offsetX,d=this.offsetY,[e,f,g,h]=this.getCoords(a),k=(l=>{const [m,p,r]=this.getStickyCoords(l,l.pageX-e,l.pageY-f,g,h);this.setPosition(m,p,g,h,r)}).bind(this);this.frame.setPointerCapture(a.pointerId);this.frame.addEventListener("pointermove",k);this.frame.addEventListener("pointerup",()=>{this.frame.removeEventListener("pointermove",k);this.isChanged||this.offsetX===c&&this.offsetY===d||this.handleChange();this.fm.isSingleFrame()&&(this.fm.x=this.offsetX,
this.fm.y=this.offsetY,this.dispatchPos(this.offsetX,this.offsetY),this.staticAnchor||this.frame.dataset.anchor===b||(this.fm.anchor=this.frame.dataset.anchor,this.dispatchAnchor(this.frame.dataset.anchor)))},{once:!0});(this.fm.stickyEdges&&a.ctrlKey||!this.fm.stickyEdges&&!a.ctrlKey)&&k(a)}}getStickyCoords(a,b,c,d,e){if(this.fm.stickyEdges&&a.ctrlKey||!this.fm.stickyEdges&&!a.ctrlKey||!this.fm.hasFrames())return[b,c,null];const f=this.fm.stickyEdgesDistance;let g,h,k,l,m=null,p,r;this.fm.getFrames().forEach(q=>
{if(q!==this){var n=q.frame.getBoundingClientRect();var u=Math.abs(n.y-(c+e));u<f&&(void 0===k||u<k)&&n.x+n.width>=b&&n.x<=b+d&&(!r||r[0]===q.frame.dataset.anchor[0])&&(k=u,c=n.y-e,m=r=q.frame.dataset.anchor);u=Math.abs(n.y+n.height-c);u<f&&(void 0===l||u<l)&&n.x+n.width>=b&&n.x<=b+d&&(!r||r[0]===q.frame.dataset.anchor[0])&&(l=u,c=n.y+n.height,m=r=q.frame.dataset.anchor);u=Math.abs(n.x-(b+d));u<f&&(void 0===g||u<g)&&n.y+n.height>=c&&n.y<=c+e&&(!p||p[1]===q.frame.dataset.anchor[1])&&(g=u,b=n.x-d,m=
p=q.frame.dataset.anchor);u=Math.abs(n.x+n.width-b);u<f&&(void 0===h||u<h)&&n.y+n.height>=c&&n.y<=c+e&&(!p||p[1]===q.frame.dataset.anchor[1])&&(h=u,b=n.x+n.width,m=p=q.frame.dataset.anchor)}});return[b,c,m]}resizeHandler(a){if(2===a.button){var b=this.width,c=a.pageX,d=this.image.getBoundingClientRect().width,e=this.frame.dataset.anchor,f=(g=>{g=g.pageX-c;this.setSize(Math.min(Math.max(d+(e[1]===GPReferenceFrame_.ANCHOR.LEFT?g:-g),this.minWidth),GPReferenceFrame_.MAX_WIDTH))}).bind(this);this.frame.setPointerCapture(a.pointerId);
this.frame.addEventListener("pointermove",f);this.frame.addEventListener("pointerup",g=>{document.addEventListener("contextmenu",this.suppressEvent,{once:!0});this.frame.removeEventListener("pointermove",f);this.frame.classList.remove("resizing_");this.isChanged||this.handleChange();this.fm.isSingleFrame()&&this.width!==b&&(this.fm.width=this.width,this.dispatchSize(this.width))},{once:!0});this.frame.classList.add("resizing_")}}closeHandler(a){1===a.button&&(this.close(),a.preventDefault())}suppressEvent(a){a.preventDefault()}setSize(a){this.width=
a;this.height=Math.round(a/this.aspectRatio);this.frame.style.setProperty("--gp-ref-frame-width",`${a}px`)}updatePosition(){const a=Math.max(Math.min(this.offsetX,document.documentElement.clientWidth-(this.width+GPReferenceFrame_.BORDER_WIDTH)),GPReferenceFrame_.BORDER_WIDTH),b=Math.max(Math.min(this.offsetY,document.documentElement.clientHeight-(this.height+GPReferenceFrame_.BORDER_WIDTH)),GPReferenceFrame_.BORDER_WIDTH);this.frame.style.inset="unset";Array.from(this.frame.dataset.anchor).forEach(c=>
{const d=GPReferenceFrame_.ANCHOR_PROPS[c];switch(c){case GPReferenceFrame_.ANCHOR.TOP:case GPReferenceFrame_.ANCHOR.BOTTOM:this.frame.style[d]=`${b}px`;break;case GPReferenceFrame_.ANCHOR.LEFT:case GPReferenceFrame_.ANCHOR.RIGHT:this.frame.style[d]=`${a}px`}})}setPosition(a,b,c,d,e){if(!c||!d){const [l,m]=this.frame.getBoundingClientRect();c=l;d=m}const f=document.documentElement.clientWidth,g=document.documentElement.clientHeight;var h;if(this.fm.staticAnchor)var k=h=GPReferenceFrameManager_.MIN_FRAME_DISPLAY_AREA_SIZE;
else h=c,k=d;h=Math.max(Math.min(a,f-(h+GPReferenceFrame_.BORDER_WIDTH)),GPReferenceFrame_.BORDER_WIDTH);k=Math.max(Math.min(b,g-(k+GPReferenceFrame_.BORDER_WIDTH)),GPReferenceFrame_.BORDER_WIDTH);a=e??(this.fm.staticAnchor?GPReferenceFrame_.DEFAULT_ANCHOR:(b+d/2>g/2?GPReferenceFrame_.ANCHOR.BOTTOM:GPReferenceFrame_.ANCHOR.TOP)+(a+c/2>f/2?GPReferenceFrame_.ANCHOR.RIGHT:GPReferenceFrame_.ANCHOR.LEFT));this.frame.dataset.anchor=a;this.frame.style.inset="unset";a[0]===GPReferenceFrame_.ANCHOR.TOP?(this.offsetY=
Math.round(k),this.frame.style.top=`${this.offsetY}px`):(this.offsetY=Math.round(g-(k+d)),this.frame.style.bottom=`${this.offsetY}px`);a[1]===GPReferenceFrame_.ANCHOR.LEFT?(this.offsetX=Math.round(h),this.frame.style.left=`${this.offsetX}px`):(this.offsetX=Math.round(f-(h+c)),this.frame.style.right=`${this.offsetX}px`)}getCoords(a){const [b,c]=a.touches?[a.touches[0].clientX,a.touches[0].clientY]:[a.clientX,a.clientY];a=a.currentTarget.getBoundingClientRect();return[Math.round(b-a.left),Math.round(c-
a.top),a.width,a.height]}handleChange(){this.isChanged=!0}dispatchSize(a){this.fm.dispatchEvent(new CustomEvent("size",{detail:{width:a}}))}dispatchPos(a,b){this.fm.dispatchEvent(new CustomEvent("pos",{detail:{x:a,y:b}}))}dispatchAnchor(a){this.fm.dispatchEvent(new CustomEvent("anchor",{detail:{anchor:a}}))}load(a){const b=URL.createObjectURL(a);this.image.src=b;this.image.onload=c=>{const {naturalWidth:d,naturalHeight:e}=this.image;this.aspectRatio=d/e;this.image.style.setProperty("--aspect-ratio",
this.aspectRatio);this.minWidth=Math.min(GPReferenceFrame_.MIN_WIDTH,d);this.setSize(Math.min(this.isSeparated?this.fm.width:GPReferenceFrame_.DEFAULT_WIDTH,d));if(this.isSeparated)this.offsetX=this.fm.x,this.offsetY=this.fm.y,this.frame.dataset.anchor=this.fm.anchor;else{const [f,g]=this.fm.getAlignedCoords(this);this.offsetX=f;this.offsetY=g;this.frame.dataset.anchor=GPReferenceFrame_.DEFAULT_ANCHOR}this.updatePosition();URL.revokeObjectURL(b)}}close(){this.remove();this.fm.delete(this)}remove(){this.frame.remove()}setZIndex(a){this.zIndex=
this.frame.style.zIndex=a}}window.GPReferenceFrame_=GPReferenceFrame_;window.GPReferenceFrameManager_=GPReferenceFrameManager_;class GPPlayersManager_ extends EventTarget{static DISPLAY_MODE={NORMAL:"normal",EXPANDED:"expanded",FULLSCREEN:"fullscreen"};static PREVIEW_PANEL_PATHS=["write","memory"];static DEFAULT_SETTINGS={autoplay:!0,openPlayerWithDoubleClick:!1,defaultDisplayMode:this.DISPLAY_MODE.NORMAL};static SETTINGS_UI={autoplay:{type:"switch",description:"\u0410\u0432\u0442\u043e\u0432\u043e\u0441\u043f\u0440\u043e\u0438\u0437\u0432\u0435\u0434\u0435\u043d\u0438\u0435 \u043f\u0440\u043e\u0446\u0435\u0441\u0441\u0430 \u0440\u0438\u0441\u043e\u0432\u0430\u043d\u0438\u044f \u0441\u0440\u0430\u0437\u0443 \u043f\u043e\u0441\u043b\u0435 \u043e\u0442\u043a\u0440\u044b\u0442\u0438\u044f \u043f\u043b\u0435\u0435\u0440\u0430 \u0432 \u0430\u043b\u044c\u0431\u043e\u043c\u0435"},
openPlayerWithDoubleClick:{type:"switch",description:"\u041e\u0442\u043a\u0440\u044b\u0432\u0430\u0442\u044c \u043f\u043b\u0435\u0435\u0440 \u0441 \u043f\u043e\u043c\u043e\u0449\u044c\u044e \u0434\u0432\u043e\u0439\u043d\u043e\u0433\u043e \u043a\u043b\u0438\u043a\u0430 \u043f\u043e \u0440\u0438\u0441\u0443\u043d\u043a\u0443 \u0432 \u0430\u043b\u044c\u0431\u043e\u043c\u0435"},defaultDisplayMode:{type:"dropdown",args:{items:Object.values(this.DISPLAY_MODE)},description:"\u0420\u0435\u0436\u0438\u043c \u043e\u0442\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044f \u043e\u043a\u043d\u0430 \u043f\u043b\u0435\u0435\u0440\u0430 \u043f\u0440\u0438 \u043e\u0442\u043a\u0440\u044b\u0442\u0438\u0438 \u0432 \u0430\u043b\u044c\u0431\u043e\u043c\u0435"}};static MODULE={title:"Timelapse Player",
alias:"pl",dependencies:["GPTimelapsePlayer_"],settings:{storage:"gp_timelapse-player",defaultSettings:this.DEFAULT_SETTINGS,ui:this.SETTINGS_UI},useCSS:!0};constructor(a){super();this.prx=a.prx;this.s=a.sm.setSettings(this);this.currentPath=null;GPUtils_.bindMethods([this.onAlbumMiddleClick,this.onAlbumDoubleClick,this.onPreviewMiddleClick,this.onPreviewDoubleClick],this);document.addEventListener("_url_changed",({detail:{path:b}})=>{this.currentPath=b.slice(1)});this.prx.addEventListener("data",
({detail:{event:b}})=>{b===GPProxy_.EVENT.TURN_STARTED?this.closePlayers():b===GPProxy_.EVENT.GAME_STARTED?(document.addEventListener("pointerdown",this.onPreviewMiddleClick),document.addEventListener("dblclick",this.onPreviewDoubleClick)):[GPProxy_.EVENT.ALBUM_INFO,GPProxy_.EVENT.NEW_GAME,GPProxy_.EVENT.ALBUM_SCORE,GPProxy_.EVENT.GAME_QUIT].includes(b)?(this.closePlayers(),b!==GPProxy_.EVENT.ALBUM_INFO&&(document.removeEventListener("pointerdown",this.onAlbumMiddleClick),document.removeEventListener("dblclick",
this.onAlbumDoubleClick))):b===GPProxy_.EVENT.GALLERY_SETTINGS&&(document.addEventListener("pointerdown",this.onAlbumMiddleClick),document.addEventListener("dblclick",this.onAlbumDoubleClick),document.removeEventListener("pointerdown",this.onPreviewMiddleClick),document.removeEventListener("dblclick",this.onPreviewDoubleClick))});this.prx.addEventListener("rejoin",({detail:{stage:b}})=>{switch(b){case GPProxy_.STAGE.GAME:document.addEventListener("pointerdown",this.onPreviewMiddleClick);document.addEventListener("dblclick",
this.onPreviewDoubleClick);break;case GPProxy_.STAGE.ALBUM:document.addEventListener("pointerdown",this.onAlbumMiddleClick),document.addEventListener("dblclick",this.onAlbumDoubleClick)}})}onPreviewMiddleClick(a){1===a.button&&this.handleImageClick(a)}onPreviewDoubleClick(a){0===a.button&&this.s.openPlayerWithDoubleClick&&this.handleImageClick(a)}handleImageClick(a){if(this.isPreviewPanelShown()&&"CANVAS"===a.target.tagName&&a.target.parentElement.parentElement.classList.contains("core")){const b=
{data:this.prx.getPrevImageData(),meta:{author:"",title:"",date:Date.now()}};a=a.target.parentElement.parentElement;const c=document.querySelector(".screen");a.isPlayerRendered||this.renderPlayer(b,a,c,GPTimelapsePlayer_.DISPLAY_MODE.NORMAL,!1,!0)}}isPreviewPanelShown(){return GPPlayersManager_.PREVIEW_PANEL_PATHS.includes(this.currentPath)}onAlbumMiddleClick(a){1===a.button&&this.handleAlbumClick(a)}onAlbumDoubleClick(a){0===a.button&&this.s.openPlayerWithDoubleClick&&this.handleAlbumClick(a)}handleAlbumClick(a){if("CANVAS"===
a.target.tagName&&!a.target.parentElement.classList.contains("animation")){var b=a.target.closest(".item");if(b){a=[...b.parentElement.children].filter(d=>d.classList.contains("item")).indexOf(b);a=this.prx.getAlbumItem(a);b=b.querySelector(".balloon");var c=document.querySelector(".screen");b.isPlayerRendered||this.renderPlayer(a,b,c)}}}renderPlayer(a,b,c,d,e,f){const g=new GPTimelapsePlayer_({image:a,container:b,mainContainer:c},d||this.s.defaultDisplayMode,f);(e??this.s.autoplay)&&g.addEventListener("data_loaded",
()=>{g.play()})}closePlayers(){GPTimelapsePlayer_.closeAll()}}window.GPPlayersManager_=GPPlayersManager_;class GPTimelapsePlayer_ extends EventTarget{static players=new Set;static CACHE_ENABLED=!0;static CACHE_INTERVAL=1E3;static CANVAS_DENSITY=1;static BACKGROUND_COLOR="#FFFFFF";static STROKE_OFFSET=3;static SPEEDS=[[1,1],[5,1],[15,1],[30,1],[50,1],[0,1],[0,2],[0,4],[0,8],[0,16],[0,32]];static SPEED=0;static SPEED_SLIDER_WIDTH=130;static SPEED_SLIDER_HEIGHT=16;static SPEED_SLIDER_THUMB_WIDTH=14;static M_STROKE_OFFSET=67;static DISPLAY_MODE={NORMAL:"normal",EXPANDED:"expanded",FULLSCREEN:"fullscreen"};static DEFAULT_DISPLAY_MODE=GPTimelapsePlayer_.DISPLAY_MODE.NORMAL;static FV2_DATE=1681366233E3;static GARTICPHONE_HOSTNAME_PATTERN=/(^|\.)garticphone\.com$/;constructor({image:{data:a,
background:b,canvasTypeId:c,auth:d,meta:{author:e,title:f,date:g}},container:h,mainContainer:k},l=GPTimelapsePlayer_.DEFAULT_DISPLAY_MODE,m=!1){super();GPTimelapsePlayer_.players.add(this);this.canvasTypeId=c;this.canvasType=GPUtils_.getCanvasTypeById(c);const [p,r]=GPUtils_.getCanvasDimensionsById(c);this.density=GPTimelapsePlayer_.CANVAS_DENSITY;this.originalWidth=p;this.originalHeight=r;this.width=this.originalWidth*this.density;this.height=this.originalHeight*this.density;this.originalData=a.slice();
const [q,n,u]=this.handleDelimiters(a,b);this.data=q;this.background=n;this.auth=d;this.author=e;this.title=f;this.date=new Date(g);this.eraserAlpha=!u;this.fi=g&&this.date.getTime()>GPTimelapsePlayer_.FV2_DATE?5:4;this.container=h;this.container.isPlayerRendered=!0;this.mainContainer=k;this.defaultDisplayMode=l;this.defaultDisplayModeDensity=this.getModeDensity(l);this.cache;this.canvas;this.ctx;this.isPlaying=!1;this.currentSpeed=JSON.parse(localStorage.getItem("gp-timelapse-player-speed"))||GPTimelapsePlayer_.SPEED;
this.speed=GPTimelapsePlayer_.SPEEDS[this.currentSpeed];this.sPos=this.pos=0;this.lastContainerDimension={width:0,height:0};this.isContextLayoutShown=this.expandStateBeforeFullscreen=this.isFullscreen=this.isExpanded=!1;this.isContextMenuDisabled=m;this.isStandalone=!GPTimelapsePlayer_.GARTICPHONE_HOSTNAME_PATTERN.test(location.hostname);GPUtils_.bindMethods([this.progressBarPointerMoveHandler,this.resizeHandler,this.toggleFullscreen,this.playPause,this.drawing,this.expand,this.terminate,this.toggleContextLayout,
this.saveImage,this.speedViewPointerMoveHandler],this);window.addEventListener("resize",this.resizeHandler);this.addEventListener("cache_updated",this.updateCacheHandler);this.initData();this.initCacheWorker()}static closeAll(){GPTimelapsePlayer_.players.forEach(a=>{a.terminate()})}updateCacheHandler({detail:{density:a}}){if(a===this.defaultDisplayModeDensity){this.render();switch(this.defaultDisplayMode){case GPTimelapsePlayer_.DISPLAY_MODE.EXPANDED:this.expand(!0);break;case GPTimelapsePlayer_.DISPLAY_MODE.FULLSCREEN:this.player.requestFullscreen()}this.seek(this.data.length);
this.dispatchEvent(new Event("image_rendered"));this.dispatchEvent(new CustomEvent("data_loaded",{detail:{author:this.author,title:this.title,date:this.date.toISOString()}}));this.removeEventListener("cache_updated",this.updateCacheHandler)}}getModeDensity(a){switch(a){case GPTimelapsePlayer_.DISPLAY_MODE.NORMAL:const {width:b,height:c}=getComputedStyle(this.container);return this.getDensityByDimensions(parseInt(b),parseInt(c)).density;case GPTimelapsePlayer_.DISPLAY_MODE.EXPANDED:const {width:d,
height:e}=getComputedStyle(this.mainContainer);return this.getDensityByDimensions(parseInt(d),parseInt(e)).density;case GPTimelapsePlayer_.DISPLAY_MODE.FULLSCREEN:return this.getDensityByDimensions(window.screen.width,window.screen.height).density}}terminate(){document.fullscreenElement===this.player&&this.mainContainer.classList.remove("gp-tp-fullscreen_");this.pause();this.worker.terminate();this.cache=this.originalData=this.data=null;this.player.remove();this.container.isPlayerRendered=!1;this.container=
null;this.speedInput&&this.speedInput.remove();window.removeEventListener("resize",this.resizeHandler);GPTimelapsePlayer_.players.delete(this);this.dispatchEvent(new Event("terminated"))}initData(){const a=[];for(let b=0;b<this.data.length;b++)this.data[b].index=b,this.isMStroke(this.data[b])&&a.push(b);a.reverse().forEach(b=>{this.data.splice(b,1)})}isMStroke(a){return!(1===a[0]&&a[3][0]>this.originalWidth&&a[3][1]>this.originalHeight)||a[3][0]-this.originalWidth-GPTimelapsePlayer_.M_STROKE_OFFSET||
a.at(-1)[1]-this.originalHeight-GPTimelapsePlayer_.M_STROKE_OFFSET?!1:!0}render(){this.player=document.createElement("div");this.player.className="timelapse-player_";this.player.dataset.canvasType=this.canvasType;this.player.addEventListener("click",e=>{e.stopPropagation()});this.player.addEventListener("pointerdown",e=>{e.stopPropagation()});this.player.addEventListener("pointerup",e=>{e.stopPropagation()});this.player.addEventListener("mouseup",e=>{e.stopPropagation()});this.player.addEventListener("mousedown",
e=>{e.preventDefault();e.stopPropagation();1===e.button&&(this.isFullscreen?this.toggleFullscreen():this.expand())},!0);this.player.addEventListener("contextmenu",e=>{e.stopPropagation();e.preventDefault();this.toggleContextLayout()});this.player.addEventListener("fullscreenchange",e=>{this.isFullscreen=!!document.fullscreenElement;this.player.classList.toggle("fullscreen_",this.isFullscreen);this.mainContainer.classList.toggle("gp-tp-fullscreen_",this.isFullscreen);this.isStandalone&&!this.isFullscreen?
this.expand(this.expandStateBeforeFullscreen):this.resizeHandler()});this.bgCanvas=document.createElement("canvas");this.bgCanvas.className="background-canvas_";this.bgCanvas.width=this.width;this.bgCanvas.height=this.height;this.player.appendChild(this.bgCanvas);this.bgCtx=this.bgCanvas.getContext("2d");this.bgCtx.fillStyle=GPTimelapsePlayer_.BACKGROUND_COLOR;this.bgCtx.fillRect(0,0,this.bgCanvas.width,this.bgCanvas.height);this.background&&this.drawFunction(this.bgCtx,this.background,this.density,
!1);this.canvas=document.createElement("canvas");this.canvas.className="canvas_";this.canvas.width=this.width;this.canvas.height=this.height;this.player.appendChild(this.canvas);this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0});this.strokeCanvas=document.createElement("canvas");this.strokeCanvas.className="stroke-canvas_";this.strokeCanvas.width=this.width;this.strokeCanvas.height=this.height;this.player.appendChild(this.strokeCanvas);this.strokeCtx=this.strokeCanvas.getContext("2d");
var a=document.createElement("div");a.className="event-catcher_";a.addEventListener("click",this.playPause);a.addEventListener("dblclick",this.toggleFullscreen);this.player.appendChild(a);a=document.createElement("div");a.className="controls_";a.style.cssText="";this.player.appendChild(a);const b=document.createElement("div");b.className="progress-bar_";b.addEventListener("pointermove",e=>{const [f,,g]=this.getCoords(e);d.style.width=`${100*Math.max(0,Math.min(1,f/g))}%`},!0);b.addEventListener("pointerdown",
e=>{if(0===e.button){var f=this.isPlaying;this.progress.classList.remove("smooth_");this.player.classList.toggle("finished_",this.pos===this.data.length-1);this.progressBarPointerMoveHandler(e);b.setPointerCapture(e.pointerId);b.addEventListener("pointermove",this.progressBarPointerMoveHandler);b.addEventListener("pointerup",g=>{b.removeEventListener("pointermove",this.progressBarPointerMoveHandler);this.progress.classList.add("smooth_");this.player.classList.toggle("finished_",this.pos===this.data.length);
f&&this.pos<this.data.length&&this.play()},{once:!0})}});a.appendChild(b);var c=document.createElement("div");c.className="progress-bar-bg_";b.appendChild(c);const d=document.createElement("div");d.className="progress-hover_";b.appendChild(d);this.progress=document.createElement("div");this.progress.className="progress_ smooth_";this.updateProgress();b.appendChild(this.progress);c=document.createElement("div");c.className="play-btn_ btn_";c.title="\u0417\u0430\u043f\u0443\u0441\u0442\u0438\u0442\u044c/\u041e\u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u044c \u043f\u0440\u043e\u0438\u0433\u0440\u044b\u0432\u0430\u043d\u0438\u0435";
a.appendChild(c);c.addEventListener("click",e=>{this.playPause()});c=document.createElement("div");c.className="first-frame-btn_ btn_";c.title="\u041a \u043f\u0435\u0440\u0432\u043e\u043c\u0443 \u0448\u0442\u0440\u0438\u0445\u0443";c.addEventListener("click",e=>{this.seek(0);this.updateProgress();this.player.classList.remove("finished_")});a.appendChild(c);c=document.createElement("div");c.className="speed-down-btn_ btn_";c.title="\u0423\u043c\u0435\u043d\u044c\u0448\u0438\u0442\u044c \u0441\u043a\u043e\u0440\u043e\u0441\u0442\u044c";
c.addEventListener("click",e=>{this.changeSpeed(-1)});a.appendChild(c);c=document.createElement("div");c.className="speed-up-btn_ btn_";c.title="\u0423\u0432\u0435\u043b\u0438\u0447\u0438\u0442\u044c \u0441\u043a\u043e\u0440\u043e\u0441\u0442\u044c";c.addEventListener("click",e=>{this.changeSpeed(1)});a.appendChild(c);c=document.createElement("div");c.className="last-frame-btn_ btn_";c.title="\u041a \u043f\u043e\u0441\u043b\u0435\u0434\u043d\u0435\u043c\u0443 \u0448\u0442\u0440\u0438\u0445\u0443";
c.addEventListener("click",e=>{this.seek(this.data.length);this.updateProgress();this.player.classList.add("finished_")});a.appendChild(c);this.speedView=document.createElement("div");this.speedView.className="speed_";this.speedView.title="\u0422\u0435\u043a\u0443\u0449\u0430\u044f \u0441\u043a\u043e\u0440\u043e\u0441\u0442\u044c";this.speedView.textContent=" ";this.updateSpeedView();a.appendChild(this.speedView);this.speedView.addEventListener("pointerdown",e=>{const {x:f,y:g}=this.player.getBoundingClientRect(),
h=(e.clientY-g-(e.clientY-e.target.getBoundingClientRect().y))/this.scaleY;this.renderSpeedInput((e.clientX-f)/this.scaleX,h);this.speedView.setPointerCapture(e.pointerId);this.speedView.addEventListener("pointermove",this.speedViewPointerMoveHandler);this.speedView.addEventListener("pointerup",k=>{this.speedView.removeEventListener("pointermove",this.speedViewPointerMoveHandler);this.speedInput?.remove()},{once:!0})});this.strokeNumView=document.createElement("div");this.strokeNumView.className=
"stroke_";this.strokeNumView.title="\u0422\u0435\u043a\u0443\u0449\u0438\u0439 \u0448\u0442\u0440\u0438\u0445";this.strokeNumView.textContent=" ";this.updateStrokeView();a.appendChild(this.strokeNumView);a.appendChild(document.createElement("span"));c=document.createElement("div");c.className="expand-btn_ btn_";c.title="\u0420\u0430\u0437\u0432\u0435\u0440\u043d\u0443\u0442\u044c/\u0421\u0432\u0435\u0440\u043d\u0443\u0442\u044c";c.addEventListener("click",e=>{this.expand()});a.appendChild(c);c=document.createElement("div");
c.className="fullscreen-btn_ btn_";c.title="\u0420\u0430\u0437\u0432\u0435\u0440\u043d\u0443\u0442\u044c \u043d\u0430 \u0432\u0435\u0441\u044c \u044d\u043a\u0440\u0430\u043d";c.addEventListener("click",this.toggleFullscreen);a.appendChild(c);a=document.createElement("div");a.className="close-btn_";a.title="\u0417\u0430\u043a\u0440\u044b\u0442\u044c \u043f\u0440\u043e\u0438\u0433\u0440\u044b\u0432\u0430\u0442\u0435\u043b\u044c";a.addEventListener("click",this.terminate);this.player.appendChild(a);
this.contextLayout=document.createElement("div");this.contextLayout.className="context-layout_";this.contextLayout.addEventListener("click",this.toggleContextLayout);a=document.createElement("div");a.className="save-img-data-btn_ btn_";a.title="\u0421\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c \u0438\u0441\u0445\u043e\u0434\u043d\u0438\u043a";a.addEventListener("click",e=>{e.stopPropagation();this.saveImageData()});this.contextLayout.appendChild(a);a=document.createElement("div");a.className=
"save-img-btn_ btn_";a.title="\u0421\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0435";a.addEventListener("click",e=>{e.stopPropagation();this.saveImage()});this.contextLayout.appendChild(a);this.player.appendChild(this.contextLayout);this.container.firstElementChild.before(this.player);this.resizeHandler()}toggleContextLayout(){this.isContextMenuDisabled||(this.pause(),this.isContextLayoutShown=!this.isContextLayoutShown,this.player.classList.toggle("context-menu_",
this.isContextLayoutShown))}updateSpeedView(){let a=Number(!this.speed[0]);this.speedView.firstChild.nodeValue=`x${a?100*this.speed[a]:this.speed[a]}`}updateStrokeView(){this.strokeNumView.firstChild.nodeValue=`${this.pos} / ${this.data.length}`}resizeHandler(){const a=this.isPlaying;this.pause();if(document.fullscreenElement===this.player)this.setSize(document.documentElement.clientWidth,document.documentElement.clientHeight);else{const d=this.isExpanded?this.mainContainer:this.container;let {width:e,
height:f}=getComputedStyle(d);e=parseInt(e);f=parseInt(f);const {width:g,height:h}=this.lastContainerDimension;if(d!==this.mainContainer||e!==g||f!==h)this.setSize(e,f),this.lastContainerDimension={width:e,height:f}}a&&this.play();const {width:b,height:c}=this.mainContainer.getBoundingClientRect();this.scaleX=b/this.mainContainer.offsetWidth;this.scaleY=c/this.mainContainer.offsetHeight}getDensityByDimensions(a,b){a=Math.min(Math.ceil(a/this.originalWidth),Math.ceil(b/this.originalHeight));return{density:a,
canvasWidth:this.originalWidth*a,canvasHeight:this.originalHeight*a}}setSize(a,b){const {density:c,canvasWidth:d,canvasHeight:e}=this.getDensityByDimensions(a,b),{width:f,height:g}=this.calculateAspectRatioFit(this.originalWidth,this.originalHeight,a,b);a=document.documentElement.style;a.setProperty("--timelapse-player-width",`${Math.round(f)}px`);a.setProperty("--timelapse-player-height",`${Math.round(g)}px`);this.density=c;this.width=d;this.height=e;this.bgCanvas.width=d;this.bgCanvas.height=e;
this.canvas.width=d;this.canvas.height=e;this.strokeCanvas.width=d;this.strokeCanvas.height=e;this.redraw()}redraw(){this.pause();if(this.background){this.clearBackground();var a=this.getCache();this.cache[this.density]?(a=a.at(-1),this.bgCtx.putImageData(a,0,0)):this.drawFunction(this.bgCtx,this.background,this.density,!1)}else this.bgCtx.fillStyle=GPTimelapsePlayer_.BACKGROUND_COLOR,this.bgCtx.fillRect(0,0,this.bgCanvas.width,this.bgCanvas.height);this.clearCanvas();a=this.data.slice(0,this.pos);
this.draw(this.ctx,a);this.clearStroke();this.stroke&&(a=this.stroke.slice(0,GPTimelapsePlayer_.STROKE_OFFSET+this.sPos+1),this.draw(this.strokeCtx,[a],this.density,!1))}calculateAspectRatioFit(a,b,c,d){c=Math.min(c/a,d/b);return{width:a*c,height:b*c}}expand(a){this.isExpanded=a??!this.isExpanded;this.player.classList.toggle("expanded_",this.isExpanded);this.isExpanded?this.mainContainer.appendChild(this.player):this.container.firstElementChild.before(this.player);this.resizeHandler();this.isStandalone&&
document.dispatchEvent(new CustomEvent("gp:player.display_mode_changed",{detail:{displayMode:this.isExpanded?GPTimelapsePlayer_.DISPLAY_MODE.EXPANDED:GPTimelapsePlayer_.DISPLAY_MODE.NORMAL}}))}playPause(){this.isPlaying?this.pause():this.play()}play(a=this.pos){a||this.clearCanvas();this.isPlaying=!0;this.updateProgress();this.player.classList.add("playing_");setTimeout(()=>{this.player.classList.remove("finished_")},24);this.timer=requestAnimationFrame(this.drawing)}pause(){this.isPlaying=!1;cancelAnimationFrame(this.timer);
this.player.classList.remove("playing_")}stop(){this.pause();this.pos=0;this.updateProgress()}seek(a){this.pause();a=Math.max(0,Math.min(this.data.length,a));if(a!==this.pos||!a){this.clearStroke();if(a<this.pos||!this.pos){this.clearCanvas();var b=this.data.slice(0,a)}else b=this.data.slice(this.pos,a);this.draw(this.ctx,b);this.pos=a;this.sPos=0;this.stroke=null;this.updateStrokeView()}}drawing(){if(this.stroke)this.drawingStroke(this.stroke);else if(this.pos<this.data.length){const a=this.data.slice(this.pos,
this.pos+this.speed[1]),b=a.at(-1);this.speed[0]&&[1,2].includes(b[0])?(this.sPos=0,this.stroke=b,this.drawingStroke(b)):(this.draw(this.ctx,a),this.pos=Math.min(this.data.length,this.pos+this.speed[1]),this.pos<this.data.length?this.timer=requestAnimationFrame(this.drawing):(this.player.classList.add("finished_"),this.pause()),this.updateProgress(),this.updateStrokeView())}else this.pos=0,this.updateProgress(),this.play()}drawingStroke(a){if(this.speed[0]&&this.sPos<a.length-GPTimelapsePlayer_.STROKE_OFFSET){const b=
a.slice(0,GPTimelapsePlayer_.STROKE_OFFSET+this.sPos+1);this.sPos+=this.speed[0];this.clearStroke();this.draw(this.strokeCtx,[b],this.density,!1);this.timer=requestAnimationFrame(()=>{this.drawingStroke(a)})}else this.sPos=0,this.pos=Math.min(this.data.length,this.pos+this.speed[1]),this.clearStroke(),this.draw(this.ctx,[a]),this.updateProgress(),this.updateStrokeView(),this.stroke=null,this.pos<this.data.length?this.timer=requestAnimationFrame(this.drawing):(this.player.classList.add("finished_"),
this.pause())}changeSpeed(a,b){this.currentSpeed=Math.max(0,Math.min(GPTimelapsePlayer_.SPEEDS.length-1,b??this.currentSpeed+a));this.speed=GPTimelapsePlayer_.SPEEDS[this.currentSpeed];localStorage.setItem("gp-timelapse-player-speed",JSON.stringify(this.currentSpeed));this.updateSpeedView()}speedViewPointerMoveHandler(a){a=(a.clientX-this.player.getBoundingClientRect().x)/this.scaleX;a=Math.round(Math.max(0,Math.min(GPTimelapsePlayer_.SPEED_SLIDER_WIDTH-GPTimelapsePlayer_.SPEED_SLIDER_THUMB_WIDTH,
a-this.speedInput.currentX))/((GPTimelapsePlayer_.SPEED_SLIDER_WIDTH-GPTimelapsePlayer_.SPEED_SLIDER_THUMB_WIDTH)/(GPTimelapsePlayer_.SPEEDS.length-1)));this.speedInput.value=a;this.changeSpeed(null,a)}renderSpeedInput(a,b){if(!this.speedInput){this.speedInput=document.createElement("input");this.speedInput.className="speed-slider_";this.speedInput.type="range";this.speedInput.min=0;this.speedInput.max=GPTimelapsePlayer_.SPEEDS.length-1;this.speedInput.style.width=`${GPTimelapsePlayer_.SPEED_SLIDER_WIDTH}px`;
this.speedInput.style.height=`${GPTimelapsePlayer_.SPEED_SLIDER_HEIGHT}px`;var c=GPTimelapsePlayer_.SPEEDS.findIndex(([d])=>!d);this.speedInput.style.setProperty("--bg-separator",`${Math.round(c/GPTimelapsePlayer_.SPEEDS.length*100)+Math.round(GPTimelapsePlayer_.SPEED_SLIDER_THUMB_WIDTH/GPTimelapsePlayer_.SPEED_SLIDER_WIDTH*100)/2}%`)}this.speedInput.value=this.currentSpeed;c=(GPTimelapsePlayer_.SPEED_SLIDER_WIDTH-GPTimelapsePlayer_.SPEED_SLIDER_THUMB_WIDTH)/(GPTimelapsePlayer_.SPEEDS.length-1)*Number(this.speedInput.value);
this.speedInput.style.top=`${b-GPTimelapsePlayer_.SPEED_SLIDER_HEIGHT-10}px`;this.speedInput.style.left=`${a-c-GPTimelapsePlayer_.SPEED_SLIDER_THUMB_WIDTH/2}px`;this.player.appendChild(this.speedInput);this.speedInput.currentX=a-c}clearBackground(){this.bgCtx.fillStyle=GPTimelapsePlayer_.BACKGROUND_COLOR;this.bgCtx.fillRect(0,0,this.width,this.height)}clearCanvas(){this.ctx.clearRect(0,0,this.width,this.height)}clearStroke(){this.strokeCtx.clearRect(0,0,this.width,this.height)}updateProgress(a=this.pos){this.progress.style.width=
`${Math.round(a/this.data.length*100)}%`}splitStroke(a){const [b,c,d,...e]=a;if(1===b||2===b){a=[];for(let f=1;f<=e.length;f++)a.push([b,c,d,...e.slice(0,f)]);return a}return[a]}getCoords(a,b){b=(b||a.target).getBoundingClientRect();const [c,d]=a.touches?[a.touches[0].clientX,a.touches[0].clientY]:[a.clientX,a.clientY],[e,f]=[c-b.left,d-b.top];return[Math.round(e),Math.round(f),b.width,b.height]}progressBarPointerMoveHandler(a){const [b,,c]=this.getCoords(a);a=Math.max(0,Math.min(1,b/c));const d=
Math.round(this.data.length*a);this.progress.style.width=`${100*a}%`;this.seek(d)}toggleFullscreen(){document.fullscreenElement?document.exitFullscreen():(this.expandStateBeforeFullscreen=this.isExpanded,this.expand(!1),this.player.requestFullscreen())}saveImage(){var a=document.createElement("canvas");a.width=this.width;a.height=this.height;var b=a.getContext("2d");this.draw(b,this.data,this.density,this.eraserAlpha);b=document.createElement("canvas");b.width=this.width;b.height=this.height;var c=
b.getContext("2d");c.fillStyle=GPTimelapsePlayer_.BACKGROUND_COLOR;c.fillRect(0,0,this.width,this.height);if(this.background){var d=this.getCache();this.cache[this.density]?(d=d.at(-1),c.putImageData(d,0,0)):this.drawFunction(c,this.background,this.density,!1)}c=document.createElement("canvas");c.width=this.width;c.height=this.height;d=c.getContext("2d");d.drawImage(b,0,0,this.width,this.height);d.drawImage(a,0,0,this.width,this.height);a=this.date.toLocaleDateString("ru-RU");a=`${this.author} - ${this.title} (${a}).png`;
b=document.createElement("a");b.href=c.toDataURL();b.download=a;b.click()}async saveImageData(){var a=this.date.toLocaleDateString("ru-RU");a=`${this.author} - ${this.title} (${a}).gpimg`;var b={m:{a:this.author,t:this.title,d:this.date.toISOString()},d:this.originalData,c:this.canvasTypeId};this.background&&(b.b=this.background);this.auth&&(b.a=this.auth);b=await GPUtils_.wCompressData(b);GPUtils_.saveBlob(b,a)}getCache(){this.cache?.[this.density]||this.updateCache();return this.cache[this.density]}updateCache(){const a=
this.cache||{};a[this.density]||this.worker.postMessage({type:"get-cache",density:this.density});this.cache=a}draw(a,b,c,d,e=!0){if(b){var f=GPTimelapsePlayer_.CACHE_INTERVAL;if(GPTimelapsePlayer_.CACHE_ENABLED&&e&&b.length>f)if(e=this.getCache(),!this.cache[this.density]&&b.at(-1).index+1<f)this.drawFunction(a,b,c,d);else{const g=Math.floor((b.at(-1).index+1)/f)-1;a.putImageData(e[g],0,0);b=b.slice(-(b.at(-1).index+1-(g+1)*f));this.drawFunction(a,b,c,d)}else this.drawFunction(a,b,c,d)}}drawFunction(a,
b,c=this.density,d=this.eraserAlpha,e=!1){GPUtils_.drawFunction(a,b,c,d,e)}handleDelimiters(a,b){const c=a.findLastIndex(d=>11===d[0]);if(~c){const d=a.slice(c+1);a=(b??[]).concat(a.slice(0,c).filter(e=>11!==e[0]));return[d,a,!0]}return[a,b,!1]}initCacheWorker(){let {width:a,height:b}=getComputedStyle(this.container);a=parseInt(a);b=parseInt(b);var {density:c}=this.getDensityByDimensions(a,b);let {width:d,height:e}=getComputedStyle(this.mainContainer);d=parseInt(d);e=parseInt(e);const {density:f}=
this.getDensityByDimensions(d,e),{density:g}=this.getDensityByDimensions(window.screen.width,window.screen.height),h=[...(new Set([c,f,g]))];this.worker||(c=URL.createObjectURL(new Blob([this.getFuncBody(this.cacheWorkerBody)])),this.worker=new Worker(c),URL.revokeObjectURL(c),this.worker.addEventListener("message",({data:k})=>{"worker-ready"===k.type?h.forEach(l=>{this.worker.postMessage({type:"get-cache",density:l})}):"cache-updated"===k.type&&(this.cache=k.cache,this.dispatchEvent(new CustomEvent("cache_updated",
{detail:{density:k.density}})))}));this.worker.postMessage({type:"init",data:this.data,background:this.background,eraserAlpha:this.eraserAlpha,drawFunctionString:GPUtils_.drawFunctionString,fi:this.fi,CACHE_INTERVAL:GPTimelapsePlayer_.CACHE_INTERVAL,ORIGINAL_WIDTH:this.originalWidth,ORIGINAL_HEIGHT:this.originalHeight,BACKGROUND_COLOR:GPTimelapsePlayer_.BACKGROUND_COLOR})}cacheWorkerBody(){function a(f){var g=b*f,h=c*f;if(!this.cache[f]){this.cache[f]=[];const l=e,m=Math.floor(self.data.length/l);
g=new OffscreenCanvas(g,h);h=g.getContext("2d",{willReadFrequently:!0});let p;self.background&&(h.fillStyle=d,h.fillRect(0,0,g.width,g.height),self.draw(h,this.background,f,!1),p=h.getImageData(0,0,g.width,g.height),h.clearRect(0,0,g.width,g.height));for(let r=0;r<m;r++){var k=r*l;k=self.data.slice(k,k+l);self.draw(h,k,f,self.eraserAlpha);k=h.getImageData(0,0,g.width,g.height);this.cache[f].push(k)}self.background&&this.cache[f].push(p)}}let b,c,d,e;self.data;self.draw;self.cache=[];self.addEventListener("message",
({data:f})=>{"init"===f.type?(self.data=f.data,self.background=f.background,self.eraserAlpha=f.eraserAlpha,self.fi=f.fi,self.draw=(new Function(`return ${f.drawFunctionString}`))(),e=f.CACHE_INTERVAL,b=f.ORIGINAL_WIDTH,c=f.ORIGINAL_HEIGHT,d=f.BACKGROUND_COLOR,self.postMessage({type:"worker-ready"})):"get-cache"===f.type&&(self.cache[f.density]||a(f.density),self.postMessage({type:"cache-updated",cache:self.cache,density:f.density}))})}getFuncBody(a){a=a.toString();return a.substring(a.indexOf("{")+
1,a.lastIndexOf("}"))}}window.GPTimelapsePlayer_=GPTimelapsePlayer_;class GPTimer_ extends EventTarget{static STARTED="started";static PAUSED="paused";static STOPPED="stopped";static SETTING="setting";static SOUND_ALERT_URL="https://garticphone.com/sounds/timeout.mp3";static SETTING_MINUTE_STEP=5;static POINTER_TIMER_CHANGE_SENSITIVITY=Math.round(window.screen.height/1080*15);static DEFAULT_SETTINGS={reverted:!0,delimiterFlicker:!0,soundAlert:!0,soundAlertVolume:1,runAfterTurnStart:!1,readyAfterTimeExpires:!1,defaultTimer:"1800000",timers:[]};static SETTINGS_UI={reverted:{type:"switch",
description:"\u0412\u043a\u043b\u044e\u0447\u0430\u0435\u0442 \u043e\u0442\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0435 \u043e\u0442\u0441\u0447\u0451\u0442\u0430 \u0432\u0440\u0435\u043c\u0435\u043d\u0438 \u0432 \u043e\u0431\u0440\u0430\u0442\u043d\u043e\u043c \u043d\u0430\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0438"},delimiterFlicker:{type:"switch",description:"\u0412\u043a\u043b\u044e\u0447\u0430\u0435\u0442 \u043c\u0435\u0440\u0446\u0430\u043d\u0438\u0435 \u0440\u0430\u0437\u0434\u0435\u043b\u0438\u0442\u0435\u043b\u044f \u0447\u0430\u0441\u043e\u0432 \u0438 \u043c\u0438\u043d\u0443\u0442"},
_2:{text:"Sound Alert"},soundAlert:{type:"switch",description:"\u0417\u0432\u0443\u043a\u043e\u0432\u043e\u0435 \u043e\u043f\u043e\u0432\u0435\u0449\u0435\u043d\u0438\u0435, \u0441\u0438\u0433\u043d\u0430\u043b\u0438\u0437\u0438\u0440\u0443\u044e\u0449\u0435\u0435 \u043e \u0437\u0430\u0432\u0435\u0440\u0448\u0435\u043d\u0438\u0438 \u0432\u0440\u0435\u043c\u0435\u043d\u0438"},soundAlertVolume:{type:"slider",args:{min:0,max:1,step:.01},formatter:this.volumeFormatter,description:"\u0423\u0440\u043e\u0432\u0435\u043d\u044c \u0433\u0440\u043e\u043c\u043a\u043e\u0441\u0442\u0438 \u0437\u0432\u0443\u043a\u043e\u0432\u043e\u0433\u043e \u043e\u043f\u043e\u0432\u0435\u0449\u0435\u043d\u0438\u044f"},
_3:{text:"Triggers"},runAfterTurnStart:{type:"switch",description:"\u0410\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438 \u0437\u0430\u043f\u0443\u0441\u043a\u0430\u0442\u044c \u0442\u0430\u0439\u043c\u0435\u0440 \u043f\u043e\u0441\u043b\u0435 \u043d\u0430\u0447\u0430\u043b\u0430 \u0440\u0430\u0443\u043d\u0434\u0430"},readyAfterTimeExpires:{type:"switch",description:"\u0410\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438 \u043d\u0430\u0436\u0438\u043c\u0430\u0442\u044c \u043a\u043d\u043e\u043f\u043a\u0443 \u0433\u043e\u0442\u043e\u0432\u043d\u043e\u0441\u0442\u0438 \u043f\u043e \u0438\u0441\u0442\u0435\u0447\u0435\u043d\u0438\u0438 \u0432\u0440\u0435\u043c\u0435\u043d\u0438"},
_4:{text:"Timers"},defaultTimer:{type:"dropdown",args:{items:this.DEFAULT_SETTINGS.timers,itemsProxySetting:"timers"},formatter:this.timeFormatter,description:"\u0422\u0430\u0439\u043c\u0435\u0440 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e (\u0443\u0441\u0442\u0430\u043d\u0430\u0432\u043b\u0438\u0432\u0430\u0435\u0442\u0441\u044f \u043f\u0440\u0438 \u0432\u0445\u043e\u0434\u0435 \u043d\u0430 \u0441\u0430\u0439\u0442)"},timers:{type:"list-multiple-dynamic",formatter:this.timeFormatter,
description:"\u0421\u043f\u0438\u0441\u043e\u043a \u0434\u043e\u0431\u0430\u0432\u043b\u0435\u043d\u043d\u044b\u0445 \u0432\u0430\u043c\u0438 \u0442\u0430\u0439\u043c\u0435\u0440\u043e\u0432"}};static timeFormatter(a){return`${Math.floor(a/36E5)}:${String(Math.floor(a/6E4)%60).padStart(2,"0")}`}static volumeFormatter(a){return`${Math.round(100*a)}`}static MODULE={title:"Timer",alias:"tmr",settings:{storage:"gp_timer",defaultSettings:this.DEFAULT_SETTINGS,ui:this.SETTINGS_UI},useCSS:!0};constructor(a){if(GPTimer_.instance)return GPTimer_.instance;
super();GPTimer_.instance=this;this.s=a.sm.setSettings(this,this.updateSettings);this.timer;this.value=+this.s.defaultTimer;this.timeStarted;this.timePaused;this.elapsed=0;this.state=GPTimer_.STOPPED;GPUtils_.bindMethods([this.onPointerDown,this.onWheel,this.onTimerChange,this.onAddBtnClick],this);this.render()}static getInstance(){return this.instance}getElement(){return this.container}render(){this.container=document.createElement("div");this.container.className="gp-timer_";this.container.dataset.state=
this.state;this.container.addEventListener("pointerdown",this.onPointerDown);this.container.addEventListener("wheel",this.onWheel);this.container.addEventListener("contextmenu",b=>{b.preventDefault()});this.hours=document.createElement("div");this.hours.className="hours_";this.hours.addEventListener("pointerdown",this.onTimerChange);this.minutes=document.createElement("div");this.minutes.className="minutes_";this.minutes.addEventListener("pointerdown",this.onTimerChange);this.seconds=document.createElement("div");
this.seconds.className="seconds_";this.delimiter=document.createElement("div");this.delimiter.className="delimiter_";this.delimiter.classList.toggle("flicker_",this.s.delimiterFlicker);this.delimiter.textContent=":";this.addBtn=document.createElement("div");this.addBtn.className="add-btn_";this.addBtn.textContent="+";this.addBtn.addEventListener("click",this.onAddBtnClick);this.container.appendChild(this.hours);this.container.appendChild(this.delimiter);this.container.appendChild(this.minutes);this.container.appendChild(this.seconds);
this.container.appendChild(this.addBtn);const a=this.formatTime(this.value);this.renderTime(a);this.alert=new Audio(GPTimer_.SOUND_ALERT_URL);this.alert.src=GPTimer_.SOUND_ALERT_URL}onPointerDown(a){if(0===a.button&&!a.ctrlKey)this.playPause();else if(2===a.button)this.revertTime();else if(1===a.button||0===a.button&&a.ctrlKey)this.state===GPTimer_.STARTED?this.reset():this.toggleSetting()}onWheel(a){var b=0>a.deltaY;switch(this.state){case GPTimer_.SETTING:var c=Number.parseInt(this.hours.textContent);
let d=Number.parseInt(this.minutes.textContent);switch(a.target){case this.hours:c+=b?1:-1;c=(0>c?c+24:c)%24;break;case this.minutes:d+=(b?1:-1)*GPTimer_.SETTING_MINUTE_STEP,d=(0>d?d+60:d)%60}this.value=36E5*Math.max(Math.min(c,24),0)+6E4*Math.max(Math.min(d,55),0);b=this.formatTime(this.value);this.renderTime(b);break;case GPTimer_.STARTED:a=this.s.timers.length,c=this.s.timers.findIndex(e=>+e===this.value),~c?(b=c+(b?-1:1),this.value=+this.s.timers[(0>b?b+a:b)%a]):a&&(this.value=+this.s.timers[0]),
this.reset()}}onTimerChange(a){if(this.state===GPTimer_.SETTING){var b=a.clientY,c=d=>{var e=d.clientY-b,f=0>e;if(Math.abs(e)>=GPTimer_.POINTER_TIMER_CHANGE_SENSITIVITY){e=Number.parseInt(this.hours.textContent);let g=Number.parseInt(this.minutes.textContent);switch(d.currentTarget){case this.hours:e+=f?1:-1;e=(0>e?e+24:e)%24;break;case this.minutes:g+=(f?1:-1)*GPTimer_.SETTING_MINUTE_STEP,g=(0>g?g+60:g)%60}this.value=36E5*Math.max(Math.min(e,24),0)+6E4*Math.max(Math.min(g,55),0);f=this.formatTime(this.value);
this.renderTime(f);b=d.clientY}};a.currentTarget.setPointerCapture(a.pointerId);a.currentTarget.addEventListener("pointermove",c);a.currentTarget.addEventListener("pointerup",d=>{d.currentTarget.removeEventListener("pointermove",c)},{once:!0})}}onAddBtnClick(a){this.value&&!this.s.timers.includes(String(this.value))&&(this.s.timers=[...this.s.timers,String(this.value)].sort((b,c)=>c-b))}toggleSetting(){this.state!==GPTimer_.SETTING?(this.reset(),this.updateState(GPTimer_.SETTING)):this.updateState(GPTimer_.STOPPED)}revertTime(a){this.state===
GPTimer_.STARTED&&(void 0===a&&(this.s.reverted=a=!this.s.reverted),this.container.classList.remove("last-minute_"),a=this.formatTime(a?Math.max(this.value-this.elapsed,0):Math.min(this.elapsed,this.value)),this.renderTime(a))}renderTime({h:a,m:b,s:c}){this.hours.textContent=a;this.minutes.textContent=String(b).padStart(2,"0");this.state!==GPTimer_.STARTED||!this.s.reverted||a||b||(this.container.classList.add("last-minute_"),this.seconds.textContent=String(c).padStart(2,"0"))}tick(){this.elapsed=
Date.now()-this.timeStarted;const a=this.formatTime(this.s.reverted?Math.max(this.value-this.elapsed,0):Math.min(this.elapsed,this.value));this.renderTime(a);this.elapsed>=this.value&&(this.stop(),this.s.soundAlert&&!this.s.readyAfterTimeExpires&&this.runAlert(),this.dispatchEvent(new Event("finish")),this.container.classList.add("finished_"))}playPause(){switch(this.state){case GPTimer_.STOPPED:case GPTimer_.PAUSED:this.start();break;case GPTimer_.STARTED:this.pause()}}start(){clearInterval(this.timer);
this.container.classList.remove("finished_");this.state===GPTimer_.STOPPED?this.timeStarted=Date.now():this.state===GPTimer_.PAUSED&&(this.timeStarted=Date.now()-(this.timePaused-this.timeStarted));this.timer=setInterval(this.tick.bind(this),1E3);this.updateState(GPTimer_.STARTED);this.tick()}pause(){this.timePaused=Date.now();clearInterval(this.timer);this.updateState(GPTimer_.PAUSED)}stop(){this.container.classList.remove("last-minute_");clearInterval(this.timer);this.updateState(GPTimer_.STOPPED)}reset(){this.stop();
this.elapsed=0;const a=this.formatTime(this.value,!0);this.renderTime(a);this.container.classList.remove("finished_")}formatTime(a){return{h:Math.floor(a/36E5),m:Math.floor(a/6E4)%60,s:Math.round(a/1E3)%61}}runAlert(a=0){this.alert.currentTime=a;this.alert.play()}updateState(a){this.state=a;this.container.dataset.state=a}updateSettings({detail:{settings:a}}){"reverted"in a&&this.revertTime(a.reverted);"delimiterFlicker"in a&&this.delimiter.classList.toggle("flicker_",a.delimiterFlicker);"soundAlertVolume"in
a&&(this.alert.volume=Number.parseFloat(a.soundAlertVolume),1===Object.keys(a).length&&this.runAlert(.3));"defaultTimer"in a&&this.state===GPTimer_.STOPPED&&(this.value=+a.defaultTimer)}}window.GPTimer_=GPTimer_;class GPKnownUsersDB_ extends EventTarget{static READ="readonly";static WRITE="readwrite";static DB_NAME="gp_users_db";static STORE_NAME="users";static USERS_LIMIT=1E4;constructor(){super();this.db=null;this.init()}init(){return new Promise((a,b)=>{const c=window.indexedDB.open(GPKnownUsersDB_.DB_NAME,1);c.addEventListener("error",d=>{console.error("Users Database Request Error:",d.target.errorCode);b(d.target.errorCode)});c.addEventListener("success",d=>{d=d.target.result;d.addEventListener("error",
e=>{console.error("Users Database Error:",e.target.errorCode)});this.db=d;this.dispatchEvent(new CustomEvent("init",{detail:d}));a(d)});c.addEventListener("upgradeneeded",d=>{d=d.target.result.createObjectStore(GPKnownUsersDB_.STORE_NAME,{keyPath:"username"});d.createIndex("username","username",{unique:!0});d.createIndex("last_seen","last_seen")})})}async hasUsers(a){const b=new Set;if(!this.db)return b;const c=await this.getStore(GPKnownUsersDB_.READ);(await Promise.all(a.map(d=>this.getUser(d,c)))).forEach(d=>
{null!==d&&b.add(d)});return b}async hasUser(a,b){return null!==await this.getUser(a,b)?!0:!1}getUser(a,b){return this.db?new Promise(async c=>{b||=await this.getStore(GPKnownUsersDB_.READ);const d=b.getKey(a);d.addEventListener("success",e=>{c(e.target.result??null)});d.addEventListener("error",()=>{c(null)})}):Promise.resolve(null)}async addUsers(a){if(a?.length)for(let b of a)await this.addUser(b)}addUser(a,b){return this.db?new Promise(async c=>{var d={username:a,last_seen:Date.now()};b||=await this.getStore(GPKnownUsersDB_.WRITE);
d=b.put(d);d.addEventListener("success",async e=>{await this.size()>GPKnownUsersDB_.USERS_LIMIT&&await this.clean();c(!0)});d.addEventListener("error",e=>{c(!1)})}):Promise.resolve(!1)}async deleteUser(a){this.db&&(await this.getStore(GPKnownUsersDB_.WRITE)).delete(a)}async clean(){if(this.db){var a=await this.size()-GPKnownUsersDB_.USERS_LIMIT;if(!(0>=a)){var b=await this.getStore(GPKnownUsersDB_.WRITE);b.index("last_seen").openKeyCursor(null,"next").addEventListener("success",c=>{(c=c.target.result)&&
a&&(b.delete(c.primaryKey),a--,c.continue())})}}}size(){return new Promise(async a=>{(await this.getStore(GPKnownUsersDB_.READ)).count().addEventListener("success",b=>{a(b.target.result)})})}async getStore(a){try{return this.db.transaction([GPKnownUsersDB_.STORE_NAME],a).objectStore(GPKnownUsersDB_.STORE_NAME)}catch(b){return await this.init(),this.getStore(a)}}}window.GPKnownUsersDB_=GPKnownUsersDB_;class GPModeration_ extends EventTarget{static TWITCH_APP_CLIENT_ID="qrohytuwdc7d3uns3gnvtb4esylpqy";static TWITCH_APP_SCOPES="moderator:manage:banned_users";static TWITCH_APP_REDIRECT_URI="https://gpmod.github.io/twitch-token?WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWW&tokenType={token-type}";static TWITCH_AUTH_URL=`https://id.twitch.tv/oauth2/authorize?client_id=${this.TWITCH_APP_CLIENT_ID}&redirect_uri=${encodeURIComponent(this.TWITCH_APP_REDIRECT_URI)}&response_type=token&scope=${this.TWITCH_APP_SCOPES}`;static TWITCH_BANS_API="https://api.twitch.tv/helix/moderation/bans";static NEW_ACCOUNT_PERIODS=["3600000",
"86400000","604800000","2678400000"];static NEW_ACCOUNT_PERIODS_ALIASES=["Hour","Day","Week","Month"];static ALBUM_ITEM_TYPE={IMAGE:"image",TEXT:"text",ANIMATION:"animation"};static CENSORING_REASON={BANNED_PLAYER:"banned_player",BACKGROUND:"background",UNKNOWN_PLAYER:"unknown_player",NEW_ACCOUNT:"new_account",FORGERY:"forgery",BY_USER:"by_user",ANIMATION_FRAME:"animation_frame",SAFE_MODE:"safe_mode"};static PREVIEW_PATHS=["write","memory"];static PREVIEW_MONITOR_INTERVAL=200;static PREVIEW_MONITOR_TIMEOUT=2E3;static SAFE_MODE_OPT_L10N={ru:{TITLE:"\u0411\u0435\u0437\u043e\u043f\u0430\u0441\u043d\u044b\u0439 \u0440\u0435\u0436\u0438\u043c",
DESC:"\u0421\u043a\u0440\u044b\u0432\u0430\u0442\u044c \u0432\u0441\u0435 \u0440\u0438\u0441\u0443\u043d\u043a\u0438 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e",ON:"\u0412\u041a\u041b",OFF:"\u0412\u042b\u041a\u041b"},en:{TITLE:"Safe Mode",DESC:"Hide all drawings by default",ON:"ON",OFF:"OFF"},es:{TITLE:"Modo Seguro",DESC:"Ocultar todos los dibujos por defecto",ON:"ON",OFF:"OFF"}};static DEFAULT_SETTINGS={showUI:!1,autoKick:!0,autoKickNewAccounts:!1,copyUsernamesWithClick:!1,
compactMode:!0,playersColorIndication:!0,twitchFollowerBadges:!1,twitchSubscriberBadges:!1,disableLocalizedTwitchUsernames:!1,censorDrawings:!0,censorSentences:!0,censorNicknames:!1,censorUnknownPlayers:!1,censorNewAccounts:!1,newAccountPeriod:"86400000",safeMode:!1,previewEnabled:!1,previewPanelPos:{x:0,y:0,o:"br"},previewPanelWidth:280,userBansSyncWithTwitch:!1,twitchToken:"",sendBanReports:!0};static SETTINGS_UI={autoKick:{type:"switch",description:"\u0412\u044b\u0433\u043e\u043d\u044f\u0442\u044c \u0438\u0437 \u043b\u043e\u0431\u0431\u0438 \u0438\u0433\u0440\u043e\u043a\u043e\u0432 \u0438\u0437 \u0441\u043f\u0438\u0441\u043a\u0430 \u0437\u0430\u0431\u0430\u043d\u0435\u043d\u043d\u044b\u0445"},
autoKickNewAccounts:{type:"switch",description:"\u0412\u044b\u0433\u043e\u043d\u044f\u0442\u044c \u0438\u0437 \u043b\u043e\u0431\u0431\u0438 \u0438\u0433\u0440\u043e\u043a\u043e\u0432 \u0441 \u043d\u043e\u0432\u044b\u043c\u0438 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u0430\u043c\u0438 (Twitch)"},copyUsernamesWithClick:{type:"switch",description:"\u041a\u043e\u043f\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0438\u043c\u044f \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0438 \u043f\u0440\u0438 \u043d\u0430\u0436\u0430\u0442\u0438\u0438 \u043d\u0430 \u0435\u0433\u043e \u043d\u0438\u043a \u0432 \u0430\u043b\u044c\u0431\u043e\u043c\u0435 \u0438\u043b\u0438 \u0432 \u0441\u043f\u0438\u0441\u043a\u0435 \u0438\u0433\u0440\u043e\u043a\u043e\u0432"},
_1:{text:"Interface"},compactMode:{type:"switch",description:"\u041a\u043e\u043c\u043f\u0430\u043a\u0442\u043d\u044b\u0439 \u0440\u0435\u0436\u0438\u043c \u043e\u0442\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044f \u043f\u0430\u043d\u0435\u043b\u0438 \u0441\u043f\u0438\u0441\u043a\u0430 \u0438\u0433\u0440\u043e\u043a\u043e\u0432"},playersColorIndication:{type:"switch",description:"\u041e\u0442\u043e\u0431\u0440\u0430\u0436\u0430\u0442\u044c \u0446\u0432\u0435\u0442\u043e\u0432\u044b\u0435 \u043e\u0431\u043e\u0437\u043d\u0430\u0447\u0435\u043d\u0438\u044f \u0437\u0430\u0431\u0430\u043d\u0435\u043d\u043d\u044b\u0445, \u043d\u0435\u0438\u0437\u0432\u0435\u0441\u0442\u043d\u044b\u0445 \u0438 \u0438\u0433\u0440\u043e\u043a\u043e\u0432 \u0441 \u043d\u043e\u0432\u044b\u043c\u0438 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u0430\u043c\u0438 \u0432 \u0441\u043f\u0438\u0441\u043a\u0435 \u0438\u0433\u0440\u043e\u043a\u043e\u0432 \u0440\u043e\u0434\u043d\u043e\u0433\u043e \u0438\u043d\u0442\u0435\u0440\u0444\u0435\u0439\u0441\u0430"},
twitchFollowerBadges:{type:"switch",description:"\u041e\u0442\u043e\u0431\u0440\u0430\u0436\u0430\u0442\u044c \u0437\u043d\u0430\u0447\u043e\u043a \u0444\u043e\u043b\u043b\u043e\u0432\u0435\u0440\u0430 \u0434\u043b\u044f \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439 Twitch"},twitchSubscriberBadges:{type:"switch",description:"\u041e\u0442\u043e\u0431\u0440\u0430\u0436\u0430\u0442\u044c \u0437\u043d\u0430\u0447\u043e\u043a \u043f\u043e\u0434\u043f\u0438\u0441\u0447\u0438\u043a\u0430 \u0434\u043b\u044f \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439 Twitch"},
disableLocalizedTwitchUsernames:{type:"switch",description:"\u0417\u0430\u043c\u0435\u043d\u044f\u0442\u044c \u044f\u043f\u043e\u043d\u0441\u043a\u0438\u0435, \u043a\u043e\u0440\u0435\u0439\u0441\u043a\u0438\u0435 \u0438 \u043a\u0438\u0442\u0430\u0439\u0441\u043a\u0438\u0435 \u0438\u043c\u0435\u043d\u0430 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439 \u0432 \u0441\u043f\u0438\u0441\u043a\u0435 \u0438\u0433\u0440\u043e\u043a\u043e\u0432 \u0438 \u0432 \u0430\u043b\u044c\u0431\u043e\u043c\u0430\u0445 \u043d\u0430 \u0438\u043c\u0435\u043d\u0430 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u043e\u0432"},
_2:{text:"Censor Content"},censorDrawings:{type:"switch",description:"\u0421\u043a\u0440\u044b\u0432\u0430\u0442\u044c \u0440\u0438\u0441\u0443\u043d\u043a\u0438 \u0438\u0433\u0440\u043e\u043a\u043e\u0432, \u0432\u043d\u0435\u0441\u0451\u043d\u043d\u044b\u0445 \u0441\u043f\u0438\u0441\u043e\u043a \u0437\u0430\u0431\u0430\u043d\u0435\u043d\u043d\u044b\u0445"},censorSentences:{type:"switch",description:"\u0421\u043a\u0440\u044b\u0432\u0430\u0442\u044c \u043e\u043f\u0438\u0441\u0430\u043d\u0438\u044f \u0440\u0438\u0441\u0443\u043d\u043a\u043e\u0432 \u0438\u0433\u0440\u043e\u043a\u043e\u0432, \u0432\u043d\u0435\u0441\u0451\u043d\u043d\u044b\u0445 \u0441\u043f\u0438\u0441\u043e\u043a \u0437\u0430\u0431\u0430\u043d\u0435\u043d\u043d\u044b\u0445"},
censorNicknames:{type:"switch",description:"\u0421\u043a\u0440\u044b\u0432\u0430\u0442\u044c \u0438\u043c\u0435\u043d\u0430 \u0438\u0433\u0440\u043e\u043a\u043e\u0432, \u0432\u043d\u0435\u0441\u0451\u043d\u043d\u044b\u0445 \u0432 \u0441\u043f\u0438\u0441\u043e\u043a \u0437\u0430\u0431\u0430\u043d\u0435\u043d\u043d\u044b\u0445"},_3:{text:"Censor Rules"},censorUnknownPlayers:{type:"switch",description:"\u0421\u043a\u0440\u044b\u0432\u0430\u0442\u044c \u043a\u043e\u043d\u0442\u0435\u043d\u0442 \u0438\u0433\u0440\u043e\u043a\u043e\u0432, \u043a\u043e\u0442\u043e\u0440\u044b\u0445 \u0412\u044b \u0432\u0438\u0434\u0438\u0442\u0435 \u0432 \u0438\u0433\u0440\u0430\u0445 \u0432\u043f\u0435\u0440\u0432\u044b\u0435"},
censorNewAccounts:{type:"switch",description:"\u0421\u043a\u0440\u044b\u0432\u0430\u0442\u044c \u043a\u043e\u043d\u0442\u0435\u043d\u0442 \u0438\u0433\u0440\u043e\u043a\u043e\u0432, \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u044b \u043a\u043e\u0442\u043e\u0440\u044b\u0445 \u0441\u0447\u0438\u0442\u0430\u044e\u0442\u0441\u044f \u043d\u043e\u0432\u044b\u043c\u0438 (Twitch)"},newAccountPeriod:{type:"dropdown",args:{items:GPModeration_.NEW_ACCOUNT_PERIODS},formatter:this.newAccountPeriodFormatter,description:"\u041f\u0435\u0440\u0438\u043e\u0434, \u0432 \u0442\u0435\u0447\u0435\u043d\u0438\u0435 \u043a\u043e\u0442\u043e\u0440\u043e\u0433\u043e \u0430\u043a\u043a\u0430\u0443\u043d\u0442 \u0441\u0447\u0438\u0442\u0430\u0435\u0442\u0441\u044f \u043d\u043e\u0432\u044b\u043c"},
safeMode:{type:"switch",description:"\u0421\u043a\u0440\u044b\u0432\u0430\u0442\u044c \u0440\u0438\u0441\u0443\u043d\u043a\u0438\u00a0\u0438\u0433\u0440\u043e\u043a\u043e\u0432 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e\n\u0420\u0438\u0441\u0443\u043d\u043a\u0438 \u043c\u043e\u0436\u043d\u043e \u043f\u0440\u043e\u0441\u043c\u0430\u0442\u0440\u0438\u0432\u0430\u0442\u044c \u0447\u0435\u0440\u0435\u0437 \u043f\u0430\u043d\u0435\u043b\u044c \u043f\u0440\u0435\u0434\u043f\u0440\u043e\u0441\u043c\u043e\u0442\u0440\u0430 \u043f\u0435\u0440\u0435\u0434 \u043f\u043e\u043a\u0430\u0437\u043e\u043c \u0438\u0445 \u043d\u0430 \u0442\u0440\u0430\u043d\u0441\u043b\u044f\u0446\u0438\u0438"},
_4:{text:"Twitch Integration"},userBansSyncWithTwitch:{type:"switch",description:"\u0421\u0438\u043d\u0445\u0440\u043e\u043d\u0438\u0437\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0431\u043b\u043e\u043a\u0438\u0440\u043e\u0432\u043a\u0443 \u0438\u0433\u0440\u043e\u043a\u043e\u0432 \u0432 Gartic Phone \u0441 \u0431\u043b\u043e\u043a\u0438\u0440\u043e\u0432\u043a\u0430\u043c\u0438 \u043d\u0430 Twitch\n\u0412 \u0438\u0433\u0440\u0430\u0445 \u0441 \u0430\u0432\u0442\u043e\u0440\u0438\u0437\u0430\u0446\u0438\u0435\u0439 \u0447\u0435\u0440\u0435\u0437 Twitch \u0431\u0430\u043d\u044b/\u0440\u0430\u0437\u0431\u0430\u043d\u044b \u043f\u0440\u0438\u0432\u043e\u0434\u044f\u0442 \u043a \u0431\u0430\u043d\u0430\u043c/\u0440\u0430\u0437\u0431\u0430\u043d\u0430\u043c \u043d\u0430 \u043a\u0430\u043d\u0430\u043b\u0435 Twitch"},
_5:{text:"Reports"},sendBanReports:{type:"switch",description:"\u041e\u0442\u0441\u044b\u043b\u0430\u0442\u044c \u043e\u0442\u0447\u0451\u0442\u044b \u043e \u0440\u0438\u0441\u0443\u043d\u043a\u0430\u0445 \u043f\u0440\u0438 \u0431\u043b\u043e\u043a\u0438\u0440\u043e\u0432\u043a\u0435 \u0438\u0433\u0440\u043e\u043a\u0430 \u0447\u0435\u0440\u0435\u0437 \u043d\u0430\u0436\u0430\u0442\u0438\u0435 \u043d\u0430 \u0430\u0432\u0430\u0442\u0430\u0440 \u0432 \u0430\u043b\u044c\u0431\u043e\u043c\u0435\n\u0412 \u0446\u0435\u043b\u044f\u0445 \u0434\u043e\u0431\u0430\u0432\u043b\u0435\u043d\u0438\u044f \u0430\u0432\u0442\u043e\u0440\u0430 \u0440\u0438\u0441\u0443\u043d\u043a\u0430 \u0432 \u0433\u043b\u043e\u0431\u0430\u043b\u044c\u043d\u044b\u0439 \u0441\u043f\u0438\u0441\u043e\u043a \u0437\u0430\u0431\u0430\u043d\u0435\u043d\u043d\u044b\u0445 \u0438\u0433\u0440\u043e\u043a\u043e\u0432 (\u043f\u043e\u0441\u043b\u0435 \u043f\u0440\u043e\u0432\u0435\u0440\u043a\u0438)"}};static newAccountPeriodFormatter(a,
b){return GPModeration_.NEW_ACCOUNT_PERIODS_ALIASES[b]}static MODULE={title:"Moderation",alias:"mod",dependencies:"GPUtils_ GPAssets_ GPContentObserver_ GPKnownUsersDB_ GPImageReportSender_ GPPreview_".split(" "),settings:{storage:"gp_userlist",defaultSettings:this.DEFAULT_SETTINGS,ui:this.SETTINGS_UI},useCSS:!0};constructor(a){if(GPModeration_.instance)return GPModeration_.instance;super();GPModeration_.instance=this;this.prx=a.prx;this.av=a.av;this.ac=a.ac;this.abt=a.abt;this.s=a.sm.setSettings(this,
this.updateSettings);this.usersDB=new GPKnownUsersDB_;this.twitchAPI=new GPTwitchAPI_;this.twitchAPI.addEventListener("token",({detail:{type:b,token:c}})=>{switch(b){case GPTwitchAPI_.TOKEN_TYPE.BAN_USERS:this.s.twitchToken=c;break;case GPTwitchAPI_.TOKEN_TYPE.FOLLOWERS_SUBSCRIPTIONS:this.s.twitchToken2=c}});this.banlist=new Set(this.prx.isTwitchOAuth?null:JSON.parse(localStorage.getItem("ul_banlist")));this.twitchUserIds=new Map;this.localizedLogins=new Map;this.isMiddlewareActive=!1;this.searchPreviewTimer;
GPUtils_.bindMethods([this.handlePlayerItem,this.handlePreviewImage,this.handleAlbumAvatars,this.handleAlbumItem,this.handlePreviewItem,this.handleAlbumUsername,this.handleAlbumHeader,this.handleAlbumFooter,this.handleAlbumRanking,this.handlePainterHeader],this);this.contentObserver=new GPContentObserver_(a.prx);this.contentObserver.addPlayerListHandler(this.handlePlayerItem);this.contentObserver.addPainterHeaderHandler(this.handlePainterHeader);this.contentObserver.addDrawingPreviewHandler(this.handlePreviewImage);
this.contentObserver.addAlbumItemsHandler(this.handleAlbumAvatars,this.handleAlbumItem,this.handlePreviewItem,this.handleAlbumUsername);this.albumItems=this.contentObserver.getAlbumItems();this.contentObserver.addAlbumHeaderHandler(this.handleAlbumHeader);this.contentObserver.addAlbumFooterHandler(this.handleAlbumFooter);this.contentObserver.addAlbumRankingHandler(this.handleAlbumRanking);this.reportSender=new GPImageReportSender_(GPImageReportSender_.BAN,this.prx,a.act);this.preview=new GPPreview_(this.prx,
this.s.previewEnabled,this.s.previewPanelPos,this.s.previewPanelWidth,this.l);this.preview.addEventListener("status",({detail:{status:b}})=>{this.s.previewEnabled=b});this.preview.addEventListener("panel_pos_changed",({detail:b})=>{this.s.previewPanelPos=b});this.preview.addEventListener("panel_width_changed",({detail:{width:b}})=>{this.s.previewPanelWidth=b});this.censorItems=new Map;this.unknownUsers=new Set;this.suspiciousItems=this.ac?.getSuspiciousItems()??new Set;this.userDatesCreated={};this.followers=
{};this.subscribers={};this.isAlbumBgHidden=!1;this.newAccountLabels=this.l.NEW_ACCOUNT_AGE.split("|").map(b=>b.split(","));this.inGallerySettingsObserving=!1;this.safeModControl=null;this.safeItems=new Set;a=document.documentElement.style;a.setProperty("--mod-item-banned-player",`'${this.l.ITEM_BANNED_PLAYER}'`);a.setProperty("--mod-item-censored-bg",`'${this.l.ITEM_CENSORED_BG}'`);a.setProperty("--mod-item-unknown-player",`'${this.l.ITEM_UNKNOWN_PLAYER}'`);a.setProperty("--mod-item-new-account",
`'${this.l.ITEM_NEW_ACCOUNT}'`);a.setProperty("--mod-item-censored",`'${this.l.ITEM_CENSORED}'`);a.setProperty("--mod-item-safe-mode",`'${this.l.ITEM_SAFE_MODE}'`);GPUtils_.bindMethods([this.middleware,this.usersClickHandler,this.banlistClickHandler,this.albumItemClickHandler,this.albumItemEnterHandler,this.albumItemLeaveHandler,this.preventAlbumContentInteraction,this.imagePreviewOverHandler,this.imagePreviewDownHandler,this.painterHeaderTextOverHandler,this.painterHeaderTextDownHandler],this);this.prx.addEventListener("data",
({detail:{event:b}})=>{if(this.prx.isAuthorized||this.prx.isTwitchOAuth)b===GPProxy_.EVENT.GAME_STARTED?this.prx.isAuthorized&&this.parseUnknownUsers():b===GPProxy_.EVENT.TURNS_ENDED?this.prx.isHost()&&document.addEventListener("gp:screen_changed",({detail:{screen:c}})=>{"book"===c&&this.injectSafeModeControl()},{once:!0}):b===GPProxy_.EVENT.GALLERY_SETTINGS&&(this.prx.addWSMsgMiddleware([GPProxy_.EVENT.ALBUM_ITEM,GPProxy_.EVENT.ALBUM_INFO],this.middleware),this.isMiddlewareActive=!0,this.init()),
this.isMiddlewareActive&&[GPProxy_.EVENT.NEW_GAME,GPProxy_.EVENT.ALBUM_SCORE,GPProxy_.EVENT.GAME_QUIT,GPProxy_.EVENT.GAME_STARTED].includes(b)&&(this.prx.removeWSMsgMiddleware(this.middleware),this.isMiddlewareActive=!1,this.terminate())});this.prx.addEventListener("rejoin",({detail:{stage:b}})=>{switch(b){case GPProxy_.STAGE.GAME:this.prx.isAuthorized&&this.parseUnknownUsers();break;case GPProxy_.STAGE.ALBUM:if(this.prx.isAuthorized||this.prx.isTwitchOAuth)this.init(),this.prx.addWSMsgMiddleware([GPProxy_.EVENT.ALBUM_ITEM,
GPProxy_.EVENT.ALBUM_INFO],this.middleware),this.isMiddlewareActive=!0;this.prx.isTwitchAuth()&&document.addEventListener("gp:tw.ids_usernames",()=>{this.handleAlbumHeader();this.handleAlbumFooter();this.handleAlbumUsernames()},{once:!0});break;case GPProxy_.STAGE.SCORE:this.prx.isTwitchAuth()&&document.addEventListener("gp:tw.ids_usernames",()=>{this.updateRankingUsers()},{once:!0})}});this.prx.addEventListener("albums_ended",()=>{if(this.prx.isAuthorized&&this.prx.isHost()){var b=this.prx.getUsers().filter(({nick:c,
viewer:d})=>!this.prx.isYou(c)&&!d&&!this.banlist.has(this.prx.formatNickname(c))).map(c=>c.nick);this.usersDB.addUsers(b)}});this.prx.addEventListener("users_updated",({detail:{users:b}})=>{this.renderUsers(b)});this.prx.addEventListener("player_joined",({detail:b})=>{this.clearPlayers([b]);this.requestTwitchUsersData([b])});this.prx.addEventListener("owner_status",()=>{this.renderUsers();this.updatePlayerItems()});document.addEventListener("_tw_users_data",({detail:{userDatesCreated:b,followers:c,
subscribers:d}})=>{this.updateUserDatesCreatedCache(b);this.updateFollowers(c);this.updateSubscribers(d);this.clearPlayers();this.renderUsers();this.s.twitchFollowerBadges||this.s.twitchSubscriberBadges?this.updatePlayerItems():Object.keys(b).length&&this.prx.getUsers().forEach(e=>{this.prx.formatNickname(e.nick)in b&&this.isNewAccount(e.nick)&&this.updatePlayerItem(e.nick)})});document.addEventListener("gp:tw.ids_usernames",({detail:{usernamesMap:b,localizedLoginsMap:c}})=>{this.updateUserIdsCache(b);
this.updateLocalizedLogins(c);c.size&&(this.prx.getUsers().forEach(d=>{c.has(d.nick)&&this.updatePlayerItem(d.nick)}),c.forEach((d,e)=>{this.updateBanlistUsername(e,d)}))});document.addEventListener("gp:tw.invalid_token_2",b=>{this.showTwitchToken2Notice()});this.ac&&this.ac.addEventListener("trigger",this.acTriggerHandler.bind(this));this.render();this.initInitialState();this.prx.isTwitchAuth()&&(this.s.userBansSyncWithTwitch&&this.checkTwitchTokenStatus(),(this.s.twitchFollowerBadges||this.s.twitchSubscriberBadges)&&
this.checkTwitchToken2Status())}getElement(){return this.container}init(){document.addEventListener("pointerdown",this.albumItemClickHandler);document.addEventListener("click",this.preventAlbumContentInteraction,!0)}terminate(){this.censorItems.clear();this.safeItems.clear();this.unknownUsers.clear();this.safeModControl=null;document.removeEventListener("pointerdown",this.albumItemClickHandler);document.addEventListener("click",this.preventAlbumContentInteraction,!0)}initInitialState(){const a=this.prx.getUsers();
this.clearPlayers(a);this.renderUsers(a);this.requestTwitchUsersData(a);this.initUsernamesCopying()}initUsernamesCopying(){this.prx.isAuthorized&&document.querySelector("#content")?.classList.toggle("gp-copy-username_",this.s.copyUsernamesWithClick)}render(){this.renderUserlist()}renderUserlist(){this.container=document.createElement("div");this.container.className="gp-userlist_";this.container.classList.toggle("shown_",this.s.showUI);this.container.classList.toggle("compact_",this.s.compactMode);
this.container.classList.toggle("autokick_",this.s.autoKick);this.buttons=document.createElement("div");this.buttons.className="ul-buttons_";this.container.appendChild(this.buttons);this.activateBtn=document.createElement("div");this.activateBtn.className="ul-activate-btn_ ul-button_ gp-module-btn_";this.activateBtn.classList.toggle("pressed_",this.s.showUI);this.activateBtn.title=this.l.MODULE_BTN_TTL;this.activateBtn.addEventListener("click",b=>{this.s.showUI=!this.s.showUI;this.container.classList.toggle("shown_",
this.s.showUI);this.container.classList.remove("banlist_");this.renderUsers();this.activateBtn.classList.toggle("pressed_",this.s.showUI)});this.buttons.appendChild(this.activateBtn);var a=document.createElement("div");a.className="ul-mode-btn_ ul-button_";a.title=this.l.MODE_BTN_TTL;a.addEventListener("click",b=>{this.s.compactMode=!this.s.compactMode});this.buttons.appendChild(a);this.buttons.appendChild(document.createElement("div"));a=document.createElement("div");a.className="ul-autokick-btn_ ul-button_";
a.title=this.l.AUTOKICK_BTN_TTL;a.addEventListener("click",b=>{this.s.autoKick=!this.s.autoKick;this.container.classList.toggle("autokick_",this.s.autoKick);this.clearPlayers()});this.buttons.appendChild(a);a=document.createElement("div");a.className="ul-banlist-btn_ ul-button_";a.title=this.l.BANLIST_BTN_TTL;a.addEventListener("click",b=>{this.container.classList.toggle("banlist_")});this.buttons.appendChild(a);this.list=document.createElement("div");this.list.className="ul-users_";this.list.addEventListener("contextmenu",
this.usersClickHandler);this.list.addEventListener("dblclick",this.usersClickHandler);this.list.addEventListener("click",b=>{b.ctrlKey&&this.usersClickHandler(b)});this.container.appendChild(this.list);this.banlistElem=document.createElement("div");this.banlistElem.className="ul-banlist_";this.banlistElem.addEventListener("click",this.banlistClickHandler);this.container.appendChild(this.banlistElem);this.renderBanlist();document.body.appendChild(this.container)}renderBanlist(){const a=this.banlistElem.scrollTop;
this.banlistElem.innerHTML="";const b=document.createDocumentFragment();var c=document.createElement("span");c.className="ul-title_";c.textContent=this.l.BANLIST;b.appendChild(c);this.banlist.size?this.banlist.forEach(d=>{var e=d;let f=!1;if(this.prx.isTwitchAuth()&&this.s.disableLocalizedTwitchUsernames){var g=this.localizedLogins.get(this.prx.getUsers().find(k=>this.prx.formatNickname(k.nick)===d)?.nick);g&&(e=g,f=!0)}g=document.createElement("div");g.className="ul-banned-user_";g.dataset.username=
d;const h=document.createElement("div");h.className="username_";h.title=f?`${e}   |   ${d}`:d;h.textContent=e;f&&(h.dataset.login=e);g.appendChild(h);e=document.createElement("div");e.className="remove-btn_";e.textContent="\u2716";e.addEventListener("click",k=>{});g.appendChild(e);b.appendChild(g)}):(c=document.createElement("div"),c.className="ul-banlist-placeholder_",c.textContent=this.l.BANLIST_EMPTY,b.appendChild(c));this.banlistElem.appendChild(b);this.banlistElem.scrollTop=a}updateBanlistUsername(a,
b){a=this.prx.formatNickname(a);const c=this.banlistElem.querySelector(`.ul-banned-user_[data-username="${a}"] .username_`);c&&(c.title=b?`${b}   |   ${a}`:a,c.textContent=b??a,b&&(c.dataset.login=b))}renderBtn(a,b,c){const d=document.createElement("div");d.className=`ul-button_ ul-${a}-btn_`;d.title=b||"";d.addEventListener("click",c);this.buttons.appendChild(d);return d}renderUsers(a){if(this.s.showUI){a=a||this.prx.getUsers();var b=this.list.scrollTop;this.list.innerHTML="";var c,d=document.createDocumentFragment();
a.forEach(e=>{if(e.viewer&&!c){c=!0;const f=document.createElement("span");f.className="ul-title_";f.textContent=this.l.USERLIST_WAITING;d.appendChild(f)}d.appendChild(this.renderUser(e))});this.list.appendChild(d);this.list.scrollTop=b}}renderUser(a){const b=document.createElement("div");b.className="ul-user_";b.classList.toggle("host_",!!a.owner);b.classList.toggle("away_",!!a.away);b.classList.toggle("ready_",!!a.ready);b.classList.toggle("viewer_",!!a.viewer);b.classList.toggle("you_",!!a.you);
b.classList.toggle("banned_",!a.you&&this.isUserBanned(a));b.dataset.nickname=a.nick;var c=document.createElement("div");c.className="ul-av_";b.appendChild(c);const d=document.createElement("span");d.className="img_";d.style.backgroundImage=`url(/images/avatar/${a.avatar}.svg)`;c.appendChild(d);this.prx.isAuthorized?(c=this.prx.formatNickname(a.nick),this.av.requestAvatarURL(c,g=>{d.style.backgroundImage=`url(${g})`})):this.prx.isTwitchOAuth&&a.nick===this.prx.getNickname()&&this.av.requestAvatarURL(this.prx.twitchOAuthLogin,
g=>{d.style.backgroundImage=`url(${g})`});let e=a.nick;c=!1;if(this.prx.isTwitchAuth()){if(this.s.disableLocalizedTwitchUsernames){const g=this.localizedLogins.get(e);g&&(e=g,c=!0)}this.prx.isHost()&&!this.prx.isYou(e)&&(this.s.twitchFollowerBadges&&this.followers[a.nick]&&b.classList.add("follower_"),this.s.twitchSubscriberBadges&&this.subscribers[a.nick]&&b.classList.add("subscriber_"))}const f=document.createElement("div");f.className="ul-nick_";f.title=c?`${a.nick} (${e})`:a.nick;f.textContent=
e;b.appendChild(f);a.you||this.prx.isTwitchOAuth||this.usersDB.hasUser(a.nick).then(g=>{g||(b.classList.toggle("unknown_",!g),f.dataset.sinceCreation=e,this.isNewAccount(a.nick)&&(b.classList.add("new_"),b.dataset.created=this.getDateCreated(a.nick),b.addEventListener("pointerenter",h=>{f.dataset.sinceCreation=this.getSinceCreationTime(b.dataset.created)??e})))});c=document.createElement("div");c.className="ul-state_";b.appendChild(c);return b}handlePlayerItem(a,b){const c=a.querySelector(".nick"),
d=b??c?.textContent;delete a.dataset.state;if(this.prx.isHost()&&this.s.playersColorIndication){if(this.prx.isYou(d))return;this.isBannedUser(d)?a.dataset.state="banned":this.prx.isTwitchOAuth||this.usersDB.hasUser(d).then(e=>{e||(this.isNewAccount(d)?a.dataset.state="new":a.dataset.state="unknown")})}this.prx.isTwitchAuth()&&(this.s.disableLocalizedTwitchUsernames?(b=this.localizedLogins.get(d))?c.dataset.login=b:delete c.dataset.login:delete c.dataset.login,delete a.dataset.badge,this.prx.isHost()&&
!this.prx.isYou(d)&&(this.s.twitchFollowerBadges&&this.followers[d]?a.dataset.badge="follower":this.s.twitchSubscriberBadges&&this.subscribers[d]&&(a.dataset.badge="subscriber")))}updatePlayerItem(a){if(this.prx.isHost()){var b=this.contentObserver.getPlayerItems().get(a);b&&this.handlePlayerItem(b,a)}}updatePlayerItems(){this.contentObserver.getPlayerItems().size&&this.prx.getUsers().forEach(a=>{this.updatePlayerItem(a.nick)})}getSinceCreationTime(a){const b=Date.now()-(new Date(a)).getTime();a=
this.newAccountLabels;var c=[26784E5,864E5,36E5,6E4];const d=c.findIndex(f=>b>=f);if(!~d)return a.at(-1)[0];c=Math.trunc(b/c[d]);let e;switch(this.l.lang){case "ru":const f=c%100,g=f%10;if(10<=f&&20>f)e=2;else if(1===g)e=0;else if(1<g&&5>g)e=1;else if(!g||4<g)e=2;return`${c} ${a[d][e]}`;default:return`${c} ${a[d][1<c?1:0]}`}}isUserBanned({nick:a,id:b}){return a&&b?!this.prx.isYou(b)&&this.banlist.has(this.prx.formatNickname(a)):!1}clearPlayers(a){this.prx.isHost()&&(this.s.autoKick||this.s.autoKickNewAccounts)&&
(a=a||this.prx.getUsers(),this.prx.isGameStage(GPProxy_.GAME_STAGE.LOBBY)&&a.forEach(b=>{this.prx.isYou(b.nick)||this.usersDB.hasUser(b.nick).then(c=>{(this.s.autoKick&&this.isUserBanned(b)||this.s.autoKickNewAccounts&&this.isNewAccount(b.nick)&&!c)&&this.prx.kickPlayer(b.id)})}))}usersClickHandler(a){a.preventDefault();if(this.prx.isAuthorized||this.prx.isTwitchOAuth)if(a=a.target.closest(".ul-user_"),!a?.classList.contains("you_")){const b=this.toggleUserBan(a.dataset.nickname);a.classList.toggle("banned_",
b);a.classList.add("unknown_")}}banlistClickHandler(a){var b=a.target.closest(".ul-banned-user_");if(b)if(b=b.dataset.username,a.target.matches(".username_"))navigator.clipboard.writeText(a.target.dataset.login??b);else if(a.target.matches(".remove-btn_")){const c=this.findNickname(b);this.banlist.delete(b);this.s.userBansSyncWithTwitch&&this.prx.isTwitchAuth()&&this.unbanTwitchUser(b);this.renderBanlist();c&&(this.renderUsers(),this.clearPlayers(),this.updatePlayerItem(c),this.handleItems());this.saveBanlist()}a.preventDefault()}findNickname(a){return this.prx.getUsers().find(b=>
a===this.prx.formatNickname(b.nick))?.nick}middleware([a,b]){if(!this.s.censorDrawings&&!this.s.censorNicknames&&!this.s.censorSentences)return[a,b];if(a[1]===GPProxy_.EVENT.ALBUM_ITEM&&a[2].active){if(this.s.safeMode&&a[2].type===GPProxy_.ALBUM_ITEM_TYPE.TEXT&&(a[3]=null,b=!0),this.isUserBanned(a[2].user))if(a[2].data?.length)switch(a[2].type){case GPProxy_.ALBUM_ITEM_TYPE.TEXT:this.s.censorSentences&&(a[3]=null,b=!0)}else this.prx.isGameOrder(GPProxy_.GAME_ORDER.DRAWINGS_WITH_A_BACKGROUND)&&this.s.censorDrawings&&
a[2].bg&&(a[2].data=this.prx.getAlbum().background,a[2].bg=!1,this.isAlbumBgHidden=b=!0)}else if(a[1]===GPProxy_.EVENT.ALBUM_INFO){this.isAlbumBgHidden=!1;a[2].background&&this.prx.isGameOrder(GPProxy_.GAME_ORDER.DRAWINGS_WITH_A_BACKGROUND)&&this.isUserBanned(a[2].bookAuthor)&&this.s.censorDrawings&&(a[2].background=[],this.isAlbumBgHidden=b=!0);const c=this.prx.isGameOrder(GPProxy_.GAME_ORDER.DRAWINGS_WITH_A_BACKGROUND)&&this.isUserBanned(this.prx.getAlbum().bookAuthor)&&this.s.censorDrawings;a[2].timeline?.length&&
(a[2].timeline=a[2].timeline.map(d=>{c&&d.bg&&(d.data=this.prx.getAlbum().background,d.bg=!1,b=!0);return d}))}return[a,b]}async albumItemClickHandler(a){if(0===a.button){var b=a.target.closest(".item");if(b&&!this.isAIImageItem(b)){var c=this.getContentId(b),d=this.getNickname(b);if(this.s.copyUsernamesWithClick&&this.isAlbumUsername(a.target))navigator.clipboard.writeText(a.target.dataset.login??d);else{var e,f=!1;if(this.isAlbumAvatar(a.target))this.prx.isYou(d)||this.isAnimationOrMultiPieceItem(b)||
(e=this.toggleUserBan(d))&&this.s.sendBanReports&&this.reportSender.send({itemId:this.getItemId(b),albumId:this.prx.getCurrentAlbumId()});else if(this.isAlbumContent(a.target)){if(this.isEmptyItem(b))return;if(this.s.safeMode&&!this.isBannedItem(b)&&!this.safeItems.has(c)){this.safeItems.add(c);this.isAnimationOrMultiPieceItem(b)&&this.hasCensoredImageItems()&&this.toggleAlbumItemPreview(b,!0);this.handleAlbumItem(b);return}this.shouldBeBannedItem(b,d)||this.isPreviewedItem(b)||b.dataset.cr&&b.dataset.cr!==
GPModeration_.CENSORING_REASON.BY_USER?(this.toggleAlbumItemPreview(b),f=!0,this.preview.isEnabled()&&(this.preview.clear(),b.classList.remove("previewed_"))):this.censorItems.has(c)?this.censorItems.delete(c):this.censorItems.set(c,b.dataset.type)}void 0!==e||this.prx.isGameOrder(GPProxy_.GAME_ORDER.DRAWINGS_WITH_A_BACKGROUND_NO_PREVIEW)&&0===this.getItemId(b)?this.handleItems(f?b:null):(this.handleAlbumItem(b),this.prx.isAnimateMode()&&!this.isAnimationItem(b)&&(a=this.getAnimationItem())&&(this.toggleAlbumItemPreview(a,
!1),this.handleAlbumItem(a)),this.prx.isMultiPieceMode()&&!this.isMultiPieceItem(b)&&(b=this.getMultiPieceItem())&&(this.toggleAlbumItemPreview(b,!1),this.handleAlbumItem(b)))}}}}isAlbumUsername(a){return a.matches(":is(.answerBalloon, .drawBalloon) > div:not(.avatar) > span")}isAlbumAvatar(a){return a.parentElement.classList.contains("avatar")}isAlbumContent(a){return("CANVAS"===a.tagName||"SPAN"===a.tagName)&&a.closest(".drawBalloon:not(.load)")||("SPAN"===a.tagName||a.classList.contains("balloon"))&&
a.closest(".answerBalloon:not(.load)")}handleAlbumItem(a){this.resetItem(a);if(!this.isAIImageItem(a)){var b=this.getNickname(a);if(this.isAnimationOrMultiPieceItem(a))this.shouldBeCensoredBySafemode(a)?this.censorItem(a,GPModeration_.CENSORING_REASON.SAFE_MODE):this.hasCensoredImageItems()?this.censorItem(a,GPModeration_.CENSORING_REASON.ANIMATION_FRAME):this.shouldBeCensoredItem(a)&&this.censorItem(a,GPModeration_.CENSORING_REASON.BY_USER);else if(this.isBannedUser(b)&&a.classList.add("banned_"),
this.isSuspiciousItem(a)&&a.classList.add("suspicious_"),this.shouldBeBannedItem(a,b))this.censorItem(a,GPModeration_.CENSORING_REASON.BANNED_PLAYER);else{if(this.s.safeMode&&!this.isAnimationOrMultiPieceItem(a)){if(!this.safeItems.has(this.getContentId(a))){this.censorItem(a,GPModeration_.CENSORING_REASON.SAFE_MODE);return}}else{if(this.shouldBeCensoredByUnknownPlayer(a,b)){this.censorItem(a,GPModeration_.CENSORING_REASON.UNKNOWN_PLAYER);return}if(this.shouldBeCensoredByNewAccount(a,b)){this.censorItem(a,
GPModeration_.CENSORING_REASON.NEW_ACCOUNT);return}}this.shouldByCensoredByBackground(a)?this.censorItem(a,GPModeration_.CENSORING_REASON.BACKGROUND):this.shouldBeCensoredItem(a)&&this.censorItem(a,GPModeration_.CENSORING_REASON.BY_USER)}}}async handleItems(a){for(const b of this.albumItems)b!==a&&(this.toggleAlbumItemPreview(b,!1),await this.handleAlbumItem(b))}resetItem(a){a.classList.remove("banned_","censored_","censored-nickname_","suspicious_");delete a.dataset.cr}isEmptyItem(a){return a.firstElementChild?.classList.contains("empty")}isPreviewedItem(a){return a.classList.contains("preview_")}isSuspiciousItem(a){return this.isImageItem(a)?
this.suspiciousItems.has(this.getContentId(a)):!1}toggleAlbumItemPreview(a,b){a.classList.toggle("preview_",b)}censorItem(a,b=GPModeration_.CENSORING_REASON.BY_USER){a.classList.add("censored_");a.dataset.cr=b;b===GPModeration_.CENSORING_REASON.BANNED_PLAYER&&a.classList.toggle("censored-nickname_",this.s.censorNicknames)}shouldBeCensoredBySafemode(a){return this.s.safeMode&&!this.safeItems.has(this.getContentId(a))}shouldByCensoredByBackground(a){return(this.prx.isGameOrder(GPProxy_.GAME_ORDER.DRAWINGS_WITH_A_BACKGROUND_NO_PREVIEW)||
this.prx.isGameOrder(GPProxy_.GAME_ORDER.DRAWINGS_WITH_A_BACKGROUND)&&!this.isAlbumBgHidden)&&0<this.getItemId(a)?(a=this.getNickname(this.albumItems[0]),this.shouldBeBannedItem(this.albumItems[0],a)||this.isCensoredItem(this.albumItems[0])):!1}shouldBeCensoredItem(a){return this.isCensoredItem(a)}shouldBeBannedItem(a,b){return this.isAnimationOrMultiPieceItem(a)?!1:this.isBannedUser(b)&&(this.isImageItem(a)&&this.s.censorDrawings||this.isTextItem(a)&&this.s.censorSentences)?!0:!1}shouldBeCensoredByUnknownPlayer(a,
b){a=this.isImageItem(a);return!this.prx.isYou(b)&&this.s.censorUnknownPlayers&&(this.s.censorDrawings&&a||this.s.censorSentences&&!a)?this.unknownUsers.has(b):!1}async parseUnknownUsers(){const a=this.prx.getUsers().filter(c=>!c.viewer&&!c.owner).map(c=>c.nick),b=await this.usersDB.hasUsers(a);this.unknownUsers=new Set(a.filter(c=>!b.has(c)))}shouldBeCensoredByNewAccount(a,b){a=this.isImageItem(a);return!this.prx.isYou(b)&&this.s.censorNewAccounts&&this.unknownUsers.has(b)&&(this.s.censorDrawings&&
a||this.s.censorSentences&&!a)&&this.isNewAccount(b)?!0:!1}getItemId(a){return+a.dataset.id}isBannedUser(a){return this.banlist.has(this.prx.formatNickname(a))}getNickname(a){return this.getNicknameElem(a)?.textContent}getNicknameElem(a){return a.querySelector(":scope :is(.answerBalloon, .drawBalloon) > div:not(.avatar) > span")}toggleUserBan(a){const b=this.prx.formatNickname(a),c=!this.banlist.has(b);c?(this.banlist.add(b),this.prx.isTwitchOAuth||(this.usersDB.deleteUser(a),this.unknownUsers.add(a))):
this.banlist.delete(b);this.s.userBansSyncWithTwitch&&this.prx.isTwitchAuth()&&(c?this.banTwitchUser(b):this.unbanTwitchUser(b));this.renderUsers();this.renderBanlist();this.clearPlayers();this.updatePlayerItem(a);this.handleItems();this.saveBanlist();return c}getAnimationItem(){return this.albumItems.find(a=>"animation"===a.dataset.type)}getMultiPieceItem(){return this.albumItems.find(a=>"multi-piece"===a.dataset.type)}getContentId(a){return this.prx.isGameStage(GPProxy_.GAME_STAGE.ALBUM)?`${this.prx.getCurrentAlbumId()}_${this.getItemId(a)}`:
`t_${this.prx.getCurrentTurnId()}`}isCensoredItem(a,b){a=this.censorItems.get(this.getContentId(a));return b?b===a:!!a}isCensoredImageItem(a){return this.isCensoredItem(a,GPModeration_.ALBUM_ITEM_TYPE.IMAGE)}isBannedItem(a){return a.classList.contains("banned_")}hasCensoredImageItems(){return this.albumItems.some(a=>this.isCensoredImageItem(a))?!0:this.s.censorDrawings?this.albumItems.some(a=>this.isImageItem(a)&&(a.dataset.cr===GPModeration_.CENSORING_REASON.BANNED_PLAYER||a.dataset.cr===GPModeration_.CENSORING_REASON.UNKNOWN_PLAYER||
a.dataset.cr===GPModeration_.CENSORING_REASON.NEW_ACCOUNT)):!1}isTextItem(a){return"text"===a.dataset.type}isImageItem(a){return"image"===a.dataset.type}isAnimationItem(a){return"animation"===a.dataset.type}isMultiPieceItem(a){return"multi-piece"===a.dataset.type}isAnimationOrMultiPieceItem(a){return this.isAnimationItem(a)||this.isMultiPieceItem(a)}isAIImageItem(a){return"ai-image"===a.dataset.type}isNewAccount(a){a=this.getDateCreated(a);return!!a&&Date.now()-(new Date(a)).getTime()<=+this.s.newAccountPeriod}getDateCreated(a){return this.userDatesCreated[this.prx.formatNickname(a)]}updateUserDatesCreatedCache(a){Object.assign(this.userDatesCreated,
a)}requestUserDatesCreated(a){this.prx.isHost()&&this.prx.isTwitchAuth()&&(a=a.filter(b=>!this.hasUserDateCreated(b.nick)&&!this.prx.isYou(b.nick)&&!this.prx.isViewer(b)).map(b=>this.prx.formatNickname(b.nick)),a.length&&document.dispatchEvent(new CustomEvent("_request_user_dates_created",{detail:{usernames:a}})))}hasUserDateCreated(a){return void 0!==this.userDatesCreated[this.prx.formatNickname(a)]}requestTwitchUsersData(a){if(this.prx.isHost()&&this.prx.isTwitchAuth()){var b=a.filter(d=>!this.prx.isYou(d.nick)&&
!this.prx.isViewer(d)).map(d=>this.prx.formatNickname(d.nick));a=b.filter(d=>!(d in this.userDatesCreated));b=this.s.twitchFollowerBadges||this.s.twitchSubscriberBadges?b:[];if(a.length||b.length){var c=!!this.s.twitchToken2;document.dispatchEvent(new CustomEvent("_request_users_data",{detail:{datesCreatedUsernames:a,followerSubscriberUsernames:b,broadcasterId:this.prx.getUser().authId,token:this.s.twitchToken2,datesCreatedFlag:!0,followersFlag:c&&this.s.twitchFollowerBadges,subscribersFlag:c&&this.s.twitchSubscriberBadges}}))}}}updateFollowers(a){a&&
Object.assign(this.followers,...a.map(b=>({[b]:!0})))}updateSubscribers(a){a&&Object.assign(this.subscribers,...a.map(b=>({[b]:!0})))}saveBanlist(){this.prx.isTwitchOAuth||localStorage.setItem("ul_banlist",JSON.stringify(Array.from(this.banlist)))}preventAlbumContentInteraction(a){a.target.closest(".item")&&this.isAlbumContent(a.target)&&a.stopPropagation()}handlePreviewImage(a){a.addEventListener("pointerover",this.imagePreviewOverHandler);a.addEventListener("pointerdown",this.imagePreviewDownHandler);
a.dataset.type="image";a.dataset.typeId=GPProxy_.ALBUM_ITEM_TYPE.IMAGE;this.handleCensorableItem(a)}searchPreviewImage(a=!1){const b=Date.now();return new Promise(c=>{const d=()=>{clearTimeout(this.searchPreviewTimer);var e=document.querySelector(".screen :is(.write, .memory) .core > div > canvas");e?(e=e.parentElement,e.dataset.type="image",c(e)):!a&&Date.now()-b<GPModeration_.PREVIEW_MONITOR_TIMEOUT&&(this.searchPreviewTimer=setTimeout(()=>{d()},GPModeration_.PREVIEW_MONITOR_INTERVAL))};d()})}handleCensorableItem(a){this.resetItem(a);
const b=this.prx.getPrevData()?.user?.nick;if(b)if(this.isSuspiciousItem(a)&&a.classList.add("suspicious_"),this.shouldBeBannedItem(a,b))this.censorItem(a,GPModeration_.CENSORING_REASON.BANNED_PLAYER);else{if(this.s.safeMode&&!this.isAnimationOrMultiPieceItem(a)){if(!this.safeItems.has(this.getContentId(a))){this.censorItem(a,GPModeration_.CENSORING_REASON.SAFE_MODE);return}}else{if(this.shouldBeCensoredByUnknownPlayer(a,b)){this.censorItem(a,GPModeration_.CENSORING_REASON.UNKNOWN_PLAYER);return}if(this.shouldBeCensoredByNewAccount(a,
b)){this.censorItem(a,GPModeration_.CENSORING_REASON.NEW_ACCOUNT);return}}this.isCensoredItem(a)&&this.censorItem(a,GPModeration_.CENSORING_REASON.BY_USER)}}handlePreviewItem(a){this.isAnimationOrMultiPieceItem(a)||(a=a.querySelector(".balloon"),a.addEventListener("pointerenter",this.albumItemEnterHandler),a.addEventListener("pointerleave",this.albumItemLeaveHandler))}albumItemEnterHandler(a){if(this.preview.isEnabled()&&(a=a.currentTarget.closest(".item"),!this.isEmptyItem(a)&&!this.isPreviewedItem(a)&&
a.matches(".banned_, .censored_, .suspicious_"))){a.classList.add("previewed_");var b=this.getItemId(a);if(a=this.prx.getAlbumItem(b))b=`${this.prx.getCurrentAlbumId()}_${b}`,this.preview.load(a.data,a.type,b)}}albumItemLeaveHandler(a){this.preview.isEnabled()&&(a=a.currentTarget.closest(".item"),a.classList.contains("previewed_")&&(a.classList.remove("previewed_"),this.preview.clear()))}imagePreviewOverHandler(a){this.preview.isEnabled()&&this.isPreviewCanvas(a.target)&&this.previewCensorableItem(a.target.parentElement)}previewCensorableItem(a){const b=
this.prx.getPrevImageData();if(b&&a.matches(".banned_, .censored_, .suspicious_")){a.classList.add("previewed_");a.addEventListener("pointerleave",d=>{a.classList.remove("previewed_");this.preview.clear()},{once:!0});const c=this.prx.getCurrentTurnId();this.preview.load(b,Number(a.dataset.typeId),`t_${c}`)}}imagePreviewDownHandler(a){0===a.button&&this.isPreviewCanvas(a.target)&&this.handleCensorableItemDown(a.target.parentElement)}handleCensorableItemDown(a){const b=this.getContentId(a),c=this.prx.getPrevData()?.user?.nick;
this.s.safeMode&&!this.safeItems.has(b)?this.safeItems.add(b):this.shouldBeBannedItem(a,c)||this.isPreviewedItem(a)||a.dataset.cr&&a.dataset.cr!==GPModeration_.CENSORING_REASON.BY_USER?(a.classList.toggle("preview_"),this.preview.isEnabled()&&(this.preview.clear(),a.classList.remove("previewed_"))):this.censorItems.has(b)?this.censorItems.delete(b):this.censorItems.set(b,a.dataset.type);this.handleCensorableItem(a)}isPreviewCanvas(a){return"CANVAS"===a.tagName}isPreviewScreen(a){return GPModeration_.PREVIEW_PATHS.includes(a.slice(1))}handlePainterHeader(a){if(a=
a.querySelector("h4 + h3"))a.addEventListener("pointerover",this.painterHeaderTextOverHandler),a.addEventListener("pointerdown",this.painterHeaderTextDownHandler),a.dataset.type="text",a.dataset.typeId=GPProxy_.ALBUM_ITEM_TYPE.TEXT,this.handleCensorableItem(a)}painterHeaderTextOverHandler(a){this.preview.isEnabled()&&this.previewCensorableItem(a.target)}painterHeaderTextDownHandler(a){0===a.button&&this.handleCensorableItemDown(a.target)}acTriggerHandler({detail:{itemId:a,albumId:b}}){this.prx.getCurrentAlbumId()===
b&&(b=this.albumItems.find(c=>this.getItemId(c)===a))&&b.classList.add("suspicious_")}initTwitchTokenBtn(){this.twitchTokenBtn=document.createElement("div");this.twitchTokenBtn.className="mod-twitch-token-btn_";this.twitchTokenBtn.title="\u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c Twitch-\u0442\u043e\u043a\u0435\u043d, \u043f\u0440\u0435\u0434\u043e\u0441\u0442\u0430\u0432\u0438\u0432 \u043d\u0435\u043e\u0431\u0445\u043e\u0434\u0438\u043c\u044b\u0435 \u043f\u0440\u0430\u0432\u0430 \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u044e gp-mod (\u043d\u0435 \u0434\u0435\u043b\u0430\u0439\u0441\u044f \u044d\u0442\u043e\u0433\u043e \u043d\u0430 \u0442\u0440\u0430\u043d\u0441\u043b\u044f\u0446\u0438\u0438 \u0438 \u043d\u0435 \u0441\u043e\u043e\u0431\u0449\u0430\u0439\u0442\u0435 \u0442\u043e\u043a\u0435\u043d \u043d\u0438\u043a\u043e\u043c\u0443)";
this.twitchTokenBtn.textContent="Get Twitch Token";this.twitchTokenBtn.addEventListener("click",a=>{this.twitchAuthWindow&&this.twitchAuthWindow.close();this.twitchAuthWindow=window.open(GPModeration_.TWITCH_AUTH_URL)})}requestTwitchTokenStatus(){return this.s.twitchToken?fetch("https://id.twitch.tv/oauth2/validate",{headers:{Authorization:`OAuth ${this.s.twitchToken}`},credentials:"omit",cache:"no-cache"}).then(a=>a.ok).catch(()=>!1):Promise.resolve(!1)}checkTwitchTokenStatus(){this.s.twitchToken&&
this.twitchAPI.validateToken(this.s.twitchToken).then(a=>{a||this.showTwitchTokenNotice()})}checkTwitchToken2Status(){this.s.twitchToken2&&this.twitchAPI.validateToken(this.s.twitchToken2).then(a=>{a||this.showTwitchToken2Notice()})}banTwitchUser(a){if(a=this.twitchUserIds.get(a)){const b=this.prx.getUser().authId;this.twitchAPI.banUser(a,b,this.s.twitchToken).catch(()=>{this.twitchAPI.validateToken(this.s.twitchToken).then(c=>{c||this.showTwitchTokenNotice()})})}}unbanTwitchUser(a){if(a=this.twitchUserIds.get(a)){const b=
this.prx.getUser().authId;this.twitchAPI.unbanUser(a,b,this.s.twitchToken).catch(()=>{this.twitchAPI.validateToken(this.s.twitchToken).then(c=>{c||this.showTwitchTokenNotice()})})}}showTwitchTokenNotice(){this.abt?.showTwitchTokenNotice({onButtonClick:()=>{this.twitchAPI.requestToken(GPTwitchAPI_.TOKEN_TYPE.BAN_USERS)},onClose:()=>{this.s.userBansSyncWithTwitch=!1}})}showTwitchToken2Notice(){this.abt?.showTwitchToken2Notice({onButtonClick:()=>{this.twitchAPI.requestToken(GPTwitchAPI_.TOKEN_TYPE.FOLLOWERS_SUBSCRIPTIONS)},
onClose:()=>{this.s.twitchFollowerBadges=!1;this.s.twitchSubscriberBadges=!1}})}updateUserIdsCache(a){a.forEach((b,c)=>{this.twitchUserIds.set(b,c)})}updateLocalizedLogins(a){a.forEach((b,c)=>{this.localizedLogins.set(c,b)})}handleAlbumUsernames(){this.contentObserver.getAlbumItems().forEach(a=>{this.handleAlbumUsername(a)})}handleAlbumUsername(a){this.prx.isTwitchAuth()&&this.handleAlbumLocalizedTwitchUsername(a)}handleAlbumAvatars(a){const b=this.getNickname(a);a.classList.toggle("own_",this.prx.isYou(b));
a.classList.toggle("gartic_",!b)}handleAlbumLocalizedTwitchUsername(a){if(this.prx.isTwitchAuth())if(a=this.getNicknameElem(a),this.s.disableLocalizedTwitchUsernames){const b=this.localizedLogins.get(a?.textContent);b&&(a.classList.add("processing_"),a.dataset.login=b,a.style.width=getComputedStyle(a,"::before").width,a.classList.remove("processing_"))}else delete a.dataset.login,a.style.width=""}handleAlbumHeader(a){if(this.prx.isTwitchAuth()&&(a??=this.contentObserver.getAlbumHeader(),a))if(this.s.disableLocalizedTwitchUsernames){const b=
this.prx.getAlbumAuthor(),c=this.localizedLogins.get(b);c&&(a.dataset.login=a.textContent.replace(b,c))}else delete a.dataset.login}handleAlbumFooter(a){if(this.prx.isTwitchAuth()&&(a??=this.contentObserver.getAlbumFooter(),a))if(this.s.disableLocalizedTwitchUsernames){const b=this.prx.getAlbumAuthor(),c=this.localizedLogins.get(b);c&&(a.classList.add("processing_"),a.dataset.login=a.textContent.replace(b,c),a.style.width=getComputedStyle(a,"::before").width,a.classList.remove("processing_"))}else delete a.dataset.login,
a.style.width=""}updateRankingUsers(){this.prx.isTwitchAuth()&&this.contentObserver.getRankingUsers().forEach(a=>{this.handleAlbumRanking(a)})}handleAlbumRanking(a){if(this.prx.isTwitchAuth()){a=a.querySelector(".nick");var b=a?.textContent;if(this.s.disableLocalizedTwitchUsernames){if(b=this.localizedLogins.get(b))a.dataset.login=b}else delete a.dataset.login}}injectSafeModeControl(){const a=document.querySelector(".scrapbook .controls > section");this.renderSafeModeControl(a)}gallerySettingsObserverCallback(a,
b){for(const c of a)if("childList"===c.type&&c.addedNodes[0]?.classList?.contains("fade-enter")&&c.addedNodes[0].firstElementChild?.classList?.contains("book")){a=c.addedNodes[0].querySelector(".scrapbook .controls > section");this.renderSafeModeControl(a);b.disconnect();this.inGallerySettingsObserving=!1;break}}renderSafeModeControl(a){const b=document.createElement("div");b.className="safe-mode-opt_ label";var c=GPModeration_.SAFE_MODE_OPT_L10N[window.__NEXT_DATA__.locale]??GPModeration_.SAFE_MODE_OPT_L10N.en;
b.innerHTML=`<div class="legend"><i class="icon_"></i><span><h5 class="title_">${c.TITLE}</h5><p class="description_">${c.DESC}</p></span></div><section class="toggle_"><form class="switch"><input type="radio" id="safe_mode_0" name="safe_mode" value="1"><label for="safe_mode_0">${c.ON}</label><input type="radio" id="safe_mode_1" name="safe_mode" value="0"><label for="safe_mode_1">${c.OFF}</label></form></section>`;c=b.querySelector("form.switch");c.elements.safe_mode.value=+this.s.safeMode;c.addEventListener("change",
d=>{this.s.safeMode=!!+d.target.value});this.safeModControl=c.elements.safe_mode;c=a.children.length+1;c=Math.min(Math.round((393-50*c)/(c-1)),3<c?50:60);a.classList.add("gp-custom-options_");a.style.setProperty("--options-gap",`${c}px`);a.appendChild(b)}updateSafeModControl(){const a=this.safeModControl?.[0];a&&(a.isConnected?this.safeModControl.value=+this.s.safeMode:this.safeModControl=null)}updateSettings({detail:{settings:a}}){"showUI"in a&&(this.container.classList.toggle("shown_",a.showUI),
this.container.classList.remove("banlist_"),this.renderUsers(),this.activateBtn.classList.toggle("pressed_",a.showUI));"autoKick"in a&&(this.container.classList.toggle("autokick_",a.autoKick),this.clearPlayers());"autoKickNewAccounts"in a&&this.clearPlayers();"copyUsernamesWithClick"in a&&this.initUsernamesCopying();"compactMode"in a&&this.container.classList.toggle("compact_",a.compactMode);"playersColorIndication"in a&&this.updatePlayerItems();"disableLocalizedTwitchUsernames"in a&&this.prx.isTwitchAuth()&&
(this.renderUsers(),this.renderBanlist(),this.prx.isGameStages(GPProxy_.GAME_STAGE.LOBBY,GPProxy_.GAME_STAGE.ALBUM,GPProxy_.GAME_STAGE.GALLERY_SETTINGS,GPProxy_.GAME_STAGE.SCORE)&&this.updatePlayerItems(),this.prx.isGameStage(GPProxy_.GAME_STAGE.ALBUM)?(this.handleAlbumHeader(),this.handleAlbumFooter(),this.handleAlbumUsernames()):this.prx.isGameStage(GPProxy_.GAME_STAGE.SCORE)&&this.updateRankingUsers());"newAccountPeriod"in a&&this.renderUsers();["censorSentences","censorNicknames"].some(b=>b in
a)&&this.prx.isGameStage(GPProxy_.GAME_STAGE.ALBUM)&&this.handleItems();["censorDrawings","censorUnknownPlayers","censorNewAccounts","safeMode"].some(b=>b in a)&&("safeMode"in a&&(this.safeItems.clear(),this.updateSafeModControl()),this.prx.isGameStage(GPProxy_.GAME_STAGE.ALBUM)?this.handleItems():this.prx.isScreen(GPProxy_.SCREEN_ID.PAINTER)&&this.searchPreviewImage(!0).then(this.handleCensorableItem));"userBansSyncWithTwitch"in a&&a.userBansSyncWithTwitch&&this.twitchAPI.validateToken(this.s.twitchToken).then(b=>
{b||this.twitchAPI.requestToken(GPTwitchAPI_.TOKEN_TYPE.BAN_USERS)});if("twitchFollowerBadges"in a||"twitchSubscriberBadges"in a)a.twitchFollowerBadges&&a.twitchSubscriberBadges||(this.renderUsers(),this.updatePlayerItems()),(a.twitchFollowerBadges||a.twitchSubscriberBadges)&&this.twitchAPI.validateToken(this.s.twitchToken2).then(b=>{b?this.requestTwitchUsersData(this.prx.getUsers()):this.twitchAPI.requestToken(GPTwitchAPI_.TOKEN_TYPE.FOLLOWERS_SUBSCRIPTIONS)})}}window.GPModeration_=GPModeration_;class GPPreview_ extends EventTarget{static CANVAS_WIDTH=758;static CANVAS_HEIGHT=424;static CANVAS_DENSITY=.5;static MAX_PANEL_WIDTH=window.screen.width/3;static MIN_PANEL_WIDTH=180;static PANEL_WIDTH_STEP=10;static MIN_PANEL_BORDER_WIDTH=2;static ANCHORS={t:"top",b:"bottom",l:"left",r:"right"};static ANCHOR={TOP:"top",BOTTOM:"bottom",LEFT:"left",RIGHT:"right"};static TYPES={1:"image",2:"text",5:"animation"};static WINDOW_URL="https://gpmod.github.io/preview";constructor(a,b,{x:c,y:d,o:e},f,g){super();
this.prx=a;this.l=g;this.enabled=!!b;this.panelOffsetX=c;this.panelOffsetY=d;this.panelAnchor=e;this.panelWidth=f;this.panelBorderWidth=GPPreview_.MIN_PANEL_BORDER_WIDTH;this.window=null;this.cache=new Map;this.worker=null;this.addEventListener("rendered",()=>{this.panel.classList.add("rendered_")});this.prx.addEventListener("data",({detail:{event:h}})=>{h===GPProxy_.EVENT.GAME_STARTED&&this.cache.clear()});window.addEventListener("message",h=>{switch(h.data?.type){case "gp-preview-request-draw-function":this.window.postMessage({type:"draw_function",
drawFunctionString:GPUtils_.drawFunctionString},GPPreview_.WINDOW_URL);break;case "gp-preview-win-closed":this.window=null,this.panel.classList.replace("win-mode_","frame-mode_")}});window.addEventListener("resize",()=>{this.updatePanelPosition()});this.render();this.toggle(b)}render(){this.showPanelBtn=document.createElement("div");this.showPanelBtn.className="gp-preview-btn_ gp-module-btn_";this.showPanelBtn.title=this.l.PREVIEW_PANEL_BTN_TTL;this.showPanelBtn.addEventListener("click",()=>{this.toggle()});
this.showPanelBtn.addEventListener("pointerenter",()=>{this.panel.classList.add("hover_")});this.showPanelBtn.addEventListener("pointerleave",()=>{this.panel.classList.remove("hover_")});document.body.appendChild(this.showPanelBtn);this.panel=document.createElement("div");this.panel.className="gp-preview_";this.panel.dataset.type=GPPreview_.TYPES[GPProxy_.ALBUM_ITEM_TYPE.IMAGE];this.panel.style.setProperty("--gp-preview-width",`${this.panelWidth}px`);this.panel.addEventListener("contextmenu",b=>{b.preventDefault()});
this.panel.addEventListener("wheel",b=>{b.preventDefault();this.panelWidth=0<b.deltaY?Math.max(this.panelWidth-GPPreview_.PANEL_WIDTH_STEP,GPPreview_.MIN_PANEL_WIDTH):Math.min(this.panelWidth+GPPreview_.PANEL_WIDTH_STEP,GPPreview_.MAX_PANEL_WIDTH);this.updatePanelSize();this.updatePanelPosition();this.dispatchEvent(new CustomEvent("panel_width_changed",{detail:{width:this.panelWidth}}))});this.panel.addEventListener("pointerdown",b=>{if(0===b.button){var [c,d,e,f]=this.getCoords(b),g=(h=>{this.setPanelPosition(h.pageX-
c,h.pageY-d,e,f)}).bind(this);this.panel.setPointerCapture(b.pointerId);this.panel.addEventListener("pointermove",g);this.panel.addEventListener("pointerup",()=>{this.dispatchEvent(new CustomEvent("panel_pos_changed",{detail:{x:this.panelOffsetX,y:this.panelOffsetY,o:this.panelAnchor}}));this.panel.removeEventListener("pointermove",g)},{once:!0});g(b)}});this.panel.addEventListener("pointerdown",b=>{if(1===b.button||2===b.button)this.panel.setPointerCapture(b.pointerId),this.panel.addEventListener("pointerup",
c=>{if(1===c.button||2===c.button)this.window?this.closeWindow():this.openWindow()},{once:!0})});const a=document.createElement("div");a.className="warning_";a.style.setProperty("--frame-mode-warning",`'${this.l.PREIVEW_PANEL_WARNING}'`);a.style.setProperty("--win-mode-warning",`'${this.l.PREIVEW_TAB_WARNING}'`);this.panel.appendChild(a);this.canvas=this.createCanvas();this.panel.appendChild(this.canvas);this.text=document.createElement("div");this.text.className="text_";this.panel.appendChild(this.text);
document.body.appendChild(this.panel);this.updatePanelPosition();this.updatePanelSize()}createCanvas(){const a=document.createElement("canvas");a.className="canvas_";a.width=GPPreview_.CANVAS_WIDTH*GPPreview_.CANVAS_DENSITY;a.height=GPPreview_.CANVAS_HEIGHT*GPPreview_.CANVAS_DENSITY;return a}replaceCanvas(){const a=this.createCanvas();this.canvas.replaceWith(a);this.canvas=a}toggle(a){this.enabled=void 0!==a?!!a:!this.enabled;this.panel.classList.toggle("shown_",this.enabled);this.enabled?(this.panel.classList.add("frame-mode_"),
this.initWorker()):(this.clear(),this.window&&this.closeWindow(),this.terminateWorker(),this.replaceCanvas());this.dispatchEvent(new CustomEvent("status",{detail:{status:this.enabled}}));this.showPanelBtn.classList.toggle("pressed_",this.enabled)}openWindow(){this.window&&this.window.close();this.window=window.open(GPPreview_.WINDOW_URL);this.panel.classList.replace("frame-mode_","win-mode_")}closeWindow(){this.window.close();this.window=null;this.panel.classList.replace("win-mode_","frame-mode_")}updatePanelSize(){this.panel.style.setProperty("--gp-preview-width",
`${this.panelWidth}px`);this.panelBorderWidth=Math.max(Math.round(this.panelWidth/142),GPPreview_.MIN_PANEL_BORDER_WIDTH);this.panel.style.setProperty("--gp-preview-border-width",`${this.panelBorderWidth}px`)}updatePanelPosition(){const a=Math.max(Math.min(this.panelOffsetX,document.documentElement.clientWidth-this.panelWidth-this.panelBorderWidth),this.panelBorderWidth),b=Math.max(Math.min(this.panelOffsetY,document.documentElement.clientHeight-this.panelWidth/(GPPreview_.CANVAS_WIDTH/GPPreview_.CANVAS_HEIGHT)-
this.panelBorderWidth),this.panelBorderWidth);this.panel.style.inset="unset";this.panelAnchor.split("").map(c=>GPPreview_.ANCHORS[c]).forEach(c=>{switch(c){case GPPreview_.ANCHOR.TOP:case GPPreview_.ANCHOR.BOTTOM:this.panel.style[c]=`${b}px`;break;case GPPreview_.ANCHOR.LEFT:case GPPreview_.ANCHOR.RIGHT:this.panel.style[c]=`${a}px`}})}setPanelPosition(a,b,c,d){if(!c||!d){const [k,l]=this.panel.getBoundingClientRect();c=k;d=l}const e=document.documentElement.clientWidth,f=document.documentElement.clientHeight,
g=Math.max(Math.min(a,e-c-this.panelBorderWidth),this.panelBorderWidth),h=Math.max(Math.min(b,f-d-this.panelBorderWidth),this.panelBorderWidth);this.panel.style.inset="unset";this.panel.dataset.anchor="";b+d/2>f/2?(this.panelOffsetY=Math.round(f-(h+d)),this.panel.style.bottom=`${this.panelOffsetY}px`,this.panel.dataset.anchor+="b"):(this.panelOffsetY=Math.round(h),this.panel.style.top=`${this.panelOffsetY}px`,this.panel.dataset.anchor+="t");a+c/2>e/2?(this.panelOffsetX=Math.round(e-(g+c)),this.panel.style.right=
`${this.panelOffsetX}px`,this.panel.dataset.anchor+="r"):(this.panelOffsetX=Math.round(g),this.panel.style.left=`${this.panelOffsetX}px`,this.panel.dataset.anchor+="l");this.panelAnchor=this.panel.dataset.anchor}getCoords(a){const [b,c]=a.touches?[a.touches[0].clientX,a.touches[0].clientY]:[a.clientX,a.clientY];a=a.currentTarget.getBoundingClientRect();return[Math.round(b-a.left),Math.round(c-a.top),a.width,a.height]}initWorker(){const a=this.canvas.transferControlToOffscreen();this.worker=GPUtils_.createWorker(this.workerBody);
this.worker.postMessage({type:"init",data:{canvas:a,density:GPPreview_.CANVAS_DENSITY,drawFunctionString:GPUtils_.drawFunctionString}},[a]);this.worker.addEventListener("message",({data:{type:b,...c}})=>{switch(b){case "cache":const {imageData:d,cacheId:e}=c;this.cache.set(e,d);break;case "rendered":this.dispatchEvent(new Event("rendered"))}})}terminateWorker(){this.worker&&this.worker.terminate()}workerBody(){self.addEventListener("message",({data:{type:a,data:b}})=>{switch(a){case "draw":const {strokes:c,
cacheId:d}=b;self.clear();self.draw(self.ctx,c,self.density,!0,!1);a=self.ctx.getImageData(0,0,self.canvas.width,self.canvas.height);self.postMessage({type:"cache",imageData:a,cacheId:d});self.postMessage({type:"rendered"});break;case "clear":self.clear();break;case "cache":self.clear();self.ctx.putImageData(b,0,0);self.postMessage({type:"rendered"});break;case "init":const {canvas:e,density:f}=b;self.density=f;self.canvas=e;self.ctx=self.canvas.getContext("2d");self.ctx.imageSmoothingQuality="high";
self.draw=(new Function(`return ${b.drawFunctionString}`))();self.clear=()=>{self.ctx.clearRect(0,0,self.canvas.width,self.canvas.height)}}})}load(a,b,c){if(a){var d=GPPreview_.TYPES[b];this.panel.classList.remove("rendered_");this.panel.classList.add("loading_");if(this.window)this.window.postMessage({type:"data",data:a,itemType:d},GPPreview_.WINDOW_URL);else switch(this.panel.dataset.type=d,b){case GPProxy_.ALBUM_ITEM_TYPE.IMAGE:this.worker.postMessage({type:"clear"});(b=this.cache.get(c))?this.worker.postMessage({type:"cache",
data:b}):this.worker.postMessage({type:"draw",data:{strokes:a,cacheId:c}});break;case GPProxy_.ALBUM_ITEM_TYPE.TEXT:this.text.textContent=a,this.dispatchEvent(new Event("rendered"))}}}clear(){this.window?this.window.postMessage({type:"clear"},GPPreview_.WINDOW_URL):this.worker?.postMessage({type:"clear"});this.text.textContent="";this.panel.classList.remove("loading_")}isEnabled(){return this.enabled||this.window}}window.GPPreview_=GPPreview_;class GPTwitchAPI_ extends EventTarget{static CLIENT_ID="qrohytuwdc7d3uns3gnvtb4esylpqy";static BASE_URL="https://api.twitch.tv/helix";static BANS_API="/moderation/bans";static AUTH_URL=`https://id.twitch.tv/oauth2/authorize?client_id=${this.CLIENT_ID}&redirect_uri=${encodeURIComponent("https://gpmod.github.io/twitch-token?WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWW&tokenType={token-type}")}&response_type=token&scope={scopes}`;static TOKEN_TYPE={BAN_USERS:"ban-users",
FOLLOWERS_SUBSCRIPTIONS:"followers-subscriptions"};static SCOPES={[this.TOKEN_TYPE.BAN_USERS]:"moderator:manage:banned_users",[this.TOKEN_TYPE.FOLLOWERS_SUBSCRIPTIONS]:"moderator:read:followers channel:read:subscriptions"};constructor(){super();this.authWindow=null;window.addEventListener("message",a=>{if(("https://gpmod.github.io"===a.origin||"https://localhost"===a.origin)&&"gp-twitch-token"===a.data.type){switch(a.data.tokenType){case GPTwitchAPI_.TOKEN_TYPE.BAN_USERS:this.dispatchEvent(new CustomEvent("token",
{detail:{type:GPTwitchAPI_.TOKEN_TYPE.BAN_USERS,token:a.data.token}}));break;case GPTwitchAPI_.TOKEN_TYPE.FOLLOWERS_SUBSCRIPTIONS:this.dispatchEvent(new CustomEvent("token",{detail:{type:GPTwitchAPI_.TOKEN_TYPE.FOLLOWERS_SUBSCRIPTIONS,token:a.data.token}}))}this.authWindow.postMessage({type:"close"},a.origin);this.authWindow=null}})}requestToken(a){this.openAuthWindow(GPTwitchAPI_.SCOPES[a],a)}openAuthWindow(a,b){this.authWindow&&this.authWindow.close();a=GPTwitchAPI_.AUTH_URL.replace("{scopes}",
encodeURIComponent(a)).replace("%7Btoken-type%7D",encodeURIComponent(b));this.authWindow=window.open(a)}validateToken(a){return a?fetch("https://id.twitch.tv/oauth2/validate",{headers:{Authorization:`OAuth ${a}`},credentials:"omit",cache:"no-cache"}).then(b=>b.ok).catch(()=>!1):Promise.resolve(!1)}banUser(a,b,c){return fetch(`${GPTwitchAPI_.BASE_URL}${GPTwitchAPI_.BANS_API}?broadcaster_id=${b}&moderator_id=${b}`,{method:"POST",headers:{Authorization:`Bearer ${c}`,"Client-Id":GPTwitchAPI_.CLIENT_ID,
"Content-Type":"application/json"},body:JSON.stringify({data:{user_id:a,reason:"Gartic Phone"}})}).then(d=>{if(401===d.status)throw Error("Unauthorized");})}unbanUser(a,b,c){return fetch(`${GPTwitchAPI_.BASE_URL}${GPTwitchAPI_.BANS_API}?broadcaster_id=${b}&moderator_id=${b}&user_id=${a}`,{method:"DELETE",headers:{Authorization:`Bearer ${c}`,"Client-Id":GPTwitchAPI_.CLIENT_ID}}).then(d=>{if(401===d.status)throw Error("Unauthorized");})}}window.GPTwitchAPI_=GPTwitchAPI_;
}).call(this)
